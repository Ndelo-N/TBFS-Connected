<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Active Loans - TBFS</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Page-Specific Styles -->
    <style>
        .btn-info {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #2980b9 0%, #21618c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
        }
        
        .loan-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .loan-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-defaulted {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-blacklisted {
            background: #212529;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-section select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .stats-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats-summary h3 {
            margin-bottom: 15px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .loan-card {
                padding: 15px;
            }
            
            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div id="navigation-header"></div>
    
    <!-- Main Container -->
    <div class="container fade-in">
        <div class="page-content">
            <h1 class="mb-lg">üí∞ Active Loans Management</h1>
            
            <!-- Stats Summary -->
            <div class="stats-summary">
                <h3>üìä Portfolio Overview</h3>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">Active Loans</div>
                        <div class="stat-value" id="activeLoansCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Outstanding</div>
                        <div class="stat-value" id="totalOutstanding">R0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Overdue Loans</div>
                        <div class="stat-value" id="overdueCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">This Month Revenue</div>
                        <div class="stat-value" id="monthRevenue">R0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <label><strong>Filter by Status:</strong></label>
                <select id="statusFilter" onchange="filterLoans()">
                    <option value="all">All Loans</option>
                    <option value="active" selected>Active Only</option>
                    <option value="completed">Completed</option>
                    <option value="defaulted">Defaulted</option>
                    <option value="blacklisted">Blacklisted</option>
                    <option value="overdue">Overdue</option>
                </select>
                
                <label><strong>Sort by:</strong></label>
                <select id="sortBy" onchange="filterLoans()">
                    <option value="date">Date (Newest First)</option>
                    <option value="amount">Loan Amount</option>
                    <option value="balance">Outstanding Balance</option>
                    <option value="due">Due Date</option>
                </select>
                
                <button class="btn btn-success" onclick="location.href='calculator.html'" style="margin-left: auto;">
                    ‚ûï New Loan
                </button>
            </div>
            
            <!-- Export Buttons -->
            <div class="filter-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="btn btn-danger" onclick="exportToPDF()" style="margin-left: 10px;">üìÑ Export to PDF</button>
            </div>
            
            <!-- Loans List -->
            <div id="loansList"></div>
        </div>
    </div>
    
    <!-- Shared Modules -->
    <script src="shared/app-state.js"></script>
    <script src="shared/calculations.js"></script>
    <script src="shared/navigation.js"></script>
    
    <!-- Page Logic -->
    <script>
        // Global state
        let AppState = {};
        let allLoans = [];
        let currentFilter = 'active';
        let currentSort = 'date';
        
        /**
         * Initialize page
         */
        function init() {
            // Load app state
            AppState = AppStateManager.load();
            
            // Initialize navigation
            Navigation.init('loans');
            
            // Load loans
            loadLoans();
            
            // Listen for state updates from other tabs
            AppStateManager.onUpdate(() => {
                console.log('State updated from another tab, reloading...');
                AppState = AppStateManager.load();
                loadLoans();
            });
            
            console.log('‚úÖ Active Loans page initialized');
        }
        
        /**
         * Generate payment schedule for a loan that doesn't have one
         * This ensures all loans have schedules for accurate payment allocation
         * 
         * @param {object} loan - Loan object to generate schedule for
         * @returns {array} - Array of payment schedule entries
         */
        function generateLoanSchedule(loan) {
            try {
                // Extract loan details
                const principal = loan.principal_amount || loan.principal || 0;
                const term = loan.term_months || loan.term || 0;
                const startMonthIndex = loan.start_month_index || 0;
                const loanDate = loan.created_at ? new Date(loan.created_at) : new Date();
                const currentYear = loanDate.getFullYear();
                
                // Determine if this is a stockvel loan
                const isStockvel = loan.loan_type === 'stockvel' || loan.isStockvelLoan;
                
                let schedule = [];
                
                if (isStockvel && loan.total_contributions) {
                    // STOCKVEL LOAN: Use tiered interest calculation
                    const totalContributions = loan.total_contributions || 0;
                    const monthlyContribution = loan.monthly_contribution || 0;
                    
                    // Calculate tiered interest for each month
                    const principalPerMonth = principal / term;
                    let balance = principal;
                    let currentSavings = totalContributions;
                    
                    // Calculate total interest using tiered method
                    const interestPeriod = loan.interest_calculation_months || Calculations.calculateInterestPeriod(term).interestMonths;
                    let totalInterest = 0;
                    
                    for (let month = 1; month <= interestPeriod; month++) {
                        const tieredResult = Calculations.calculateTieredStockvelInterest(balance, currentSavings);
                        const minimumInterest = balance * 0.10;
                        const monthInterest = Math.max(tieredResult.tiers1to4Interest, minimumInterest);
                        totalInterest += monthInterest;
                        balance -= principalPerMonth;
                        currentSavings += monthlyContribution;
                    }
                    
                    // Equalize interest across all months
                    const equalizedInterest = totalInterest / term;
                    
                    // Calculate initiation fee (0% if principal <= contributions, 12% on excess)
                    const totalInitiationFee = principal <= totalContributions ? 0 : (principal - totalContributions) * 0.12;
                    const monthlyInitiationFee = totalInitiationFee / term;
                    
                    // Calculate admin fee (reduced for stockvel based on contributions)
                    let adminFee = 60; // Default
                    if (totalContributions >= 20000) adminFee = 45;
                    else if (totalContributions >= 10000) adminFee = 50;
                    
                    // Build schedule
                    balance = principal;
                    for (let month = 1; month <= term; month++) {
                        const dueDate = Calculations.calculateDueDate(currentYear, startMonthIndex, month);
                        schedule.push({
                            payment_number: month,
                            due_date: dueDate,
                            monthly_payment: (principalPerMonth + equalizedInterest + adminFee + monthlyInitiationFee),
                            principal_payment: principalPerMonth,
                            interest_payment: equalizedInterest,
                            admin_fee: adminFee,
                            initiation_fee: monthlyInitiationFee,
                            outstanding_balance: Math.max(0, balance - principalPerMonth),
                            status: 'pending'
                        });
                        balance -= principalPerMonth;
                    }
                } else {
                    // STANDARD LOAN: Use 30% Income Table method
                    const standardResult = Calculations.calculateStandardLoan(principal, term);
                    
                    if (standardResult && standardResult.breakdown) {
                        // Transform breakdown into schedule format
                        schedule = standardResult.breakdown.map((item) => {
                            const dueDate = Calculations.calculateDueDate(currentYear, startMonthIndex, item.month);
                            return {
                                payment_number: item.month,
                                due_date: dueDate,
                                monthly_payment: item.totalPayment || standardResult.monthlyPayment,
                                principal_payment: item.principal,
                                interest_payment: item.interest,
                                admin_fee: item.adminFee,
                                initiation_fee: item.initiationFee,
                                outstanding_balance: item.outstandingBalance,
                                status: 'pending'
                            };
                        });
                    } else {
                        // Fallback: Simple schedule if calculation fails
                        const principalPerMonth = principal / term;
                        const monthlyPayment = loan.monthly_payment || (principal * 1.3 / term); // Rough estimate
                        const adminFee = 60;
                        const initiationFee = (principal * 0.12) / term;
                        const estimatedInterest = (monthlyPayment - principalPerMonth - adminFee - initiationFee);
                        
                        let balance = principal;
                        for (let month = 1; month <= term; month++) {
                            const dueDate = Calculations.calculateDueDate(currentYear, startMonthIndex, month);
                            schedule.push({
                                payment_number: month,
                                due_date: dueDate,
                                monthly_payment: monthlyPayment,
                                principal_payment: principalPerMonth,
                                interest_payment: estimatedInterest,
                                admin_fee: adminFee,
                                initiation_fee: initiationFee,
                                outstanding_balance: Math.max(0, balance - principalPerMonth),
                                status: 'pending'
                            });
                            balance -= principalPerMonth;
                        }
                    }
                }
                
                // Mark payments as paid if loan has payment history
                if (loan.payment_history && loan.payment_history.length > 0) {
                    const paymentsMade = loan.payments_made || 0;
                    for (let i = 0; i < Math.min(paymentsMade, schedule.length); i++) {
                        schedule[i].status = 'paid';
                        if (loan.payment_history[i]) {
                            schedule[i].payment_date = loan.payment_history[i].date;
                            schedule[i].amount_paid = loan.payment_history[i].amount;
                        }
                    }
                }
                
                return schedule;
            } catch (error) {
                console.error('Error generating schedule for loan:', loan.loan_id, error);
                // Return empty schedule on error - will trigger validation
                return [];
            }
        }

        /**
         * Calculate total interest for a standard loan using the business rules.
         */
        function calculateStandardTotalInterest(principal, term) {
            const result = Calculations.calculateStandardLoan(principal, term);
            return result && typeof result.totalInterest === 'number' ? result.totalInterest : 0;
        }

        /**
         * Calculate total interest for a stockvel loan using tiered rules.
         */
        function calculateStockvelTotalInterest(principal, term, totalContributions, monthlyContribution) {
            const interestPeriod = Calculations.calculateInterestPeriod(term).interestMonths;
            const principalPerMonth = principal / term;
            let balance = principal;
            let currentSavings = totalContributions || 0;
            let totalInterest = 0;

            for (let month = 1; month <= interestPeriod; month++) {
                const tieredResult = Calculations.calculateTieredStockvelInterest(balance, currentSavings);
                const minimumInterest = balance * 0.10;
                const monthInterest = Math.max(tieredResult.tiers1to4Interest, minimumInterest);
                totalInterest += monthInterest;
                balance -= principalPerMonth;
                currentSavings += (monthlyContribution || 0);
            }

            return totalInterest;
        }

        function getStockvelAdminFee(totalContributions) {
            if (totalContributions >= 20000) return 45;
            if (totalContributions >= 10000) return 50;
            return 60;
        }

        /**
         * Build a schedule that respects previously paid months and recalculated totals.
         */
        function buildAdjustedSchedule(loan, options) {
            const term = loan.term_months || loan.term || 0;
            const paymentsMade = Math.min(Math.floor(options.paymentsMade || 0), term);
            const remainingMonths = Math.max(1, term - paymentsMade);
            const remainingPrincipal = options.remainingPrincipal || 0;
            const remainingInterest = options.remainingInterest || 0;
            const remainingInitiationFee = options.remainingInitiationFee || 0;
            const adminFee = options.adminFee || 60;

            const loanDate = loan.created_at ? new Date(loan.created_at) : new Date();
            const currentYear = loanDate.getFullYear();
            const startMonthIndex = loan.start_month_index || 0;

            const principalPerMonth = remainingPrincipal / remainingMonths;
            const interestPerMonth = remainingInterest / remainingMonths;
            const initiationFeePerMonth = remainingInitiationFee / remainingMonths;
            const monthlyPayment = principalPerMonth + interestPerMonth + adminFee + initiationFeePerMonth;

            let remainingBalance = remainingPrincipal;
            const schedule = [];
            const existingSchedule = Array.isArray(loan.schedule) ? loan.schedule : [];
            const paymentHistory = Array.isArray(loan.payment_history) ? loan.payment_history : [];

            for (let month = 1; month <= term; month++) {
                const dueDate = Calculations.calculateDueDate(currentYear, startMonthIndex, month);

                if (month <= paymentsMade) {
                    const existing = existingSchedule[month - 1] || {};
                    const history = paymentHistory[month - 1] || {};

                    schedule.push({
                        payment_number: month,
                        due_date: existing.due_date || dueDate,
                        monthly_payment: existing.monthly_payment || history.amount || monthlyPayment,
                        principal_payment: existing.principal_payment || history.principal || 0,
                        interest_payment: existing.interest_payment || history.interest || 0,
                        admin_fee: existing.admin_fee || history.admin_fee || adminFee,
                        initiation_fee: existing.initiation_fee || history.initiation_fee || 0,
                        outstanding_balance: existing.outstanding_balance || 0,
                        status: 'paid',
                        payment_date: history.date || existing.payment_date,
                        amount_paid: history.amount || existing.amount_paid
                    });
                    continue;
                }

                const nextOutstanding = Math.max(0, remainingBalance - principalPerMonth);

                schedule.push({
                    payment_number: month,
                    due_date: dueDate,
                    monthly_payment: monthlyPayment,
                    principal_payment: principalPerMonth,
                    interest_payment: interestPerMonth,
                    admin_fee: adminFee,
                    initiation_fee: initiationFeePerMonth,
                    outstanding_balance: nextOutstanding,
                    status: 'pending'
                });

                remainingBalance = nextOutstanding;
            }

            return schedule;
        }
        
        /**
         * Ensure all loans have payment schedules
         * Generates schedules for loans that don't have them
         * This is critical for accurate payment allocation
         */
        function ensureAllLoansHaveSchedules() {
            let schedulesGenerated = 0;
            
            allLoans.forEach(loan => {
                // Check if loan needs a schedule
                if (!loan.schedule || !Array.isArray(loan.schedule) || loan.schedule.length === 0) {
                    console.log(`üìã Generating schedule for Loan #${loan.loan_id} (${loan.client_name})`);
                    loan.schedule = generateLoanSchedule(loan);
                    schedulesGenerated++;
                    
                    // Update total_interest from schedule if not set
                    if (!loan.total_interest && loan.schedule.length > 0) {
                        loan.total_interest = loan.schedule.reduce((sum, payment) => {
                            return sum + (payment.interest_payment || 0);
                        }, 0);
                    }
                } else {
                    // Validate existing schedule has correct structure
                    const needsRegeneration = loan.schedule.some(p => 
                        !p.payment_number || 
                        !p.principal_payment || 
                        !p.interest_payment === undefined ||
                        !p.admin_fee === undefined ||
                        !p.initiation_fee === undefined
                    );
                    
                    if (needsRegeneration) {
                        console.log(`‚ö†Ô∏è Regenerating incomplete schedule for Loan #${loan.loan_id}`);
                        loan.schedule = generateLoanSchedule(loan);
                        schedulesGenerated++;
                    }
                }
            });
            
            if (schedulesGenerated > 0) {
                console.log(`‚úÖ Generated ${schedulesGenerated} payment schedule(s)`);
                // Save state after generating schedules
                AppStateManager.save(AppState);
            }
        }
        
        /**
         * Load and display all loans
         * Also ensures all loans have payment schedules for accurate payment processing
         */
        function loadLoans() {
            // Load loans from AppState
            allLoans = AppState.loans || [];
            
            // CRITICAL: Ensure all loans have schedules before processing payments
            // This prevents payment allocation errors and ensures accurate calculations
            ensureAllLoansHaveSchedules();
            
            // Update statistics dashboard
            updateStats();
            
            // Filter and display loans
            filterLoans();
        }
        
        /**
         * Update statistics dashboard
         * 
         * Calculates and displays key metrics:
         * - Active loans count
         * - Total outstanding principal
         * - Overdue loans count
         * - This month's revenue
         * 
         * This provides a quick overview of the loan portfolio status
         */
        function updateStats() {
            // STEP 1: FILTER ACTIVE LOANS
            // Only count loans that are currently active (not completed, defaulted, etc.)
            const activeLoans = allLoans.filter(l => l.status === 'active');
            
            // STEP 2: CALCULATE TOTAL OUTSTANDING PRINCIPAL
            // Sum of all remaining principal on active loans
            // This represents the total amount currently loaned out
            const totalOutstanding = activeLoans.reduce((sum, l) => sum + (l.remaining_principal || 0), 0);
            
            // STEP 3: CALCULATE OVERDUE LOANS
            // A loan is overdue if its due date has passed
            // Due date is calculated based on loan start date, start month index, and payments made
            const today = new Date();
            const overdueLoans = activeLoans.filter(l => {
                // Skip loans without required date information
                if (!l.created_at || !l.start_month_index) return false;
                
                // Calculate due date for next payment
                const loanDate = new Date(l.created_at);
                const paymentsMade = l.payments_made || 0;
                const targetMonthOffset = l.start_month_index + paymentsMade;
                const targetYear = loanDate.getFullYear() + Math.floor(targetMonthOffset / 12);
                const targetMonth = targetMonthOffset % 12;
                
                // Due date is the last day of the target month
                const dueDate = new Date(targetYear, targetMonth + 1, 0);
                
                // Loan is overdue if due date is in the past
                return dueDate < today;
            });
            
            // STEP 4: CALCULATE THIS MONTH'S REVENUE
            // Revenue = Interest + Admin Fees + Initiation Fees from payments this month
            // This gives a snapshot of current month's income
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const transactions = AppState.transactions || [];
            const monthRevenue = transactions
                .filter(t => {
                    // Filter transactions from this month
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === thisMonth && 
                           tDate.getFullYear() === thisYear &&
                           t.type === 'payment';
                })
                .reduce((sum, t) => 
                    sum + (t.data?.interestPaid || 0) + 
                    (t.data?.adminFeePaid || 0) + 
                    (t.data?.initiationFeePaid || 0), 
                    0
                );
            
            // STEP 5: UPDATE DISPLAY
            // Update the statistics dashboard with calculated values
            document.getElementById('activeLoansCount').textContent = activeLoans.length;
            document.getElementById('totalOutstanding').textContent = Calculations.formatCurrency(totalOutstanding);
            document.getElementById('overdueCount').textContent = overdueLoans.length;
            document.getElementById('monthRevenue').textContent = Calculations.formatCurrency(monthRevenue);
        }
        
        /**
         * Filter and sort loans
         */
        function filterLoans() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filteredLoans = [...allLoans];
            
            // Apply status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'overdue') {
                    const today = new Date();
                    filteredLoans = filteredLoans.filter(l => {
                        if (l.status !== 'active') return false;
                        if (!l.created_at || !l.start_month_index) return false;
                        const loanDate = new Date(l.created_at);
                        const paymentsMade = l.payments_made || 0;
                        const targetMonthOffset = l.start_month_index + paymentsMade;
                        const targetYear = loanDate.getFullYear() + Math.floor(targetMonthOffset / 12);
                        const targetMonth = targetMonthOffset % 12;
                        const dueDate = new Date(targetYear, targetMonth + 1, 0);
                        return dueDate < today;
                    });
                } else {
                    filteredLoans = filteredLoans.filter(l => l.status === statusFilter);
                }
            }
            
            // Apply sorting
            filteredLoans.sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'amount':
                        return (b.principal || 0) - (a.principal || 0);
                    case 'balance':
                        return (b.remaining_principal || 0) - (a.remaining_principal || 0);
                    case 'due':
                        // Calculate due dates and compare
                        const getDueDate = (loan) => {
                            if (!loan.created_at || !loan.start_month_index) return new Date();
                            const loanDate = new Date(loan.created_at);
                            const paymentsMade = loan.payments_made || 0;
                            const targetMonthOffset = loan.start_month_index + paymentsMade;
                            const targetYear = loanDate.getFullYear() + Math.floor(targetMonthOffset / 12);
                            const targetMonth = targetMonthOffset % 12;
                            return new Date(targetYear, targetMonth + 1, 0);
                        };
                        return getDueDate(a) - getDueDate(b);
                    default:
                        return 0;
                }
            });
            
            displayLoans(filteredLoans);
        }
        
        /**
         * Display loans
         */
        function displayLoans(loans) {
            const container = document.getElementById('loansList');
            
            if (loans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No loans found</h3>
                        <p>No loans match your current filter.</p>
                        <button class="btn btn-primary mt-lg" onclick="location.href='calculator.html'">
                            ‚ûï Create New Loan
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = loans.map(loan => {
                // Calculate dates and status
                const loanDate = new Date(loan.created_at);
                const loanDateStr = loanDate.toLocaleDateString('en-ZA', { 
                    day: '2-digit', month: 'short', year: 'numeric' 
                });
                
                // Calculate payments made
                const paymentsMade = loan.payments_made || 0;
                
                // Calculate next due date
                let nextDueStr = 'N/A';
                let isOverdue = false;
                let daysOverdue = 0;
                
                if (loan.status === 'active' && loan.start_month_index !== undefined) {
                    const startYear = loanDate.getFullYear();
                    const targetMonthOffset = loan.start_month_index + paymentsMade;
                    const targetYear = startYear + Math.floor(targetMonthOffset / 12);
                    const targetMonth = targetMonthOffset % 12;
                    const dueDate = new Date(targetYear, targetMonth + 1, 0);
                    
                    nextDueStr = dueDate.toLocaleDateString('en-ZA', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                    
                    const today = new Date();
                    isOverdue = dueDate < today;
                    if (isOverdue) {
                        daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    }
                }
                
                const principal = loan.principal || loan.principal_amount || 0;
                const remainingPrincipal = loan.remaining_principal || principal;
                const monthlyPayment = loan.monthly_payment || 0;
                const currentBalance = loan.current_balance || 0;
                
                return `
                    <div class="loan-card">
                        <h4>Loan #${loan.loan_id} - ${loan.client_name}</h4>
                        
                        <div class="info-row">
                            <span>üìÖ Loan Date:</span>
                            <strong style="color: #7f8c8d;">${loanDateStr}</strong>
                        </div>
                        
                        ${loan.payment_history && loan.payment_history.length > 0 ? `
                        <div class="info-row">
                            <span>üí≥ Last Payment:</span>
                            <strong style="color: #27ae60;">
                                ${new Date(loan.payment_history[loan.payment_history.length - 1].date).toLocaleDateString('en-ZA', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                })}
                                (${Calculations.formatCurrency(loan.payment_history[loan.payment_history.length - 1].amount)})
                            </strong>
                        </div>
                        ` : ''}
                        
                        ${loan.status === 'active' ? `
                        <div class="info-row">
                            <span>üìÜ Next Payment Due:</span>
                            <strong style="color: ${isOverdue ? '#e74c3c' : '#27ae60'};">
                                ${nextDueStr}${isOverdue ? ` (${daysOverdue} days overdue!)` : ''}
                            </strong>
                        </div>
                        ` : ''}
                        
                        <div class="info-row">
                            <span>üí∞ Principal:</span>
                            <strong>${Calculations.formatCurrency(principal)}</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üí≥ Monthly Payment:</span>
                            <strong>${Calculations.formatCurrency(monthlyPayment)}</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üìä Progress:</span>
                            <strong>${paymentsMade}/${loan.term_months} payments made</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üíµ Remaining Principal:</span>
                            <strong style="color: #e74c3c;">${Calculations.formatCurrency(remainingPrincipal)}</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üìã Status:</span>
                            <span class="status-badge status-${loan.status}">${loan.status}</span>
                        </div>
                        
                        <div class="info-row">
                            <span>‚ö° Actions:</span>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                ${loan.status === 'active' ? `
                                    <button class="btn btn-success" style="padding: 8px 12px; font-size: 13px;" 
                                            onclick="makePayment(${loan.loan_id})">
                                        üí∞ Make Payment
                                    </button>
                                    <button class="btn btn-info" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="calculateEarlyPayoff(${loan.loan_id})">
                                        üéØ Early Payoff
                                    </button>
                                    <button class="btn btn-warning" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="viewLoanDetails(${loan.loan_id})">
                                        üëÅÔ∏è View Details
                                    </button>
                                    <button class="btn" style="padding: 8px 12px; font-size: 13px; background: #9b59b6; color: white;"
                                            onclick="downloadLoanStatementPDF(${loan.loan_id})">
                                        üì• Download PDF
                                    </button>
                                    <button class="btn btn-danger" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="markAsDefaulted(${loan.loan_id})">
                                        ‚ö†Ô∏è Mark Default
                                    </button>
                                    <button class="btn" style="padding: 8px 12px; font-size: 13px; background: #16a085; color: white;"
                                            onclick="adjustLoan(${loan.loan_id})">
                                        üîß Adjust Loan
                                    </button>
                                ` : `
                                    <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="viewLoanDetails(${loan.loan_id})">
                                        üëÅÔ∏è View Details
                                    </button>
                                    <button class="btn" style="padding: 8px 12px; font-size: 13px; background: #9b59b6; color: white;"
                                            onclick="downloadLoanStatementPDF(${loan.loan_id})">
                                        üì• Download PDF
                                    </button>
                                    ${loan.status === 'completed' ? `
                                        <button class="btn" style="padding: 8px 12px; font-size: 13px; background: #27ae60;"
                                                onclick="alert('‚úÖ This loan has been fully paid!')">
                                            ‚úÖ Completed
                                        </button>
                                    ` : ''}
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        /**
         * Calculate early payoff quote for a loan
         */
        function calculateEarlyPayoff(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            if (loan.status !== 'active') {
                alert('‚ö†Ô∏è Only active loans can be paid off early!');
                return;
            }
            
            // Ask for payoff month
            const currentMonth = (loan.payments_made || 0) + 1;
            const maxMonth = loan.term_months;
            
            const payoffMonth = prompt(
                `üéØ Early Payoff Calculator\n\n` +
                `Loan #${loanId} - ${loan.client_name}\n` +
                `Original Term: ${loan.term_months} months\n` +
                `Payments Made: ${loan.payments_made || 0}\n\n` +
                `Enter the month you want to pay off the loan:\n` +
                `(Must be between ${currentMonth} and ${maxMonth})`
            );
            
            if (!payoffMonth) return;
            
            const month = parseInt(payoffMonth);
            
            // Validate
            if (isNaN(month) || month < currentMonth || month > maxMonth) {
                alert(`‚ùå Invalid month!\n\nMust be between ${currentMonth} and ${maxMonth}`);
                return;
            }
            
            try {
                // Calculate early payoff
                const payoff = Calculations.calculateEarlyPayoff(loan, month);
                
                // Format the display
                const breakdown = payoff.formatted.breakdown.map(item => 
                    `${item.label}: ${item.amount}`
                ).join('\n');
                
                // Show detailed quote
                const quote = `
üéØ EARLY PAYOFF QUOTE - LOAN #${loanId}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìã Loan Details:
Client: ${loan.client_name}
Original Term: ${loan.term_months} months
Payoff Month: ${month}
Payments Made: ${loan.payments_made || 0}

üí∞ Payoff Breakdown:
${breakdown}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
TOTAL PAYOFF: ${payoff.formatted.totalPayoff}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìä Financial Summary:
Already Paid: ${Calculations.formatCurrency(payoff.totalPaidSoFar)}
Payoff Amount: ${payoff.formatted.totalPayoff}
Total Cost: ${Calculations.formatCurrency(payoff.totalWithPayoff)}

vs Full Term: ${Calculations.formatCurrency(payoff.originalTotalCost)}
YOU SAVE: ${payoff.formatted.savings} (${payoff.savingsPercentage.toFixed(2)}%)

‚è∞ You'll finish ${payoff.monthsSaved} months early!

üí° Interest Calculated for ${payoff.monthsInterestCalculated} months
   (min of payoff month ${month} and interest period ${loan.interest_calculation_months})

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Would you like to proceed with early payoff?
Click "OK" to process payment or "Cancel" to go back.
                `.trim();
                
                const proceed = confirm(quote);
                
                if (proceed) {
                    // Process early payoff
                    processEarlyPayoff(loan, month, payoff);
                }
                
            } catch (error) {
                console.error('Early payoff calculation error:', error);
                alert(`‚ùå Error calculating early payoff:\n\n${error.message}`);
            }
        }
        
        /**
         * Process early payoff payment
         * 
         * This function finalizes the early payoff transaction:
         * - Updates loan status to 'completed'
         * - Records early payoff details
         * - Updates all balances to zero
         * - Updates AppState financial metrics
         * - Logs transaction for audit trail
         * 
         * @param {object} loan - The loan object being paid off
         * @param {number} payoffMonth - The month the loan is being paid off
         * @param {object} payoffData - Calculated payoff breakdown from calculateEarlyPayoff()
         */
        function processEarlyPayoff(loan, payoffMonth, payoffData) {
            try {
                const totalPayoff = payoffData.totalPayoff;
                
                // STEP 1: FINAL CONFIRMATION
                // Early payoff is a significant transaction - require explicit confirmation
                const finalConfirm = confirm(
                    `üí∞ Final Confirmation\n\n` +
                    `You are about to pay off Loan #${loan.loan_id}\n\n` +
                    `Total Amount: ${Calculations.formatCurrency(totalPayoff)}\n` +
                    `Savings: ${payoffData.formatted.savings}\n\n` +
                    `This action cannot be undone.\n` +
                    `Proceed with payment?`
                );
                
                if (!finalConfirm) {
                    alert('‚è∏Ô∏è Early payoff cancelled.');
                    return;
                }
                
                // STEP 2: UPDATE LOAN RECORD
                // Mark loan as completed and record early payoff details
                loan.status = 'completed';
                loan.completion_date = new Date().toISOString();
                loan.remaining_principal = 0; // Loan fully paid
                
                // Update interest paid (add prorated interest for payoff month)
                loan.interest_paid = (loan.interest_paid || 0) + payoffData.interestOwed;
                
                // Initiation fee must be paid in full for early payoff
                loan.initiation_fee_paid = loan.total_initiation_fee || 0;
                
                // Record early payoff metadata
                loan.early_payoff = true;
                loan.payoff_month = payoffMonth;
                loan.payoff_date = new Date().toISOString();
                loan.payoff_amount = totalPayoff;
                loan.savings_from_early_payoff = payoffData.savings;
                
                // Mark all schedule entries as paid
                if (loan.schedule) {
                    loan.schedule.forEach(payment => {
                        payment.status = 'paid';
                    });
                }
                
                // STEP 3: UPDATE APPSTATE (GLOBAL FINANCIAL TRACKING)
                // Update system-wide financial metrics
                AppState.capital = (AppState.capital || 0) + totalPayoff;
                AppState.deployed = Math.max(0, (AppState.deployed || 0) - loan.principal_amount);
                AppState.totalInterestEarned = (AppState.totalInterestEarned || 0) + payoffData.interestOwed;
                AppState.totalFeesEarned = (AppState.totalFeesEarned || 0) + payoffData.initiationFeeOwed + payoffData.adminFeesOwed;
                
                // Log transaction
                if (!AppState.transactionHistory) AppState.transactionHistory = [];
                AppState.transactionHistory.push({
                    type: 'early_payoff',
                    timestamp: new Date().toISOString(),
                    details: {
                        loanId: loan.loan_id,
                        clientName: loan.client_name,
                        originalTerm: loan.term_months,
                        payoffMonth: payoffMonth,
                        paymentsMade: loan.payments_made || 0,
                        payoffAmount: totalPayoff,
                        remainingPrincipal: payoffData.remainingPrincipal,
                        interestOwed: payoffData.interestOwed,
                        initiationFeeOwed: payoffData.initiationFeeOwed,
                        adminFeesOwed: payoffData.adminFeesOwed,
                        savings: payoffData.savings,
                        savingsPercentage: payoffData.savingsPercentage,
                        monthsSaved: payoffData.monthsSaved
                    }
                });
                
                // Save state
                AppStateManager.save(AppState);
                
                // Show success message
                alert(
                    `‚úÖ LOAN PAID OFF SUCCESSFULLY!\n\n` +
                    `üéâ Congratulations!\n\n` +
                    `Loan #${loan.loan_id} has been fully paid off.\n\n` +
                    `üí∞ Total Paid: ${Calculations.formatCurrency(totalPayoff)}\n` +
                    `üíµ You Saved: ${payoffData.formatted.savings}\n` +
                    `‚è∞ Finished ${payoffData.monthsSaved} months early!\n\n` +
                    `Thank you for your business! üåü`
                );
                
                // Refresh display
                loadLoans();
                
            } catch (error) {
                console.error('Error processing early payoff:', error);
                alert(`‚ùå Error processing early payoff:\n\n${error.message}`);
            }
        }
        
        /**
         * Make payment on a loan
         * 
         * This is the core payment processing function that handles:
         * - Payment validation and input
         * - Payment allocation (waterfall method)
         * - Interest recalculation for early overpayments
         * - Stockvel bonus calculation
         * - State updates and transaction logging
         * 
         * Payment Allocation Order (Waterfall Method):
         * 1. Initiation Fee (monthly portion)
         * 2. Admin Fee (R60 per month, or reduced for stockvel)
         * 3. Interest (from schedule)
         * 4. Principal (remaining amount)
         * 
         * Overpayment Handling:
         * - First Half: Applied to principal (triggers interest recalculation)
         * - Second Half: Applied to fees/interest first, then principal
         * 
         * @param {number} loanId - The ID of the loan to make payment on
         */
        function makePayment(loanId) {
            // STEP 1: VALIDATION - Find and validate loan
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            // Only active loans can receive payments
            if (loan.status !== 'active') {
                alert('‚ö†Ô∏è Can only make payments on active loans!');
                return;
            }
            
            // STEP 2: CRITICAL VALIDATION - Ensure payment schedule exists
            // Payment schedules are required for accurate payment allocation
            // Without a schedule, we cannot properly allocate payments to fees, interest, and principal
            if (!loan.schedule || !Array.isArray(loan.schedule) || loan.schedule.length === 0) {
                console.warn(`‚ö†Ô∏è Loan #${loanId} missing schedule. Generating now...`);
                
                // Attempt to generate schedule
                loan.schedule = generateLoanSchedule(loan);
                
                // If generation failed, abort payment
                if (!loan.schedule || loan.schedule.length === 0) {
                    alert(
                        '‚ùå Payment Schedule Error!\n\n' +
                        `Loan #${loanId} does not have a payment schedule and could not be generated.\n\n` +
                        'Please contact support or regenerate the loan schedule.\n\n' +
                        'Payment cannot be processed without a valid schedule.'
                    );
                    return;
                }
                
                // Save state after generating schedule
                AppStateManager.save(AppState);
                console.log(`‚úÖ Schedule generated for Loan #${loanId}`);
            }
            
            // STEP 3: INITIALIZE TRACKING FIELDS
            // These fields track payment progress and must be initialized for older loans
            if (!loan.remaining_principal) {
                loan.remaining_principal = loan.principal_amount || loan.principal || 0;
            }
            if (!loan.initiation_fee_paid) {
                loan.initiation_fee_paid = 0;
            }
            if (!loan.interest_paid) {
                loan.interest_paid = 0;
            }
            
            // STEP 4: CALCULATE TOTAL INITIATION FEE (if not already set)
            // Initiation fee calculation differs for stockvel vs standard loans
            if (!loan.total_initiation_fee) {
                const principal = loan.principal_amount || loan.principal || 0;
                if (loan.loan_type === 'stockvel' && loan.total_contributions) {
                    // Stockvel Rule: 0% initiation fee if principal <= total contributions
                    // 12% initiation fee on the excess amount above contributions
                    loan.total_initiation_fee = principal <= loan.total_contributions ? 0 : (principal - loan.total_contributions) * 0.12;
                } else {
                    // Standard Rule: 12% of principal
                    loan.total_initiation_fee = principal * 0.12;
                }
            }
            
            // STEP 5: CALCULATE TOTAL INTEREST (if not already set)
            // Total interest should come from the payment schedule for accuracy
            if (!loan.total_interest) {
                if (loan.schedule && loan.schedule.length > 0) {
                    // Sum interest from schedule (most accurate method)
                    loan.total_interest = loan.schedule.reduce((sum, payment) => {
                        return sum + (payment.interest_payment || 0);
                    }, 0);
                } else {
                    // Fallback: Estimate from monthly payment (less accurate)
                    // This should rarely be needed if schedules are properly generated
                    const principal = loan.principal_amount || loan.principal || 0;
                    const monthlyPayment = loan.monthly_payment || 0;
                    const totalPayments = monthlyPayment * loan.term_months;
                    const totalFees = loan.total_initiation_fee + (60 * loan.term_months); // Admin fees
                    loan.total_interest = Math.max(0, totalPayments - principal - totalFees);
                    console.warn(`‚ö†Ô∏è Loan #${loanId}: Estimated interest (schedule not available)`);
                }
            }
            
            // STEP 6: CALCULATE REMAINING AMOUNTS
            // These are displayed to the user before payment input
            const remainingInitiationFee = Math.max(0, loan.total_initiation_fee - loan.initiation_fee_paid);
            const remainingInterest = Math.max(0, loan.total_interest - loan.interest_paid);
            
            // STEP 7: GET PAYMENT AMOUNT FROM USER
            // Display loan details and prompt for payment amount
            const expectedPayment = loan.monthly_payment || 0;
            const remainingPrincipal = loan.remaining_principal;
            const paymentsRemaining = loan.term_months - (loan.payments_made || 0);
            
            const paymentAmount = prompt(
                `üí∞ Enter payment amount for Loan #${loanId}\n\n` +
                `Expected Monthly Payment: ${Calculations.formatCurrency(expectedPayment)}\n` +
                `Remaining Principal: ${Calculations.formatCurrency(remainingPrincipal)}\n` +
                `Remaining Interest: ${Calculations.formatCurrency(remainingInterest)}\n` +
                `Remaining Initiation Fee: ${Calculations.formatCurrency(remainingInitiationFee)}\n` +
                `Payments Made: ${loan.payments_made || 0}/${loan.term_months}\n\n` +
                `üí° You can make partial or overpayments`
            );
            
            // Validate payment amount input
            if (!paymentAmount || isNaN(paymentAmount) || parseFloat(paymentAmount) <= 0) {
                alert('‚ùå Invalid payment amount!');
                return;
            }
            
            const amount = parseFloat(paymentAmount);
            
            // STEP 8: GET PAYMENT DATE FROM USER
            // Payment date allows backdating or future-dating payments
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
            const paymentDateInput = prompt(
                `üìÖ Enter payment date for Loan #${loanId}\n\n` +
                `Amount: ${Calculations.formatCurrency(amount)}\n\n` +
                `Enter date (YYYY-MM-DD):\n` +
                `üí° Press OK for today (${today}) or enter a different date`
            , today);
            
            if (!paymentDateInput) {
                alert('‚ùå Payment cancelled!');
                return;
            }
            
            // Validate and parse payment date
            let paymentDate;
            try {
                paymentDate = new Date(paymentDateInput);
                if (isNaN(paymentDate.getTime())) {
                    throw new Error('Invalid date');
                }
                // Convert to ISO string for consistent storage
                paymentDate = paymentDate.toISOString();
            } catch (error) {
                alert(`‚ùå Invalid date format!\n\nPlease use YYYY-MM-DD format (e.g., ${today})`);
                return;
            }
            
            // STEP 9: PAYMENT ALLOCATION (WATERFALL METHOD)
            // Initialize allocation variables
            let remainingAmount = amount;
            let principalPaid = 0;
            let interestPaid = 0;
            let adminFeePaid = 0;
            let initiationFeePaid = 0;
            
            // Track principal before payment for interest recalculation check
            const principalBeforePayment = loan.remaining_principal;
            
            // STEP 10: GET NEXT PENDING PAYMENT FROM SCHEDULE
            // The schedule contains the expected payment breakdown for each month
            // We find the next unpaid payment to allocate against
            let nextPayment = loan.schedule.find(p => p.status === 'pending');
            
            // VALIDATION: Ensure we have a valid next payment
            if (!nextPayment) {
                // Check if all payments are marked as paid
                const allPaid = loan.schedule.every(p => p.status === 'paid');
                if (allPaid && loan.remaining_principal <= 0.01) {
                    alert('‚úÖ This loan is already fully paid!');
                    return;
                } else {
                    // Schedule exists but no pending payment found - regenerate schedule
                    console.warn(`‚ö†Ô∏è No pending payment found in schedule for Loan #${loanId}. Regenerating...`);
                    loan.schedule = generateLoanSchedule(loan);
                    nextPayment = loan.schedule.find(p => p.status === 'pending');
                    if (!nextPayment) {
                        alert('‚ùå Error: Could not find next payment in schedule. Please contact support.');
                        return;
                    }
                    // Continue with regenerated schedule
                }
            }
            
            // STEP 11: ALLOCATE PAYMENT USING WATERFALL METHOD
            // Payment allocation follows a strict order to ensure fees are paid first
            // This order is: Initiation Fee ‚Üí Admin Fee ‚Üí Interest ‚Üí Principal
            
            // ALLOCATION 1: Pay Initiation Fee (monthly portion)
            // Initiation fee is spread across all months of the loan term
            const initiationDue = nextPayment.initiation_fee || 0;
            if (remainingAmount > 0 && initiationDue > 0) {
                initiationFeePaid = Math.min(remainingAmount, initiationDue);
                remainingAmount -= initiationFeePaid;
            }
            
            // ALLOCATION 2: Pay Admin Fee
            // Admin fee is R60 per month for standard loans
            // Reduced for stockvel members (R45 if contributions >= R20k, R50 if >= R10k)
            const adminDue = nextPayment.admin_fee || 0;
            if (remainingAmount > 0 && adminDue > 0) {
                adminFeePaid = Math.min(remainingAmount, adminDue);
                remainingAmount -= adminFeePaid;
            }
            
            // ALLOCATION 3: Pay Interest
            // Interest is calculated based on loan type (standard 30% income table or stockvel tiered)
            // Interest is equalized across all months for client convenience
            const interestDue = nextPayment.interest_payment || 0;
            if (remainingAmount > 0 && interestDue > 0) {
                interestPaid = Math.min(remainingAmount, interestDue);
                remainingAmount -= interestPaid;
            }
            
            // ALLOCATION 4: Pay Principal
            // Principal payment reduces the outstanding loan balance
            // This is the actual loan amount being repaid
            const principalDue = nextPayment.principal_payment || 0;
            if (remainingAmount > 0 && principalDue > 0) {
                principalPaid = Math.min(remainingAmount, principalDue, loan.remaining_principal);
                remainingAmount -= principalPaid;
            }
            
            // STEP 12: HANDLE OVERPAYMENT
            // Overpayments are handled differently depending on when they occur in the loan term
            // This rewards early overpayments with interest recalculation
            if (remainingAmount > 0 && loan.remaining_principal > principalPaid) {
                // Calculate which payment number we're on
                const halfwayPoint = Math.ceil(loan.term_months / 2);
                const principalPerMonth = (loan.original_principal || loan.principal_amount) / loan.term_months;
                const currentPaymentNumber = Math.floor((loan.original_principal - loan.remaining_principal) / principalPerMonth) + 1;
                
                if (currentPaymentNumber <= halfwayPoint) {
                    // FIRST HALF OVERPAYMENT: Apply extra to principal
                    // This triggers interest recalculation, rewarding early overpayments
                    const additionalPrincipal = Math.min(remainingAmount, loan.remaining_principal - principalPaid);
                    principalPaid += additionalPrincipal;
                    remainingAmount -= additionalPrincipal;
                    
                    console.log(`üí° Overpayment in first half (month ${currentPaymentNumber}/${halfwayPoint})`);
                    console.log(`Extra principal paid: R${additionalPrincipal.toFixed(2)}`);
                    console.log(`Interest will be recalculated on reduced balance`);
                } else {
                    // SECOND HALF OVERPAYMENT: Apply to fees/interest first, then principal
                    // In the second half, we prioritize paying off fees and interest before principal
                    console.log(`üìä Overpayment in second half (month ${currentPaymentNumber}/${halfwayPoint})`);
                    
                    // Apply to remaining initiation fee balance first
                    const remainingInitiationFee = Math.max(0, (loan.total_initiation_fee || 0) - (loan.initiation_fee_paid || 0));
                    if (remainingAmount > 0 && remainingInitiationFee > 0) {
                        const extraInitiation = Math.min(remainingAmount, remainingInitiationFee);
                        initiationFeePaid += extraInitiation;
                        remainingAmount -= extraInitiation;
                        console.log(`Applied R${extraInitiation.toFixed(2)} to initiation fee balance`);
                    }
                    
                    // Apply to remaining interest balance
                    const remainingInterest = Math.max(0, (loan.total_interest || 0) - (loan.interest_paid || 0));
                    if (remainingAmount > 0 && remainingInterest > 0) {
                        const extraInterest = Math.min(remainingAmount, remainingInterest);
                        interestPaid += extraInterest;
                        remainingAmount -= extraInterest;
                        console.log(`Applied R${extraInterest.toFixed(2)} to interest balance`);
                    }
                    
                    // Finally apply to principal
                    if (remainingAmount > 0) {
                        const additionalPrincipal = Math.min(remainingAmount, loan.remaining_principal - principalPaid);
                        principalPaid += additionalPrincipal;
                        remainingAmount -= additionalPrincipal;
                        console.log(`Applied R${additionalPrincipal.toFixed(2)} to principal`);
                    }
                }
            }
            
            // STEP 13: UPDATE PAYMENT SCHEDULE ENTRY
            // Mark the payment as paid in the schedule for tracking
            nextPayment.status = 'paid';
            nextPayment.payment_date = paymentDate;
            nextPayment.amount_paid = amount;
            
            // Track total principal received (not just this payment)
            if (!loan.total_principal_received) {
                loan.total_principal_received = 0;
            }
            loan.total_principal_received += principalPaid;
            
            // Initialize payment history if not exists
            if (!loan.payment_history) {
                loan.payment_history = [];
            }
            
            // Add this payment to history
            loan.payment_history.push({
                date: paymentDate,
                amount: amount,
                principal: principalPaid,
                interest: interestPaid,
                admin_fee: adminFeePaid,
                initiation_fee: initiationFeePaid,
                payments_made_after: 0, // Will be updated below
                remaining_principal_after: 0, // Will be updated below
                interest_recalculated: false // Will be updated if recalc happens
            });
            
            // Update loan totals
            loan.remaining_principal = Math.max(0, loan.remaining_principal - principalPaid);
            loan.initiation_fee_paid = (loan.initiation_fee_paid || 0) + initiationFeePaid;
            loan.interest_paid = (loan.interest_paid || 0) + interestPaid;
            
            // STEP 16: CALCULATE PAYMENTS MADE
            // Payments are calculated based on principal received, not payment count
            // This handles partial payments and overpayments correctly
            // Example: If principal per month is R1,000 and R1,500 was received, that's 1.5 payments
            const principalPerMonth = (loan.original_principal || loan.principal_amount) / loan.term_months;
            loan.payments_made = Math.floor(loan.total_principal_received / principalPerMonth);
            
            // STEP 17: UPDATE PAYMENT HISTORY ENTRY
            // Record the payment in the loan's payment history for audit trail
            // This provides a complete record of all transactions on the loan
            const lastPayment = loan.payment_history[loan.payment_history.length - 1];
            if (lastPayment) {
                lastPayment.payments_made_after = loan.payments_made;
                lastPayment.remaining_principal_after = loan.remaining_principal;
            }
            
            // Log principal tracking for debugging and verification
            console.log(`üí∞ Principal Tracking:`);
            console.log(`Total Principal Received: R${loan.total_principal_received.toFixed(2)}`);
            console.log(`Principal Per Month: R${principalPerMonth.toFixed(2)}`);
            console.log(`Payments Made (calculated): ${loan.payments_made}/${loan.term_months}`);
            
            // Check for interest recalculation (if overpayment in first half)
            const halfwayPoint = Math.ceil(loan.term_months / 2);
            const interestPeriod = loan.interest_calculation_months || Calculations.calculateInterestPeriod(loan.term_months).interestMonths;
            
            if (loan.payments_made <= halfwayPoint && principalPaid > principalPerMonth * 1.1) {
                // Significant overpayment in first half - recalculate interest
                console.log(`\nüîÑ RECALCULATING INTEREST (Overpayment in first half)`);
                console.log(`Previous Principal: R${principalBeforePayment.toFixed(2)}`);
                console.log(`New Principal: R${loan.remaining_principal.toFixed(2)}`);
                
                try {
                    // Recalculate interest on new reduced principal
                    const isStockvel = loan.loan_type === 'stockvel' || loan.isStockvelLoan;
                    let newInterestCalculation = 0;
                    
                    if (isStockvel && loan.total_contributions) {
                        // Stockvel: Use tiered rates on new balance
                        let balance = loan.remaining_principal;
                        let currentSavings = loan.total_contributions + ((loan.monthly_contribution || 0) * loan.payments_made);
                        const remainingMonths = interestPeriod - loan.payments_made;
                        
                        for (let i = 0; i < remainingMonths; i++) {
                            const tieredResult = Calculations.calculateTieredStockvelInterest(balance, currentSavings);
                            const minimumInterest = balance * 0.10;
                            const monthInterest = Math.max(tieredResult.tiers1to4Interest, minimumInterest);
                            newInterestCalculation += monthInterest;
                            balance -= principalPerMonth;
                            currentSavings += (loan.monthly_contribution || 0);
                        }
                    } else {
                        // Standard: Use 30% income table on new balance
                        let balance = loan.remaining_principal;
                        const remainingMonths = interestPeriod - loan.payments_made;
                        
                        for (let i = 0; i < remainingMonths; i++) {
                            const tbfsIncome = balance * 0.30;
                            const adminFee = 60;
                            const initiationFee = (loan.total_initiation_fee || 0) / loan.term_months;
                            const monthInterest = tbfsIncome - adminFee - initiationFee;
                            newInterestCalculation += monthInterest;
                            balance -= principalPerMonth;
                        }
                    }
                    
                    // Update interest tracking
                    const previousMaxInterest = loan.max_interest_allowed || 0;
                    const newMaxInterest = loan.interest_paid + newInterestCalculation;
                    loan.max_interest_allowed = newMaxInterest;
                    loan.expected_monthly_interest = newMaxInterest / loan.term_months;
                    
                    console.log(`Previous Max Interest: R${previousMaxInterest.toFixed(2)}`);
                    console.log(`New Max Interest: R${newMaxInterest.toFixed(2)}`);
                    console.log(`Interest Reduction: R${(previousMaxInterest - newMaxInterest).toFixed(2)}`);
                    console.log(`‚úÖ Interest recalculated successfully!`);
                    
                    // Flag for display
                    loan.interest_recalculated = true;
                    loan.last_recalculation_date = paymentDate;
                    
                    // Update payment history entry
                    const lastPayment = loan.payment_history[loan.payment_history.length - 1];
                    lastPayment.interest_recalculated = true;
                    lastPayment.new_max_interest = newMaxInterest;
                    
                } catch (error) {
                    console.error('Error recalculating interest:', error);
                }
            }
            
            // STEP 20: UPDATE LEGACY FIELDS FOR BACKWARD COMPATIBILITY
            // Some older code may reference total_interest_charged instead of interest_paid
            // Keep both fields in sync to prevent data inconsistencies
            loan.total_interest_charged = loan.interest_paid;
            
            // STEP 21: CHECK IF LOAN IS FULLY PAID OFF
            // A loan is considered complete when:
            // - Remaining principal is <= R0.01 (essentially zero)
            // - OR payments_made >= term_months (all scheduled payments completed)
            if (loan.remaining_principal <= 0.01 || loan.payments_made >= loan.term_months) {
                loan.status = 'completed';
                loan.completion_date = new Date().toISOString();
                loan.remaining_principal = 0; // Ensure it's exactly zero
                
                // Mark all remaining schedule entries as paid
                loan.schedule.forEach(payment => {
                    if (payment.status === 'pending') {
                        payment.status = 'paid';
                    }
                });
            }
            
            // STEP 22: CALCULATE AND RECORD BONUS FOR STOCKVEL MEMBERS
            // Stockvel members earn bonuses when they pay less than the 10% minimum charge
            // Bonus = 10% minimum - actual amount due
            // This rewards members with good savings-to-loan ratios
            let bonusEarned = 0;
            if (loan.memberNumber && AppState.stockvelMembers) {
                // Find the stockvel member using standardized lookup
                const stockvelMember = Calculations.findStockvelMember(
                    { memberNumber: loan.memberNumber }, 
                    AppState.stockvelMembers
                );
                
                if (stockvelMember) {
                    // Calculate what TBFS is due (tiered interest + fees)
                    // Use balance BEFORE this payment for calculation
                    const remainingBalance = loan.remaining_principal + principalPaid;
                    
                    // Amount due to TBFS = interest + admin fee + initiation fee
                    const amountDueToTBFS = interestPaid + adminFeePaid + initiationFeePaid;
                    
                    // 10% minimum charge rule: Member must pay at least 10% of balance
                    const minimumCharge = remainingBalance * 0.10;
                    
                    // Bonus is earned when actual amount due is less than minimum charge
                    if (amountDueToTBFS < minimumCharge) {
                        // Member pays EXACTLY 10% (minimum)
                        // Bonus = difference between minimum and actual amount due
                        bonusEarned = minimumCharge - amountDueToTBFS;
                        
                        // Add bonus to member's accumulated bonus (NOT to contributions!)
                        // This keeps contributions pure and bonuses separate
                        stockvelMember.accumulatedBonus = (stockvelMember.accumulatedBonus || 0) + bonusEarned;
                        
                        // Ensure stockvelReceipts array exists
                        if (!AppState.stockvelReceipts) AppState.stockvelReceipts = [];
                        
                        // Record bonus receipt for audit trail
                        AppState.stockvelReceipts.push({
                            id: Date.now(),
                            memberNumber: stockvelMember.memberNumber,
                            memberName: stockvelMember.name,
                            type: 'loan_payment',
                            amount: amount,
                            date: paymentDate,
                            notes: `Loan #${loanId} payment - Bonus earned (paid 10% minimum, saved ${((bonusEarned/minimumCharge)*100).toFixed(1)}%)`,
                            previousTotal: stockvelMember.totalContributions,
                            newTotal: stockvelMember.totalContributions, // Contributions stay same!
                            bonusAmount: bonusEarned,
                            previousBonus: stockvelMember.accumulatedBonus - bonusEarned
                        });
                        
                        console.log(`üéÅ Stockvel Bonus Earned: R${bonusEarned.toFixed(2)}`);
                    }
                    // else: amountDueToTBFS >= minimumCharge
                    // Member pays tiered amount (already > 10%), no bonus earned
                }
            }
            
            // STEP 23: UPDATE APPSTATE (GLOBAL FINANCIAL TRACKING)
            // Update system-wide financial metrics
            // Capital: All money received goes to capital
            AppState.capital = (AppState.capital || 0) + amount;
            
            // Deployed: Reduce by principal paid (money is no longer loaned out)
            AppState.deployed = Math.max(0, (AppState.deployed || 0) - principalPaid);
            
            // Total Interest Earned: Track cumulative interest income
            AppState.totalInterestEarned = (AppState.totalInterestEarned || 0) + interestPaid;
            
            // Total Fees Earned: Track cumulative fee income (admin + initiation)
            AppState.totalFeesEarned = (AppState.totalFeesEarned || 0) + adminFeePaid + initiationFeePaid;
            
            // STEP 24: LOG TRANSACTION FOR AUDIT TRAIL
            // Transaction history provides a complete record of all financial activity
            // This is used for reporting, reconciliation, and debugging
            if (!AppState.transactionHistory) AppState.transactionHistory = [];
            AppState.transactionHistory.push({
                type: 'payment',
                timestamp: new Date().toISOString(), // When transaction was recorded in system
                paymentDate: paymentDate, // When payment was actually received (may be backdated)
                details: {
                    loanId: loanId,
                    clientName: loan.client_name,
                    paymentAmount: amount,
                    principalPaid: principalPaid,
                    interestPaid: interestPaid,
                    adminFeePaid: adminFeePaid,
                    initiationFeePaid: initiationFeePaid,
                    overpayment: remainingAmount,
                    remainingPrincipal: loan.remaining_principal,
                    remainingInterest: Math.max(0, loan.total_interest - loan.interest_paid),
                    remainingInitiationFee: Math.max(0, loan.total_initiation_fee - loan.initiation_fee_paid),
                    paymentNumber: loan.payments_made,
                    totalPrincipalReceived: loan.total_principal_received,
                    interestRecalculated: loan.interest_recalculated || false,
                    newMaxInterest: loan.interest_recalculated ? loan.max_interest_allowed : null
                }
            });
            
            // STEP 25: SAVE STATE TO PERSISTENCE
            // Save all changes to localStorage for persistence
            // This also triggers cross-tab synchronization via AppStateManager
            AppStateManager.save(AppState);
            
            // Calculate remaining amounts for display
            const newRemainingInitiationFee = Math.max(0, loan.total_initiation_fee - loan.initiation_fee_paid);
            const newRemainingInterest = Math.max(0, loan.total_interest - loan.interest_paid);
            
            // Show success message
            const completionMsg = loan.status === 'completed' ? '\n\nüéâ LOAN FULLY PAID!' : '';
            const overpaymentMsg = remainingAmount > 0.01 ? `\nüí° Overpayment: ${Calculations.formatCurrency(remainingAmount)} (credited to account)` : '';
            const partialMsg = nextPayment && nextPayment.partial_payment ? '\n‚ö†Ô∏è Partial payment recorded - installment not yet complete' : '';
            const recalcMsg = loan.interest_recalculated ? `\n\nüîÑ INTEREST RECALCULATED!\nYour overpayment in the first half reduced future interest.\nNew Max Interest: ${Calculations.formatCurrency(loan.max_interest_allowed)}` : '';
            
            // Stockvel bonus message
            let bonusMsg = '';
            if (bonusEarned > 0 && loan.memberNumber && AppState.stockvelMembers) {
                const stockvelMember = AppState.stockvelMembers.find(m => m.memberNumber === loan.memberNumber);
                if (stockvelMember) {
                    bonusMsg = `\n\nüéÅ Stockvel Member Bonus:\n` +
                              `üéÅ Bonus Earned: ${Calculations.formatCurrency(bonusEarned)}\n` +
                              `‚Ä¢ Total Accumulated: ${Calculations.formatCurrency(stockvelMember.accumulatedBonus)}`;
                }
            }
            
            // Format payment date for display
            const paymentDateFormatted = new Date(paymentDate).toLocaleDateString('en-ZA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            alert(
                `‚úÖ Payment Processed Successfully!${completionMsg}${partialMsg}${recalcMsg}${bonusMsg}\n\n` +
                `üìÖ Payment Date: ${paymentDateFormatted}\n` +
                `üí∞ Total Paid: ${Calculations.formatCurrency(amount)}\n\n` +
                `üìä Payment Breakdown:\n` +
                `‚Ä¢ Principal: ${Calculations.formatCurrency(principalPaid)}\n` +
                `‚Ä¢ Interest: ${Calculations.formatCurrency(interestPaid)}\n` +
                `‚Ä¢ Admin Fee: ${Calculations.formatCurrency(adminFeePaid)}\n` +
                `‚Ä¢ Initiation Fee: ${Calculations.formatCurrency(initiationFeePaid)}${overpaymentMsg}\n\n` +
                `üìà Progress:\n` +
                `‚Ä¢ Payments Made: ${loan.payments_made}/${loan.term_months}\n` +
                `‚Ä¢ Total Principal Received: ${Calculations.formatCurrency(loan.total_principal_received)}\n\n` +
                `üíµ Remaining Balances:\n` +
                `‚Ä¢ Principal: ${Calculations.formatCurrency(loan.remaining_principal)}\n` +
                `‚Ä¢ Interest: ${Calculations.formatCurrency(newRemainingInterest)}\n` +
                `‚Ä¢ Initiation Fee: ${Calculations.formatCurrency(newRemainingInitiationFee)}`
            );
            
            // Reload loans
            loadLoans();
        }
        
        /**
         * Download loan statement as PDF
         * 
         * Generates a comprehensive PDF statement for a loan including:
         * - Loan summary and current status
         * - Financial breakdown (principal, interest, fees)
         * - Complete payment history
         * - Interest recalculation details (if applicable)
         * - Early payoff information (if applicable)
         * 
         * The PDF is optimized for printing and mobile viewing
         * 
         * @param {number} loanId - The ID of the loan to generate statement for
         */
        function downloadLoanStatementPDF(loanId) {
            // STEP 1: VALIDATION - Find loan
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            try {
                // STEP 2: INITIALIZE PDF DOCUMENT
                // Create new PDF document using jsPDF library
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Page settings
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const contentWidth = pageWidth - (2 * margin);
                let yPos = 20;
                
                // Helper function to check if we need a new page
                function checkPageBreak(neededSpace) {
                    if (yPos + neededSpace > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                        return true;
                    }
                    return false;
                }
                
                // Helper function to add text with word wrap
                function addText(text, x, y, options = {}) {
                    const fontSize = options.fontSize || 10;
                    const maxWidth = options.maxWidth || contentWidth;
                    const align = options.align || 'left';
                    
                    doc.setFontSize(fontSize);
                    if (options.bold) doc.setFont('helvetica', 'bold');
                    else doc.setFont('helvetica', 'normal');
                    
                    const lines = doc.splitTextToSize(text, maxWidth);
                    lines.forEach((line, index) => {
                        checkPageBreak(fontSize * 0.5);
                        doc.text(line, x, y + (index * fontSize * 0.5), { align: align });
                    });
                    
                    return y + (lines.length * fontSize * 0.5);
                }
                
                // ============================================
                // HEADER
                // ============================================
                doc.setFillColor(41, 128, 185);
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text('TBFS LOAN STATEMENT', pageWidth / 2, 18, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(`Loan #${loan.loan_id} - ${loan.client_name}`, pageWidth / 2, 30, { align: 'center' });
                
                doc.setTextColor(0, 0, 0);
                yPos = 50;
                
                // ============================================
                // LOAN SUMMARY
                // ============================================
                checkPageBreak(40);
                doc.setFillColor(236, 240, 241);
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('LOAN SUMMARY', margin + 2, yPos + 5.5);
                yPos += 12;
                
                const principal = loan.original_principal || loan.principal_amount || loan.principal || 0;
                const loanType = loan.loan_type === 'stockvel' ? 'Stockvel Member' : 'Standard';
                const createdDate = new Date(loan.created_at || Date.now()).toLocaleDateString('en-ZA');
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const summaryData = [
                    ['Loan Type:', loanType],
                    ['Original Principal:', Calculations.formatCurrency(principal)],
                    ['Term:', `${loan.term_months} months`],
                    ['Monthly Payment:', Calculations.formatCurrency(loan.monthly_payment || 0)],
                    ['Status:', loan.status.toUpperCase()],
                    ['Created:', createdDate]
                ];
                
                if (loan.completion_date) {
                    summaryData.push(['Completed:', new Date(loan.completion_date).toLocaleDateString('en-ZA')]);
                }
                
                if (loan.early_payoff) {
                    summaryData.push(['Early Payoff:', `YES (Month ${loan.payoff_month})`]);
                    summaryData.push(['Savings:', Calculations.formatCurrency(loan.savings_from_early_payoff || 0)]);
                }
                
                summaryData.forEach(([label, value]) => {
                    checkPageBreak(6);
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, margin + 5, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, margin + 60, yPos);
                    yPos += 6;
                });
                
                yPos += 5;
                
                // ============================================
                // FINANCIAL BREAKDOWN
                // ============================================
                checkPageBreak(50);
                doc.setFillColor(236, 240, 241);
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('FINANCIAL BREAKDOWN', margin + 2, yPos + 5.5);
                yPos += 12;
                
                const totalInterest = loan.total_interest || 0;
                const totalInitiationFee = loan.total_initiation_fee || 0;
                const totalAdminFees = (loan.term_months || 0) * 60;
                const totalCost = principal + totalInterest + totalInitiationFee + totalAdminFees;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const financialData = [
                    ['Original Principal:', Calculations.formatCurrency(principal)],
                    ['Total Interest:', Calculations.formatCurrency(totalInterest)],
                    ['Initiation Fee:', Calculations.formatCurrency(totalInitiationFee)],
                    ['Admin Fees:', Calculations.formatCurrency(totalAdminFees)]
                ];
                
                financialData.forEach(([label, value]) => {
                    checkPageBreak(6);
                    doc.setFont('helvetica', 'normal');
                    doc.text(label, margin + 5, yPos);
                    doc.text(value, margin + 60, yPos);
                    yPos += 6;
                });
                
                // Total line
                checkPageBreak(8);
                doc.setDrawColor(0, 0, 0);
                doc.line(margin + 55, yPos, margin + contentWidth - 5, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL LOAN COST:', margin + 5, yPos);
                doc.text(Calculations.formatCurrency(totalCost), margin + 60, yPos);
                yPos += 10;
                
                if (loan.interest_calculation_months) {
                    checkPageBreak(6);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.text(`Interest Period: ${loan.interest_calculation_months} months`, margin + 5, yPos);
                    yPos += 5;
                    
                    if (loan.interest_recalculated) {
                        doc.setTextColor(231, 76, 60);
                        doc.text('‚ö† Interest Recalculated due to early overpayment', margin + 5, yPos);
                        yPos += 5;
                        doc.setFont('helvetica', 'bold');
                        doc.text(`New Max Interest: ${Calculations.formatCurrency(loan.max_interest_allowed || 0)}`, margin + 5, yPos);
                        doc.setTextColor(0, 0, 0);
                        yPos += 5;
                    }
                }
                
                yPos += 5;
                
                // ============================================
                // CURRENT POSITION
                // ============================================
                checkPageBreak(80);
                doc.setFillColor(236, 240, 241);
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('CURRENT POSITION', margin + 2, yPos + 5.5);
                yPos += 12;
                
                const remainingPrincipal = loan.remaining_principal || 0;
                const interestPaid = loan.interest_paid || 0;
                const interestRemaining = Math.max(0, totalInterest - interestPaid);
                const initiationFeePaid = loan.initiation_fee_paid || 0;
                const initiationFeeRemaining = Math.max(0, totalInitiationFee - initiationFeePaid);
                const paymentsMade = loan.payments_made || 0;
                const paymentsRemaining = (loan.term_months || 0) - paymentsMade;
                const totalPrincipalReceived = loan.total_principal_received || 0;
                const progress = ((paymentsMade / (loan.term_months || 1)) * 100).toFixed(1);
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                const positionData = [
                    ['Payments Made:', `${paymentsMade} of ${loan.term_months}`],
                    ['Payments Remaining:', `${paymentsRemaining}`],
                    ['Progress:', `${progress}%`],
                    ['', ''],
                    ['Principal Paid:', Calculations.formatCurrency(totalPrincipalReceived)],
                    ['Principal Remaining:', Calculations.formatCurrency(remainingPrincipal)],
                    ['', ''],
                    ['Interest Paid:', Calculations.formatCurrency(interestPaid)],
                    ['Interest Remaining:', Calculations.formatCurrency(interestRemaining)],
                    ['', ''],
                    ['Initiation Fee Paid:', Calculations.formatCurrency(initiationFeePaid)],
                    ['Initiation Fee Remaining:', Calculations.formatCurrency(initiationFeeRemaining)],
                    ['', ''],
                    ['Admin Fees Paid:', Calculations.formatCurrency(paymentsMade * 60)],
                    ['Admin Fees Remaining:', Calculations.formatCurrency(paymentsRemaining * 60)]
                ];
                
                positionData.forEach(([label, value]) => {
                    if (label === '') {
                        yPos += 3;
                        return;
                    }
                    checkPageBreak(6);
                    doc.text(label, margin + 5, yPos);
                    doc.text(value, margin + 70, yPos);
                    yPos += 6;
                });
                
                // Totals
                checkPageBreak(10);
                const totalPaid = totalPrincipalReceived + interestPaid + initiationFeePaid + (paymentsMade * 60);
                const totalRemaining = remainingPrincipal + interestRemaining + initiationFeeRemaining + (paymentsRemaining * 60);
                
                doc.line(margin + 65, yPos, margin + contentWidth - 5, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'bold');
                doc.text('TOTAL PAID:', margin + 5, yPos);
                doc.text(Calculations.formatCurrency(totalPaid), margin + 70, yPos);
                yPos += 6;
                doc.text('TOTAL REMAINING:', margin + 5, yPos);
                doc.text(Calculations.formatCurrency(totalRemaining), margin + 70, yPos);
                yPos += 10;
                
                // ============================================
                // ACTIVITY HISTORY
                // ============================================
                checkPageBreak(30);
                doc.setFillColor(236, 240, 241);
                doc.rect(margin, yPos, contentWidth, 8, 'F');
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('ACTIVITY HISTORY', margin + 2, yPos + 5.5);
                yPos += 12;
                
                // Build activities
                const activities = [];
                
                activities.push({
                    date: new Date(loan.created_at || Date.now()),
                    type: 'creation',
                    description: 'Loan created and disbursed',
                    amount: principal
                });
                
                if (loan.payment_history && loan.payment_history.length > 0) {
                    loan.payment_history.forEach((payment, index) => {
                        const paymentNum = index + 1;
                        let description = `Payment #${paymentNum}: `;
                        const parts = [];
                        
                        if (payment.principal > 0) parts.push(`Principal: ${Calculations.formatCurrency(payment.principal)}`);
                        if (payment.interest > 0) parts.push(`Interest: ${Calculations.formatCurrency(payment.interest)}`);
                        if (payment.initiation_fee > 0) parts.push(`Init Fee: ${Calculations.formatCurrency(payment.initiation_fee)}`);
                        if (payment.admin_fee > 0) parts.push(`Admin: ${Calculations.formatCurrency(payment.admin_fee)}`);
                        
                        description += parts.join(', ');
                        
                        activities.push({
                            date: new Date(payment.date),
                            type: 'payment',
                            description: description,
                            subDescription: `Balance after: ${Calculations.formatCurrency(payment.remaining_principal_after)} | Payments: ${payment.payments_made_after}/${loan.term_months}`,
                            amount: payment.amount,
                            recalculated: payment.interest_recalculated,
                            newMaxInterest: payment.new_max_interest
                        });
                    });
                }
                
                if (loan.early_payoff && loan.payoff_date) {
                    activities.push({
                        date: new Date(loan.payoff_date),
                        type: 'early_payoff',
                        description: `Early payoff in month ${loan.payoff_month}`,
                        subDescription: `Saved: ${Calculations.formatCurrency(loan.savings_from_early_payoff || 0)}`,
                        amount: loan.payoff_amount || 0
                    });
                }
                
                if (loan.status === 'completed' && loan.completion_date) {
                    activities.push({
                        date: new Date(loan.completion_date),
                        type: 'completion',
                        description: 'Loan fully paid and completed',
                        amount: 0
                    });
                }
                
                if (loan.status === 'defaulted' && loan.default_date) {
                    activities.push({
                        date: new Date(loan.default_date),
                        type: 'default',
                        description: 'Loan marked as DEFAULTED',
                        amount: 0
                    });
                }
                
                activities.sort((a, b) => a.date - b.date);
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                if (activities.length === 0) {
                    doc.text('No activity recorded yet.', margin + 5, yPos);
                    yPos += 6;
                } else {
                    activities.forEach((activity) => {
                        checkPageBreak(20);
                        
                        const dateStr = activity.date.toLocaleDateString('en-ZA', {
                            year: 'numeric', month: 'short', day: 'numeric'
                        });
                        const timeStr = activity.date.toLocaleTimeString('en-ZA', {
                            hour: '2-digit', minute: '2-digit'
                        });
                        
                        // Date and time
                        doc.setFont('helvetica', 'bold');
                        doc.text(`${dateStr} ${timeStr}`, margin + 5, yPos);
                        yPos += 5;
                        
                        // Description
                        doc.setFont('helvetica', 'normal');
                        const descLines = doc.splitTextToSize(activity.description, contentWidth - 15);
                        descLines.forEach(line => {
                            checkPageBreak(5);
                            doc.text(line, margin + 10, yPos);
                            yPos += 4;
                        });
                        
                        // Sub-description
                        if (activity.subDescription) {
                            doc.setFontSize(8);
                            doc.setTextColor(100, 100, 100);
                            const subLines = doc.splitTextToSize(activity.subDescription, contentWidth - 15);
                            subLines.forEach(line => {
                                checkPageBreak(5);
                                doc.text(line, margin + 10, yPos);
                                yPos += 4;
                            });
                            doc.setFontSize(9);
                            doc.setTextColor(0, 0, 0);
                        }
                        
                        // Amount
                        if (activity.amount > 0) {
                            doc.setFont('helvetica', 'bold');
                            doc.text(`Amount: ${Calculations.formatCurrency(activity.amount)}`, margin + 10, yPos);
                            doc.setFont('helvetica', 'normal');
                            yPos += 4;
                        }
                        
                        // Recalculation note
                        if (activity.recalculated) {
                            doc.setTextColor(231, 76, 60);
                            doc.setFont('helvetica', 'bold');
                            doc.text(`‚ö† Interest recalculated! New max: ${Calculations.formatCurrency(activity.newMaxInterest)}`, margin + 10, yPos);
                            doc.setFont('helvetica', 'normal');
                            doc.setTextColor(0, 0, 0);
                            yPos += 4;
                        }
                        
                        yPos += 3;
                    });
                }
                
                // ============================================
                // FOOTER on each page
                // ============================================
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(128, 128, 128);
                    doc.text(`Generated: ${new Date().toLocaleString('en-ZA')}`, margin, pageHeight - 10);
                    doc.text(`Page ${i} of ${pageCount}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    doc.text('TBFS - Transparent, Fair, Simple', pageWidth / 2, pageHeight - 10, { align: 'center' });
                }
                
                // Download
                const filename = `TBFS_Loan_Statement_${loan.loan_id}_${loan.client_name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Mobile-friendly download
                if (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    const blob = doc.output('blob');
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    doc.save(filename);
                }
                
                alert(`‚úÖ Loan statement downloaded!\n\nFile: ${filename}`);
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert(`‚ùå Error generating PDF:\n\n${error.message}`);
            }
        }
        
        /**
         * View comprehensive loan statement with full activity history
         */
        function viewLoanDetails(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            // Build comprehensive loan statement
            let statement = '';
            
            // ============================================
            // HEADER - Loan Summary
            // ============================================
            statement += `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë        TBFS LOAN STATEMENT                     ‚ïë
‚ïë        Loan #${loan.loan_id} - ${loan.client_name.padEnd(28, ' ')}‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìã LOAN SUMMARY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            const principal = loan.original_principal || loan.principal_amount || loan.principal || 0;
            const loanType = loan.loan_type === 'stockvel' ? 'üåü Stockvel Member' : 'üìÑ Standard';
            const createdDate = new Date(loan.created_at || Date.now()).toLocaleDateString('en-ZA', {
                year: 'numeric', month: 'short', day: 'numeric'
            });
            
            statement += `
Loan Type:              ${loanType}
Original Principal:     ${Calculations.formatCurrency(principal)}
Term:                   ${loan.term_months} months
Monthly Payment:        ${Calculations.formatCurrency(loan.monthly_payment || 0)}
Status:                 ${loan.status.toUpperCase()}
Created:                ${createdDate}
`;
            
            if (loan.completion_date) {
                const completedDate = new Date(loan.completion_date).toLocaleDateString('en-ZA', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
                statement += `Completed:              ${completedDate}\n`;
            }
            
            if (loan.early_payoff) {
                statement += `Early Payoff:           ‚úÖ YES (Month ${loan.payoff_month})\n`;
                statement += `Savings from Early:     ${Calculations.formatCurrency(loan.savings_from_early_payoff || 0)}\n`;
            }
            
            // ============================================
            // FINANCIAL BREAKDOWN
            // ============================================
            statement += `
\nüí∞ FINANCIAL BREAKDOWN
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            const totalInterest = loan.total_interest || 0;
            const totalInitiationFee = loan.total_initiation_fee || 0;
            const totalAdminFees = (loan.term_months || 0) * 60;
            const totalCost = principal + totalInterest + totalInitiationFee + totalAdminFees;
            
            statement += `
Original Principal:     ${Calculations.formatCurrency(principal)}
Total Interest:         ${Calculations.formatCurrency(totalInterest)}
Initiation Fee:         ${Calculations.formatCurrency(totalInitiationFee)}
Admin Fees:             ${Calculations.formatCurrency(totalAdminFees)}
                        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL LOAN COST:        ${Calculations.formatCurrency(totalCost)}
`;
            
            // Interest calculation details
            if (loan.interest_calculation_months) {
                statement += `\nüìä Interest Period:     ${loan.interest_calculation_months} months\n`;
                if (loan.interest_recalculated) {
                    statement += `‚ö†Ô∏è  Interest Recalculated: YES (due to early overpayment)\n`;
                    statement += `   New Max Interest:    ${Calculations.formatCurrency(loan.max_interest_allowed || 0)}\n`;
                }
            }
            
            // ============================================
            // CURRENT POSITION
            // ============================================
            statement += `
\nüìà CURRENT POSITION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            const remainingPrincipal = loan.remaining_principal || 0;
            const interestPaid = loan.interest_paid || 0;
            const interestRemaining = Math.max(0, totalInterest - interestPaid);
            const initiationFeePaid = loan.initiation_fee_paid || 0;
            const initiationFeeRemaining = Math.max(0, totalInitiationFee - initiationFeePaid);
            const paymentsMade = loan.payments_made || 0;
            const paymentsRemaining = (loan.term_months || 0) - paymentsMade;
            const totalPrincipalReceived = loan.total_principal_received || 0;
            
            statement += `
Payments Made:          ${paymentsMade} of ${loan.term_months}
Payments Remaining:     ${paymentsRemaining}
Progress:               ${((paymentsMade / (loan.term_months || 1)) * 100).toFixed(1)}%

Principal Paid:         ${Calculations.formatCurrency(totalPrincipalReceived)}
Principal Remaining:    ${Calculations.formatCurrency(remainingPrincipal)}

Interest Paid:          ${Calculations.formatCurrency(interestPaid)}
Interest Remaining:     ${Calculations.formatCurrency(interestRemaining)}

Initiation Fee Paid:    ${Calculations.formatCurrency(initiationFeePaid)}
Initiation Fee Remaining: ${Calculations.formatCurrency(initiationFeeRemaining)}

Admin Fees Paid:        ${Calculations.formatCurrency((paymentsMade * 60))}
Admin Fees Remaining:   ${Calculations.formatCurrency((paymentsRemaining * 60))}
`;
            
            const totalPaid = totalPrincipalReceived + interestPaid + initiationFeePaid + (paymentsMade * 60);
            const totalRemaining = remainingPrincipal + interestRemaining + initiationFeeRemaining + (paymentsRemaining * 60);
            
            statement += `
                        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL PAID:             ${Calculations.formatCurrency(totalPaid)}
TOTAL REMAINING:        ${Calculations.formatCurrency(totalRemaining)}
`;
            
            // ============================================
            // PAYMENT HISTORY / ACTIVITY LOG
            // ============================================
            statement += `
\nüìú ACTIVITY HISTORY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            // Build activity timeline
            const activities = [];
            
            // 1. Loan Creation
            activities.push({
                date: new Date(loan.created_at || Date.now()),
                type: 'creation',
                description: 'Loan created and disbursed',
                amount: principal,
                icon: 'üÜï'
            });
            
            // 2. Payment History
            if (loan.payment_history && loan.payment_history.length > 0) {
                loan.payment_history.forEach((payment, index) => {
                    const paymentNum = index + 1;
                    let description = `Payment #${paymentNum}: `;
                    description += `Principal: ${Calculations.formatCurrency(payment.principal)}`;
                    
                    if (payment.interest > 0) {
                        description += `, Interest: ${Calculations.formatCurrency(payment.interest)}`;
                    }
                    if (payment.initiation_fee > 0) {
                        description += `, Init Fee: ${Calculations.formatCurrency(payment.initiation_fee)}`;
                    }
                    if (payment.admin_fee > 0) {
                        description += `, Admin: ${Calculations.formatCurrency(payment.admin_fee)}`;
                    }
                    
                    description += `\n   ‚Üí Balance after: ${Calculations.formatCurrency(payment.remaining_principal_after)}`;
                    description += ` | Payments: ${payment.payments_made_after}/${loan.term_months}`;
                    
                    if (payment.interest_recalculated) {
                        description += `\n   üîÑ Interest recalculated! New max: ${Calculations.formatCurrency(payment.new_max_interest)}`;
                    }
                    
                    activities.push({
                        date: new Date(payment.date),
                        type: 'payment',
                        description: description,
                        amount: payment.amount,
                        icon: 'üí∞'
                    });
                });
            }
            
            // 3. Interest Recalculation Events
            if (loan.interest_recalculated && loan.last_recalculation_date) {
                // Check if not already shown in payment
                const recalcAlreadyShown = activities.some(a => 
                    a.type === 'payment' && 
                    a.date.toISOString() === new Date(loan.last_recalculation_date).toISOString()
                );
                
                if (!recalcAlreadyShown) {
                    activities.push({
                        date: new Date(loan.last_recalculation_date),
                        type: 'recalculation',
                        description: `Interest recalculated due to overpayment\n   ‚Üí New max interest: ${Calculations.formatCurrency(loan.max_interest_allowed)}`,
                        amount: 0,
                        icon: 'üîÑ'
                    });
                }
            }
            
            // 4. Early Payoff
            if (loan.early_payoff && loan.payoff_date) {
                activities.push({
                    date: new Date(loan.payoff_date),
                    type: 'early_payoff',
                    description: `Early payoff in month ${loan.payoff_month}\n   ‚Üí Saved: ${Calculations.formatCurrency(loan.savings_from_early_payoff || 0)}`,
                    amount: loan.payoff_amount || 0,
                    icon: 'üéØ'
                });
            }
            
            // 5. Completion
            if (loan.status === 'completed' && loan.completion_date) {
                activities.push({
                    date: new Date(loan.completion_date),
                    type: 'completion',
                    description: 'Loan fully paid and completed',
                    amount: 0,
                    icon: '‚úÖ'
                });
            }
            
            // 6. Default
            if (loan.status === 'defaulted' && loan.default_date) {
                activities.push({
                    date: new Date(loan.default_date),
                    type: 'default',
                    description: 'Loan marked as DEFAULTED',
                    amount: 0,
                    icon: '‚ö†Ô∏è'
                });
            }
            
            // Sort activities by date (oldest first)
            activities.sort((a, b) => a.date - b.date);
            
            // Display activities
            if (activities.length === 0) {
                statement += `\nNo activity recorded yet.\n`;
            } else {
                activities.forEach((activity, index) => {
                    const dateStr = activity.date.toLocaleDateString('en-ZA', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    const timeStr = activity.date.toLocaleTimeString('en-ZA', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    statement += `\n${activity.icon} ${dateStr} ${timeStr}\n`;
                    statement += `   ${activity.description}\n`;
                    
                    if (activity.amount > 0) {
                        statement += `   Amount: ${Calculations.formatCurrency(activity.amount)}\n`;
                    }
                });
            }
            
            // ============================================
            // FOOTER
            // ============================================
            statement += `
\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Generated: ${new Date().toLocaleString('en-ZA')}
TBFS - Transparent, Fair, Simple
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;
            
            // Display in alert with option to download PDF
            const choice = confirm(
                statement + 
                '\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n' +
                'üì• Would you like to download this statement as PDF?\n\n' +
                'Click OK to download PDF, or Cancel to close.'
            );
            
            if (choice) {
                downloadLoanStatementPDF(loanId);
            }
        }
        
        /**
         * Mark loan as defaulted
         */
        /**
         * Main loan adjustment function
         * Provides options to adjust loan terms and amounts
         * 
         * @param {number} loanId - The ID of the loan to adjust
         */
        function adjustLoan(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            if (loan.status !== 'active') {
                alert('‚ö†Ô∏è Only active loans can be adjusted!');
                return;
            }
            
            // Show adjustment options menu
            const option = prompt(
                `üîß Loan Adjustment Options\n\n` +
                `Loan #${loanId} - ${loan.client_name}\n` +
                `Current Balance: ${Calculations.formatCurrency(loan.remaining_principal || 0)}\n` +
                `Current Term: ${loan.term_months} months\n` +
                `Payments Made: ${loan.payments_made || 0}/${loan.term_months}\n\n` +
                `Select adjustment:\n` +
                `1 - Change Repayment Period (Term)\n` +
                `2 - Add Additional Amount to Loan\n\n` +
                `Enter option number (1 or 2):`
            );
            
            if (!option) {
                return; // User cancelled
            }
            
            switch (option.trim()) {
                case '1':
                    changeRepaymentPeriod(loanId);
                    break;
                case '2':
                    addAmountToLoan(loanId);
                    break;
                default:
                    alert('‚ùå Invalid option selected!');
                    return;
            }
        }
        
        /**
         * Change the repayment period (term) for the remaining balance
         * 
         * This function recalculates the loan schedule based on the new term
         * while keeping the remaining principal and interest calculations valid
         * 
         * @param {number} loanId - The ID of the loan to adjust
         */
        function changeRepaymentPeriod(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            const currentTerm = loan.term_months;
            const paymentsMade = loan.payments_made || 0;
            const remainingMonths = currentTerm - paymentsMade;
            const remainingPrincipal = loan.remaining_principal || 0;
            
            // Get new term from user
            const newTermInput = prompt(
                `üìÖ Change Repayment Period\n\n` +
                `Loan #${loanId} - ${loan.client_name}\n\n` +
                `Current Term: ${currentTerm} months\n` +
                `Payments Made: ${paymentsMade} months\n` +
                `Remaining Months: ${remainingMonths} months\n` +
                `Remaining Principal: ${Calculations.formatCurrency(remainingPrincipal)}\n\n` +
                `Enter new total term (months):\n` +
                `üí° Must be greater than ${paymentsMade} (payments already made)`
            );
            
            if (!newTermInput) {
                return; // User cancelled
            }
            
            const newTerm = parseInt(newTermInput);
            
            // VALIDATION: New term must be valid
            if (isNaN(newTerm) || newTerm <= 0) {
                alert('‚ùå Invalid term! Please enter a positive number.');
                return;
            }
            
            if (newTerm <= paymentsMade) {
                alert(`‚ùå Invalid term!\n\nNew term (${newTerm} months) must be greater than payments already made (${paymentsMade} months).`);
                return;
            }
            
            if (newTerm > 60) {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Warning: Very Long Term\n\n` +
                    `You're setting a term of ${newTerm} months (${(newTerm/12).toFixed(1)} years).\n\n` +
                    `This is unusually long. Are you sure?`
                );
                if (!confirm) {
                    return;
                }
            }
            
            // Calculate new monthly payment based on remaining balance
            const remainingMonthsNew = newTerm - paymentsMade;
            
            // Get reason for adjustment
            const reason = prompt(
                `üìù Enter reason for changing repayment period:\n` +
                `(e.g., "Client requested extension", "Financial hardship", etc.)`
            );
            
            if (!reason || reason.trim() === '') {
                alert('‚ùå Reason is required. Adjustment cancelled.');
                return;
            }
            
            // Store old values for comparison
            const oldTerm = loan.term_months;
            const oldMonthlyPayment = loan.monthly_payment || 0;
            
            // STEP 1: UPDATE LOAN TERM
            loan.term_months = newTerm;
            
            // STEP 2: RECALCULATE INTEREST BASED ON ORIGINAL PRINCIPAL + HALF-TERM RULE
            const isStockvel = loan.loan_type === 'stockvel' || loan.isStockvelLoan;
            const originalPrincipal = loan.original_principal || loan.principal_amount || remainingPrincipal;
            const totalContributions = loan.total_contributions || 0;
            const totalInitiationFee = loan.total_initiation_fee || (originalPrincipal * 0.12);
            const initiationFeePaid = loan.initiation_fee_paid || 0;
            const interestAlreadyPaid = loan.interest_paid || 0;

            let fullInterest = 0;
            let adminFee = 60;

            if (isStockvel && totalContributions) {
                fullInterest = calculateStockvelTotalInterest(
                    originalPrincipal,
                    newTerm,
                    totalContributions,
                    loan.monthly_contribution || 0
                );
                adminFee = getStockvelAdminFee(totalContributions);
            } else {
                fullInterest = calculateStandardTotalInterest(originalPrincipal, newTerm);
            }

            const totalInterest = Math.max(fullInterest, interestAlreadyPaid);
            const remainingInterest = Math.max(0, totalInterest - interestAlreadyPaid);
            const remainingInitiationFee = Math.max(0, totalInitiationFee - initiationFeePaid);

            const principalPerMonth = remainingPrincipal / remainingMonthsNew;
            const interestPerMonth = remainingInterest / remainingMonthsNew;
            const initiationFeePerMonth = remainingInitiationFee / remainingMonthsNew;
            const newMonthlyPayment = principalPerMonth + interestPerMonth + adminFee + initiationFeePerMonth;

            // STEP 3: UPDATE INTEREST TRACKING
            loan.total_interest = totalInterest;
            loan.total_initiation_fee = totalInitiationFee;
            loan.interest_calculation_months = Calculations.calculateInterestPeriod(newTerm).interestMonths;
            loan.max_interest_allowed = Math.min(loan.total_interest, originalPrincipal);
            loan.expected_monthly_interest = remainingInterest / remainingMonthsNew;
            
            // STEP 4: UPDATE MONTHLY PAYMENT
            loan.monthly_payment = newMonthlyPayment;
            
            // STEP 5: REGENERATE PAYMENT SCHEDULE (RESPECT PRIOR PAYMENTS)
            console.log(`üîÑ Regenerating schedule for Loan #${loanId} with new term: ${newTerm} months`);
            loan.schedule = buildAdjustedSchedule(loan, {
                remainingPrincipal: remainingPrincipal,
                remainingInterest: remainingInterest,
                remainingInitiationFee: remainingInitiationFee,
                paymentsMade: paymentsMade,
                adminFee: adminFee
            });
            
            // STEP 6: LOG TRANSACTION
            if (!AppState.transactionHistory) AppState.transactionHistory = [];
            AppState.transactionHistory.push({
                type: 'loan_adjustment',
                timestamp: new Date().toISOString(),
                details: {
                    loanId: loanId,
                    clientName: loan.client_name,
                    adjustmentType: 'change_repayment_period',
                    oldTerm: oldTerm,
                    newTerm: newTerm,
                    oldMonthlyPayment: oldMonthlyPayment,
                    newMonthlyPayment: newMonthlyPayment,
                    remainingPrincipal: remainingPrincipal,
                    newTotalInterest: loan.total_interest,
                    reason: reason
                }
            });
            
            // STEP 7: SAVE STATE
            AppStateManager.save(AppState);
            
            // STEP 8: RELOAD LOANS TO REFLECT CHANGES
            loadLoans();
            
            // Show success message
            alert(
                `‚úÖ Repayment Period Changed Successfully!\n\n` +
                `Loan #${loanId} - ${loan.client_name}\n\n` +
                `Term: ${oldTerm} ‚Üí ${newTerm} months\n` +
                `Monthly Payment: ${Calculations.formatCurrency(oldMonthlyPayment)} ‚Üí ${Calculations.formatCurrency(newMonthlyPayment)}\n` +
                `Remaining Months: ${remainingMonthsNew} months\n` +
                `New Total Interest: ${Calculations.formatCurrency(loan.total_interest)}\n\n` +
                `Reason: ${reason}\n\n` +
                `üí° Payment schedule has been regenerated.`
            );
        }
        
        /**
         * Add additional amount to an existing loan
         * 
         * This function adds money to the loan principal with proper validation:
         * - Checks available capital
         * - Validates interest recalculation
         * - Updates all related fields
         * - Regenerates payment schedule
         * 
         * @param {number} loanId - The ID of the loan to add amount to
         */
        function addAmountToLoan(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            const currentPrincipal = loan.principal_amount || loan.principal || 0;
            const remainingPrincipal = loan.remaining_principal || 0;
            const currentTerm = loan.term_months;
            const paymentsMade = loan.payments_made || 0;
            const remainingMonths = currentTerm - paymentsMade;
            
            // Get amount to add
            const amountInput = prompt(
                `üí∞ Add Amount to Loan\n\n` +
                `Loan #${loanId} - ${loan.client_name}\n\n` +
                `Current Principal: ${Calculations.formatCurrency(currentPrincipal)}\n` +
                `Remaining Principal: ${Calculations.formatCurrency(remainingPrincipal)}\n` +
                `Term: ${currentTerm} months\n` +
                `Payments Made: ${paymentsMade}\n\n` +
                `Enter amount to add:\n` +
                `(This will increase the loan principal)`
            );
            
            if (!amountInput) {
                return; // User cancelled
            }
            
            const amount = parseFloat(amountInput);
            
            // VALIDATION 1: Amount must be valid
            if (isNaN(amount) || amount <= 0) {
                alert('‚ùå Invalid amount! Please enter a positive number.');
                return;
            }
            
            // VALIDATION 2: Check available capital
            const availableCapital = AppState.capital || 0;
            if (availableCapital < amount) {
                alert(
                    `‚ùå Insufficient Capital!\n\n` +
                    `Available Capital: ${Calculations.formatCurrency(availableCapital)}\n` +
                    `Requested Amount: ${Calculations.formatCurrency(amount)}\n` +
                    `Shortfall: ${Calculations.formatCurrency(amount - availableCapital)}\n\n` +
                    `Please ensure sufficient capital before adding to loan.`
                );
                return;
            }
            
            // VALIDATION 3: Check if new total would be reasonable
            const newTotalPrincipal = currentPrincipal + amount;
            if (newTotalPrincipal > 1000000) {
                const confirm = window.confirm(
                    `‚ö†Ô∏è Very Large Loan Amount\n\n` +
                    `New total principal would be: ${Calculations.formatCurrency(newTotalPrincipal)}\n\n` +
                    `This is a very large loan. Are you sure?`
                );
                if (!confirm) {
                    return;
                }
            }
            
            // Get reason for addition
            const reason = prompt(
                `üìù Enter reason for adding amount to loan:\n` +
                `(e.g., "Top-up requested", "Additional capital needed", etc.)`
            );
            
            if (!reason || reason.trim() === '') {
                alert('‚ùå Reason is required. Adjustment cancelled.');
                return;
            }
            
            // STEP 1: CALCULATE NEW VALUES
            const newPrincipal = currentPrincipal + amount;
            const newRemainingPrincipal = remainingPrincipal + amount;
            
            // STEP 2: RECALCULATE INTEREST BASED ON ORIGINAL PRINCIPAL + HALF-TERM RULE
            // This keeps interest consistent with business rules and respects interest already paid
            const isStockvel = loan.loan_type === 'stockvel' || loan.isStockvelLoan;
            const totalContributions = loan.total_contributions || 0;
            const interestAlreadyPaid = loan.interest_paid || 0;
            let recalculatedInterest = 0;
            let newMonthlyPayment = 0;
            let additionalInitiationFee = 0;
            let newTotalInitiationFee = 0;
            let adminFee = 60;

            if (isStockvel && totalContributions) {
                // STOCKVEL: Tiered interest on the new principal for the full term
                newTotalInitiationFee = newPrincipal <= totalContributions ? 0 : (newPrincipal - totalContributions) * 0.12;
                adminFee = getStockvelAdminFee(totalContributions);

                const fullInterest = calculateStockvelTotalInterest(
                    newPrincipal,
                    currentTerm,
                    totalContributions,
                    loan.monthly_contribution || 0
                );
                recalculatedInterest = Math.max(fullInterest, interestAlreadyPaid);
            } else {
                // STANDARD: 30% Income Table method on the new principal for full term
                newTotalInitiationFee = newPrincipal * 0.12;
                const fullInterest = calculateStandardTotalInterest(newPrincipal, currentTerm);
                recalculatedInterest = Math.max(fullInterest, interestAlreadyPaid);
            }

            additionalInitiationFee = newTotalInitiationFee - (loan.total_initiation_fee || 0);
            const remainingInterest = Math.max(0, recalculatedInterest - interestAlreadyPaid);
            const remainingInitiationFee = Math.max(0, newTotalInitiationFee - (loan.initiation_fee_paid || 0));
            const principalPerMonth = newRemainingPrincipal / remainingMonths;
            const interestPerMonth = remainingInterest / remainingMonths;
            const initiationFeePerMonth = remainingInitiationFee / remainingMonths;

            newMonthlyPayment = principalPerMonth + interestPerMonth + adminFee + initiationFeePerMonth;
            
            // STEP 3: VALIDATE RECALCULATION
            // Check if the recalculation is valid
            const oldTotalInterest = loan.total_interest || 0;
            const interestIncrease = recalculatedInterest - oldTotalInterest;
            const interestIncreasePercent = oldTotalInterest > 0 ? (interestIncrease / oldTotalInterest) * 100 : 0;
            
            // Show validation summary
            const validationSummary = 
                `üìä Recalculation Validation\n\n` +
                `Amount to Add: ${Calculations.formatCurrency(amount)}\n\n` +
                `INTEREST CALCULATION:\n` +
                `Old Total Interest: ${Calculations.formatCurrency(oldTotalInterest)}\n` +
                `New Total Interest: ${Calculations.formatCurrency(recalculatedInterest)}\n` +
                `Interest Increase: ${Calculations.formatCurrency(interestIncrease)} (${interestIncreasePercent.toFixed(1)}%)\n\n` +
                `MONTHLY PAYMENT:\n` +
                `Old Monthly Payment: ${Calculations.formatCurrency(loan.monthly_payment || 0)}\n` +
                `New Monthly Payment: ${Calculations.formatCurrency(newMonthlyPayment)}\n\n` +
                `ADDITIONAL FEES:\n` +
                `Additional Initiation Fee: ${Calculations.formatCurrency(additionalInitiationFee)}\n\n` +
                `PRINCIPAL:\n` +
                `Old Principal: ${Calculations.formatCurrency(currentPrincipal)}\n` +
                `New Principal: ${Calculations.formatCurrency(newPrincipal)}\n` +
                `New Remaining: ${Calculations.formatCurrency(newRemainingPrincipal)}\n\n` +
                `CAPITAL IMPACT:\n` +
                `Current Capital: ${Calculations.formatCurrency(availableCapital)}\n` +
                `After Addition: ${Calculations.formatCurrency(availableCapital - amount)}\n` +
                `Deployed: ${Calculations.formatCurrency((AppState.deployed || 0) + amount)}\n\n` +
                `Reason: ${reason}\n\n` +
                `‚úÖ Recalculation validated. Proceed?`;
            
            const confirm = window.confirm(validationSummary);
            
            if (!confirm) {
                alert('‚è∏Ô∏è Adjustment cancelled.');
                return;
            }
            
            // STEP 4: UPDATE LOAN FIELDS
            loan.principal_amount = newPrincipal;
            loan.original_principal = newPrincipal; // Update original too
            loan.remaining_principal = newRemainingPrincipal;
            loan.total_interest = recalculatedInterest;
            loan.total_initiation_fee = newTotalInitiationFee;
            loan.monthly_payment = newMonthlyPayment;
            
            // Update interest cap
            const interestPeriod = Calculations.calculateInterestPeriod(currentTerm).interestMonths;
            loan.interest_calculation_months = interestPeriod;
            loan.max_interest_allowed = Math.min(recalculatedInterest, newPrincipal);
            loan.expected_monthly_interest = remainingInterest / remainingMonths;
            
            // STEP 5: UPDATE APPSTATE
            AppState.capital = availableCapital - amount;
            AppState.deployed = (AppState.deployed || 0) + amount;
            
            // STEP 6: REGENERATE PAYMENT SCHEDULE
            // Critical: Schedule must reflect new principal and terms
            console.log(`üîÑ Regenerating schedule for Loan #${loanId} with added amount: ${Calculations.formatCurrency(amount)}`);
            loan.schedule = buildAdjustedSchedule(loan, {
                remainingPrincipal: newRemainingPrincipal,
                remainingInterest: remainingInterest,
                remainingInitiationFee: remainingInitiationFee,
                paymentsMade: paymentsMade,
                adminFee: adminFee
            });
            
            // STEP 7: LOG TRANSACTION
            if (!AppState.transactionHistory) AppState.transactionHistory = [];
            AppState.transactionHistory.push({
                type: 'loan_adjustment',
                timestamp: new Date().toISOString(),
                details: {
                    loanId: loanId,
                    clientName: loan.client_name,
                    adjustmentType: 'add_amount',
                    amount: amount,
                    oldPrincipal: currentPrincipal,
                    newPrincipal: newPrincipal,
                    oldRemainingPrincipal: remainingPrincipal,
                    newRemainingPrincipal: newRemainingPrincipal,
                    oldTotalInterest: oldTotalInterest,
                    newTotalInterest: recalculatedInterest,
                    interestIncrease: interestIncrease,
                    additionalInitiationFee: additionalInitiationFee,
                    oldMonthlyPayment: loan.monthly_payment,
                    newMonthlyPayment: newMonthlyPayment,
                    reason: reason
                }
            });
            
            // STEP 8: SAVE STATE
            AppStateManager.save(AppState);
            
            // STEP 9: RELOAD LOANS TO REFLECT CHANGES
            loadLoans();
            
            // Show success message
            alert(
                `‚úÖ Amount Added to Loan Successfully!\n\n` +
                `Loan #${loanId} - ${loan.client_name}\n\n` +
                `Amount Added: ${Calculations.formatCurrency(amount)}\n` +
                `Principal: ${Calculations.formatCurrency(currentPrincipal)} ‚Üí ${Calculations.formatCurrency(newPrincipal)}\n` +
                `Remaining: ${Calculations.formatCurrency(remainingPrincipal)} ‚Üí ${Calculations.formatCurrency(newRemainingPrincipal)}\n` +
                `Total Interest: ${Calculations.formatCurrency(oldTotalInterest)} ‚Üí ${Calculations.formatCurrency(recalculatedInterest)}\n` +
                `Monthly Payment: ${Calculations.formatCurrency(loan.monthly_payment)} ‚Üí ${Calculations.formatCurrency(newMonthlyPayment)}\n` +
                `Additional Initiation Fee: ${Calculations.formatCurrency(additionalInitiationFee)}\n\n` +
                `Reason: ${reason}\n\n` +
                `üí° Payment schedule has been regenerated.`
            );
        }
        
        function markAsDefaulted(loanId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to mark this loan as DEFAULTED?\n\nThis action can be reversed later if needed.')) {
                return;
            }
            
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            loan.status = 'defaulted';
            loan.default_date = new Date().toISOString();
            
            // Log transaction
            if (!AppState.transactions) AppState.transactions = [];
            AppState.transactions.push({
                id: Date.now(),
                type: 'status_change',
                date: new Date().toISOString(),
                description: `Loan #${loanId} marked as DEFAULTED`,
                data: { loanId: loanId, newStatus: 'defaulted' }
            });
            
            // Save state
            AppStateManager.save(AppState);
            
            alert('‚úÖ Loan marked as defaulted.');
            loadLoans();
        }
        
        /**
         * Export active loans to Excel
         */
        function exportToExcel() {
            try {
                // Get current filtered loans
                const loansToExport = allLoans.length > 0 ? allLoans : AppState.loans || [];
                
                if (loansToExport.length === 0) {
                    alert('‚ö†Ô∏è No loans to export');
                    return;
                }
                
                // Prepare data for Excel
                const excelData = [
                    // Header row
                    ['TBFS Active Loans Report'],
                    ['Generated: ' + new Date().toLocaleString()],
                    [],
                    ['Loan ID', 'Client Name', 'Account', 'Type', 'Principal', 'Monthly Payment', 'Payments Made', 'Total Payments', 'Outstanding Balance', 'Status', 'Disbursement Date', 'Next Due Date']
                ];
                
                // Add loan data
                loansToExport.forEach(loan => {
                    const nextPayment = (loan.schedule || []).find(p => p.status === 'pending');
                    const nextDueDate = nextPayment ? new Date(nextPayment.due_date).toLocaleDateString() : 'N/A';
                    
                    excelData.push([
                        loan.loan_id,
                        loan.client_name,
                        loan.account_number,
                        loan.loan_type === 'stockvel' ? 'Stockvel' : 'Standard',
                        loan.principal_amount,
                        loan.monthly_payment,
                        loan.payments_made || 0,
                        loan.term_months,
                        loan.remaining_principal || loan.principal_amount,
                        loan.status.charAt(0).toUpperCase() + loan.status.slice(1),
                        new Date(loan.disbursement_date || loan.created_at).toLocaleDateString(),
                        nextDueDate
                    ]);
                });
                
                // Add summary
                const totalPrincipal = loansToExport.reduce((sum, l) => sum + l.principal_amount, 0);
                const totalOutstanding = loansToExport.reduce((sum, l) => sum + (l.remaining_principal || l.principal_amount), 0);
                
                excelData.push([]);
                excelData.push(['SUMMARY']);
                excelData.push(['Total Loans', loansToExport.length]);
                excelData.push(['Total Principal Disbursed', totalPrincipal]);
                excelData.push(['Total Outstanding', totalOutstanding]);
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 10 },  // Loan ID
                    { wch: 25 },  // Client Name
                    { wch: 15 },  // Account
                    { wch: 10 },  // Type
                    { wch: 12 },  // Principal
                    { wch: 15 },  // Monthly Payment
                    { wch: 15 },  // Payments Made
                    { wch: 15 },  // Total Payments
                    { wch: 18 },  // Outstanding
                    { wch: 12 },  // Status
                    { wch: 15 },  // Disbursement
                    { wch: 15 }   // Next Due
                ];
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Active Loans');
                
                // Download file
                const fileName = `TBFS_Active_Loans_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('‚úÖ Excel file downloaded successfully!\n\nFile: ' + fileName);
            } catch (error) {
                console.error('Excel export error:', error);
                alert('‚ùå Error exporting to Excel: ' + error.message);
            }
        }
        
        /**
         * Export active loans to PDF
         */
        function exportToPDF() {
            try {
                // Get current filtered loans
                const loansToExport = allLoans.length > 0 ? allLoans : AppState.loans || [];
                
                if (loansToExport.length === 0) {
                    alert('‚ö†Ô∏è No loans to export');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                
                // Title
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('TBFS Active Loans Report', 105, yPos, { align: 'center' });
                yPos += 10;
                
                // Date
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Generated: ' + new Date().toLocaleString(), 105, yPos, { align: 'center' });
                yPos += 15;
                
                // Summary Stats
                const totalPrincipal = loansToExport.reduce((sum, l) => sum + l.principal_amount, 0);
                const totalOutstanding = loansToExport.reduce((sum, l) => sum + (l.remaining_principal || l.principal_amount), 0);
                const activeCount = loansToExport.filter(l => l.status === 'active').length;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Portfolio Summary:', 20, yPos);
                yPos += 7;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Total Loans: ${loansToExport.length}`, 20, yPos);
                doc.text(`Active Loans: ${activeCount}`, 80, yPos);
                yPos += 5;
                doc.text(`Total Principal: R ${totalPrincipal.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, yPos);
                doc.text(`Total Outstanding: R ${totalOutstanding.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 80, yPos);
                yPos += 15;
                
                // Loan Details
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Loan Details:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(9);
                
                loansToExport.forEach((loan, index) => {
                    // Check if we need a new page
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Loan header
                    doc.setFont(undefined, 'bold');
                    doc.text(`Loan #${loan.loan_id} - ${loan.client_name}`, 20, yPos);
                    yPos += 5;
                    
                    // Loan details
                    doc.setFont(undefined, 'normal');
                    const nextPayment = (loan.schedule || []).find(p => p.status === 'pending');
                    const nextDueDate = nextPayment ? new Date(nextPayment.due_date).toLocaleDateString() : 'N/A';
                    
                    doc.text(`Account: ${loan.account_number}`, 25, yPos);
                    doc.text(`Type: ${loan.loan_type === 'stockvel' ? 'Stockvel' : 'Standard'}`, 80, yPos);
                    doc.text(`Status: ${loan.status.charAt(0).toUpperCase() + loan.status.slice(1)}`, 130, yPos);
                    yPos += 5;
                    
                    doc.text(`Principal: R ${loan.principal_amount.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`, 25, yPos);
                    doc.text(`Monthly: R ${loan.monthly_payment.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`, 80, yPos);
                    yPos += 5;
                    
                    doc.text(`Progress: ${loan.payments_made || 0}/${loan.term_months} payments`, 25, yPos);
                    doc.text(`Outstanding: R ${(loan.remaining_principal || loan.principal_amount).toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`, 80, yPos);
                    yPos += 5;
                    
                    doc.text(`Disbursed: ${new Date(loan.disbursement_date || loan.created_at).toLocaleDateString()}`, 25, yPos);
                    doc.text(`Next Due: ${nextDueDate}`, 80, yPos);
                    yPos += 8;
                    
                    // Separator line
                    if (index < loansToExport.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(20, yPos, 190, yPos);
                        yPos += 5;
                    }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text('Thaba Bosiu Financial Services', 105, 285, { align: 'center' });
                }
                
                // Save PDF
                const fileName = `TBFS_Active_Loans_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                alert('‚úÖ PDF downloaded successfully!\n\nFile: ' + fileName);
            } catch (error) {
                console.error('PDF export error:', error);
                alert('‚ùå Error exporting to PDF: ' + error.message);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
