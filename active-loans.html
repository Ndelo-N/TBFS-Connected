<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Active Loans - TBFS</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Page-Specific Styles -->
    <style>
        .loan-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .loan-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-completed {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-defaulted {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-blacklisted {
            background: #212529;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-section select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .stats-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats-summary h3 {
            margin-bottom: 15px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .loan-card {
                padding: 15px;
            }
            
            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div id="navigation-header"></div>
    
    <!-- Main Container -->
    <div class="container fade-in">
        <div class="page-content">
            <h1 class="mb-lg">üí∞ Active Loans Management</h1>
            
            <!-- Stats Summary -->
            <div class="stats-summary">
                <h3>üìä Portfolio Overview</h3>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">Active Loans</div>
                        <div class="stat-value" id="activeLoansCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Outstanding</div>
                        <div class="stat-value" id="totalOutstanding">R0.00</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Overdue Loans</div>
                        <div class="stat-value" id="overdueCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">This Month Revenue</div>
                        <div class="stat-value" id="monthRevenue">R0.00</div>
                    </div>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <label><strong>Filter by Status:</strong></label>
                <select id="statusFilter" onchange="filterLoans()">
                    <option value="all">All Loans</option>
                    <option value="active" selected>Active Only</option>
                    <option value="completed">Completed</option>
                    <option value="defaulted">Defaulted</option>
                    <option value="blacklisted">Blacklisted</option>
                    <option value="overdue">Overdue</option>
                </select>
                
                <label><strong>Sort by:</strong></label>
                <select id="sortBy" onchange="filterLoans()">
                    <option value="date">Date (Newest First)</option>
                    <option value="amount">Loan Amount</option>
                    <option value="balance">Outstanding Balance</option>
                    <option value="due">Due Date</option>
                </select>
                
                <button class="btn btn-success" onclick="location.href='calculator.html'" style="margin-left: auto;">
                    ‚ûï New Loan
                </button>
            </div>
            
            <!-- Export Buttons -->
            <div class="filter-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export to Excel</button>
                <button class="btn btn-danger" onclick="exportToPDF()" style="margin-left: 10px;">üìÑ Export to PDF</button>
            </div>
            
            <!-- Loans List -->
            <div id="loansList"></div>
        </div>
    </div>
    
    <!-- Shared Modules -->
    <script src="shared/app-state.js"></script>
    <script src="shared/calculations.js"></script>
    <script src="shared/navigation.js"></script>
    
    <!-- Page Logic -->
    <script>
        // Global state
        let AppState = {};
        let allLoans = [];
        let currentFilter = 'active';
        let currentSort = 'date';
        
        /**
         * Initialize page
         */
        function init() {
            // Load app state
            AppState = AppStateManager.load();
            
            // Initialize navigation
            Navigation.init('loans');
            
            // Load loans
            loadLoans();
            
            // Listen for state updates from other tabs
            AppStateManager.onUpdate(() => {
                console.log('State updated from another tab, reloading...');
                AppState = AppStateManager.load();
                loadLoans();
            });
            
            console.log('‚úÖ Active Loans page initialized');
        }
        
        /**
         * Load and display all loans
         */
        function loadLoans() {
            allLoans = AppState.loans || [];
            updateStats();
            filterLoans();
        }
        
        /**
         * Update statistics
         */
        function updateStats() {
            const activeLoans = allLoans.filter(l => l.status === 'active');
            const totalOutstanding = activeLoans.reduce((sum, l) => sum + (l.remaining_principal || 0), 0);
            
            // Calculate overdue loans
            const today = new Date();
            const overdueLoans = activeLoans.filter(l => {
                if (!l.created_at || !l.start_month_index) return false;
                const loanDate = new Date(l.created_at);
                const paymentsMade = l.payments_made || 0;
                const targetMonthOffset = l.start_month_index + paymentsMade;
                const targetYear = loanDate.getFullYear() + Math.floor(targetMonthOffset / 12);
                const targetMonth = targetMonthOffset % 12;
                const dueDate = new Date(targetYear, targetMonth + 1, 0);
                return dueDate < today;
            });
            
            // Calculate this month's revenue (from transactions)
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const transactions = AppState.transactions || [];
            const monthRevenue = transactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === thisMonth && 
                           tDate.getFullYear() === thisYear &&
                           t.type === 'payment';
                })
                .reduce((sum, t) => sum + (t.data?.interestPaid || 0) + (t.data?.adminFeePaid || 0) + (t.data?.initiationFeePaid || 0), 0);
            
            // Update display
            document.getElementById('activeLoansCount').textContent = activeLoans.length;
            document.getElementById('totalOutstanding').textContent = Calculations.formatCurrency(totalOutstanding);
            document.getElementById('overdueCount').textContent = overdueLoans.length;
            document.getElementById('monthRevenue').textContent = Calculations.formatCurrency(monthRevenue);
        }
        
        /**
         * Filter and sort loans
         */
        function filterLoans() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filteredLoans = [...allLoans];
            
            // Apply status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'overdue') {
                    const today = new Date();
                    filteredLoans = filteredLoans.filter(l => {
                        if (l.status !== 'active') return false;
                        if (!l.created_at || !l.start_month_index) return false;
                        const loanDate = new Date(l.created_at);
                        const paymentsMade = l.payments_made || 0;
                        const targetMonthOffset = l.start_month_index + paymentsMade;
                        const targetYear = loanDate.getFullYear() + Math.floor(targetMonthOffset / 12);
                        const targetMonth = targetMonthOffset % 12;
                        const dueDate = new Date(targetYear, targetMonth + 1, 0);
                        return dueDate < today;
                    });
                } else {
                    filteredLoans = filteredLoans.filter(l => l.status === statusFilter);
                }
            }
            
            // Apply sorting
            filteredLoans.sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'amount':
                        return (b.principal || 0) - (a.principal || 0);
                    case 'balance':
                        return (b.remaining_principal || 0) - (a.remaining_principal || 0);
                    case 'due':
                        // Calculate due dates and compare
                        const getDueDate = (loan) => {
                            if (!loan.created_at || !loan.start_month_index) return new Date();
                            const loanDate = new Date(loan.created_at);
                            const paymentsMade = loan.payments_made || 0;
                            const targetMonthOffset = loan.start_month_index + paymentsMade;
                            const targetYear = loanDate.getFullYear() + Math.floor(targetMonthOffset / 12);
                            const targetMonth = targetMonthOffset % 12;
                            return new Date(targetYear, targetMonth + 1, 0);
                        };
                        return getDueDate(a) - getDueDate(b);
                    default:
                        return 0;
                }
            });
            
            displayLoans(filteredLoans);
        }
        
        /**
         * Display loans
         */
        function displayLoans(loans) {
            const container = document.getElementById('loansList');
            
            if (loans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No loans found</h3>
                        <p>No loans match your current filter.</p>
                        <button class="btn btn-primary mt-lg" onclick="location.href='calculator.html'">
                            ‚ûï Create New Loan
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = loans.map(loan => {
                // Calculate dates and status
                const loanDate = new Date(loan.created_at);
                const loanDateStr = loanDate.toLocaleDateString('en-ZA', { 
                    day: '2-digit', month: 'short', year: 'numeric' 
                });
                
                // Calculate payments made
                const paymentsMade = loan.payments_made || 0;
                
                // Calculate next due date
                let nextDueStr = 'N/A';
                let isOverdue = false;
                let daysOverdue = 0;
                
                if (loan.status === 'active' && loan.start_month_index !== undefined) {
                    const startYear = loanDate.getFullYear();
                    const targetMonthOffset = loan.start_month_index + paymentsMade;
                    const targetYear = startYear + Math.floor(targetMonthOffset / 12);
                    const targetMonth = targetMonthOffset % 12;
                    const dueDate = new Date(targetYear, targetMonth + 1, 0);
                    
                    nextDueStr = dueDate.toLocaleDateString('en-ZA', {
                        day: '2-digit', month: 'short', year: 'numeric'
                    });
                    
                    const today = new Date();
                    isOverdue = dueDate < today;
                    if (isOverdue) {
                        daysOverdue = Math.floor((today - dueDate) / (1000 * 60 * 60 * 24));
                    }
                }
                
                const principal = loan.principal || loan.principal_amount || 0;
                const remainingPrincipal = loan.remaining_principal || principal;
                const monthlyPayment = loan.monthly_payment || 0;
                const currentBalance = loan.current_balance || 0;
                
                return `
                    <div class="loan-card">
                        <h4>Loan #${loan.loan_id} - ${loan.client_name}</h4>
                        
                        <div class="info-row">
                            <span>üìÖ Loan Date:</span>
                            <strong style="color: #7f8c8d;">${loanDateStr}</strong>
                        </div>
                        
                        ${loan.status === 'active' ? `
                        <div class="info-row">
                            <span>üìÜ Next Payment Due:</span>
                            <strong style="color: ${isOverdue ? '#e74c3c' : '#27ae60'};">
                                ${nextDueStr}${isOverdue ? ` (${daysOverdue} days overdue!)` : ''}
                            </strong>
                        </div>
                        ` : ''}
                        
                        <div class="info-row">
                            <span>üí∞ Principal:</span>
                            <strong>${Calculations.formatCurrency(principal)}</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üí≥ Monthly Payment:</span>
                            <strong>${Calculations.formatCurrency(monthlyPayment)}</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üìä Progress:</span>
                            <strong>${paymentsMade}/${loan.term_months} payments made</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üíµ Remaining Principal:</span>
                            <strong style="color: #e74c3c;">${Calculations.formatCurrency(remainingPrincipal)}</strong>
                        </div>
                        
                        <div class="info-row">
                            <span>üìã Status:</span>
                            <span class="status-badge status-${loan.status}">${loan.status}</span>
                        </div>
                        
                        <div class="info-row">
                            <span>‚ö° Actions:</span>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                ${loan.status === 'active' ? `
                                    <button class="btn btn-success" style="padding: 8px 12px; font-size: 13px;" 
                                            onclick="makePayment(${loan.loan_id})">
                                        üí∞ Make Payment
                                    </button>
                                    <button class="btn btn-warning" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="viewLoanDetails(${loan.loan_id})">
                                        üëÅÔ∏è View Details
                                    </button>
                                    <button class="btn btn-danger" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="markAsDefaulted(${loan.loan_id})">
                                        ‚ö†Ô∏è Mark Default
                                    </button>
                                ` : `
                                    <button class="btn btn-secondary" style="padding: 8px 12px; font-size: 13px;"
                                            onclick="viewLoanDetails(${loan.loan_id})">
                                        üëÅÔ∏è View Details
                                    </button>
                                    ${loan.status === 'completed' ? `
                                        <button class="btn" style="padding: 8px 12px; font-size: 13px; background: #27ae60;"
                                                onclick="alert('‚úÖ This loan has been fully paid!')">
                                            ‚úÖ Completed
                                        </button>
                                    ` : ''}
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        /**
         * Make payment on a loan
         */
        function makePayment(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            if (loan.status !== 'active') {
                alert('‚ö†Ô∏è Can only make payments on active loans!');
                return;
            }
            
            // Initialize tracking fields if not set
            if (!loan.remaining_principal) {
                loan.remaining_principal = loan.principal_amount || loan.principal || 0;
            }
            if (!loan.initiation_fee_paid) {
                loan.initiation_fee_paid = 0;
            }
            if (!loan.interest_paid) {
                loan.interest_paid = 0;
            }
            
            // Calculate total initiation fee if not set
            if (!loan.total_initiation_fee) {
                const principal = loan.principal_amount || loan.principal || 0;
                if (loan.loan_type === 'stockvel' && loan.total_contributions) {
                    // Stockvel: 0% if principal <= contributions, 12% on excess
                    loan.total_initiation_fee = principal <= loan.total_contributions ? 0 : (principal - loan.total_contributions) * 0.12;
                } else {
                    // Standard: 12% of principal
                    loan.total_initiation_fee = principal * 0.12;
                }
            }
            
            // Calculate total interest if not set
            if (!loan.total_interest) {
                if (loan.schedule && loan.schedule.length > 0) {
                    // Sum interest from schedule
                    loan.total_interest = loan.schedule.reduce((sum, payment) => {
                        return sum + (payment.interest_payment || 0);
                    }, 0);
                } else {
                    // Estimate from monthly payment
                    const principal = loan.principal_amount || loan.principal || 0;
                    const monthlyPayment = loan.monthly_payment || 0;
                    const totalPayments = monthlyPayment * loan.term_months;
                    const totalFees = loan.total_initiation_fee + (60 * loan.term_months); // Admin fees
                    loan.total_interest = Math.max(0, totalPayments - principal - totalFees);
                }
            }
            
            // Calculate remaining amounts
            const remainingInitiationFee = Math.max(0, loan.total_initiation_fee - loan.initiation_fee_paid);
            const remainingInterest = Math.max(0, loan.total_interest - loan.interest_paid);
            
            // Get payment amount
            const expectedPayment = loan.monthly_payment || 0;
            const remainingPrincipal = loan.remaining_principal;
            const paymentsRemaining = loan.term_months - (loan.payments_made || 0);
            
            const paymentAmount = prompt(
                `üí∞ Enter payment amount for Loan #${loanId}\n\n` +
                `Expected Monthly Payment: ${Calculations.formatCurrency(expectedPayment)}\n` +
                `Remaining Principal: ${Calculations.formatCurrency(remainingPrincipal)}\n` +
                `Remaining Interest: ${Calculations.formatCurrency(remainingInterest)}\n` +
                `Remaining Initiation Fee: ${Calculations.formatCurrency(remainingInitiationFee)}\n` +
                `Payments Made: ${loan.payments_made || 0}/${loan.term_months}\n\n` +
                `üí° You can make partial or overpayments`
            );
            
            if (!paymentAmount || isNaN(paymentAmount) || parseFloat(paymentAmount) <= 0) {
                alert('‚ùå Invalid payment amount!');
                return;
            }
            
            const amount = parseFloat(paymentAmount);
            
            // Allocate payment properly
            let remainingAmount = amount;
            let principalPaid = 0;
            let interestPaid = 0;
            let adminFeePaid = 0;
            let initiationFeePaid = 0;
            
            // Get next pending payment from schedule
            const nextPayment = (loan.schedule || []).find(p => p.status === 'pending');
            
            if (nextPayment) {
                // Pay in order: Initiation Fee ‚Üí Admin Fee ‚Üí Interest ‚Üí Principal
                
                // 1. Pay initiation fee (monthly portion)
                const initiationDue = nextPayment.initiation_fee || 0;
                if (remainingAmount > 0 && initiationDue > 0) {
                    initiationFeePaid = Math.min(remainingAmount, initiationDue);
                    remainingAmount -= initiationFeePaid;
                }
                
                // 2. Pay admin fee
                const adminDue = nextPayment.admin_fee || 0;
                if (remainingAmount > 0 && adminDue > 0) {
                    adminFeePaid = Math.min(remainingAmount, adminDue);
                    remainingAmount -= adminFeePaid;
                }
                
                // 3. Pay interest
                const interestDue = nextPayment.interest_payment || 0;
                if (remainingAmount > 0 && interestDue > 0) {
                    interestPaid = Math.min(remainingAmount, interestDue);
                    remainingAmount -= interestPaid;
                }
                
                // 4. Pay principal
                const principalDue = nextPayment.principal_payment || 0;
                if (remainingAmount > 0 && principalDue > 0) {
                    principalPaid = Math.min(remainingAmount, principalDue, loan.remaining_principal);
                    remainingAmount -= principalPaid;
                }
                
                // 5. Handle overpayment - apply to next principal payment
                if (remainingAmount > 0 && loan.remaining_principal > principalPaid) {
                    const additionalPrincipal = Math.min(remainingAmount, loan.remaining_principal - principalPaid);
                    principalPaid += additionalPrincipal;
                    remainingAmount -= additionalPrincipal;
                }
                
                // Check if this payment completes the current installment
                const totalDue = initiationDue + adminDue + interestDue + principalDue;
                const totalPaid = initiationFeePaid + adminFeePaid + interestPaid + principalPaid;
                
                if (totalPaid >= totalDue - 0.01) {
                    // Full payment made - mark as paid and increment counter
                    nextPayment.status = 'paid';
                    nextPayment.payment_date = new Date().toISOString();
                    nextPayment.amount_paid = amount;
                    loan.payments_made = (loan.payments_made || 0) + 1;
                } else {
                    // Partial payment - update schedule but don't increment counter
                    nextPayment.partial_payment = (nextPayment.partial_payment || 0) + amount;
                }
            } else {
                // No schedule - use simple allocation
                const principalPerMonth = (loan.principal_amount || loan.principal) / loan.term_months;
                principalPaid = Math.min(remainingAmount, principalPerMonth, loan.remaining_principal);
            }
            
            // Update loan totals
            loan.remaining_principal = Math.max(0, loan.remaining_principal - principalPaid);
            loan.initiation_fee_paid = (loan.initiation_fee_paid || 0) + initiationFeePaid;
            loan.interest_paid = (loan.interest_paid || 0) + interestPaid;
            
            // Also update legacy field for backward compatibility
            loan.total_interest_charged = loan.interest_paid;
            
            // Check if loan is paid off
            if (loan.remaining_principal <= 0.01 || loan.payments_made >= loan.term_months) {
                loan.status = 'completed';
                loan.completion_date = new Date().toISOString();
                loan.remaining_principal = 0;
            }
            
            // Update AppState
            AppState.capital = (AppState.capital || 0) + amount;
            AppState.deployed = Math.max(0, (AppState.deployed || 0) - principalPaid);
            AppState.totalInterestEarned = (AppState.totalInterestEarned || 0) + interestPaid;
            AppState.totalFeesEarned = (AppState.totalFeesEarned || 0) + adminFeePaid + initiationFeePaid;
            
            // Log transaction
            if (!AppState.transactionHistory) AppState.transactionHistory = [];
            AppState.transactionHistory.push({
                type: 'payment',
                timestamp: new Date().toISOString(),
                details: {
                    loanId: loanId,
                    clientName: loan.client_name,
                    paymentAmount: amount,
                    principalPaid: principalPaid,
                    interestPaid: interestPaid,
                    adminFeePaid: adminFeePaid,
                    initiationFeePaid: initiationFeePaid,
                    overpayment: remainingAmount,
                    remainingPrincipal: loan.remaining_principal,
                    remainingInterest: Math.max(0, loan.total_interest - loan.interest_paid),
                    remainingInitiationFee: Math.max(0, loan.total_initiation_fee - loan.initiation_fee_paid),
                    paymentNumber: loan.payments_made,
                    paymentDate: new Date().toISOString()
                }
            });
            
            // Save state
            AppStateManager.save(AppState);
            
            // Calculate remaining amounts for display
            const newRemainingInitiationFee = Math.max(0, loan.total_initiation_fee - loan.initiation_fee_paid);
            const newRemainingInterest = Math.max(0, loan.total_interest - loan.interest_paid);
            
            // Show success message
            const completionMsg = loan.status === 'completed' ? '\n\nüéâ LOAN FULLY PAID!' : '';
            const overpaymentMsg = remainingAmount > 0.01 ? `\nüí° Overpayment: ${Calculations.formatCurrency(remainingAmount)} (credited to account)` : '';
            const partialMsg = nextPayment && nextPayment.partial_payment ? '\n‚ö†Ô∏è Partial payment recorded - installment not yet complete' : '';
            
            alert(
                `‚úÖ Payment Processed Successfully!${completionMsg}${partialMsg}\n\n` +
                `üí∞ Total Paid: ${Calculations.formatCurrency(amount)}\n\n` +
                `üìä Payment Breakdown:\n` +
                `‚Ä¢ Principal: ${Calculations.formatCurrency(principalPaid)}\n` +
                `‚Ä¢ Interest: ${Calculations.formatCurrency(interestPaid)}\n` +
                `‚Ä¢ Admin Fee: ${Calculations.formatCurrency(adminFeePaid)}\n` +
                `‚Ä¢ Initiation Fee: ${Calculations.formatCurrency(initiationFeePaid)}${overpaymentMsg}\n\n` +
                `üìä Loan Progress: ${loan.payments_made}/${loan.term_months} payments\n\n` +
                `üíµ Remaining Balances:\n` +
                `‚Ä¢ Principal: ${Calculations.formatCurrency(loan.remaining_principal)}\n` +
                `‚Ä¢ Interest: ${Calculations.formatCurrency(newRemainingInterest)}\n` +
                `‚Ä¢ Initiation Fee: ${Calculations.formatCurrency(newRemainingInitiationFee)}`
            );
            
            // Reload loans
            loadLoans();
        }
        
        /**
         * View loan details
         */
        function viewLoanDetails(loanId) {
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            const details = `
üìã Loan #${loan.loan_id} - Details

üë§ Client: ${loan.client_name}
üí∞ Principal: ${Calculations.formatCurrency(loan.principal || 0)}
üìÖ Term: ${loan.term_months} months
üí≥ Monthly Payment: ${Calculations.formatCurrency(loan.monthly_payment || 0)}
üìä Payments Made: ${loan.payments_made || 0}/${loan.term_months}
üíµ Remaining Principal: ${Calculations.formatCurrency(loan.remaining_principal || 0)}
üìã Status: ${loan.status}
üìÖ Created: ${new Date(loan.created_at).toLocaleDateString('en-ZA')}
${loan.completion_date ? `‚úÖ Completed: ${new Date(loan.completion_date).toLocaleDateString('en-ZA')}` : ''}
            `.trim();
            
            alert(details);
        }
        
        /**
         * Mark loan as defaulted
         */
        function markAsDefaulted(loanId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to mark this loan as DEFAULTED?\n\nThis action can be reversed later if needed.')) {
                return;
            }
            
            const loan = allLoans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('‚ùå Loan not found!');
                return;
            }
            
            loan.status = 'defaulted';
            loan.default_date = new Date().toISOString();
            
            // Log transaction
            if (!AppState.transactions) AppState.transactions = [];
            AppState.transactions.push({
                id: Date.now(),
                type: 'status_change',
                date: new Date().toISOString(),
                description: `Loan #${loanId} marked as DEFAULTED`,
                data: { loanId: loanId, newStatus: 'defaulted' }
            });
            
            // Save state
            AppStateManager.save(AppState);
            
            alert('‚úÖ Loan marked as defaulted.');
            loadLoans();
        }
        
        /**
         * Export active loans to Excel
         */
        function exportToExcel() {
            try {
                // Get current filtered loans
                const loansToExport = allLoans.length > 0 ? allLoans : AppState.loans || [];
                
                if (loansToExport.length === 0) {
                    alert('‚ö†Ô∏è No loans to export');
                    return;
                }
                
                // Prepare data for Excel
                const excelData = [
                    // Header row
                    ['TBFS Active Loans Report'],
                    ['Generated: ' + new Date().toLocaleString()],
                    [],
                    ['Loan ID', 'Client Name', 'Account', 'Type', 'Principal', 'Monthly Payment', 'Payments Made', 'Total Payments', 'Outstanding Balance', 'Status', 'Disbursement Date', 'Next Due Date']
                ];
                
                // Add loan data
                loansToExport.forEach(loan => {
                    const nextPayment = (loan.schedule || []).find(p => p.status === 'pending');
                    const nextDueDate = nextPayment ? new Date(nextPayment.due_date).toLocaleDateString() : 'N/A';
                    
                    excelData.push([
                        loan.loan_id,
                        loan.client_name,
                        loan.account_number,
                        loan.loan_type === 'stockvel' ? 'Stockvel' : 'Standard',
                        loan.principal_amount,
                        loan.monthly_payment,
                        loan.payments_made || 0,
                        loan.term_months,
                        loan.remaining_principal || loan.principal_amount,
                        loan.status.charAt(0).toUpperCase() + loan.status.slice(1),
                        new Date(loan.disbursement_date || loan.created_at).toLocaleDateString(),
                        nextDueDate
                    ]);
                });
                
                // Add summary
                const totalPrincipal = loansToExport.reduce((sum, l) => sum + l.principal_amount, 0);
                const totalOutstanding = loansToExport.reduce((sum, l) => sum + (l.remaining_principal || l.principal_amount), 0);
                
                excelData.push([]);
                excelData.push(['SUMMARY']);
                excelData.push(['Total Loans', loansToExport.length]);
                excelData.push(['Total Principal Disbursed', totalPrincipal]);
                excelData.push(['Total Outstanding', totalOutstanding]);
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 10 },  // Loan ID
                    { wch: 25 },  // Client Name
                    { wch: 15 },  // Account
                    { wch: 10 },  // Type
                    { wch: 12 },  // Principal
                    { wch: 15 },  // Monthly Payment
                    { wch: 15 },  // Payments Made
                    { wch: 15 },  // Total Payments
                    { wch: 18 },  // Outstanding
                    { wch: 12 },  // Status
                    { wch: 15 },  // Disbursement
                    { wch: 15 }   // Next Due
                ];
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Active Loans');
                
                // Download file
                const fileName = `TBFS_Active_Loans_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('‚úÖ Excel file downloaded successfully!\n\nFile: ' + fileName);
            } catch (error) {
                console.error('Excel export error:', error);
                alert('‚ùå Error exporting to Excel: ' + error.message);
            }
        }
        
        /**
         * Export active loans to PDF
         */
        function exportToPDF() {
            try {
                // Get current filtered loans
                const loansToExport = allLoans.length > 0 ? allLoans : AppState.loans || [];
                
                if (loansToExport.length === 0) {
                    alert('‚ö†Ô∏è No loans to export');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                
                // Title
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('TBFS Active Loans Report', 105, yPos, { align: 'center' });
                yPos += 10;
                
                // Date
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text('Generated: ' + new Date().toLocaleString(), 105, yPos, { align: 'center' });
                yPos += 15;
                
                // Summary Stats
                const totalPrincipal = loansToExport.reduce((sum, l) => sum + l.principal_amount, 0);
                const totalOutstanding = loansToExport.reduce((sum, l) => sum + (l.remaining_principal || l.principal_amount), 0);
                const activeCount = loansToExport.filter(l => l.status === 'active').length;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Portfolio Summary:', 20, yPos);
                yPos += 7;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Total Loans: ${loansToExport.length}`, 20, yPos);
                doc.text(`Active Loans: ${activeCount}`, 80, yPos);
                yPos += 5;
                doc.text(`Total Principal: R ${totalPrincipal.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 20, yPos);
                doc.text(`Total Outstanding: R ${totalOutstanding.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 80, yPos);
                yPos += 15;
                
                // Loan Details
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Loan Details:', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(9);
                
                loansToExport.forEach((loan, index) => {
                    // Check if we need a new page
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Loan header
                    doc.setFont(undefined, 'bold');
                    doc.text(`Loan #${loan.loan_id} - ${loan.client_name}`, 20, yPos);
                    yPos += 5;
                    
                    // Loan details
                    doc.setFont(undefined, 'normal');
                    const nextPayment = (loan.schedule || []).find(p => p.status === 'pending');
                    const nextDueDate = nextPayment ? new Date(nextPayment.due_date).toLocaleDateString() : 'N/A';
                    
                    doc.text(`Account: ${loan.account_number}`, 25, yPos);
                    doc.text(`Type: ${loan.loan_type === 'stockvel' ? 'Stockvel' : 'Standard'}`, 80, yPos);
                    doc.text(`Status: ${loan.status.charAt(0).toUpperCase() + loan.status.slice(1)}`, 130, yPos);
                    yPos += 5;
                    
                    doc.text(`Principal: R ${loan.principal_amount.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`, 25, yPos);
                    doc.text(`Monthly: R ${loan.monthly_payment.toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`, 80, yPos);
                    yPos += 5;
                    
                    doc.text(`Progress: ${loan.payments_made || 0}/${loan.term_months} payments`, 25, yPos);
                    doc.text(`Outstanding: R ${(loan.remaining_principal || loan.principal_amount).toLocaleString('en-ZA', { minimumFractionDigits: 2 })}`, 80, yPos);
                    yPos += 5;
                    
                    doc.text(`Disbursed: ${new Date(loan.disbursement_date || loan.created_at).toLocaleDateString()}`, 25, yPos);
                    doc.text(`Next Due: ${nextDueDate}`, 80, yPos);
                    yPos += 8;
                    
                    // Separator line
                    if (index < loansToExport.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.line(20, yPos, 190, yPos);
                        yPos += 5;
                    }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text('Thaba Bosiu Financial Services', 105, 285, { align: 'center' });
                }
                
                // Save PDF
                const fileName = `TBFS_Active_Loans_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                alert('‚úÖ PDF downloaded successfully!\n\nFile: ' + fileName);
            } catch (error) {
                console.error('PDF export error:', error);
                alert('‚ùå Error exporting to PDF: ' + error.message);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
