<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Settings - TBFS</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">
    
    <!-- Page-Specific Styles -->
    <style>
        .form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-top: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-container label {
            flex: 1;
            cursor: pointer;
        }
        
        .info-box {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid;
        }
        
        .info-box.success {
            background: #e8f5e8;
            border-color: #27ae60;
            color: #155724;
        }
        
        .info-box.warning {
            background: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }
        
        .info-box.info {
            background: #f0f4ff;
            border-color: #667eea;
            color: #2c3e50;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .setting-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .setting-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .setting-card input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .danger-zone {
            background: #fff5f5;
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .danger-zone h3 {
            color: #e74c3c;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div id="navigation-header"></div>
    
    <div class="container" style="max-width: 900px; margin: 20px auto; padding: 20px;">
        <h1 class="section-title">‚öôÔ∏è Settings</h1>
        
        <!-- Capital & Profit Goal Settings -->
        <div class="form-section">
            <h3 style="color: #2c3e50; margin-bottom: 20px;">üí∞ Financial Settings</h3>
            
            <div class="settings-grid">
                <div class="setting-card">
                    <h4>Capital Amount</h4>
                    <input type="number" id="capitalInput" placeholder="Enter capital amount" min="0" step="0.01">
                    <button class="btn btn-primary" onclick="setCapital()" style="width: 100%;">üíµ Set Capital</button>
                    <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">
                        Current: <strong id="currentCapital">R0</strong>
                    </p>
                </div>
                
                <div class="setting-card">
                    <h4>Profit Goal</h4>
                    <input type="number" id="profitGoalInput" placeholder="Enter profit goal" min="0" step="0.01">
                    <button class="btn btn-primary" onclick="setProfitGoal()" style="width: 100%;">üéØ Set Profit Goal</button>
                    <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">
                        Current: <strong id="currentProfitGoal">R0</strong>
                    </p>
                </div>
            </div>
            
            <!-- Profit Progress Display -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                <h4 style="color: #2c3e50; margin-bottom: 15px;">üìä Profit Goal Progress</h4>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: #7f8c8d;">Progress</span>
                    <strong id="profitProgressPercent" style="font-size: 18px; color: #27ae60;">0%</strong>
                </div>
                <div style="background: #e0e6ed; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div id="profitProgressBar" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 14px; text-align: center;" id="profitRemaining">Set a profit goal to track progress</p>
            </div>
        </div>
        
        <!-- App Version & Updates Section -->
        <div class="form-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">üîí App Version & Updates</h3>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Current Version</p>
                        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #2c3e50;" id="currentVersion">v1.7.11</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #95a5a6;" id="updateStatus">Checking for updates...</p>
                    </div>
                    <button class="btn" onclick="checkForUpdates()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px;">
                        üîÑ Check for Updates
                    </button>
                </div>
            </div>
            
            <div class="info-box success">
                <strong style="color: #27ae60;">üìö How Updates Work:</strong>
                <ul style="margin: 10px 0 0 20px; color: #2c3e50; font-size: 14px;">
                    <li>Updates download automatically in the background</li>
                    <li>Click "Update Now" or close and reopen the app to apply</li>
                    <li>Your data is always safe during updates</li>
                </ul>
            </div>
            
            <!-- Service Worker Update Button (shown when update available) -->
            <div id="updateBanner" style="display: none; background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60; margin-top: 15px;">
                <strong style="color: #27ae60;">‚úÖ Update Available!</strong>
                <p style="margin: 10px 0; color: #2c3e50;">A new version is ready. Click below to apply the update.</p>
                <button class="btn" onclick="applyUpdate()" style="background: #27ae60; color: white;">
                    üöÄ Update Now
                </button>
            </div>
        </div>
        
        <!-- Cloud Backup Settings -->
        <div class="form-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">‚òÅÔ∏è GitHub Cloud Backup</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Automatically backup your data to a private GitHub repository. Your data syncs across all devices and works offline.</p>
            
            <!-- Token Configured State -->
            <div id="tokenConfigured" style="display: none;">
                <div style="padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #f0f4ff; border: 2px solid #667eea;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong style="color: #667eea;">‚úÖ GitHub Token Configured</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px; color: #2c3e50;">
                                You can now restore from cloud
                            </p>
                        </div>
                        <button class="btn btn-danger" onclick="removeToken()">Remove Token</button>
                    </div>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()">
                    <label for="autoBackupToggle">
                        <strong>Enable Auto-Backup on This Device</strong>
                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            When enabled, every change automatically syncs to cloud. Leave OFF if this is a secondary device.
                        </div>
                    </label>
                </div>
                
                <div id="autoBackupStatus" style="padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #e8f5e8; border: 2px solid #27ae60; display: none;">
                    <strong style="color: #27ae60;">‚úÖ Auto-Backup Active</strong>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: #2c3e50;">
                        Last sync: <span id="lastSyncTime">Never</span>
                    </p>
                </div>
            </div>

            <!-- Token Setup Form -->
            <div id="cloudBackupSetup" style="display: block;">
                <div class="form-group">
                    <label for="githubToken">GitHub Personal Access Token:</label>
                    <input type="password" id="githubToken" placeholder="github_pat_xxxxx..." 
                           style="font-family: monospace; font-size: 14px;">
                    <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                        üîí Your token is encrypted and stored securely on your device only. Never shared or exposed.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="backupRepoUrl">Backup Repository URL:</label>
                    <input type="text" id="backupRepoUrl" 
                           value="https://github.com/Ndelo-N/TBFS-Data-Backup.git" readonly
                           style="background: #f8f9fa; font-family: monospace; font-size: 14px;">
                    <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                        ‚ö†Ô∏è Ensure this is your PRIVATE backup repository.
                    </p>
                </div>

                <button class="btn btn-primary" onclick="saveToken()" style="width: 100%;">
                    üíæ Save Token & Configure
                </button>
            </div>

            <div class="info-box warning" style="margin-top: 30px;">
                <strong style="color: #856404;">üîë How to Get Your Token:</strong>
                <ol style="margin: 10px 0 0 20px; color: #856404;">
                    <li>Go to: <code>github.com/settings/tokens</code></li>
                    <li>Click "Generate new token" ‚Üí "Fine-grained token"</li>
                    <li>Give access ONLY to <code>TBFS-Data-Backup</code> repo</li>
                    <li>Enable "Contents: Read and write" permission</li>
                    <li>Copy token and paste above</li>
                </ol>
            </div>

            <div style="margin-top: 20px;">
                <h4 style="color: #2c3e50;">Cloud Backup Features:</h4>
                <ul style="color: #7f8c8d; line-height: 1.8;">
                    <li>‚úÖ Auto-sync on every data change</li>
                    <li>‚úÖ Works offline - queues changes, syncs when online</li>
                    <li>‚úÖ Access from any device</li>
                    <li>‚úÖ Daily snapshots kept for 30 days</li>
                    <li>‚úÖ One-click restore</li>
                    <li>‚úÖ Completely free (uses your private GitHub repo)</li>
                </ul>
            </div>
        </div>

        <!-- Manual Backup & Restore -->
        <div class="form-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">üíæ Manual Backup & Restore</h3>
            <p style="color: #7f8c8d; margin-bottom: 20px;">Download or restore backups manually.</p>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="backupData()">üíæ Download Local Backup</button>
                <button class="btn" onclick="restoreData()">üì• Restore from File</button>
                <button class="btn" style="background: #27ae60; color: white;" onclick="restoreFromCloud()">‚òÅÔ∏è Restore from Cloud</button>
            </div>
            
            <div class="info-box info" style="margin-top: 15px;">
                <strong>üí° Backup Tips:</strong>
                <ul style="margin: 10px 0 0 20px; color: #2c3e50; font-size: 14px;">
                    <li>Download backups regularly for safety</li>
                    <li>Store backups in multiple locations</li>
                    <li>Cloud backup provides automatic protection</li>
                    <li>Restore only from trusted backup files</li>
                </ul>
            </div>
        </div>

        <!-- Data Management -->
        <div class="danger-zone">
            <h3>‚ö†Ô∏è Danger Zone</h3>
            <p style="color: #7f8c8d; margin-bottom: 15px;">These actions are permanent and cannot be undone. Use with extreme caution.</p>
            
            <button class="btn btn-danger" onclick="clearAllData()">
                üóëÔ∏è Clear All Data
            </button>
            <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">
                ‚ö†Ô∏è This will permanently delete ALL loans, clients, and financial data. A backup will be automatically created before clearing.
            </p>
        </div>
    </div>

    <!-- Shared Scripts -->
    <script src="shared/app-state.js"></script>
    <script src="shared/calculations.js"></script>
    <script src="shared/navigation.js"></script>

    <script>
        // App Version
        const APP_VERSION = '1.7.11';
        
        // Global state
        let AppState = {};
        let updateAvailable = false;
        let waitingServiceWorker = null;
        
        /**
         * Initialize page
         */
        function init() {
            // Load app state
            AppState = AppStateManager.load();
            
            // Initialize navigation
            Navigation.init('settings');
            
            // Initialize cloud backup
            CloudBackup.init();
            
            // Update UI with current values
            updateFinancialSettings();
            
            // Update version display
            document.getElementById('currentVersion').textContent = `v${APP_VERSION}`;
            
            // Check for service worker updates
            checkServiceWorkerUpdate();
            
            // Update sync time every minute
            setInterval(() => CloudBackup.updateSyncTime(), 60000);
            
            // Listen for state updates from other tabs
            AppStateManager.onUpdate(() => {
                console.log('State updated from another tab, reloading...');
                AppState = AppStateManager.load();
                updateFinancialSettings();
            });
            
            console.log('‚úÖ Settings page initialized');
        }
        
        /**
         * Update financial settings display
         */
        function updateFinancialSettings() {
            // Update capital display
            const capital = AppState.capital || AppState.deployedCapital || 0;
            document.getElementById('currentCapital').textContent = Calculations.formatCurrency(capital);
            if (document.getElementById('capitalInput')) {
                document.getElementById('capitalInput').value = capital;
            }
            
            // Update profit goal display
            const profitGoal = AppState.profitGoal || 0;
            document.getElementById('currentProfitGoal').textContent = Calculations.formatCurrency(profitGoal);
            if (document.getElementById('profitGoalInput')) {
                document.getElementById('profitGoalInput').value = profitGoal;
            }
            
            // Update profit progress
            const totalProfit = (AppState.totalInterestEarned || 0) + (AppState.totalFeesEarned || 0);
            if (profitGoal > 0) {
                const profitPercentage = Math.min(100, (totalProfit / profitGoal * 100));
                document.getElementById('profitProgressPercent').textContent = `${profitPercentage.toFixed(1)}%`;
                document.getElementById('profitProgressBar').style.width = `${profitPercentage}%`;
                
                const profitRemaining = Math.max(0, profitGoal - totalProfit);
                if (profitRemaining > 0) {
                    document.getElementById('profitRemaining').textContent = 
                        `${Calculations.formatCurrency(profitRemaining)} remaining to reach goal`;
                } else {
                    document.getElementById('profitRemaining').textContent = 
                        `‚úÖ Goal achieved! Exceeded by ${Calculations.formatCurrency(totalProfit - profitGoal)}`;
                    document.getElementById('profitRemaining').style.color = '#27ae60';
                }
            } else {
                document.getElementById('profitProgressPercent').textContent = '0%';
                document.getElementById('profitProgressBar').style.width = '0%';
                document.getElementById('profitRemaining').textContent = 'Set a profit goal to track progress';
            }
        }
        
        /**
         * Set capital amount
         */
        function setCapital() {
            const input = document.getElementById('capitalInput');
            const amount = parseFloat(input.value);
            
            if (isNaN(amount) || amount < 0) {
                alert('‚ùå Please enter a valid capital amount (must be 0 or greater)');
                return;
            }
            
            if (!confirm(
                `üí∞ Set Capital Amount\n\n` +
                `Current: ${Calculations.formatCurrency(AppState.capital || 0)}\n` +
                `New: ${Calculations.formatCurrency(amount)}\n\n` +
                `This will update your available capital. Continue?`
            )) {
                return;
            }
            
            AppState.capital = amount;
            AppState.deployedCapital = AppState.deployed || 0; // Ensure compatibility
            
            // Log transaction
            if (!AppState.transactions) AppState.transactions = [];
            AppState.transactions.push({
                type: 'settings_change',
                timestamp: new Date().toISOString(),
                details: {
                    changeType: 'set_capital',
                    oldValue: AppState.capital || 0,
                    newValue: amount
                }
            });
            
            AppStateManager.save(AppState);
            updateFinancialSettings();
            
            alert(`‚úÖ Capital set to ${Calculations.formatCurrency(amount)}`);
        }
        
        /**
         * Set profit goal
         */
        function setProfitGoal() {
            const input = document.getElementById('profitGoalInput');
            const amount = parseFloat(input.value);
            
            if (isNaN(amount) || amount < 0) {
                alert('‚ùå Please enter a valid profit goal (must be 0 or greater)');
                return;
            }
            
            if (!confirm(
                `üéØ Set Profit Goal\n\n` +
                `Current Goal: ${Calculations.formatCurrency(AppState.profitGoal || 0)}\n` +
                `New Goal: ${Calculations.formatCurrency(amount)}\n\n` +
                `This will update your profit tracking goal. Continue?`
            )) {
                return;
            }
            
            AppState.profitGoal = amount;
            
            // Log transaction
            if (!AppState.transactions) AppState.transactions = [];
            AppState.transactions.push({
                type: 'settings_change',
                timestamp: new Date().toISOString(),
                details: {
                    changeType: 'set_profit_goal',
                    oldValue: AppState.profitGoal || 0,
                    newValue: amount
                }
            });
            
            AppStateManager.save(AppState);
            updateFinancialSettings();
            
            alert(`‚úÖ Profit goal set to ${Calculations.formatCurrency(amount)}`);
        }
        
        /**
         * Check for app updates
         */
        async function checkForUpdates() {
            const button = document.querySelector('[onclick="checkForUpdates()"]');
            if (button) {
                button.disabled = true;
                button.textContent = 'üîÑ Checking...';
            }
            document.getElementById('updateStatus').textContent = 'Checking for updates...';
            document.getElementById('updateStatus').style.color = '#7f8c8d';
            
            try {
                // Fetch the deployed settings.html from GitHub Pages with cache-busting
                // (settings.html has the most up-to-date version number)
                const response = await fetch(`https://ndelo-n.github.io/TBFS-Connected/settings.html?t=${Date.now()}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch latest version');
                }
                
                const html = await response.text();
                
                // Extract version number from the deployed HTML
                const versionMatch = html.match(/const APP_VERSION = ['"]([^'"]+)['"]/);
                
                if (versionMatch && versionMatch[1]) {
                    const remoteVersion = versionMatch[1];
                    const currentVersion = APP_VERSION;
                    
                    console.log(`Current: ${currentVersion}, Remote: ${remoteVersion}`);
                    
                    if (remoteVersion !== currentVersion) {
                        // Version mismatch - update available
                        updateAvailable = true;
                        document.getElementById('updateStatus').textContent = 
                            `üÜï Update available! v${currentVersion} ‚Üí v${remoteVersion}`;
                        document.getElementById('updateStatus').style.color = '#27ae60';
                        showUpdateBanner();
                        
                        // Also trigger service worker update to fetch new files
                        if ('serviceWorker' in navigator) {
                            const registration = await navigator.serviceWorker.getRegistration();
                            if (registration) {
                                registration.update();
                            }
                        }
                    } else {
                        // Versions match - no update needed
                        document.getElementById('updateStatus').textContent = '‚úÖ You are running the latest version';
                        document.getElementById('updateStatus').style.color = '#27ae60';
                    }
                } else {
                    throw new Error('Could not determine remote version');
                }
            } catch (error) {
                console.error('Update check failed:', error);
                document.getElementById('updateStatus').textContent = 
                    '‚ö†Ô∏è Could not check for updates. Check your internet connection.';
                document.getElementById('updateStatus').style.color = '#e74c3c';
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üîÑ Check for Updates';
                }
            }
        }
        
        /**
         * Check for service worker update
         */
        async function checkServiceWorkerUpdate() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New service worker available
                                        waitingServiceWorker = newWorker;
                                        showUpdateBanner();
                                    }
                                });
                            }
                        });
                        
                        // Check for updates
                        await registration.update();
                    }
                } catch (error) {
                    console.error('Service worker check failed:', error);
                }
            }
        }
        
        /**
         * Show update banner
         */
        function showUpdateBanner() {
            document.getElementById('updateBanner').style.display = 'block';
        }
        
        /**
         * Apply service worker update
         */
        async function applyUpdate() {
            if (waitingServiceWorker) {
                // Tell the waiting service worker to skip waiting and activate
                waitingServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                // Reload the page
                window.location.reload();
            } else if ('serviceWorker' in navigator) {
                // Try to get the registration and skip waiting
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    } else {
                        // Fallback: just reload
                        window.location.reload();
                    }
                } catch (error) {
                    console.error('Error posting message to service worker:', error);
                    window.location.reload();
                }
            } else {
                // Fallback: just reload
                window.location.reload();
            }
        }
        
        /**
         * Cloud Backup System
         */
        const CloudBackup = {
            autoBackupEnabled: false,
            token: null,
            repoOwner: 'Ndelo-N',
            repoName: 'TBFS-Data-Backup',
            
            init() {
                // Check if token is configured
                const encryptedToken = localStorage.getItem('githubBackupToken');
                if (encryptedToken) {
                    this.token = this.decrypt(encryptedToken);
                }
                
                // Check if auto-backup is enabled
                const autoBackupSetting = localStorage.getItem('autoBackupEnabled');
                this.autoBackupEnabled = (autoBackupSetting === 'true');
                
                this.updateUI();
                
                if (this.autoBackupEnabled) {
                    this.updateSyncTime();
                }
                
                // Setup online/offline listeners
                window.addEventListener('online', () => this.syncPendingBackups());
            },
            
            hasToken() {
                return this.token !== null && this.token.length > 0;
            },
            
            encrypt(text) {
                // Simple Base64 encoding (for basic obfuscation)
                return btoa(unescape(encodeURIComponent(text)));
            },
            
            decrypt(encoded) {
                return decodeURIComponent(escape(atob(encoded)));
            },
            
            updateUI() {
                if (this.hasToken()) {
                    document.getElementById('tokenConfigured').style.display = 'block';
                    document.getElementById('cloudBackupSetup').style.display = 'none';
                    
                    // Update toggle checkbox
                    const toggle = document.getElementById('autoBackupToggle');
                    if (toggle) {
                        toggle.checked = this.autoBackupEnabled;
                    }
                    
                    // Show/hide auto-backup status
                    if (this.autoBackupEnabled) {
                        document.getElementById('autoBackupStatus').style.display = 'block';
                    } else {
                        document.getElementById('autoBackupStatus').style.display = 'none';
                    }
                } else {
                    document.getElementById('tokenConfigured').style.display = 'none';
                    document.getElementById('cloudBackupSetup').style.display = 'block';
                }
            },
            
            updateSyncTime() {
                const lastSync = localStorage.getItem('lastCloudSync');
                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - date) / 60000);
                    
                    let timeText;
                    if (diffMinutes < 1) {
                        timeText = 'Just now';
                    } else if (diffMinutes < 60) {
                        timeText = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    }
                    
                    const syncTimeElement = document.getElementById('lastSyncTime');
                    if (syncTimeElement) {
                        syncTimeElement.textContent = timeText;
                    }
                }
            },
            
            async backup() {
                if (!this.autoBackupEnabled || !this.hasToken()) {
                    return; // Auto-backup not enabled, skip
                }
                
                if (!navigator.onLine) {
                    // Queue for later if offline
                    localStorage.setItem('pendingCloudBackup', 'true');
                    console.log('Offline: Backup queued for when online');
                    return;
                }
                
                const data = {
                    capital: AppState.capital || AppState.deployedCapital || 0,
                    deployed: AppState.deployed || AppState.deployedCapital || 0,
                    totalInterestEarned: AppState.totalInterestEarned || 0,
                    totalFeesEarned: AppState.totalFeesEarned || 0,
                    profitGoal: AppState.profitGoal || 0,
                    clients: AppState.clients || [],
                    loans: AppState.loans || [],
                    transactionHistory: AppState.transactions || [],
                    nextAccountNumber: AppState.nextAccountNumber || 2025001,
                    stockvelMembers: AppState.stockvelMembers || [],
                    stockvelReceipts: AppState.stockvelReceipts || [],
                    nextMemberNumber: AppState.nextMemberNumber || 1001,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    // Upload latest.json
                    await this.uploadToGitHub('latest.json', data);
                    
                    // Also create daily snapshot
                    const dateStr = new Date().toISOString().split('T')[0];
                    await this.uploadToGitHub(`daily/${dateStr}.json`, data);
                    
                    localStorage.setItem('lastCloudSync', new Date().toISOString());
                    localStorage.removeItem('pendingCloudBackup');
                    this.updateSyncTime();
                    
                    console.log('‚úÖ Cloud backup successful');
                } catch (error) {
                    console.error('Cloud backup failed:', error);
                    localStorage.setItem('pendingCloudBackup', 'true');
                }
            },
            
            async uploadToGitHub(path, data) {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${path}`;
                
                // Check if file exists to get SHA
                let sha = null;
                try {
                    const getResponse = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist, that's okay
                }
                
                // Create or update file
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Backup: ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.statusText}`);
                }
            },
            
            async syncPendingBackups() {
                const hasPending = localStorage.getItem('pendingCloudBackup');
                if (hasPending && this.autoBackupEnabled && this.hasToken()) {
                    console.log('üîÑ Syncing pending backup...');
                    await this.backup();
                    alert('‚úÖ Pending backup synced to cloud!');
                }
            },
            
            async restore() {
                if (!this.hasToken()) {
                    alert('Please configure your GitHub token first in Settings');
                    return;
                }
                
                try {
                    const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/latest.json`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        // Handle different error types with specific messages
                        if (response.status === 404) {
                            // No backup file exists yet - this is not an error, just information
                            alert('üì¶ No cloud backup found yet.\n\n' +
                                  'üí° To create your first backup:\n' +
                                  '1. Enable "Auto-Backup" in Settings, or\n' +
                                  '2. Make any change (add/edit a loan) to trigger automatic backup, or\n' +
                                  '3. Use "Download Local Backup" to save locally first\n\n' +
                                  'Once created, your backup will sync across all devices!');
                            return;
                        } else if (response.status === 401) {
                            throw new Error('Authentication failed. Please check your GitHub token in Settings.');
                        } else if (response.status === 403) {
                            throw new Error('Access denied. Please verify your token has "Contents: Read and write" permission for the backup repository.');
                        } else {
                            throw new Error(`Unable to access cloud backup (Error ${response.status}). Please check your internet connection and try again.`);
                        }
                    }
                    
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    const data = JSON.parse(content);
                    
                    // Restore data using AppStateManager
                    AppStateManager.save(data);
                    alert('‚úÖ Data restored from cloud successfully!\n\nReloading app to display restored data...');
                    
                    // Reload page to refresh all views
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } catch (error) {
                    // Only show error for actual errors (not 404 which we handled above)
                    alert('‚ùå Failed to restore from cloud: ' + error.message);
                }
            }
        };
        
        /**
         * Save GitHub token
         */
        function saveToken() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                alert('Please enter your GitHub token');
                return;
            }
            
            if (!token.startsWith('github_pat_') && !token.startsWith('ghp_')) {
                alert('Invalid token format. Token should start with "github_pat_" or "ghp_"');
                return;
            }
            
            // Encrypt and store token
            const encrypted = CloudBackup.encrypt(token);
            localStorage.setItem('githubBackupToken', encrypted);
            
            CloudBackup.token = token;
            CloudBackup.updateUI();
            
            // Clear token input
            document.getElementById('githubToken').value = '';
            
            alert('‚úÖ Token saved! You can now restore from cloud.\n\nüí° Tip: Check the "Enable Auto-Backup" box if you want this device to automatically sync changes to cloud.');
        }
        
        /**
         * Remove GitHub token
         */
        function removeToken() {
            if (confirm('Remove GitHub token? You won\'t be able to backup or restore from cloud until you add it again.')) {
                localStorage.removeItem('githubBackupToken');
                localStorage.removeItem('autoBackupEnabled');
                localStorage.removeItem('lastCloudSync');
                CloudBackup.token = null;
                CloudBackup.autoBackupEnabled = false;
                CloudBackup.updateUI();
                alert('Token removed');
            }
        }
        
        /**
         * Toggle auto-backup
         */
        function toggleAutoBackup() {
            const isChecked = document.getElementById('autoBackupToggle').checked;
            
            if (isChecked) {
                // Enabling auto-backup
                CloudBackup.autoBackupEnabled = true;
                localStorage.setItem('autoBackupEnabled', 'true');
                CloudBackup.updateUI();
                
                // Perform initial backup
                CloudBackup.backup();
                
                alert('‚úÖ Auto-backup enabled! Every change will now sync to cloud automatically.');
            } else {
                // Disabling auto-backup
                if (confirm('Disable auto-backup on this device? You can still restore from cloud anytime.')) {
                    CloudBackup.autoBackupEnabled = false;
                    localStorage.setItem('autoBackupEnabled', 'false');
                    CloudBackup.updateUI();
                    alert('Auto-backup disabled. You can still restore from cloud anytime.');
                } else {
                    // User cancelled, re-check the box
                    document.getElementById('autoBackupToggle').checked = true;
                }
            }
        }
        
        /**
         * Restore from cloud
         */
        async function restoreFromCloud() {
            if (!CloudBackup.hasToken()) {
                alert('Please configure your GitHub token first in Settings');
                return;
            }
            
            if (confirm('This will restore data from your cloud backup and overwrite local data. Continue?')) {
                await CloudBackup.restore();
            }
        }
        
        /**
         * Backup data to local file
         */
        function backupData() {
            // Get state from AppStateManager
            const state = AppStateManager.load();
            const data = JSON.stringify(state, null, 2);
            
            if (!data || data === '{}') {
                alert('No data to backup');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TBFS_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data backup downloaded successfully!');
        }
        
        /**
         * Restore data from local file
         */
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Validate data structure
                        if (!data || typeof data !== 'object') {
                            throw new Error('Invalid backup file format');
                        }
                        
                        // Restore using AppStateManager
                        AppStateManager.save(data);
                        
                        alert('‚úÖ Data restored successfully!\n\nReloading app to display restored data...');
                        
                        // Reload page to refresh all views
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    } catch (error) {
                        alert('‚ùå Invalid backup file. Please select a valid TBFS backup file.\n\nError: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        /**
         * Clear all data
         */
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL data. Are you sure?\n\n' +
                        'This includes:\n' +
                        '‚Ä¢ All loans\n' +
                        '‚Ä¢ All clients\n' +
                        '‚Ä¢ All stockvel members\n' +
                        '‚Ä¢ All financial data\n' +
                        '‚Ä¢ All transaction history\n\n' +
                        'A backup will be automatically created before clearing.')) {
                return;
            }
            
            // Auto-backup before clearing
            console.log('üîÑ Auto-backup before clearing all data...');
            backupData();
            
            setTimeout(() => {
                // Clear localStorage
                localStorage.removeItem(AppStateManager.STORAGE_KEY);
                localStorage.removeItem('githubBackupToken');
                localStorage.removeItem('autoBackupEnabled');
                localStorage.removeItem('lastCloudSync');
                localStorage.removeItem('pendingCloudBackup');
                
                // Reset to default state
                AppState = AppStateManager.getDefaultState();
                AppStateManager.save(AppState);
                
                alert('‚úÖ All data cleared successfully.\n\nüîÑ A backup was automatically saved before clearing.\n\nReloading app...');
                
                // Reload page
                setTimeout(() => {
                    location.reload();
                }, 500);
            }, 500); // Small delay to ensure backup completes
        }
        
        // Hook into AppStateManager.save to trigger cloud backup
        const originalSave = AppStateManager.save;
        AppStateManager.save = function(state) {
            originalSave.call(this, state);
            // Trigger cloud backup after saving locally (only if auto-backup enabled)
            if (CloudBackup.autoBackupEnabled && CloudBackup.hasToken()) {
                // Update AppState reference
                AppState = state;
                CloudBackup.backup();
            }
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
