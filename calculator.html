<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Loan Calculator - TBFS</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Page-Specific Styles -->
    <style>
        .stockvel-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .stockvel-info h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stockvel-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .stockvel-info li {
            margin: 8px 0;
            color: #2c3e50;
        }
        
        .banking-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 30px 0;
            border: 2px solid #e0e6ed;
        }
        
        .banking-details h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .banking-account {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .banking-account p {
            margin: 5px 0;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s;
        }
        
        .results-section.visible {
            display: block;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .breakdown-table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .stockvel-only {
            display: none;
        }
        
        .stockvel-active .stockvel-only {
            display: table-cell;
        }
        
        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .banking-details {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div id="navigation-header"></div>
    
    <!-- Main Container -->
    <div class="container fade-in">
        <div class="page-content">
            <h1 class="mb-lg">üí≥ Loan Calculator</h1>
            
            <!-- Loan Application Form -->
            <div class="card">
                <h2 class="card-header">Loan Application Details</h2>
                <form id="loanForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">First Name:</label>
                            <input type="text" id="firstName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name:</label>
                            <input type="text" id="lastName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Account Number:</label>
                            <input type="text" id="accountNumber" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Member # (Optional):</label>
                            <input type="number" id="memberNumber" class="form-input" placeholder="e.g. 1001 - auto-fills stockvel data">
                            <small style="color: #7f8c8d; font-size: 11px;">üí° Enter Member # to auto-populate stockvel fields</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loan Amount (R):</label>
                            <input type="number" id="principal" class="form-input" min="100" step="100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loan Term (months):</label>
                            <input type="number" id="term" class="form-input" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Loan Disbursement Date:</label>
                            <input type="date" id="loanDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Month:</label>
                            <select id="startMonth" class="form-select" required>
                                <option value="">Select Month</option>
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="stockvelMember" onchange="toggleStockvelFields()">
                                <label for="stockvelMember">Stockvel Member</label>
                            </div>
                        </div>
                        
                        <!-- Stockvel Member Fields -->
                        <div id="stockvelFields" style="display: none; grid-column: 1 / -1;">
                            <div class="stockvel-info">
                                <h4>Stockvel Member Benefits</h4>
                                <ul>
                                    <li><strong>Initiation Fee:</strong> WAIVED up to contributions, 12% on excess (distributed over term)</li>
                                    <li><strong>Tiered Interest Rates:</strong> Based on loan amount vs. your contributions
                                        <ul style="margin-top: 5px; font-size: 12px;">
                                            <li>First 30% of contributions: 3%</li>
                                            <li>30-75% of contributions: 8%</li>
                                            <li>75-105% of contributions: 15%</li>
                                            <li>105-110% of contributions: 25%</li>
                                            <li>Above 110% of contributions: 30%</li>
                                        </ul>
                                    </li>
                                    <li><strong>10% Minimum Interest:</strong> Applied if tiered rate is below 10%</li>
                                    <li><strong>Admin Fee:</strong> R60 √ó (1 - interest rate)</li>
                                    <li><strong>Equal Monthly Payments:</strong> Total cost divided evenly across all months</li>
                                </ul>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Membership Start Date:</label>
                                    <input type="date" id="membershipStartDate" class="form-input" onchange="calculateMembershipEndDate()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Membership End Date:</label>
                                    <input type="date" id="membershipEndDate" class="form-input" readonly style="background: #f0f0f0; cursor: not-allowed;" title="Auto-calculated as start date + 12 months">
                                    <small style="color: #666; font-size: 11px;">Automatically calculated (12 months from start)</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Total Contributions to Date (R):</label>
                                    <input type="number" id="totalContributions" class="form-input" min="0" step="100" placeholder="Enter total amount contributed">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Monthly Contribution (R):</label>
                                    <input type="number" id="monthlyContribution" class="form-input" min="0" step="50" placeholder="Enter monthly contribution">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Accumulated Bonus (R):</label>
                                    <input type="number" id="accumulatedBonus" class="form-input" min="0" step="0.01" value="0" placeholder="Bonus from previous loans">
                                    <small style="color: #666; font-size: 11px;">Total bonus accumulated from all loans</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg mt-md">Calculate Loan Repayment</button>
                </form>
            </div>
            
            <!-- Results Section -->
            <div id="results" class="results-section">
                <div class="card">
                    <h2 class="card-header">Loan Repayment Summary</h2>
                    <div id="clientInfo" class="mb-md"></div>
                    
                    <div class="summary-grid">
                        <div class="summary-card">
                            <h3>Monthly Repayment</h3>
                            <div class="value" id="monthlyPayment">R 0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Cost</h3>
                            <div class="value" id="totalCost">R 0.00</div>
                        </div>
                        <div class="summary-card">
                            <h3>Number of Payments</h3>
                            <div class="value" id="numberOfPayments">0</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Interest</h3>
                            <div class="value" id="totalInterest">R 0.00</div>
                        </div>
                        <div class="summary-card" id="stockvelSummaryCard" style="display: none;">
                            <h3>Initiation Fee</h3>
                            <div class="value" id="initiationFeeDisplay">R 0.00</div>
                        </div>
                    </div>
                    
                    <h3 class="section-title mt-lg">Monthly Breakdown</h3>
                    <div class="breakdown-table-container">
                        <table class="table" id="breakdownTable">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Monthly Payment</th>
                                    <th>Principal Payment</th>
                                    <th>Interest</th>
                                    <th>Initiation Fee</th>
                                    <th>Admin Fee</th>
                                    <th>Outstanding Balance</th>
                                    <th class="stockvel-only">Bonus</th>
                                </tr>
                            </thead>
                            <tbody id="breakdownBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <button class="btn btn-warning mt-md" onclick="exportToExcel()">üìä Export to Excel</button>
                    
                    <!-- Banking Details -->
                    <div class="banking-details">
                        <h3>Banking Details</h3>
                        <p style="margin-bottom: 10px; color: #2c3e50;">To pay please use:</p>
                        <div class="banking-account">
                            <p><strong>Account Holder:</strong> Thaba Bosiu Financial Services</p>
                            <p><strong>Bank Name:</strong> TymeBank</p>
                            <p><strong>Branch Code:</strong> 678910</p>
                            <p><strong>Account Number:</strong> 53000021839</p>
                        </div>
                        <p style="color: #2c3e50; font-style: italic;">Please use your <strong>Name and Surname</strong> as the reference</p>
                    </div>
                    
                    <div class="mt-md">
                        <button class="btn btn-danger" onclick="generatePDF()">üìÑ Download PDF Report</button>
                        <button class="btn btn-success" style="margin-left: 10px;" onclick="acceptLoan()">‚úÖ Accept Loan & Add to System</button>
                    </div>
                    <div id="pdfStatus" class="mt-sm"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Shared Modules -->
    <script src="shared/app-state.js"></script>
    <script src="shared/calculations.js"></script>
    <script src="shared/navigation.js"></script>
    
    <!-- Page Logic -->
    <script>
        // Global state
        let AppState = {};
        let loanData = null;
        let currentYear = new Date().getFullYear();
        
        /**
         * Initialize page
         */
        function init() {
            // Load app state
            AppState = AppStateManager.load();
            
            // Initialize navigation
            NavigationManager.init('calculator');
            
            // Set default loan date to today
            document.getElementById('loanDate').valueAsDate = new Date();
            
            // Set up form handler
            document.getElementById('loanForm').addEventListener('submit', function(e) {
                e.preventDefault();
                calculateLoan();
            });
            
            // Set up member number lookup
            document.getElementById('memberNumber').addEventListener('change', loadMemberData);
            
            // Listen for state updates from other tabs
            AppStateManager.onUpdate(() => {
                console.log('State updated from another tab, reloading...');
                AppState = AppStateManager.load();
            });
            
            console.log('‚úÖ Calculator page initialized');
        }
        
        /**
         * Toggle stockvel fields
         */
        function toggleStockvelFields() {
            const isChecked = document.getElementById('stockvelMember').checked;
            const fields = document.getElementById('stockvelFields');
            fields.style.display = isChecked ? 'block' : 'none';
        }
        
        /**
         * Calculate membership end date
         */
        function calculateMembershipEndDate() {
            const startDate = document.getElementById('membershipStartDate').value;
            if (!startDate) return;
            
            const endDate = Calculations.calculateMembershipEndDate(startDate);
            document.getElementById('membershipEndDate').value = endDate;
        }
        
        /**
         * Load member data by member number
         */
        function loadMemberData() {
            const memberNumber = parseInt(document.getElementById('memberNumber').value);
            if (!memberNumber) return;
            
            const member = (AppState.stockvelMembers || []).find(m => m.memberNumber === memberNumber);
            if (!member) {
                alert('‚ùå Member not found');
                return;
            }
            
            // Auto-fill fields
            const [firstName, ...lastNameParts] = member.name.split(' ');
            document.getElementById('firstName').value = firstName || '';
            document.getElementById('lastName').value = lastNameParts.join(' ') || '';
            document.getElementById('accountNumber').value = member.phone || member.memberNumber;
            document.getElementById('stockvelMember').checked = true;
            toggleStockvelFields();
            document.getElementById('membershipStartDate').value = member.membershipStartDate || '';
            document.getElementById('membershipEndDate').value = member.membershipEndDate || '';
            document.getElementById('totalContributions').value = member.totalContributions || 0;
            document.getElementById('monthlyContribution').value = member.monthlyContribution || 0;
            document.getElementById('accumulatedBonus').value = member.accumulatedBonus || 0;
            
            alert(`‚úÖ Member data loaded: ${member.name}`);
        }
        
        /**
         * Calculate loan
         */
        function calculateLoan() {
            try {
                // Get form values
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const principal = parseFloat(document.getElementById('principal').value);
                const term = parseInt(document.getElementById('term').value);
                const loanDate = document.getElementById('loanDate').value;
                const startMonthIndex = parseInt(document.getElementById('startMonth').value);
                
                // Stockvel fields
                const isStockvelMember = document.getElementById('stockvelMember').checked;
                const totalContributions = isStockvelMember ? parseFloat(document.getElementById('totalContributions').value) || 0 : 0;
                const monthlyContribution = isStockvelMember ? parseFloat(document.getElementById('monthlyContribution').value) || 0 : 0;
                const membershipStartDate = isStockvelMember ? document.getElementById('membershipStartDate').value : '';
                const membershipEndDate = isStockvelMember ? document.getElementById('membershipEndDate').value : '';
                const accumulatedBonus = isStockvelMember ? parseFloat(document.getElementById('accumulatedBonus').value) || 0 : 0;
                
                // Validation
                if (!firstName || !lastName || !accountNumber || isNaN(startMonthIndex)) {
                    alert('‚ùå Please fill in all required fields including start month');
                    return;
                }
                
                if (isStockvelMember) {
                    if (!membershipStartDate || !membershipEndDate) {
                        alert('‚ùå Please enter membership dates');
                        return;
                    }
                    if (totalContributions === 0 && monthlyContribution === 0) {
                        alert('‚ùå Please enter your contribution amounts as a Stockvel member');
                        return;
                    }
                    
                    // Validate membership expiry
                    const today = new Date();
                    const membershipExpiry = new Date(membershipEndDate);
                    const monthsUntilExpiry = Math.floor((membershipExpiry - today) / (1000 * 60 * 60 * 24 * 30));
                    
                    if (monthsUntilExpiry < 1) {
                        alert('‚õî Membership has expired! Please renew membership before taking a loan.');
                        return;
                    }
                    
                    if (term > monthsUntilExpiry) {
                        alert(`‚õî Loan term too long!\n\nYour membership expires in ${monthsUntilExpiry} month(s).\nMaximum loan term: ${monthsUntilExpiry} month(s)\n\nPlease reduce the loan term or renew your membership first.`);
                        return;
                    }
                }
                
                if (isNaN(principal) || principal < 100) {
                    alert('‚ùå Minimum loan amount is R100');
                    return;
                }
                
                if (isNaN(term) || term < 1) {
                    alert('‚ùå Loan term must be at least 1 month');
                    return;
                }
                
                // Calculate loan
                let result;
                if (isStockvelMember) {
                    // Use stockvel calculation with tiered rates
                    const schedule = generateStockvelSchedule(principal, term, totalContributions, monthlyContribution, startMonthIndex);
                    
                    if (!schedule || schedule.length === 0) {
                        throw new Error('Failed to generate stockvel loan schedule');
                    }
                    
                    result = {
                        schedule: schedule,
                        totalInterest: schedule.reduce((sum, m) => sum + (m.interest_payment || 0), 0),
                        totalFees: schedule.reduce((sum, m) => sum + (m.admin_fee || 0) + (m.initiation_fee || 0), 0),
                        initiationFee: schedule[0] ? (schedule[0].initiation_fee || 0) * term : 0,
                        monthlyPayment: schedule[0] ? schedule[0].monthly_payment : 0
                    };
                } else {
                    // Standard loan calculation
                    const standardResult = Calculations.calculateStandardLoan(principal, term);
                    
                    if (!standardResult || !standardResult.breakdown) {
                        throw new Error('Failed to calculate standard loan');
                    }
                    
                    // Transform breakdown into schedule format
                    const schedule = standardResult.breakdown.map((item, index) => {
                        const dueDate = Calculations.calculateDueDate(currentYear, startMonthIndex, item.month);
                        return {
                            payment_number: item.month,
                            due_date: dueDate,
                            monthly_payment: item.totalPayment || standardResult.monthlyPayment,
                            principal_payment: item.principal,
                            interest_payment: item.interest,
                            admin_fee: item.adminFee,
                            initiation_fee: item.initiationFee,
                            outstanding_balance: item.outstandingBalance,
                            status: 'pending'
                        };
                    });
                    
                    result = {
                        schedule: schedule,
                        totalInterest: standardResult.totalInterest,
                        totalFees: standardResult.totalAdminFees + standardResult.totalInitiationFee,
                        initiationFee: standardResult.totalInitiationFee,
                        monthlyPayment: standardResult.monthlyPayment
                    };
                }
                
                // Store loan data
                loanData = {
                    firstName,
                    lastName,
                    accountNumber,
                    principal,
                    term,
                    loanDate,
                    startMonthIndex,
                    isStockvelMember,
                    totalContributions,
                    monthlyContribution,
                    membershipStartDate,
                    membershipEndDate,
                    accumulatedBonus,
                    schedule: result.schedule,
                    totalInterest: result.totalInterest,
                    totalFees: result.totalFees,
                    initiationFee: result.initiationFee || 0,
                    monthlyPayment: result.monthlyPayment
                };
                
                // Display results
                displayResults();
                
            } catch (error) {
                console.error('Calculation error:', error);
                alert(`‚ùå Calculation error: ${error.message}`);
            }
        }
        
        /**
         * Generate stockvel schedule with tiered rates
         */
        function generateStockvelSchedule(principal, term, totalContributions, monthlyContribution, startMonthIndex) {
            try {
                const schedule = [];
                let outstandingBalance = principal;
                let currentSavings = totalContributions || 0;
                
                // Calculate initiation fee
                const initiationFee = principal <= currentSavings ? 0 : (principal - currentSavings) * 0.12;
                const monthlyInitiationFee = initiationFee / term;
                
                // Calculate each month
                const monthlyDetails = [];
                for (let month = 1; month <= term; month++) {
                    if (month > 1) {
                        currentSavings += (monthlyContribution || 0);
                    }
                    
                    // Calculate tiered interest
                    const tieredResult = Calculations.calculateTieredStockvelInterest(outstandingBalance, currentSavings);
                    const principalPayment = principal / term;
                    
                    // Calculate interest payment with 10% minimum
                    let interestPayment = 0;
                    if (tieredResult && tieredResult.tiers1to4Interest !== undefined) {
                        const tieredInterest = tieredResult.tiers1to4Interest * (principal / outstandingBalance);
                        const minimumInterest = (principal / term) * 0.10;
                        interestPayment = Math.max(tieredInterest, minimumInterest);
                    } else {
                        // Fallback: 10% minimum
                        interestPayment = (principal / term) * 0.10;
                    }
                    
                    // Calculate admin fee
                    let adminFee = 60; // Default R60
                    if (tieredResult && tieredResult.tier1to4Amount > 0) {
                        const effectiveRate = tieredResult.tiers1to4Interest / tieredResult.tier1to4Amount;
                        adminFee = 60 * (1 - effectiveRate);
                    }
                    adminFee = Math.max(0, adminFee); // Ensure non-negative
                    
                    monthlyDetails.push({
                        month,
                        principal_payment: principalPayment,
                        interest_payment: interestPayment,
                        admin_fee: adminFee,
                        initiation_fee: monthlyInitiationFee
                    });
                    
                    outstandingBalance -= principalPayment;
                }
                
                // Calculate total and equal monthly payment
                const totalCost = monthlyDetails.reduce((sum, m) => 
                    sum + (m.principal_payment || 0) + (m.interest_payment || 0) + (m.admin_fee || 0) + (m.initiation_fee || 0), 0
                );
                const equalMonthlyPayment = totalCost / term;
                
                // Build final schedule
                let balance = principal;
                for (let i = 0; i < monthlyDetails.length; i++) {
                    const detail = monthlyDetails[i];
                    const dueDate = Calculations.calculateDueDate(currentYear, startMonthIndex, detail.month);
                    
                    schedule.push({
                        payment_number: detail.month,
                        due_date: dueDate,
                        monthly_payment: equalMonthlyPayment,
                        principal_payment: detail.principal_payment || 0,
                        interest_payment: detail.interest_payment || 0,
                        admin_fee: detail.admin_fee || 0,
                        initiation_fee: detail.initiation_fee || 0,
                        outstanding_balance: Math.max(0, balance - (detail.principal_payment || 0)),
                        bonus: (detail.interest_payment || 0) * 0.1, // 10% of interest
                        status: 'pending'
                    });
                    
                    balance -= (detail.principal_payment || 0);
                }
                
                return schedule;
            } catch (error) {
                console.error('Error generating stockvel schedule:', error);
                throw new Error('Failed to generate stockvel schedule: ' + error.message);
            }
        }
        
        /**
         * Display calculation results
         */
        function displayResults() {
            // Show results section
            document.getElementById('results').classList.add('visible');
            
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Display client info
            const clientInfo = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>Client:</strong> ${loanData.firstName} ${loanData.lastName} | 
                    <strong>Account:</strong> ${loanData.accountNumber} | 
                    <strong>Type:</strong> ${loanData.isStockvelMember ? 'Stockvel Member' : 'Standard Client'}
                </div>
            `;
            document.getElementById('clientInfo').innerHTML = clientInfo;
            
            // Display summary
            const totalCost = loanData.schedule.reduce((sum, p) => sum + p.monthly_payment, 0);
            document.getElementById('monthlyPayment').textContent = Calculations.formatCurrency(loanData.monthlyPayment);
            document.getElementById('totalCost').textContent = Calculations.formatCurrency(totalCost);
            document.getElementById('numberOfPayments').textContent = loanData.term;
            document.getElementById('totalInterest').textContent = Calculations.formatCurrency(loanData.totalInterest);
            
            // Show initiation fee card for stockvel
            if (loanData.isStockvelMember) {
                document.getElementById('stockvelSummaryCard').style.display = 'block';
                document.getElementById('initiationFeeDisplay').textContent = Calculations.formatCurrency(loanData.initiationFee);
                document.getElementById('breakdownTable').classList.add('stockvel-active');
            } else {
                document.getElementById('stockvelSummaryCard').style.display = 'none';
                document.getElementById('breakdownTable').classList.remove('stockvel-active');
            }
            
            // Display breakdown table
            const tbody = document.getElementById('breakdownBody');
            tbody.innerHTML = loanData.schedule.map(payment => `
                <tr>
                    <td>${Calculations.getMonthName(new Date(payment.due_date).getMonth())} ${new Date(payment.due_date).getFullYear()}</td>
                    <td style="font-weight: 600;">${Calculations.formatCurrency(payment.monthly_payment)}</td>
                    <td>${Calculations.formatCurrency(payment.principal_payment)}</td>
                    <td>${Calculations.formatCurrency(payment.interest_payment)}</td>
                    <td>${Calculations.formatCurrency(payment.initiation_fee || 0)}</td>
                    <td>${Calculations.formatCurrency(payment.admin_fee || 0)}</td>
                    <td>${Calculations.formatCurrency(payment.outstanding_balance)}</td>
                    ${loanData.isStockvelMember ? `<td style="color: #f39c12; font-weight: 600;">${Calculations.formatCurrency(payment.bonus || 0)}</td>` : ''}
                </tr>
            `).join('');
        }
        
        /**
         * Helper to load image as base64
         */
        function getBase64Image(imgUrl, callback) {
            var img = new window.Image();
            img.crossOrigin = '';
            img.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                var dataURL = canvas.toDataURL('image/png');
                callback(dataURL);
            };
            img.onerror = function() { callback(null); };
            img.src = imgUrl;
        }
        
        /**
         * Mobile-friendly PDF download helper
         */
        function downloadPDFMobileFriendly(doc, filename) {
            try {
                // Detect if on mobile device
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile) {
                    console.log('Mobile device detected - using blob URL method');
                    
                    // Create blob from PDF
                    const blob = doc.output('blob');
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // Try to open in new window/tab
                    const newWindow = window.open(blobUrl, '_blank');
                    
                    if (newWindow) {
                        console.log('PDF opened in new window for mobile viewing');
                        
                        // Show success message with instructions
                        alert('üìÑ PDF generated successfully!\n\nüì± The PDF has opened in a new tab.\n\nTo save it:\n‚Ä¢ Tap the share/download icon\n‚Ä¢ Choose "Save to Files" or "Download"\n\nThe PDF will then be saved to your device.');
                        
                        // Clean up blob URL after a delay
                        setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
                    } else {
                        // Popup blocked - try alternative method
                        console.log('Popup blocked - trying alternative method');
                        
                        // Create a download link
                        const link = document.createElement('a');
                        link.href = blobUrl;
                        link.download = filename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        
                        // Try to trigger download
                        link.click();
                        
                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(link);
                            URL.revokeObjectURL(blobUrl);
                        }, 100);
                        
                        alert('üìÑ PDF generated!\n\nüì± If the download didn\'t start automatically, please check your browser\'s download settings or allow pop-ups for this app.');
                    }
                } else {
                    // Desktop - use standard save method
                    console.log('Desktop device - using standard save method');
                    doc.save(filename);
                    console.log('PDF downloaded successfully:', filename);
                }
                
                return true;
            } catch (error) {
                console.error('Error in downloadPDFMobileFriendly:', error);
                
                // Final fallback - try standard save
                try {
                    doc.save(filename);
                    return true;
                } catch (fallbackError) {
                    console.error('Fallback save also failed:', fallbackError);
                    alert('‚ùå Failed to download PDF. Please try again or contact support.');
                    return false;
                }
            }
        }
        
        /**
         * Generate PDF report - Professional version
         */
        function generatePDF() {
            console.log('generatePDF function called');
            
            try {
                if (!loanData || !loanData.firstName) {
                    alert('‚ùå Please calculate a loan first before generating PDF');
                    return;
                }

                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF not loaded');
                    alert('‚ùå PDF generation library not loaded. Please refresh the page and try again.');
                    return;
                }

                // Load logo and then generate PDF
                getBase64Image('./TBFS_Logo.png', function(logoDataUrl) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    console.log('Creating PDF document');

                    // Set font
                    doc.setFont('helvetica');

                    // Header with logo
                    if (logoDataUrl) {
                        doc.addImage(logoDataUrl, 'PNG', 85, 5, 40, 40);
                    } else {
                        console.warn('Logo image could not be loaded - continuing without logo');
                    }
                    doc.setFontSize(18);
                    doc.setTextColor(44, 62, 80);
                    doc.text('THABA BOSIU FINANCIAL SERVICES', 105, 50, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Your Financial Refuge', 105, 57, { align: 'center' });

                    // Line separator
                    doc.setDrawColor(102, 126, 234);
                    doc.setLineWidth(0.5);
                    doc.line(20, 62, 190, 62);

                    // Client Information and Loan Summary
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    doc.text('Loan Details', 20, 70);
                    doc.text('Loan Summary', 105, 70);

                    // Left column - Client Info
                    doc.setFontSize(10);
                    doc.text(`Client Name: ${loanData.firstName} ${loanData.lastName}`, 20, 80);
                    doc.text(`Account Number: ${loanData.accountNumber}`, 20, 87);
                    doc.text(`Loan Amount: R ${loanData.principal.toFixed(2)}`, 20, 94);
                    doc.text(`Term: ${loanData.term} months`, 20, 101);
                    doc.text(`Start Month: ${Calculations.getMonthName(loanData.startMonthIndex)}`, 20, 108);
                    
                    if (loanData.isStockvelMember) {
                        doc.text(`Stockvel Member: Yes`, 20, 115);
                        doc.text(`Total Contributions: R ${loanData.totalContributions.toFixed(2)}`, 20, 122);
                        doc.text(`Monthly Contribution: R ${loanData.monthlyContribution.toFixed(2)}`, 20, 129);
                        
                        // Membership dates
                        if (loanData.membershipStartDate) {
                            const startDate = new Date(loanData.membershipStartDate).toLocaleDateString('en-ZA');
                            const endDate = loanData.membershipEndDate ? new Date(loanData.membershipEndDate).toLocaleDateString('en-ZA') : 'Not set';
                            doc.text(`Membership: ${startDate} to ${endDate}`, 20, 136);
                        }
                        
                        // Initiation fee
                        const initiationFeeText = loanData.initiationFee === 0 ? 
                            `Initiation Fee: R 0.00 (Waived)` : 
                            `Initiation Fee: R ${loanData.initiationFee.toLocaleString('en-ZA', {minimumFractionDigits: 2})}`;
                        doc.text(initiationFeeText, 20, 150);
                        
                        // Total admin fees
                        const totalAdminFees = loanData.schedule.reduce((sum, p) => sum + (p.admin_fee || 0), 0);
                        doc.text(`Total Admin Fees: R ${totalAdminFees.toFixed(2)}`, 20, 157);
                        
                        doc.setFontSize(10);
                        doc.setTextColor(44, 62, 80);
                    } else {
                        doc.text(`Initiation Fee: R ${loanData.initiationFee.toFixed(2)}`, 20, 115);
                        const adminFee = loanData.schedule[0] ? (loanData.schedule[0].admin_fee || 60) : 60;
                        doc.text(`Admin Fee: R ${adminFee.toFixed(2)} per month`, 20, 122);
                    }

                    // Right column - Loan Summary
                    const totalCost = loanData.schedule.reduce((sum, p) => sum + p.monthly_payment, 0);
                    doc.text(`Monthly Repayment: R ${loanData.monthlyPayment.toFixed(2)}`, 105, 80);
                    doc.text(`Total Cost: R ${totalCost.toFixed(2)}`, 105, 87);
                    doc.text(`Total Interest: R ${loanData.totalInterest.toFixed(2)}`, 105, 94);

                    // Banking Details
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    const bankingDetailsY = loanData.isStockvelMember ? 170 : 125;
                    doc.text('Banking Details', 20, bankingDetailsY);

                    doc.setFontSize(10);
                    doc.text('To pay please use:', 20, bankingDetailsY + 10);
                    doc.setFontSize(9);
                    doc.text(`Account Holder: Thaba Bosiu Financial Services`, 25, bankingDetailsY + 17);
                    doc.text(`Bank Name: TymeBank`, 25, bankingDetailsY + 24);
                    doc.text(`Branch Code: 678910`, 25, bankingDetailsY + 31);
                    doc.text(`Account Number: 53000021839`, 25, bankingDetailsY + 38);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Please use your Name and Surname as the reference', 25, bankingDetailsY + 45);
                    doc.setFont('helvetica', 'normal');

                    // Monthly breakdown table
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    const tableStartY = bankingDetailsY + 60;
                    doc.text('Monthly Payment Breakdown', 20, tableStartY);

                    // Table headers
                    doc.setFontSize(8);
                    const startY = tableStartY + 10;
                    const rowHeight = 7;
                    doc.setFillColor(44, 62, 80);
                    doc.setTextColor(255, 255, 255);
                    doc.rect(20, startY, 170, rowHeight, 'F');
                    
                    // Headers
                    doc.text('Month', 25, startY + 5);
                    doc.text('Payment', 45, startY + 5);
                    doc.text('Principal', 68, startY + 5);
                    doc.text('Interest', 92, startY + 5);
                    doc.text('Init Fee', 115, startY + 5);
                    doc.text('Admin', 138, startY + 5);
                    doc.text('Balance', 160, startY + 5);

                    // Table rows with month names - PAGE 1
                    doc.setTextColor(0, 0, 0);
                    let currentY = startY + rowHeight;
                    const page1AvailableHeight = 270 - currentY; // Leave room for footer
                    const maxRowsPage1 = Math.floor(page1AvailableHeight / rowHeight);
                    
                    // Render rows for page 1
                    let rowsRendered = 0;
                    for (let i = 0; i < Math.min(maxRowsPage1, loanData.schedule.length); i++) {
                        const payment = loanData.schedule[i];
                        if (i % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.rect(20, currentY, 170, rowHeight, 'F');
                        }
                        doc.setTextColor(0, 0, 0);
                        
                        // Format month name from due date
                        const dueDate = new Date(payment.due_date);
                        const monthName = Calculations.getMonthName(dueDate.getMonth());
                        
                        doc.text(monthName, 25, currentY + 5);
                        doc.text(`R${payment.monthly_payment.toFixed(2)}`, 45, currentY + 5);
                        doc.text(`R${payment.principal_payment.toFixed(2)}`, 68, currentY + 5);
                        doc.text(`R${payment.interest_payment.toFixed(2)}`, 92, currentY + 5);
                        doc.text(`R${(payment.initiation_fee || 0).toFixed(2)}`, 115, currentY + 5);
                        doc.text(`R${payment.admin_fee.toFixed(2)}`, 138, currentY + 5);
                        doc.text(`R${payment.outstanding_balance.toFixed(2)}`, 160, currentY + 5);
                        
                        currentY += rowHeight;
                        rowsRendered++;
                    }

                    // Footer for page 1
                    const today = new Date().toLocaleDateString('en-ZA');
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Generated on: ${today}`, 20, 280);
                    
                    if (rowsRendered < loanData.schedule.length) {
                        doc.text('Thaba Bosiu Financial Services - Your Financial Refuge', 105, 285, { align: 'center' });
                        doc.text('Page 1 of 2', 190, 280, { align: 'right' });
                        
                        // ADD PAGE 2 for remaining rows
                        doc.addPage();
                        
                        // Page 2 Header with logo
                        if (logoDataUrl) {
                            doc.addImage(logoDataUrl, 'PNG', 85, 5, 40, 40);
                        }
                        doc.setFontSize(18);
                        doc.setTextColor(44, 62, 80);
                        doc.text('THABA BOSIU FINANCIAL SERVICES', 105, 50, { align: 'center' });
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text('Your Financial Refuge', 105, 57, { align: 'center' });
                        
                        // Line separator
                        doc.setDrawColor(102, 126, 234);
                        doc.setLineWidth(0.5);
                        doc.line(20, 62, 190, 62);
                        
                        // Client info reminder
                        doc.setFontSize(10);
                        doc.setTextColor(44, 62, 80);
                        doc.text(`${loanData.firstName} ${loanData.lastName} - Account: ${loanData.accountNumber}`, 20, 70);
                        doc.text('Payment Schedule (continued)', 20, 77);
                        
                        // Table header on page 2
                        const page2StartY = 85;
                        doc.setFontSize(8);
                        doc.setFillColor(44, 62, 80);
                        doc.setTextColor(255, 255, 255);
                        doc.rect(20, page2StartY, 170, rowHeight, 'F');
                        
                        doc.text('Month', 25, page2StartY + 5);
                        doc.text('Payment', 45, page2StartY + 5);
                        doc.text('Principal', 68, page2StartY + 5);
                        doc.text('Interest', 92, page2StartY + 5);
                        doc.text('Init Fee', 115, page2StartY + 5);
                        doc.text('Admin', 138, page2StartY + 5);
                        doc.text('Balance', 160, page2StartY + 5);
                        
                        // Render remaining rows on page 2
                        let page2Y = page2StartY + rowHeight;
                        for (let i = rowsRendered; i < loanData.schedule.length; i++) {
                            const payment = loanData.schedule[i];
                            if ((i - rowsRendered) % 2 === 0) {
                                doc.setFillColor(248, 249, 250);
                                doc.rect(20, page2Y, 170, rowHeight, 'F');
                            }
                            doc.setTextColor(0, 0, 0);
                            
                            // Format month name from due date
                            const dueDate = new Date(payment.due_date);
                            const monthName = Calculations.getMonthName(dueDate.getMonth());
                            
                            doc.text(monthName, 25, page2Y + 5);
                            doc.text(`R${payment.monthly_payment.toFixed(2)}`, 45, page2Y + 5);
                            doc.text(`R${payment.principal_payment.toFixed(2)}`, 68, page2Y + 5);
                            doc.text(`R${payment.interest_payment.toFixed(2)}`, 92, page2Y + 5);
                            doc.text(`R${(payment.initiation_fee || 0).toFixed(2)}`, 115, page2Y + 5);
                            doc.text(`R${payment.admin_fee.toFixed(2)}`, 138, page2Y + 5);
                            doc.text(`R${payment.outstanding_balance.toFixed(2)}`, 160, page2Y + 5);
                            
                            page2Y += rowHeight;
                            
                            // Check if we need to stop (near bottom of page)
                            if (page2Y > 270) {
                                break;
                            }
                        }
                        
                        // Footer for page 2
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Generated on: ${today}`, 20, 280);
                        doc.text('Thaba Bosiu Financial Services - Your Financial Refuge', 105, 285, { align: 'center' });
                        doc.text('Page 2 of 2', 190, 280, { align: 'right' });
                    } else {
                        // All rows fit on page 1
                        doc.text('Thaba Bosiu Financial Services - Your Financial Refuge', 105, 285, { align: 'center' });
                        doc.text('Page 1 of 1', 190, 280, { align: 'right' });
                    }

                    // Save PDF using mobile-friendly method
                    const filename = `TBFS_Loan_Schedule_${loanData.accountNumber}.pdf`;
                    const success = downloadPDFMobileFriendly(doc, filename);

                    if (success) {
                        console.log('PDF generated successfully:', filename);

                        // Show success message (on desktop, mobile gets alert)
                        const statusEl = document.getElementById('pdfStatus');
                        if (statusEl && !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                            statusEl.innerHTML = '<p style="color: #27ae60; margin-top: 10px;">‚úÖ PDF downloaded successfully!</p>';
                            setTimeout(() => {
                                statusEl.innerHTML = '';
                            }, 5000);
                        }
                    }
                });
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå An error occurred while generating the PDF. Please try again.');
            }
        }
        
        /**
         * Export to Excel
         */
        function exportToExcel() {
            if (!loanData) {
                alert('‚ùå Please calculate a loan first');
                return;
            }
            
            const ws_data = [
                ['TBFS Loan Schedule'],
                [],
                ['Client', `${loanData.firstName} ${loanData.lastName}`],
                ['Account', loanData.accountNumber],
                ['Loan Amount', loanData.principal],
                ['Term', `${loanData.term} months`],
                ['Monthly Payment', loanData.monthlyPayment],
                [],
                ['Month', 'Payment', 'Principal', 'Interest', 'Initiation Fee', 'Admin Fee', 'Balance']
            ];
            
            loanData.schedule.forEach(payment => {
                ws_data.push([
                    `${Calculations.getMonthName(new Date(payment.due_date).getMonth())} ${new Date(payment.due_date).getFullYear()}`,
                    payment.monthly_payment,
                    payment.principal_payment,
                    payment.interest_payment,
                    payment.initiation_fee || 0,
                    payment.admin_fee || 0,
                    payment.outstanding_balance
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Loan Schedule');
            XLSX.writeFile(wb, `TBFS_Loan_Schedule_${loanData.accountNumber}_${Date.now()}.xlsx`);
            
            alert('‚úÖ Excel file downloaded!');
        }
        
        /**
         * Accept loan and add to system
         */
        function acceptLoan() {
            if (!loanData) {
                alert('‚ùå Please calculate a loan first before accepting it');
                return;
            }
            
            // Check available capital
            const availableCapital = AppState.capital || 0;
            if (loanData.principal > availableCapital) {
                alert(`‚ùå Insufficient capital!\n\nLoan Amount: ${Calculations.formatCurrency(loanData.principal)}\nAvailable: ${Calculations.formatCurrency(availableCapital)}\n\nPlease reduce the loan amount or add more capital.`);
                return;
            }
            
            // Check if client exists
            let client = (AppState.clients || []).find(c => c.account_number === loanData.accountNumber);
            
            if (client) {
                if (client.status !== 'active') {
                    alert(`‚õî SECURITY ALERT: Client ${loanData.accountNumber} is ${client.status.toUpperCase()}. Cannot approve loan for inactive clients.`);
                    return;
                }
                client.total_loans = (client.total_loans || 0) + 1;
            } else {
                // Create new client
                client = {
                    account_number: loanData.accountNumber,
                    first_name: loanData.firstName,
                    last_name: loanData.lastName,
                    phone_number: '',
                    client_type: loanData.isStockvelMember ? 'stockvel' : 'standard',
                    total_loans: 1,
                    total_contributions: loanData.totalContributions || 0,
                    total_repayment: 0,
                    status: 'active'
                };
                if (!AppState.clients) AppState.clients = [];
                AppState.clients.push(client);
            }
            
            // Calculate interest cap based on Math.ceil(term/2) with minimum 3 months
            // BUT cannot exceed the actual loan term (for 1-2 month loans)
            const calculatedMonths = Math.ceil(loanData.term / 2) >= 3 ? Math.ceil(loanData.term / 2) : 3;
            const interestMonths = Math.min(calculatedMonths, loanData.term);
            
            // Detect if this is a stockvel MEMBER loan (from separate registry)
            let memberNumber = null;
            let tieredRate = null;
            
            if (loanData.isStockvelMember) {
                // Try to find member by name and phone/account
                const memberName = `${loanData.firstName} ${loanData.lastName}`;
                const stockvelMembers = AppState.stockvelMembers || [];
                const possibleMember = stockvelMembers.find(m => 
                    m.name === memberName || 
                    m.phone === loanData.accountNumber
                );
                
                if (possibleMember) {
                    memberNumber = possibleMember.memberNumber;
                }
                
                // Calculate tiered rate for bonus calculation later
                if (loanData.totalContributions > 0) {
                    const tieredResult = Calculations.calculateTieredStockvelInterest(loanData.principal, loanData.totalContributions);
                    // Use tiers 1-4 interest only for bonus calculation
                    const tieredInterest = tieredResult.tiers1to4Interest;
                    tieredRate = loanData.totalContributions > 0 ? (tieredInterest / loanData.totalContributions) : 0;
                }
            }
            
            // Calculate total cost
            const totalCost = loanData.schedule.reduce((sum, p) => sum + p.monthly_payment, 0);
            
            // Create loan record with payment flexibility tracking
            const loan = {
                loan_id: (AppState.loans || []).length + 1,
                client_name: `${loanData.firstName} ${loanData.lastName}`,
                account_number: loanData.accountNumber,
                principal_amount: loanData.principal,
                original_principal: loanData.principal, // Track original for interest cap
                remaining_principal: loanData.principal, // Track remaining principal
                term_months: loanData.term,
                interest_calculation_months: interestMonths, // Store the interest period for cap
                monthly_payment: loanData.monthlyPayment,
                total_cost: totalCost,
                current_balance: totalCost,
                total_initiation_fee: loanData.initiationFee, // Total initiation fee
                initiation_fee_paid: 0, // Track how much initiation fee has been paid
                total_interest: loanData.totalInterest,
                max_interest_allowed: loanData.totalInterest, // Interest cap (based on Math.ceil(term/2) calculation)
                expected_monthly_interest: loanData.totalInterest / loanData.term, // Equalized monthly interest
                total_interest_charged: 0, // Track total interest charged so far
                interest_paid: 0, // Track interest payments
                loan_type: loanData.isStockvelMember ? 'stockvel' : 'standard',
                status: 'active',
                created_at: new Date(loanData.loanDate + 'T12:00:00').toISOString(), // Use custom loan date
                disbursement_date: loanData.loanDate,
                start_month_index: loanData.startMonthIndex, // Store start month for due date calculations
                schedule: loanData.schedule,
                payments_made: 0, // Track number of payments received
                total_contributions: loanData.totalContributions || 0,
                monthly_contribution: loanData.monthlyContribution || 0,
                accumulated_bonus: loanData.accumulatedBonus || 0,
                memberNumber: memberNumber, // Link to stockvel member registry (null if not stockvel)
                tieredRate: tieredRate, // Store tiered rate for bonus calculation (null if not stockvel)
                isStockvelLoan: loanData.isStockvelMember // Flag for easy identification
            };
            
            // Add loan to state
            if (!AppState.loans) AppState.loans = [];
            AppState.loans.push(loan);
            
            // Update capital
            AppState.capital = (AppState.capital || 0) - loanData.principal;
            AppState.deployed = (AppState.deployed || 0) + loanData.principal;
            
            // Save state
            AppStateManager.save(AppState);
            
            // Success message
            alert(`‚úÖ Loan Accepted Successfully!\n\nLoan ID: ${loan.loan_id}\nClient: ${loan.client_name}\nAmount: ${Calculations.formatCurrency(loan.principal_amount)}\n\nThe loan has been added to your system.`);
            
            // Clear form
            document.getElementById('loanForm').reset();
            document.getElementById('results').classList.remove('visible');
            loanData = null;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
