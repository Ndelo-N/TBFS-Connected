<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Clients - TBFS</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    
    <!-- Shared Styles -->
    <link rel="stylesheet" href="shared/styles.css">
    
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Page-Specific Styles -->
    <style>
        .client-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .client-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-defaulted {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-blacklisted {
            background: #212529;
            color: white;
        }
        
        .client-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .client-type-standard {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .client-type-stockvel {
            background: #fff3e0;
            color: #e65100;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-section select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .stats-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats-summary h3 {
            margin-bottom: 15px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .add-client-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .add-client-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .client-card {
                padding: 15px;
            }
            
            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div id="navigation-header"></div>
    
    <!-- Main Container -->
    <div class="container fade-in">
        <div class="page-content">
            <h1 class="mb-lg">üë• Client Management</h1>
            
            <!-- Stats Summary -->
            <div class="stats-summary">
                <h3>üìä Client Overview</h3>
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-value" id="totalClients">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Active</div>
                        <div class="stat-value" id="activeClients">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Blacklisted</div>
                        <div class="stat-value" id="blacklistedClients">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Defaulted</div>
                        <div class="stat-value" id="defaultedClients">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Add Client (optional - pre-register before loan) -->
            <div class="add-client-section">
                <h3>‚ûï Add New Client</h3>
                <p class="form-hint mb-md">Pre-register a client before they take a loan. Clients are also added automatically when you accept a loan from the Calculator.</p>
                <form id="addClientForm" class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                    <div class="form-group">
                        <label class="form-label">First Name:</label>
                        <input type="text" id="newClientFirstName" class="form-input" required placeholder="e.g. John">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Last Name:</label>
                        <input type="text" id="newClientLastName" class="form-input" required placeholder="e.g. Doe">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Number:</label>
                        <input type="text" id="newClientAccountNumber" class="form-input" required placeholder="e.g. ACC001">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-success">Add Client</button>
                    </div>
                </form>
            </div>
            
            <!-- Filter Section -->
            <div class="filter-section">
                <label><strong>Filter by Status:</strong></label>
                <select id="statusFilter" onchange="filterClients()">
                    <option value="all">All Clients</option>
                    <option value="active" selected>Active Only</option>
                    <option value="defaulted">Defaulted</option>
                    <option value="blacklisted">Blacklisted</option>
                </select>
                
                <label><strong>Filter by Type:</strong></label>
                <select id="typeFilter" onchange="filterClients()">
                    <option value="all">All Types</option>
                    <option value="standard">Standard Only</option>
                    <option value="stockvel">Stockvel Only</option>
                </select>
                
                <label><strong>Sort by:</strong></label>
                <select id="sortBy" onchange="filterClients()">
                    <option value="name">Name (A-Z)</option>
                    <option value="account">Account Number</option>
                    <option value="loans">Total Loans (high first)</option>
                </select>
                
                <button class="btn btn-primary" onclick="location.href='calculator.html'" style="margin-left: auto;">
                    üí≥ New Loan
                </button>
            </div>
            
            <!-- Export -->
            <div class="filter-section" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export to Excel</button>
            </div>
            
            <!-- Client Database Table -->
            <h3 class="card-header mt-lg">Client Database</h3>
            <div class="table-container">
                <table class="breakdown-table" id="clientsTable">
                    <thead>
                        <tr>
                            <th>Account Number</th>
                            <th>Client Name</th>
                            <th>Total Loans</th>
                            <th>Total Repayment</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Shared Modules -->
    <script src="shared/app-state.js"></script>
    <script src="shared/calculations.js"></script>
    <script src="shared/navigation.js"></script>
    
    <!-- Page Logic -->
    <script>
        // Global state
        let AppState = {};
        let allClients = [];
        let currentFilter = 'active';
        let currentSort = 'name';
        
        /**
         * Initialize page
         */
        function init() {
            AppState = AppStateManager.load();
            Navigation.init('clients');
            loadClients();
            
            // Listen for state updates from other tabs
            AppStateManager.onUpdate(() => {
                console.log('State updated from another tab, reloading...');
                AppState = AppStateManager.load();
                loadClients();
            });
            
            // Add client form
            document.getElementById('addClientForm').addEventListener('submit', handleAddClient);
            
            console.log('‚úÖ Clients page initialized');
        }
        
        /**
         * Load and display all clients
         */
        function loadClients() {
            allClients = AppState.clients || [];
            updateStats();
            filterClients();
        }
        
        /**
         * Update statistics
         */
        function updateStats() {
            const active = allClients.filter(c => c.status === 'active').length;
            const blacklisted = allClients.filter(c => c.status === 'blacklisted').length;
            const defaulted = allClients.filter(c => c.status === 'defaulted').length;
            
            // Unified Model: Show breakdown by type
            const standardClients = allClients.filter(c => (c.client_type || 'standard') === 'standard').length;
            const stockvelClients = allClients.filter(c => (c.client_type || 'standard') === 'stockvel').length;
            
            document.getElementById('totalClients').textContent = allClients.length;
            document.getElementById('activeClients').textContent = `${active} (${standardClients} std, ${stockvelClients} stockvel)`;
            document.getElementById('blacklistedClients').textContent = blacklisted;
            document.getElementById('defaultedClients').textContent = defaulted;
        }
        
        /**
         * Filter and sort clients
         */
        function filterClients() {
            currentFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            currentSort = document.getElementById('sortBy').value;
            
            let filtered = [...allClients];
            
            // Filter by status
            if (currentFilter !== 'all') {
                filtered = filtered.filter(c => c.status === currentFilter);
            }
            
            // Filter by type (unified model: show all clients, filter by type)
            if (typeFilter !== 'all') {
                filtered = filtered.filter(c => (c.client_type || 'standard') === typeFilter);
            }
            
            filtered.sort((a, b) => {
                switch (currentSort) {
                    case 'name':
                        const nameA = `${(a.first_name || '')} ${(a.last_name || '')}`.toLowerCase();
                        const nameB = `${(b.first_name || '')} ${(b.last_name || '')}`.toLowerCase();
                        return nameA.localeCompare(nameB);
                    case 'account':
                        return (a.account_number || '').localeCompare(b.account_number || '');
                    case 'loans':
                        return (b.total_loans || 0) - (a.total_loans || 0);
                    default:
                        return 0;
                }
            });
            
            displayClients(filtered);
        }
        
        /**
         * Display clients in table
         */
        function displayClients(clients) {
            const tbody = document.getElementById('clientsTableBody');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7f8c8d; padding: 40px;">No clients found. Add a client above or accept a loan from the Calculator.</td></tr>';
                return;
            }
            
            const loans = AppState.loans || [];
            
            tbody.innerHTML = clients.map(client => {
                const clientLoans = loans.filter(l => l.account_number === client.account_number);
                const totalLoanAmount = clientLoans.reduce((sum, l) => sum + (l.principal_amount || 0), 0);
                const totalRepayment = client.total_repayment || 0;
                const firstName = (client.first_name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const lastName = (client.last_name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const accountDisplay = (client.account_number || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const status = (client.status || 'active').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const accountForAttr = (client.account_number || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                // Unified Model: Show client type badge
                const clientType = client.client_type || 'standard';
                const typeBadge = clientType === 'stockvel' 
                    ? '<span class="client-type-badge client-type-stockvel">üéÅ Stockvel</span>'
                    : '<span class="client-type-badge client-type-standard">Standard</span>';
                
                // Get stockvel member info if applicable
                let memberInfo = '';
                if (clientType === 'stockvel' && client.memberNumber) {
                    const member = (AppState.stockvelMembers || []).find(m => m.memberNumber === client.memberNumber);
                    if (member) {
                        memberInfo = ` <small style="color: #7f8c8d;">(Member #${member.memberNumber})</small>`;
                    }
                }
                
                let actionsHtml = '';
                // Add New Loan button (always show)
                const firstNameForUrl = encodeURIComponent(client.first_name || '');
                const lastNameForUrl = encodeURIComponent(client.last_name || '');
                const accountForUrl = encodeURIComponent(client.account_number || '');
                actionsHtml += `<button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="addNewLoan('${firstNameForUrl}', '${lastNameForUrl}', '${accountForUrl}')">üí≥ New Loan</button> `;
                
                // Link to Stockvel page if stockvel member
                if (clientType === 'stockvel' && client.memberNumber) {
                    actionsHtml += `<button class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;" onclick="location.href='stockvel.html#member-${client.memberNumber}'">üéÅ View Member</button> `;
                } else if (clientType === 'standard') {
                    // Add Convert to Stockvel button for standard clients
                    actionsHtml += `<button class="btn" style="padding: 5px 10px; font-size: 12px; background: #f39c12; color: white;" onclick="convertToStockvelMember('${accountForAttr}')">üéÅ Convert to Stockvel</button> `;
                }
                
                if (status !== 'active') {
                    actionsHtml += `<button class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" onclick="updateClientStatus('${accountForAttr}', 'active')">‚úì Activate</button> `;
                }
                actionsHtml += `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="updateClientStatus('${accountForAttr}', 'defaulted')">‚ö† Mark Default</button> `;
                actionsHtml += `<button class="btn" style="padding: 5px 10px; font-size: 12px; background: #8e44ad; color: white;" onclick="updateClientStatus('${accountForAttr}', 'blacklisted')">üö´ Blacklist</button>`;
                
                return `
                    <tr>
                        <td><strong>${accountDisplay}</strong></td>
                        <td>${firstName} ${lastName}${typeBadge}${memberInfo}</td>
                        <td>R ${totalLoanAmount.toFixed(2)}</td>
                        <td>R ${totalRepayment.toFixed(2)}</td>
                        <td><span class="status-badge status-${status}">${status}</span></td>
                        <td><div style="display: flex; gap: 5px; flex-wrap: wrap;">${actionsHtml}</div></td>
                    </tr>
                `;
            }).join('');
        }
        
        /**
         * Update client status (active, defaulted, blacklisted)
         * Unified Model: Also syncs member status if stockvel client
         */
        function updateClientStatus(accountNumber, newStatus) {
            const client = AppState.clients.find(c => c.account_number === accountNumber);
            if (!client) {
                alert('Client not found');
                return;
            }
            
            if (newStatus === 'defaulted' || newStatus === 'blacklisted') {
                if (!confirm(`Are you sure you want to mark this client as ${newStatus.toUpperCase()}? Their active loans will also be updated.`)) {
                    return;
                }
            }
            
            const oldStatus = client.status;
            client.status = newStatus;
            
            // Unified Model: Sync member status if stockvel client
            if ((client.client_type || 'standard') === 'stockvel' && client.memberNumber) {
                const member = (AppState.stockvelMembers || []).find(m => m.memberNumber === client.memberNumber);
                if (member) {
                    member.status = newStatus;
                }
            }
            
            // If blacklisting or defaulting, update their active loans
            if (newStatus === 'blacklisted' || newStatus === 'defaulted') {
                const clientLoans = (AppState.loans || []).filter(l => l.account_number === accountNumber && l.status === 'active');
                clientLoans.forEach(loan => {
                    loan.status = newStatus;
                    AppState.deployed = (AppState.deployed || 0) - (loan.principal_amount || loan.remaining_principal || 0);
                });
            }
            
            // Recalculate deployed capital (in case of rounding)
            AppStateManager.recalculateDeployedCapital(AppState);
            
            AppStateManager.save(AppState);
            loadClients();
            
            const statusMessages = {
                'active': '‚úÖ Client activated',
                'defaulted': '‚ö†Ô∏è Client marked as defaulted',
                'blacklisted': 'üö´ Client blacklisted'
            };
            alert(statusMessages[newStatus] || 'Client status updated');
        }
        
        /**
         * Handle Add Client form submit
         */
        function handleAddClient(e) {
            e.preventDefault();
            
            const accountNumber = document.getElementById('newClientAccountNumber').value.trim();
            const firstName = document.getElementById('newClientFirstName').value.trim();
            const lastName = document.getElementById('newClientLastName').value.trim();
            
            if (!accountNumber || !firstName || !lastName) {
                alert('Please fill in all fields.');
                return;
            }
            
            const existing = (AppState.clients || []).find(c => c.account_number === accountNumber);
            if (existing) {
                alert(`A client with account number ${accountNumber} already exists.`);
                return;
            }
            
            const client = {
                account_number: accountNumber,
                first_name: firstName,
                last_name: lastName,
                total_loans: 0,
                total_repayment: 0,
                status: 'active'
            };
            
            if (!AppState.clients) AppState.clients = [];
            AppState.clients.push(client);
            AppStateManager.save(AppState);
            loadClients();
            
            document.getElementById('addClientForm').reset();
            alert(`‚úÖ Client ${firstName} ${lastName} added successfully.`);
        }
        
        /**
         * Navigate to calculator with client details pre-filled
         * For stockvel members, also includes membership details
         */
        function addNewLoan(firstName, lastName, accountNumber) {
            // Navigate to calculator with URL parameters
            const params = new URLSearchParams({
                firstName: firstName,
                lastName: lastName,
                accountNumber: accountNumber
            });
            
            // Check if client is stockvel member and add membership details
            const client = AppState.clients.find(c => c.account_number === accountNumber);
            
            if (client && (client.client_type || 'standard') === 'stockvel') {
                // Try multiple lookup strategies for stronger linking
                let member = null;
                let lookupStrategy = 'none';
                
                // Strategy 1: Find by account_number (strongest link - explicit account number)
                member = (AppState.stockvelMembers || []).find(m => m.account_number === accountNumber);
                if (member) {
                    lookupStrategy = 'account_number';
                }
                
                // Strategy 2: Find by memberNumber (if client has one)
                if (!member && client.memberNumber) {
                    member = (AppState.stockvelMembers || []).find(m => m.memberNumber === client.memberNumber);
                    if (member) {
                        lookupStrategy = 'memberNumber';
                    }
                }
                
                // Strategy 3: Find by phone as last resort
                if (!member) {
                    member = (AppState.stockvelMembers || []).find(m => m.phone === accountNumber);
                    if (member) {
                        lookupStrategy = 'phone';
                    }
                }
                
                
                if (member) {
                    // Check if membership has expired
                    if (member.membershipEndDate) {
                        // Get today's date in local timezone, set to midnight
                        const today = new Date();
                        const todayYear = today.getFullYear();
                        const todayMonth = today.getMonth();
                        const todayDay = today.getDate();
                        const todayMidnight = new Date(todayYear, todayMonth, todayDay, 0, 0, 0, 0);
                        
                        // Parse expiry date - handle YYYY-MM-DD format specifically to avoid timezone issues
                        let expiryDate;
                        const expiryStr = String(member.membershipEndDate);
                        
                        // Check if it's in YYYY-MM-DD format
                        if (/^\d{4}-\d{2}-\d{2}$/.test(expiryStr)) {
                            // Parse as local date to avoid timezone issues
                            const [year, month, day] = expiryStr.split('-').map(Number);
                            expiryDate = new Date(year, month - 1, day, 0, 0, 0, 0); // month is 0-indexed
                        } else {
                            // Try parsing as-is
                            expiryDate = new Date(expiryStr);
                            if (!isNaN(expiryDate.getTime())) {
                                // Set to midnight in local timezone
                                const expYear = expiryDate.getFullYear();
                                const expMonth = expiryDate.getMonth();
                                const expDay = expiryDate.getDate();
                                expiryDate = new Date(expYear, expMonth, expDay, 0, 0, 0, 0);
                            }
                        }
                        
                        // Check if date is valid
                        if (isNaN(expiryDate.getTime())) {
                            console.error('Invalid expiry date:', member.membershipEndDate);
                            // Treat as active if date is invalid (shouldn't happen)
                            params.append('isStockvelMember', 'true');
                            params.append('memberNumber', member.memberNumber.toString());
                            // Use current date as fallback
                            const startDate = new Date();
                            startDate.setMonth(startDate.getMonth() - 12);
                            params.append('membershipStartDate', startDate.toISOString().split('T')[0]);
                            params.append('membershipEndDate', Calculations.calculateMembershipEndDate(startDate.toISOString().split('T')[0]));
                            params.append('totalContributions', (member.totalContributions || 0).toString());
                            params.append('monthlyContribution', (member.monthlyContribution || 0).toString());
                            params.append('accumulatedBonus', (member.accumulatedBonus || 0).toString());
                        } else {
                            // Membership is expired if expiry date is before today (not including today)
                            // So membership is active if expiryDate >= today
                            // IMPORTANT: Compare dates correctly - expiryDate must be >= todayMidnight to be active
                            const isExpired = expiryDate.getTime() < todayMidnight.getTime();
                            const isActive = expiryDate.getTime() >= todayMidnight.getTime();
                            
                            // Only add stockvel details if membership is still active
                            const differenceMs = expiryDate.getTime() - todayMidnight.getTime();
                            const differenceDays = Math.floor(differenceMs / (1000 * 60 * 60 * 24));
                            
                            if (isActive) {
                                // Calculate start date from expiry date (membership period is always 12 months/1 year)
                                // End date = Start date + 1 year, so Start date = End date - 1 year
                                const startDate = new Date(
                                    expiryDate.getFullYear() - 1,
                                    expiryDate.getMonth(),
                                    expiryDate.getDate()
                                );
                                const startDateStr = startDate.toISOString().split('T')[0];
                                
                                // Add stockvel membership details
                                params.append('isStockvelMember', 'true');
                                params.append('memberNumber', member.memberNumber.toString());
                                params.append('membershipStartDate', startDateStr);
                                params.append('membershipEndDate', member.membershipEndDate);
                                params.append('totalContributions', (member.totalContributions || 0).toString());
                                params.append('monthlyContribution', (member.monthlyContribution || 0).toString());
                                params.append('accumulatedBonus', (member.accumulatedBonus || 0).toString());
                            } else {
                                // Membership expired - explicitly set to not be stockvel member
                                params.append('isStockvelMember', 'false');
                            }
                        }
                    } else {
                        // Member exists but no expiry date - treat as active (shouldn't happen, but handle gracefully)
                        const startDate = new Date();
                        startDate.setMonth(startDate.getMonth() - 12);
                        const startDateStr = startDate.toISOString().split('T')[0];
                        const endDate = Calculations.calculateMembershipEndDate(startDateStr);
                        params.append('isStockvelMember', 'true');
                        params.append('memberNumber', member.memberNumber.toString());
                        params.append('membershipStartDate', startDateStr);
                        params.append('membershipEndDate', endDate);
                        params.append('totalContributions', (member.totalContributions || 0).toString());
                        params.append('monthlyContribution', (member.monthlyContribution || 0).toString());
                        params.append('accumulatedBonus', (member.accumulatedBonus || 0).toString());
                    }
                } else {
                    // Client is stockvel but member not found - set to false
                    console.log('Client is stockvel but member not found - setting isStockvelMember=false');
                    params.append('isStockvelMember', 'false');
                }
            } else {
                // Client is not stockvel - explicitly set to false
                console.log('Client is not stockvel - setting isStockvelMember=false');
                params.append('isStockvelMember', 'false');
            }
            
            console.log('Final URL params:', params.toString());
            
            // Store comprehensive debug info in sessionStorage so we can see it after navigation
            // Reuse the client variable that was already found above
            const debugClient = AppState.clients.find(c => c.account_number === accountNumber);
            let debugMember = null;
            if (debugClient && debugClient.memberNumber) {
                debugMember = (AppState.stockvelMembers || []).find(m => m.memberNumber === debugClient.memberNumber);
            }
            // Also try finding by account_number/phone as fallback
            if (!debugMember && debugClient) {
                debugMember = (AppState.stockvelMembers || []).find(m => 
                    m.account_number === accountNumber || 
                    m.phone === accountNumber
                );
            }
            
            window.location.href = `calculator.html?${params.toString()}`;
        }
        
        /**
         * Unified Model: Sync function to ensure client and member are linked
         * Call this when client is stockvel type to ensure member entry exists
         */
        function syncClientToMember(client) {
            if ((client.client_type || 'standard') !== 'stockvel') return;
            
            if (!AppState.stockvelMembers) AppState.stockvelMembers = [];
            
            // Find member by memberNumber or account_number/phone
            let member = AppState.stockvelMembers.find(m => 
                m.memberNumber === client.memberNumber ||
                m.phone === client.account_number ||
                m.account_number === client.account_number
            );
            
            if (!member && client.memberNumber) {
                // Member should exist but doesn't - create placeholder
                member = {
                    memberNumber: client.memberNumber,
                    name: `${client.first_name || ''} ${client.last_name || ''}`.trim(),
                    phone: client.account_number,
                    account_number: client.account_number,
                    membershipStartDate: new Date().toISOString().split('T')[0],
                    membershipEndDate: Calculations.calculateMembershipEndDate(new Date().toISOString().split('T')[0]),
                    monthlyContribution: 0,
                    totalContributions: client.total_contributions || 0,
                    accumulatedBonus: 0,
                    registeredDate: new Date().toISOString(),
                    status: 'active'
                };
                AppState.stockvelMembers.push(member);
                AppStateManager.save(AppState);
                console.log('‚úÖ Created missing stockvel member entry for client:', client.account_number);
            } else if (member) {
                // Sync member data with client
                member.account_number = client.account_number;
                member.phone = client.account_number;
                if (!member.name || member.name === 'Unknown') {
                    member.name = `${client.first_name || ''} ${client.last_name || ''}`.trim();
                }
            }
        }
        
        /**
         * Convert a standard client to a Stockvel member
         * Unified Model: Creates stockvel member entry and updates client type
         */
        function convertToStockvelMember(accountNumber) {
            const client = AppState.clients.find(c => c.account_number === accountNumber);
            if (!client) {
                alert('‚ùå Client not found');
                return;
            }
            
            // Check if already stockvel
            if ((client.client_type || 'standard') === 'stockvel') {
                alert('‚úÖ This client is already a Stockvel member!');
                if (client.memberNumber) {
                    location.href = `stockvel.html#member-${client.memberNumber}`;
                }
                return;
            }
            
            // Check if member already exists
            if (!AppState.stockvelMembers) AppState.stockvelMembers = [];
            const existingMember = Calculations.findStockvelMember({
                phone: client.account_number,
                accountNumber: client.account_number,
                name: `${client.first_name || ''} ${client.last_name || ''}`.trim()
            }, AppState.stockvelMembers);
            
            if (existingMember) {
                // Member exists but client not linked - just link them
                client.client_type = 'stockvel';
                client.memberNumber = existingMember.memberNumber;
                AppStateManager.save(AppState);
                loadClients();
                alert(`‚úÖ Client linked to existing Stockvel member #${existingMember.memberNumber}!`);
                return;
            }
            
            // Prompt for membership details
            const membershipStartDate = prompt(
                'üìÖ Enter Membership Start Date (YYYY-MM-DD):\n\n' +
                'Leave blank to use today\'s date.',
                new Date().toISOString().split('T')[0]
            );
            
            if (membershipStartDate === null) {
                return; // User cancelled
            }
            
            const startDate = membershipStartDate.trim() || new Date().toISOString().split('T')[0];
            
            // Validate date
            if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
                alert('‚ùå Invalid date format. Please use YYYY-MM-DD');
                return;
            }
            
            const monthlyContribInput = prompt(
                'üí∞ Enter Monthly Contribution Amount (R):\n\n' +
                'This is the amount the member contributes each month.',
                '0'
            );
            
            if (monthlyContribInput === null) {
                return; // User cancelled
            }
            
            const monthlyContrib = parseFloat(monthlyContribInput) || 0;
            
            const initialContribInput = prompt(
                'üí∞ Enter Initial/Total Contributions to Date (R):\n\n' +
                'Leave blank or 0 if no contributions yet.',
                '0'
            );
            
            if (initialContribInput === null) {
                return; // User cancelled
            }
            
            const initialContrib = parseFloat(initialContribInput) || 0;
            
            const emailInput = prompt(
                'üìß Enter Email Address (optional):\n\n' +
                'Leave blank if not available.',
                ''
            );
            
            if (emailInput === null) {
                return; // User cancelled
            }
            
            const email = emailInput.trim();
            
            // Confirm conversion
            const confirmMsg = 
                `üìã Confirm Stockvel Membership Registration:\n\n` +
                `Client: ${client.first_name} ${client.last_name}\n` +
                `Account: ${client.account_number}\n` +
                `Start Date: ${startDate}\n` +
                `Monthly Contribution: R${monthlyContrib.toFixed(2)}\n` +
                `Initial Contributions: R${initialContrib.toFixed(2)}\n\n` +
                `Click OK to register as Stockvel member.`;
            
            if (!confirm(confirmMsg)) {
                return; // User cancelled
            }
            
            // Ensure arrays exist
            if (!AppState.stockvelMembers) AppState.stockvelMembers = [];
            if (!AppState.nextMemberNumber) AppState.nextMemberNumber = 1001;
            
            // Generate member number
            const memberNumber = AppState.nextMemberNumber++;
            
            // Calculate membership end date (12 months from start)
            const endDate = Calculations.calculateMembershipEndDate(startDate);
            
            // Create stockvel member entry
            const newMember = {
                memberNumber: memberNumber,
                name: `${client.first_name || ''} ${client.last_name || ''}`.trim(),
                phone: client.account_number,
                email: email,
                account_number: client.account_number,
                membershipStartDate: startDate,
                membershipEndDate: endDate,
                monthlyContribution: monthlyContrib,
                totalContributions: initialContrib,
                accumulatedBonus: 0,
                registeredDate: new Date().toISOString(),
                status: client.status || 'active'
            };
            
            AppState.stockvelMembers.push(newMember);
            
            // Update client to stockvel type
            client.client_type = 'stockvel';
            client.memberNumber = memberNumber;
            
            // Save state
            AppStateManager.save(AppState);
            loadClients();
            
            alert(
                `‚úÖ Client converted to Stockvel member!\n\n` +
                `Member #: ${memberNumber}\n` +
                `Name: ${newMember.name}\n` +
                `Membership Expires: ${new Date(endDate).toLocaleDateString()}\n\n` +
                `The client can now receive Stockvel loan benefits.`
            );
        }
        
        /**
         * Export clients to Excel
         */
        function exportToExcel() {
            const clients = AppState.clients || [];
            const loans = AppState.loans || [];
            
            const data = [
                ['Account Number', 'First Name', 'Last Name', 'Status', 'Total Loans', 'Total Loan Amount', 'Total Repayment']
            ];
            
            clients.forEach(client => {
                const clientLoans = loans.filter(l => l.account_number === client.account_number);
                const totalLoanAmount = clientLoans.reduce((sum, l) => sum + (l.principal_amount || 0), 0);
                data.push([
                    client.account_number || '',
                    client.first_name || '',
                    client.last_name || '',
                    client.status || 'active',
                    clientLoans.length,
                    totalLoanAmount.toFixed(2),
                    (client.total_repayment || 0).toFixed(2)
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Clients');
            XLSX.writeFile(wb, `TBFS_Clients_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('‚úÖ Client list exported to Excel!');
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
