<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="TBFS Ethical Lending - Dignity, No Harassment, Fair Rates">
    <title>TBFS - Enhanced Loan Management System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="TBFS Loan Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TBFS Loan Manager">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-config" content="/icons/browserconfig.xml">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    <link rel="shortcut icon" href="icons/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 50%;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .company-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 16px;
            opacity: 0.9;
            font-style: italic;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e6ed;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Swipe Navigation Styles */
        .tabs-container {
            position: relative;
            overflow: hidden;
            touch-action: pan-y; /* Allow vertical scrolling, detect horizontal swipes */
        }

        .tab-content.swipe-left {
            animation: slideOutLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .tab-content.swipe-right {
            animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .tab-content.slide-in-left {
            animation: slideInLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .tab-content.slide-in-right {
            animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideOutLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Swipe progress indicator */
        .swipe-indicator {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 48px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 1000;
        }

        .swipe-indicator.left {
            left: 30px;
        }

        .swipe-indicator.right {
            right: 30px;
        }

        .swipe-indicator.active {
            opacity: 0.5;
        }

        .swipe-indicator.ready {
            opacity: 1;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: translateY(-50%) scale(1);
            }
            50% {
                transform: translateY(-50%) scale(1.2);
            }
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .results-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .breakdown-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .breakdown-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e6ed;
        }

        .breakdown-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .breakdown-table tr:hover {
            background: #e3f2fd;
        }

        .pdf-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .loan-card {
            background: #f8f9fa;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .loan-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .loan-card .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #27ae60;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-overdue {
            background: #e74c3c;
            color: white;
        }

        .status-completed {
            background: #95a5a6;
            color: white;
        }

        .status-defaulted {
            background: #e74c3c;
            color: white;
        }

        .status-blacklisted {
            background: #8e44ad;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #27ae60;
            color: #155724;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
        }

        .stockvel-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #2c3e50;
        }

        .stockvel-info h4 {
            color: #27ae60;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stockvel-info ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .stockvel-info li {
            margin-bottom: 5px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e6ed;
            transition: all 0.3s ease;
        }

        .checkbox-container:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 15px;
            transform: scale(1.2);
        }

        .checkbox-container label {
            margin-bottom: 0;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .breakdown-table {
                font-size: 14px;
            }
            
            .breakdown-table th,
            .breakdown-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Update Available Banner -->
    <div id="updateBanner" style="display: none; background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <div style="flex: 1; min-width: 200px;">
                <strong>üéâ New Update Available!</strong>
                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.95;">A new version of TBFS is ready to install</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="activateUpdate()" style="background: white; color: #f39c12; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Update Now
                </button>
                <button onclick="dismissUpdateBanner()" style="background: transparent; color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Later
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo" style="background: none; box-shadow: none;">
                <img src="./TBFS_Logo.png" 
                     alt="TBFS Logo" 
                     style="width: 120px; height: 120px; display: block; margin: 0 auto; border-radius: 50%; background: #f8fbfd; border: 4px solid #e3e8ef; object-fit: contain;" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div id="logoFallback" style="display: none; width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;"> 
        TBFS 
    </div>
</div>
            <div class="company-name">Thaba Bosiu Financial Services</div>
            <div class="tagline">Your Financial Refuge</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="calculator">Loan Calculator</button>
            <button class="tab" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="clients">Clients</button>
            <button class="tab" data-tab="loans">Active Loans</button>
            <button class="tab" data-tab="reports">üìä Reports</button>
            <button class="tab" data-tab="income-table">üí∞ Income Table</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
        </div>

        <!-- Swipe Indicators -->
        <div class="swipe-indicator left" id="swipeLeftIndicator">‚óÄ</div>
        <div class="swipe-indicator right" id="swipeRightIndicator">‚ñ∂</div>

        <!-- Tabs Container for Swipe Detection -->
        <div class="tabs-container" id="tabsContainer">

        <!-- CALCULATOR TAB -->
        <div id="calculator" class="tab-content active">
            <div class="form-section">
                <h2 class="section-title">Loan Application Details</h2>
                <form id="loanForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstName">First Name:</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name:</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                        <div class="form-group">
                            <label for="accountNumber">Account Number:</label>
                            <input type="text" id="accountNumber" name="accountNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="principal">Loan Amount (R):</label>
                            <input type="number" id="principal" name="principal" min="100" step="100" required>
                        </div>
                        <div class="form-group">
                            <label for="term">Loan Term (months):</label>
                            <input type="number" id="term" name="term" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="loanDate">Loan Disbursement Date:</label>
                            <input type="date" id="loanDate" name="loanDate" required>
                        </div>
                        <div class="form-group">
                            <label for="startMonth">Start Month:</label>
                            <select id="startMonth" name="startMonth" required>
                                <option value="">Select Month</option>
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="stockvelMember" name="stockvelMember">
                                <label for="stockvelMember">Stockvel Member</label>
                            </div>
                        </div>
                        <div id="stockvelFields" style="display: none; grid-column: 1 / -1;">
                            <div class="stockvel-info">
                                <h4>Stockvel Member Benefits</h4>
                                <ul>
                                    <li><strong>Initiation Fee:</strong> WAIVED up to contributions, 12% on excess (distributed over term)</li>
                                    <li><strong>Interest Rates:</strong> Tiered calculation (3%-30%) with 10% minimum</li>
                                    <li><strong>Admin Fee:</strong> R60 √ó (1 - interest rate)</li>
                                    <li><strong>Membership Bonus:</strong> Difference between tiered rate and 10% minimum added to contributions after payment</li>
                                    <li><strong>Equal Monthly Payments:</strong> Total cost divided evenly across all months</li>
                                </ul>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="membershipStartDate">Membership Start Date:</label>
                                    <input type="date" id="membershipStartDate" name="membershipStartDate" placeholder="Select start date" onchange="calculateMembershipEndDate()">
                                </div>
                                <div class="form-group">
                                    <label for="membershipEndDate">Membership End Date:</label>
                                    <input type="date" id="membershipEndDate" name="membershipEndDate" readonly style="background: #f0f0f0; cursor: not-allowed;" title="Auto-calculated as start date + 12 months">
                                    <small style="color: #666; font-size: 11px;">Automatically calculated (12 months from start)</small>
                                </div>
                                <div class="form-group">
                                    <label for="totalContributions">Total Contributions to Date (R):</label>
                                    <input type="number" id="totalContributions" name="totalContributions" min="0" step="100" placeholder="Enter total amount contributed to date">
                                </div>
                                <div class="form-group">
                                    <label for="monthlyContribution">Monthly Contribution (R):</label>
                                    <input type="number" id="monthlyContribution" name="monthlyContribution" min="0" step="50" placeholder="Enter monthly contribution amount">
                                </div>
                                <div class="form-group">
                                    <label for="accumulatedBonus">Accumulated Bonus (R):</label>
                                    <input type="number" id="accumulatedBonus" name="accumulatedBonus" min="0" step="0.01" value="0" placeholder="Bonus from previous loans">
                                    <small style="color: #666; font-size: 11px;">Total bonus accumulated from all loans</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="calculate-btn">Calculate Loan Repayment</button>
                </form>
            </div>

            <div id="results" class="results-section">
                <h2 class="section-title">Loan Repayment Summary</h2>
                <div id="clientInfo"></div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Monthly Repayment</h3>
                        <div class="value" id="monthlyPayment">R 0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Cost</h3>
                        <div class="value" id="totalCost">R 0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Number of Payments</h3>
                        <div class="value" id="numberOfPayments">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Interest</h3>
                        <div class="value" id="totalInterest">R 0.00</div>
                    </div>
                    <div class="summary-card" id="stockvelSummaryCard" style="display: none;">
                        <h3>Initiation Fee</h3>
                        <div class="value" id="initiationFeeDisplay">R 0.00</div>
                    </div>
                </div>

                <h3 class="section-title">Monthly Breakdown</h3>
                <div style="overflow-x: auto;">
                    <table class="breakdown-table" id="breakdownTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Monthly Payment</th>
                                <th>Principal Payment</th>
                                <th>Interest</th>
                                <th>Initiation Fee</th>
                                <th>Admin Fee</th>
                                <th>Outstanding Balance</th>
                                <th class="stockvel-only" style="display: none;">Bonus</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownBody">
                        </tbody>
                    </table>
                </div>
                <button class="pdf-btn" style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); margin-top: 15px;" onclick="exportToExcel()">Export to Excel</button>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 30px 0; border: 2px solid #e0e6ed;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 18px;">Banking Details</h3>
                    <p style="margin-bottom: 10px; color: #2c3e50;">To pay please use:</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 5px;"><strong>Account Holder:</strong> Thaba Bosiu Financial Services</p>
                        <p style="margin-bottom: 5px;"><strong>Bank Name:</strong> TymeBank</p>
                        <p style="margin-bottom: 5px;"><strong>Branch Code:</strong> 678910</p>
                        <p style="margin-bottom: 5px;"><strong>Account Number:</strong> 53000021839</p>
                    </div>
                    <p style="color: #2c3e50; font-style: italic;">Please use your <strong>Name and Surname</strong> as the reference</p>
                </div>

                <button class="pdf-btn" onclick="generatePDF()">Download PDF Report</button>
                <button class="pdf-btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); margin-left: 10px;" onclick="acceptLoan()">‚úÖ Accept Loan & Add to System</button>
                <div id="pdfStatus"></div>
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content">
            <h2>Portfolio Overview</h2>
            
            <div id="dashboardAlerts"></div>

            <!-- Financial Overview -->
            <h3 class="section-title">üí∞ Financial Overview</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                    <h3>Account Balance</h3>
                    <div class="value" id="totalCapital">R 100,000</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Available in bank</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);">
                    <h3>Deployed</h3>
                    <div class="value" id="deployedCapital">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Currently loaned out</p>
                </div>
                <div class="stat-card">
                    <h3>Active Loans</h3>
                    <div class="value" id="activeLoans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Default Rate</h3>
                    <div class="value" id="defaultRate">0%</div>
                </div>
            </div>

            <!-- Profitability Metrics -->
            <h3 class="section-title" style="margin-top: 30px;">üìà Profitability & Earnings</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3>Total Interest Earned</h3>
                    <div class="value" id="totalInterestEarned">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Lifetime interest income</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3>Total Fees Earned</h3>
                    <div class="value" id="totalFeesEarned">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Admin + Initiation fees</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);">
                    <h3>Total Profit</h3>
                    <div class="value" id="totalProfit">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Interest + Fees</p>
                </div>
            </div>

            <!-- Profit Goal Progress -->
            <h3 class="section-title" style="margin-top: 30px;">üéØ Profit Goal Progress</h3>
            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Goal: R500,000</p>
                        <p style="margin: 5px 0 0 0; font-size: 32px; font-weight: bold; color: #2c3e50;" id="profitAmount">R 0</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Progress</p>
                        <p style="margin: 5px 0 0 0; font-size: 32px; font-weight: bold; color: #27ae60;" id="profitPercentage">0%</p>
                    </div>
                </div>
                <div style="background: #e0e6ed; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div id="profitProgressBar" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <p style="margin: 15px 0 0 0; color: #7f8c8d; font-size: 14px; text-align: center;" id="profitRemaining">R500,000 remaining to reach goal</p>
            </div>

            <!-- Loan Portfolio Stats -->
            <h3 class="section-title" style="margin-top: 30px;">üìä Loan Portfolio</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Loans</h3>
                    <div class="value" id="totalLoans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="value" id="completedLoans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Defaulted</h3>
                    <div class="value" id="defaultedLoans">0</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Data Management</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="backupData()">üì• Backup Data</button>
                <button class="btn" onclick="restoreData()">üì§ Restore Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>

            <!-- Transaction History Section -->
            <h3 class="section-title" style="margin-top: 30px;">üìú Transaction History</h3>
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Last 20 transactions</p>
                    <button class="btn" id="undoLastPaymentBtn" onclick="undoLastPayment()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 8px 16px; font-size: 14px; display: none;">
                        ‚Ü∂ Undo Last Payment
                    </button>
                </div>
                <div id="transactionHistoryList" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: #95a5a6; text-align: center; padding: 20px;">No transactions yet.</p>
                </div>
            </div>
        </div>

        <!-- CLIENTS TAB -->
        <div id="clients" class="tab-content">
            <h2>Client Management</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Clients</h3>
                    <div class="value" id="totalClients">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Clients</h3>
                    <div class="value" id="activeClients">0</div>
                </div>
                <div class="stat-card">
                    <h3>Blacklisted</h3>
                    <div class="value" id="blacklistedClients">0</div>
                </div>
                <div class="stat-card">
                    <h3>Defaulted</h3>
                    <div class="value" id="defaultedClients">0</div>
                </div>
            </div>

            <h3>Client Database</h3>
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="breakdown-table" id="clientsTable">
                    <thead>
                        <tr>
                            <th>Account Number</th>
                            <th>Client Name</th>
                            <th>Total Loans</th>
                            <th>Total Repayment</th>
                            <th>Current Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- LOANS TAB -->
        <div id="loans" class="tab-content">
            <h2>Active Loans</h2>
            <div id="loansList"></div>
        </div>

        <!-- REPORTS TAB -->
        <div id="reports" class="tab-content">
            <h2 class="section-title">üìä Business Reports & Analytics</h2>
            
            <!-- Report Period Selector -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üìÖ Report Period</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="btn" onclick="setReportPeriod('month')" id="periodMonth" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">This Month</button>
                    <button class="btn btn-secondary" onclick="setReportPeriod('quarter')" id="periodQuarter">This Quarter</button>
                    <button class="btn btn-secondary" onclick="setReportPeriod('year')" id="periodYear">This Year</button>
                    <button class="btn btn-secondary" onclick="setReportPeriod('all')" id="periodAll">All Time</button>
                    <button class="btn" onclick="generateReports()" style="margin-left: auto; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">üîÑ Refresh Reports</button>
                </div>
            </div>

            <!-- Summary Statistics -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üìà Financial Summary</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Revenue</h3>
                        <div class="value" id="reportTotalRevenue">R0.00</div>
                        <p style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">Interest + Fees</p>
                    </div>
                    <div class="stat-card">
                        <h3>Interest Earned</h3>
                        <div class="value" id="reportInterestEarned">R0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Fees Earned</h3>
                        <div class="value" id="reportFeesEarned">R0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Loans Disbursed</h3>
                        <div class="value" id="reportLoansDisbursed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Loan Size</h3>
                        <div class="value" id="reportAvgLoanSize">R0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Loan Term</h3>
                        <div class="value" id="reportAvgLoanTerm">0 months</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Visual Analytics</h3>
                
                <!-- Revenue Trend Chart -->
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">üìà Revenue Trend (Last 12 Months) - Actual Payments Received</h4>
                    <canvas id="revenueTrendChart" style="max-height: 350px;"></canvas>
                    <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d; text-align: center;">
                        <strong>Green:</strong> Total Revenue | <strong>Purple:</strong> Interest | <strong>Orange:</strong> Fees
                    </p>
                </div>

                <!-- Portfolio Breakdown Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Loan Type Distribution -->
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">ü•ß Loan Type Distribution</h4>
                        <canvas id="loanTypeChart" style="max-height: 250px;"></canvas>
                    </div>

                    <!-- Loan Status Distribution -->
                    <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">üìä Loan Status Breakdown</h4>
                        <canvas id="loanStatusChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Cash Flow Projections - NEW FEATURE v1.6 -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üí∞ Cash Flow Projections (Next 6 Months)</h3>
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                    <canvas id="cashFlowChart" style="max-height: 300px;"></canvas>
                    <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d; text-align: center;">
                        Projected cash flows based on scheduled loan payments from active loans
                    </p>
                </div>

                <!-- Cash Flow Summary Table -->
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">üìã Monthly Forecast Breakdown</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Month</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Principal</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Interest</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Fees</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;"><strong>Total Inflow</strong></th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6;">Loans Due</th>
                                </tr>
                            </thead>
                            <tbody id="cashFlowTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr style="background: #e8f5e9; font-weight: bold;">
                                    <td style="padding: 12px; border-top: 2px solid #dee2e6;">6-Month Total</td>
                                    <td style="padding: 12px; text-align: right; border-top: 2px solid #dee2e6;" id="totalPrincipal">R0.00</td>
                                    <td style="padding: 12px; text-align: right; border-top: 2px solid #dee2e6;" id="totalInterest">R0.00</td>
                                    <td style="padding: 12px; text-align: right; border-top: 2px solid #dee2e6;" id="totalFees">R0.00</td>
                                    <td style="padding: 12px; text-align: right; border-top: 2px solid #dee2e6;" id="totalInflow">R0.00</td>
                                    <td style="padding: 12px; text-align: right; border-top: 2px solid #dee2e6;" id="totalPayments">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üéØ Performance Metrics</h3>
                
                <!-- Current Metrics Cards -->
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">Return on Capital Deployed (ROCD)</p>
                            <p style="font-size: 24px; font-weight: bold; color: #27ae60;" id="reportROCD">0%</p>
                            <p style="font-size: 12px; color: #27ae60; margin-top: 5px;" id="rocdTrend">‚Üë Trending</p>
                        </div>
                        <div>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">Default Rate</p>
                            <p style="font-size: 24px; font-weight: bold; color: #e74c3c;" id="reportDefaultRate">0%</p>
                        </div>
                        <div>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">Portfolio Utilization</p>
                            <p style="font-size: 24px; font-weight: bold; color: #3498db;" id="reportUtilization">0%</p>
                        </div>
                        <div>
                            <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 5px;">Avg Client Lifetime Value</p>
                            <p style="font-size: 24px; font-weight: bold; color: #9b59b6;" id="reportCLV">R0.00</p>
                        </div>
                    </div>
                </div>

                <!-- ROCD Trend Chart - NEW v1.6 -->
                <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">üìà ROCD Performance Trend (Last 12 Months)</h4>
                    <canvas id="rocdTrendChart" style="max-height: 300px;"></canvas>
                    <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d; text-align: center;">
                        Track your return on capital deployed over time - Higher is better!
                    </p>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div>
                            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">Best Month</p>
                            <p style="font-size: 16px; font-weight: bold; color: #27ae60;" id="bestROCD">-</p>
                        </div>
                        <div>
                            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">Worst Month</p>
                            <p style="font-size: 16px; font-weight: bold; color: #e74c3c;" id="worstROCD">-</p>
                        </div>
                        <div>
                            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">Average ROCD</p>
                            <p style="font-size: 16px; font-weight: bold; color: #3498db;" id="avgROCD">-</p>
                        </div>
                        <div>
                            <p style="font-size: 12px; color: #7f8c8d; margin-bottom: 3px;">Current vs Avg</p>
                            <p style="font-size: 16px; font-weight: bold;" id="rocdComparison">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üì• Export Reports</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="exportReportPDF()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">üìÑ Export to PDF</button>
                    <button class="btn" onclick="exportReportExcel()" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">üìä Export to Excel</button>
                    <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print Report</button>
                </div>
            </div>
        </div>

        <!-- INCOME TABLE TAB -->
        <div id="income-table" class="tab-content">
            <iframe src="loan-income-calculator.html" style="width: 100%; height: 90vh; border: none; border-radius: 10px;"></iframe>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <h2 class="section-title">‚öôÔ∏è Settings</h2>
            
            <!-- App Version & Updates Section -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üì± App Version & Updates</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Current Version</p>
                            <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #2c3e50;" id="currentVersion">v1.2.0</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #95a5a6;" id="updateStatus">Checking for updates...</p>
                        </div>
                        <button class="btn" onclick="checkForUpdates()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px;">
                            üîÑ Check for Updates
                        </button>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <strong style="color: #27ae60;">üí° How Updates Work:</strong>
                    <ul style="margin: 10px 0 0 20px; color: #2c3e50; font-size: 14px;">
                        <li>Updates download automatically in the background</li>
                        <li>Click "Update Now" or close and reopen the app to apply</li>
                        <li>Your data is always safe during updates</li>
                    </ul>
                </div>
            </div>
            
            <h3 class="section-title">‚òÅÔ∏è Cloud Backup Settings</h3>
            
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üîê GitHub Cloud Backup</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Automatically backup your data to a private GitHub repository. Your data syncs across all devices and works offline.</p>
                
                <div id="tokenConfigured" style="display: none;">
                    <div style="padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #f0f4ff; border: 2px solid #667eea;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong style="color: #667eea;">üîê GitHub Token Configured</strong>
                                <p style="margin: 5px 0 0 0; font-size: 14px; color: #2c3e50;">
                                    You can now restore from cloud
                                </p>
                            </div>
                            <button class="btn btn-danger" onclick="removeToken()">Remove Token</button>
                        </div>
                    </div>
                    
                    <div class="checkbox-container" style="margin-bottom: 20px;">
                        <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()">
                        <label for="autoBackupToggle" style="cursor: pointer;">
                            <strong>Enable Auto-Backup on This Device</strong>
                            <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                                When enabled, every change automatically syncs to cloud. Leave OFF if this is a secondary device.
                            </div>
                        </label>
                    </div>
                    
                    <div id="autoBackupStatus" style="padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #e8f5e8; border: 2px solid #27ae60; display: none;">
                        <strong style="color: #27ae60;">‚úÖ Auto-Backup Active</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #2c3e50;">
                            Last sync: <span id="lastSyncTime">Never</span>
                        </p>
                    </div>
                </div>

                <div id="cloudBackupSetup" style="display: block;">
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token:</label>
                        <input type="password" id="githubToken" placeholder="github_pat_xxxxx..." 
                               style="font-family: monospace; font-size: 14px;">
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            ‚ÑπÔ∏è Your token is encrypted and stored securely on your device only. Never shared or exposed.
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="backupRepoUrl">Backup Repository URL:</label>
                        <input type="text" id="backupRepoUrl" 
                               value="https://github.com/Ndelo-N/TBFS-Data-Backup.git" readonly
                               style="background: #f8f9fa; font-family: monospace; font-size: 14px;">
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            ‚ÑπÔ∏è Ensure this is your PRIVATE backup repository.
                        </p>
                    </div>

                    <button class="calculate-btn" onclick="saveToken()">
                        üîê Save Token & Configure
                    </button>
                </div>

                <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 5px;">
                    <strong style="color: #856404;">üìã How to Get Your Token:</strong>
                    <ol style="margin: 10px 0 0 20px; color: #856404;">
                        <li>Go to: <code>github.com/settings/tokens</code></li>
                        <li>Click "Generate new token" ‚Üí "Fine-grained token"</li>
                        <li>Give access ONLY to <code>TBFS-Data-Backup</code> repo</li>
                        <li>Enable "Contents: Read and write" permission</li>
                        <li>Copy token and paste above</li>
                    </ol>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="color: #2c3e50;">Cloud Backup Features:</h4>
                    <ul style="color: #7f8c8d; line-height: 1.8;">
                        <li>‚úÖ Auto-sync on every data change</li>
                        <li>‚úÖ Works offline - queues changes, syncs when online</li>
                        <li>‚úÖ Access from any device</li>
                        <li>‚úÖ Daily snapshots kept for 30 days</li>
                        <li>‚úÖ One-click restore</li>
                        <li>‚úÖ Completely free (uses your private GitHub repo)</li>
                    </ul>
                </div>
            </div>

            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üîÑ Manual Backup</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Download or restore backups manually.</p>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="backupData()">üì• Download Local Backup</button>
                    <button class="btn" onclick="restoreData()">üì§ Restore from File</button>
                    <button class="btn" style="background: #27ae60;" onclick="restoreFromCloud()">‚òÅÔ∏è Restore from Cloud</button>
                </div>
            </div>
        </div>

        </div> <!-- End tabs-container -->
    </div>

    <script>
        // App Version
        const APP_VERSION = '1.6.0'; // Enhanced Reports & Analytics - Advanced Charts, Cash Flow Projections, ROCD Trends, Multi-Sheet Excel, Comprehensive PDF
        
        // App State Management
        const AppState = {
            capital: 100000, // Account balance (what's in the bank)
            deployed: 0, // Amount currently loaned out
            totalInterestEarned: 0, // Lifetime interest earned
            totalFeesEarned: 0, // Lifetime fees earned (admin + initiation)
            profitGoal: 500000, // Business profit goal
            clients: [],
            loans: [],
            transactionHistory: [], // Track all changes
            nextAccountNumber: 2025001,
            
            init() {
                this.loadFromStorage();
                this.updateDashboard();
            },
            
            loadFromStorage() {
                const saved = localStorage.getItem('tbfsAppState');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.capital = data.capital || 100000;
                    this.deployed = data.deployed || 0;
                    this.totalInterestEarned = data.totalInterestEarned || 0;
                    this.totalFeesEarned = data.totalFeesEarned || 0;
                    this.profitGoal = data.profitGoal || 500000;
                    this.clients = data.clients || [];
                    this.loans = data.loans || [];
                    this.transactionHistory = data.transactionHistory || [];
                    this.nextAccountNumber = data.nextAccountNumber || 2025001;
                }
            },
            
            save() {
                localStorage.setItem('tbfsAppState', JSON.stringify({
                    capital: this.capital,
                    deployed: this.deployed,
                    totalInterestEarned: this.totalInterestEarned,
                    totalFeesEarned: this.totalFeesEarned,
                    profitGoal: this.profitGoal,
                    clients: this.clients,
                    loans: this.loans,
                    transactionHistory: this.transactionHistory,
                    nextAccountNumber: this.nextAccountNumber
                }));
            },
            
            // Add transaction to history (keeps last 20)
            logTransaction(type, description, details = {}) {
                const transaction = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: type, // 'payment', 'loan_created', 'client_status', 'system'
                    description: description,
                    details: details
                };
                
                this.transactionHistory.unshift(transaction); // Add to beginning
                
                // Keep only last 20 transactions
                if (this.transactionHistory.length > 20) {
                    this.transactionHistory = this.transactionHistory.slice(0, 20);
                }
                
                this.save();
            },
            
            addClient(client) {
                this.clients.push(client);
                this.save();
                this.updateDashboard();
            },
            
            addLoan(loan) {
                this.loans.push(loan);
                this.deployed += loan.principal_amount;
                this.save();
                this.updateDashboard();
            },
            
            updateDashboard() {
                // Data validation and cleanup
                this.validateAndFixData();
                
                // Comprehensive financial recalculation (fixes accumulated errors)
                this.recalculateFinancialState();
                
                // Financial Overview
                document.getElementById('totalCapital').textContent = `R ${this.capital.toLocaleString()}`;
                document.getElementById('deployedCapital').textContent = `R ${this.deployed.toLocaleString()}`;
                document.getElementById('activeLoans').textContent = this.loans.filter(l => l.status === 'active').length;
                
                // Profitability Metrics
                document.getElementById('totalInterestEarned').textContent = `R ${this.totalInterestEarned.toLocaleString()}`;
                document.getElementById('totalFeesEarned').textContent = `R ${this.totalFeesEarned.toLocaleString()}`;
                
                const totalProfit = this.totalInterestEarned + this.totalFeesEarned;
                document.getElementById('totalProfit').textContent = `R ${totalProfit.toLocaleString()}`;
                
                // Profit Goal Progress
                const profitPercentage = Math.min(100, (totalProfit / this.profitGoal * 100)).toFixed(1);
                const profitRemaining = Math.max(0, this.profitGoal - totalProfit);
                
                document.getElementById('profitAmount').textContent = `R ${totalProfit.toLocaleString()}`;
                document.getElementById('profitPercentage').textContent = `${profitPercentage}%`;
                document.getElementById('profitProgressBar').style.width = `${profitPercentage}%`;
                
                if (profitRemaining > 0) {
                    document.getElementById('profitRemaining').textContent = `R${profitRemaining.toLocaleString()} remaining to reach goal`;
                } else {
                    document.getElementById('profitRemaining').textContent = `üéâ Goal achieved! Exceeded by R${(totalProfit - this.profitGoal).toLocaleString()}`;
                    document.getElementById('profitRemaining').style.color = '#27ae60';
                    document.getElementById('profitRemaining').style.fontWeight = 'bold';
                }
                
                // Loan Portfolio Stats
                document.getElementById('totalLoans').textContent = this.loans.length;
                document.getElementById('completedLoans').textContent = this.loans.filter(l => l.status === 'completed').length;
                document.getElementById('defaultedLoans').textContent = this.loans.filter(l => l.status === 'defaulted').length;
                document.getElementById('totalClients').textContent = this.clients.length;
                
                const completed = this.loans.filter(l => l.status === 'completed' || l.status === 'defaulted').length;
                const defaulted = this.loans.filter(l => l.status === 'defaulted').length;
                const defaultRate = completed > 0 ? ((defaulted / completed) * 100).toFixed(1) : 0;
                document.getElementById('defaultRate').textContent = `${defaultRate}%`;
                
                this.checkRedFlags();
                this.updateClientsList();
                this.updateLoansList();
                this.updateTransactionHistory();
            },
            
            updateTransactionHistory() {
                const container = document.getElementById('transactionHistoryList');
                const undoBtn = document.getElementById('undoLastPaymentBtn');
                
                if (this.transactionHistory.length === 0) {
                    container.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 20px;">No transactions yet.</p>';
                    undoBtn.style.display = 'none';
                    return;
                }
                
                // Show undo button if last transaction was a payment
                const lastTransaction = this.transactionHistory[0];
                if (lastTransaction && lastTransaction.type === 'payment') {
                    undoBtn.style.display = 'inline-block';
                } else {
                    undoBtn.style.display = 'none';
                }
                
                let html = '';
                this.transactionHistory.forEach(tx => {
                    const date = new Date(tx.timestamp);
                    const timeStr = date.toLocaleString('en-ZA', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    let icon = 'üìù';
                    let color = '#3498db';
                    
                    switch(tx.type) {
                        case 'payment':
                            icon = 'üí∞';
                            color = '#27ae60';
                            break;
                        case 'loan_created':
                            icon = 'üìã';
                            color = '#f39c12';
                            break;
                        case 'client_status':
                            icon = '‚ö†Ô∏è';
                            color = '#e74c3c';
                            break;
                        case 'system':
                            icon = '‚öôÔ∏è';
                            color = '#95a5a6';
                            break;
                    }
                    
                    html += `
                        <div style="border-bottom: 1px solid #ecf0f1; padding: 12px 0;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 24px;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #2c3e50; margin-bottom: 4px;">${tx.description}</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">${timeStr}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            validateAndFixData() {
                // Recalculate deployed capital from active loans (fixes accumulated errors)
                const calculatedDeployed = this.loans
                    .filter(l => l.status === 'active')
                    .reduce((sum, loan) => {
                        const remaining = loan.remaining_principal || loan.principal_amount;
                        return sum + remaining;
                    }, 0);
                
                // Round to 2 decimal places
                const roundedDeployed = Math.round(calculatedDeployed * 100) / 100;
                
                if (Math.abs(this.deployed - roundedDeployed) > 0.05) {
                    console.warn(`Fixed deployed capital mismatch: ${this.deployed} ‚Üí ${roundedDeployed}`);
                    this.deployed = roundedDeployed;
                }
                
                // Fix negative deployed capital
                if (this.deployed < 0) {
                    console.warn('Fixed negative deployed capital:', this.deployed);
                    this.deployed = 0;
                }
                
                // Fix completed loans with outstanding balances
                this.loans.forEach(loan => {
                    if (loan.status === 'completed') {
                        if (loan.current_balance > 0) {
                            console.warn(`Fixed completed loan #${loan.loan_id} with balance:`, loan.current_balance);
                            loan.current_balance = 0;
                        }
                        if (loan.remaining_principal > 0) {
                            console.warn(`Fixed completed loan #${loan.loan_id} with remaining principal:`, loan.remaining_principal);
                            loan.remaining_principal = 0;
                        }
                    }
                    
                    // Round loan amounts to 2 decimal places to fix floating-point errors
                    if (loan.remaining_principal) {
                        loan.remaining_principal = Math.round(loan.remaining_principal * 100) / 100;
                    }
                    if (loan.current_balance) {
                        loan.current_balance = Math.round(loan.current_balance * 100) / 100;
                    }
                });
                
                // Ensure capital is never negative
                if (this.capital < 0) {
                    console.warn('Fixed negative capital:', this.capital);
                    this.capital = 0;
                }
                
                // Round capital values to 2 decimal places
                this.capital = Math.round(this.capital * 100) / 100;
                this.deployed = Math.round(this.deployed * 100) / 100;
                this.totalInterestEarned = Math.round(this.totalInterestEarned * 100) / 100;
                this.totalFeesEarned = Math.round(this.totalFeesEarned * 100) / 100;
                
                // Save fixes
                this.save();
            },
            
            // Advanced Interest Management System
            calculateAdvancedInterest(loan, asOfDate = new Date()) {
                const loanStartDate = new Date(loan.created_at);
                const monthsElapsed = Math.max(1, this.getMonthsDifference(loanStartDate, asOfDate));
                
                // Calculate declining balance interest for elapsed months
                let totalInterestIncurred = 0;
                let currentBalance = loan.original_principal || loan.principal_amount;
                const monthlyPrincipal = currentBalance / loan.term_months;
                
                for (let month = 1; month <= monthsElapsed; month++) {
                    const monthlyInterest = currentBalance * 0.15; // 15% per month
                    totalInterestIncurred += monthlyInterest;
                    currentBalance = Math.max(0, currentBalance - monthlyPrincipal);
                }
                
                // Apply 100% cap (never exceed principal)
                const maxAllowedInterest = loan.original_principal || loan.principal_amount;
                totalInterestIncurred = Math.min(totalInterestIncurred, maxAllowedInterest);
                
                // Calculate late penalties
                const latePenalties = this.calculateLatePenalties(loan, asOfDate);
                
                return {
                    totalInterestIncurred: totalInterestIncurred,
                    latePenalties: latePenalties,
                    totalOwed: totalInterestIncurred + latePenalties,
                    monthsElapsed: monthsElapsed,
                    isCapped: totalInterestIncurred >= maxAllowedInterest
                };
            },
            
            calculateLatePenalties(loan, asOfDate = new Date()) {
                const loanStartDate = new Date(loan.created_at);
                const monthlyPayment = loan.monthly_payment;
                let totalPenalties = 0;
                
                // Calculate expected payment dates (last day of each month)
                for (let month = 1; month <= loan.term_months; month++) {
                    const expectedPaymentDate = new Date(loanStartDate);
                    expectedPaymentDate.setMonth(expectedPaymentDate.getMonth() + month);
                    expectedPaymentDate.setDate(0); // Last day of the month
                    
                    // Check if this payment was made on time
                    const paymentsMade = loan.payments_made || 0;
                    if (month > paymentsMade) {
                        // This payment is overdue
                        const daysLate = Math.max(0, Math.floor((asOfDate - expectedPaymentDate) / (1000 * 60 * 60 * 24)));
                        
                        if (daysLate > 3) {
                            // Apply penalty: 0.1% of monthly payment √ó days late (max 7 days)
                            const penaltyDays = Math.min(daysLate - 3, 7);
                            const penalty = (monthlyPayment * 0.001) * penaltyDays;
                            totalPenalties += penalty;
                        }
                    }
                }
                
                return totalPenalties;
            },
            
            getMonthsDifference(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                return (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
            },
            
            // Loan Revision Tool for Cap Compliance
            reviseLoan(loanId) {
                const loan = AppState.loans.find(l => l.loan_id === loanId);
                if (!loan) {
                    alert('Loan not found');
                    return;
                }
                
                const advancedInterest = AppState.calculateAdvancedInterest(loan);
                const principal = loan.original_principal || loan.principal_amount;
                
                if (!advancedInterest.isCapped) {
                    alert('This loan is within the 100% cap. No revision needed.');
                    return;
                }
                
                const options = [
                    `1. Extend term to ${Math.ceil(loan.term_months * 1.5)} months (reduce monthly interest)`,
                    `2. Reduce principal to R${(principal * 0.8).toFixed(2)} (20% reduction)`,
                    `3. Freeze interest at current level (R${advancedInterest.totalInterestIncurred.toFixed(2)})`,
                    `4. Cancel revision`
                ].join('\n');
                
                const choice = prompt(`üîß Loan Revision Required!\n\nLoan #${loanId} exceeds 100% interest cap.\nCurrent interest: R${advancedInterest.totalInterestIncurred.toFixed(2)} (${((advancedInterest.totalInterestIncurred/principal)*100).toFixed(1)}%)\n\nOptions:\n${options}\n\nEnter choice (1-4):`);
                
                switch(choice) {
                    case '1':
                        this.extendLoanTerm(loan);
                        break;
                    case '2':
                        this.reduceLoanPrincipal(loan);
                        break;
                    case '3':
                        this.freezeLoanInterest(loan);
                        break;
                    case '4':
                        return;
                    default:
                        alert('Invalid choice');
                }
            },
            
            extendLoanTerm(loan) {
                const newTerm = Math.ceil(loan.term_months * 1.5);
                const oldTerm = loan.term_months;
                
                loan.term_months = newTerm;
                loan.monthly_payment = (loan.original_principal + loan.max_interest_allowed) / newTerm;
                
                AppState.logTransaction('system', `Loan #${loan.loan_id} term extended: ${oldTerm} ‚Üí ${newTerm} months`, {
                    loanId: loan.loan_id,
                    oldTerm: oldTerm,
                    newTerm: newTerm
                });
                
                alert(`‚úÖ Loan term extended to ${newTerm} months. Monthly payment reduced to R${loan.monthly_payment.toFixed(2)}`);
                AppState.save();
                AppState.updateDashboard();
            },
            
            reduceLoanPrincipal(loan) {
                const reduction = loan.original_principal * 0.2;
                const newPrincipal = loan.original_principal - reduction;
                
                loan.original_principal = newPrincipal;
                loan.principal_amount = newPrincipal;
                loan.remaining_principal = Math.min(loan.remaining_principal, newPrincipal);
                loan.max_interest_allowed = newPrincipal; // Reset cap
                
                AppState.logTransaction('system', `Loan #${loan.loan_id} principal reduced: R${(loan.original_principal + reduction).toFixed(2)} ‚Üí R${newPrincipal.toFixed(2)}`, {
                    loanId: loan.loan_id,
                    reduction: reduction
                });
                
                alert(`‚úÖ Principal reduced by R${reduction.toFixed(2)}. New principal: R${newPrincipal.toFixed(2)}`);
                AppState.save();
                AppState.updateDashboard();
            },
            
            freezeLoanInterest(loan) {
                const currentInterest = AppState.calculateAdvancedInterest(loan).totalInterestIncurred;
                loan.max_interest_allowed = currentInterest;
                loan.expected_monthly_interest = currentInterest / loan.term_months;
                
                AppState.logTransaction('system', `Loan #${loan.loan_id} interest frozen at R${currentInterest.toFixed(2)}`, {
                    loanId: loan.loan_id,
                    frozenAmount: currentInterest
                });
                
                alert(`‚úÖ Interest frozen at R${currentInterest.toFixed(2)}. No further interest will accrue.`);
                AppState.save();
                AppState.updateDashboard();
            },
            
            recalculateFinancialState() {
                console.log('üîÑ Starting comprehensive financial recalculation...');
                
                const INITIAL_CAPITAL = 100000; // Your starting capital
                
                // Step 1: Calculate total money loaned out (disbursements)
                let totalDisbursed = 0;
                let totalPrincipalRepaid = 0;
                let totalInterestReceived = 0;
                let totalFeesReceived = 0;
                
                this.loans.forEach(loan => {
                    // Backward compatibility: Initialize payments_made if missing
                    if (loan.payments_made === undefined) {
                        const principalRepaid = (loan.original_principal || loan.principal_amount) - (loan.remaining_principal || 0);
                        // Estimate payments made based on principal repaid
                        if (loan.status === 'completed') {
                            loan.payments_made = loan.term_months; // All payments made
                        } else if (principalRepaid > 0) {
                            // Estimate based on proportion of principal repaid
                            loan.payments_made = Math.floor((principalRepaid / loan.principal_amount) * loan.term_months);
                        } else {
                            loan.payments_made = 0;
                        }
                        console.log(`Initialized payments_made for Loan #${loan.loan_id}: ${loan.payments_made}/${loan.term_months}`);
                    }
                    
                    // Money loaned out
                    totalDisbursed += loan.principal_amount;
                    
                    // Money received back
                    const principalRepaid = (loan.original_principal || loan.principal_amount) - (loan.remaining_principal || 0);
                    const interestReceived = loan.total_interest_charged || 0;
                    const initiationFeeReceived = loan.initiation_fee_paid || 0;
                    
                    // Calculate admin fees based on how much principal was repaid
                    // Admin fee is included in monthly payment, need to extract it
                    // For completed loans: use total_cost - principal - interest - initiation fee
                    let adminFeesReceived = 0;
                    
                    if (loan.status === 'completed') {
                        // All admin fees received
                        adminFeesReceived = loan.term_months * 60; // R60 per month
                    } else {
                        // Estimate based on principal repaid
                        const paymentsEstimate = loan.term_months > 0 ? 
                            Math.floor((principalRepaid / loan.principal_amount) * loan.term_months) : 0;
                        adminFeesReceived = paymentsEstimate * 60;
                    }
                    
                    totalPrincipalRepaid += principalRepaid;
                    totalInterestReceived += interestReceived;
                    totalFeesReceived += (initiationFeeReceived + adminFeesReceived);
                    
                    console.log(`Loan #${loan.loan_id}: Disbursed R${loan.principal_amount}, Repaid R${principalRepaid}, Interest R${interestReceived}, Fees R${initiationFeeReceived + adminFeesReceived}`);
                });
                
                // Step 2: Calculate actual capital (money in bank)
                const calculatedCapital = INITIAL_CAPITAL - totalDisbursed + totalPrincipalRepaid + totalInterestReceived + totalFeesReceived;
                
                // Step 3: Calculate deployed capital (active loans)
                const calculatedDeployed = this.loans
                    .filter(l => l.status === 'active')
                    .reduce((sum, loan) => sum + (loan.remaining_principal || loan.principal_amount), 0);
                
                // Step 4: Calculate actual profit earned
                const calculatedInterestEarned = totalInterestReceived;
                const calculatedFeesEarned = totalFeesReceived;
                const calculatedTotalProfit = calculatedInterestEarned + calculatedFeesEarned;
                
                // Step 5: Validate the fundamental equation
                const totalAssets = calculatedCapital + calculatedDeployed;
                const expectedTotal = INITIAL_CAPITAL + calculatedTotalProfit;
                const balanceCheck = Math.abs(totalAssets - expectedTotal);
                
                console.log('\nüìä Recalculation Results:');
                console.log(`Capital (in bank): R${calculatedCapital.toFixed(2)} (was R${this.capital.toFixed(2)})`);
                console.log(`Deployed (loaned out): R${calculatedDeployed.toFixed(2)} (was R${this.deployed.toFixed(2)})`);
                console.log(`Interest Earned: R${calculatedInterestEarned.toFixed(2)} (was R${this.totalInterestEarned.toFixed(2)})`);
                console.log(`Fees Earned: R${calculatedFeesEarned.toFixed(2)} (was R${this.totalFeesEarned.toFixed(2)})`);
                console.log(`Total Profit: R${calculatedTotalProfit.toFixed(2)} (was R${(this.totalInterestEarned + this.totalFeesEarned).toFixed(2)})`);
                console.log(`\n‚úÖ Balance Check: R${totalAssets.toFixed(2)} (Capital + Deployed) vs R${expectedTotal.toFixed(2)} (Initial + Profit)`);
                console.log(`Difference: R${balanceCheck.toFixed(2)} ${balanceCheck < 0.10 ? '‚úÖ' : '‚ùå'}`);
                
                // Step 6: Apply corrections
                const oldCapital = this.capital;
                const oldDeployed = this.deployed;
                const oldInterest = this.totalInterestEarned;
                const oldFees = this.totalFeesEarned;
                
                this.capital = Math.round(calculatedCapital * 100) / 100;
                this.deployed = Math.round(calculatedDeployed * 100) / 100;
                this.totalInterestEarned = Math.round(calculatedInterestEarned * 100) / 100;
                this.totalFeesEarned = Math.round(calculatedFeesEarned * 100) / 100;
                
                console.log('\nüîß Applied Corrections:');
                if (Math.abs(oldCapital - this.capital) > 0.01) {
                    console.log(`‚úì Fixed capital: R${oldCapital.toFixed(2)} ‚Üí R${this.capital.toFixed(2)} (${this.capital > oldCapital ? '+' : ''}${(this.capital - oldCapital).toFixed(2)})`);
                }
                if (Math.abs(oldDeployed - this.deployed) > 0.01) {
                    console.log(`‚úì Fixed deployed: R${oldDeployed.toFixed(2)} ‚Üí R${this.deployed.toFixed(2)} (${this.deployed > oldDeployed ? '+' : ''}${(this.deployed - oldDeployed).toFixed(2)})`);
                }
                if (Math.abs(oldInterest - this.totalInterestEarned) > 0.01) {
                    console.log(`‚úì Fixed interest: R${oldInterest.toFixed(2)} ‚Üí R${this.totalInterestEarned.toFixed(2)} (${this.totalInterestEarned > oldInterest ? '+' : ''}${(this.totalInterestEarned - oldInterest).toFixed(2)})`);
                }
                if (Math.abs(oldFees - this.totalFeesEarned) > 0.01) {
                    console.log(`‚úì Fixed fees: R${oldFees.toFixed(2)} ‚Üí R${this.totalFeesEarned.toFixed(2)} (${this.totalFeesEarned > oldFees ? '+' : ''}${(this.totalFeesEarned - oldFees).toFixed(2)})`);
                }
                
                this.save();
                console.log('\n‚úÖ Financial recalculation complete!');
                
                return {
                    capital: this.capital,
                    deployed: this.deployed,
                    interestEarned: this.totalInterestEarned,
                    feesEarned: this.totalFeesEarned,
                    totalProfit: this.totalInterestEarned + this.totalFeesEarned,
                    balanceCheck: balanceCheck < 0.10
                };
            },
            
            checkRedFlags() {
                const alerts = document.getElementById('dashboardAlerts');
                alerts.innerHTML = '';
                
                // Warning at 80 active loans
                const activeLoans = this.loans.filter(l => l.status === 'active').length;
                if (activeLoans >= 80) {
                    alerts.innerHTML += `<div class="alert alert-warning">‚ö†Ô∏è <strong>High Loan Volume:</strong> You have ${activeLoans} active loans. Consider monitoring capacity.</div>`;
                }
                
                // Deployment limit at R80,000
                if (this.deployed > 80000) {
                    alerts.innerHTML += `<div class="alert alert-danger">üö® <strong>Deployment Limit Exceeded:</strong> You've deployed R${this.deployed.toLocaleString()}. Maximum deployment is R80,000!</div>`;
                }
                
                // Reserve capital warning at R20,000 remaining
                const available = this.capital - this.deployed;
                if (available < 20000) {
                    alerts.innerHTML += `<div class="alert alert-warning">‚ö†Ô∏è <strong>Reserve Capital Low:</strong> Only R${available.toLocaleString()} remaining. Consider maintaining higher reserves.</div>`;
                }
            },
            
            updateClientsList() {
                const tbody = document.getElementById('clientsTableBody');
                if (!tbody) return;
                
                if (this.clients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #95a5a6; padding: 20px;">No clients yet.</td></tr>';
                    return;
                }
                
                // Calculate client statistics
                const activeClients = this.clients.filter(c => c.status === 'active').length;
                const blacklistedClients = this.clients.filter(c => c.status === 'blacklisted').length;
                const defaultedClients = this.clients.filter(c => c.status === 'defaulted').length;
                
                // Update statistics
                document.getElementById('activeClients').textContent = activeClients;
                document.getElementById('blacklistedClients').textContent = blacklistedClients;
                document.getElementById('defaultedClients').textContent = defaultedClients;
                
                // Build table rows
                tbody.innerHTML = this.clients.map(client => {
                    // Calculate total loan amount for this client
                    const clientLoans = this.loans.filter(l => l.account_number === client.account_number);
                    const totalLoanAmount = clientLoans.reduce((sum, loan) => sum + loan.principal_amount, 0);
                    
                    // Get total repayment amount (initialize to 0 if not set)
                    const totalRepayment = client.total_repayment || 0;
                    
                    return `
                        <tr>
                            <td><strong>${client.account_number}</strong></td>
                            <td>${client.first_name} ${client.last_name}</td>
                            <td>R ${totalLoanAmount.toFixed(2)}</td>
                            <td>R ${totalRepayment.toFixed(2)}</td>
                            <td><span class="status-badge status-${client.status}">${client.status}</span></td>
                            <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    ${client.status !== 'active' ? `<button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="updateClientStatus('${client.account_number}', 'active')">‚úÖ Activate</button>` : ''}
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="updateClientStatus('${client.account_number}', 'defaulted')">‚ùå Mark Default</button>
                                    <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #8e44ad;" onclick="updateClientStatus('${client.account_number}', 'blacklisted')">üö´ Blacklist</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            updateLoansList() {
                const container = document.getElementById('loansList');
                
                // Sort loans: Active first (by creation date), then completed at bottom
                const sortedLoans = this.loans.slice().sort((a, b) => {
                    // Status priority: active > defaulted > blacklisted > completed
                    const statusOrder = { 'active': 1, 'defaulted': 2, 'blacklisted': 3, 'completed': 4 };
                    const aOrder = statusOrder[a.status] || 999;
                    const bOrder = statusOrder[b.status] || 999;
                    
                    if (aOrder !== bOrder) {
                        return aOrder - bOrder;
                    }
                    
                    // Within same status, sort by creation date (newest first)
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                if (sortedLoans.length === 0) {
                    container.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 20px;">No loans yet.</p>';
                    return;
                }
                
                container.innerHTML = sortedLoans.map(loan => {
                    // Initialize current balance if not set
                    if (!loan.current_balance) {
                        loan.current_balance = loan.total_cost;
                    }
                    
                    // Calculate loan start date and next payment due date
                    const loanStartDate = new Date(loan.created_at);
                    const loanStartStr = loanStartDate.toLocaleDateString('en-ZA', { day: '2-digit', month: 'short', year: 'numeric' });
                    
                    // Calculate payments made (based on reduction in balance)
                    const totalPaid = loan.total_cost - loan.current_balance;
                    const paymentsMade = Math.floor(totalPaid / loan.monthly_payment);
                    
                    // Calculate next payment due date (loan start + payments made + 1 month)
                    const nextDueDate = new Date(loanStartDate);
                    nextDueDate.setMonth(nextDueDate.getMonth() + paymentsMade + 1);
                    const nextDueStr = nextDueDate.toLocaleDateString('en-ZA', { day: '2-digit', month: 'short', year: 'numeric' });
                    
                    // Check if overdue
                    const today = new Date();
                    const isOverdue = loan.status === 'active' && nextDueDate < today;
                    const daysOverdue = isOverdue ? Math.floor((today - nextDueDate) / (1000 * 60 * 60 * 24)) : 0;
                    
                    return `
                        <div class="loan-card">
                            <h4>Loan #${loan.loan_id} - ${loan.client_name}</h4>
                            <div class="info-row">
                                <span>üìÖ Loan Date:</span>
                                <strong style="color: #7f8c8d;">${loanStartStr}</strong>
                            </div>
                            ${loan.status === 'active' ? `
                            <div class="info-row">
                                <span>üìÜ Next Payment Due:</span>
                                <strong style="color: ${isOverdue ? '#e74c3c' : '#27ae60'};">${nextDueStr}${isOverdue ? ` (${daysOverdue} days overdue)` : ''}</strong>
                            </div>
                            ` : ''}
                            <div class="info-row">
                                <span>Principal:</span>
                                <strong>R ${loan.principal_amount.toFixed(2)}</strong>
                            </div>
                            <div class="info-row">
                                <span>Monthly Payment:</span>
                                <strong>R ${loan.monthly_payment.toFixed(2)}</strong>
                            </div>
                            <div class="info-row">
                                <span>Term:</span>
                                <strong>${loan.term_months} months (${paymentsMade}/${loan.term_months} paid)</strong>
                            </div>
                            <div class="info-row">
                                <span>Current Balance:</span>
                                <strong style="color: #e74c3c;">R ${loan.current_balance.toFixed(2)}</strong>
                            </div>
                            <div class="info-row">
                                <span>Status:</span>
                                <span class="status-badge status-${loan.status}">${loan.status}</span>
                            </div>
                            <div class="info-row">
                                <span>Actions:</span>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    ${loan.status === 'active' ? `
                                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="makePayment(${loan.loan_id})">üí∞ Make Payment</button>
                                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="updateLoanStatus(${loan.loan_id}, 'completed')">‚úÖ Mark Paid</button>
                                        <button class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;" onclick="AppState.reviseLoan(${loan.loan_id})">üîß Revise Loan</button>
                                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="updateLoanStatus(${loan.loan_id}, 'defaulted')">‚ùå Mark Default</button>
                                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #8e44ad;" onclick="updateLoanStatus(${loan.loan_id}, 'blacklisted')">üö´ Blacklist</button>
                                    ` : `
                                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="updateLoanStatus(${loan.loan_id}, 'active')">üîÑ Reactivate</button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        let loanData = {};

        // Swipe Navigation System
        function switchTab(tabId, direction = null) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            const currentTab = document.querySelector('.tab.active');
            const currentContent = document.querySelector('.tab-content.active');
            const newTab = document.querySelector(`[data-tab="${tabId}"]`);
            const newContent = document.getElementById(tabId);

            if (!newContent || currentContent === newContent) return;

            // Remove active states from BOTH tabs AND content
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            
            // Add animation based on swipe direction
            if (direction === 'left') {
                currentContent.classList.add('swipe-left');
                newContent.classList.add('slide-in-right');
            } else if (direction === 'right') {
                currentContent.classList.add('swipe-right');
                newContent.classList.add('slide-in-left');
            }

            // Show new content
            newContent.classList.add('active');
            newContent.style.display = 'block';
            newTab.classList.add('active');

            // Clean up animations - store reference to prevent race conditions
            const contentToHide = currentContent;
            setTimeout(() => {
                // Only clean up the specific content that was active when this switch started
                if (contentToHide) {
                    contentToHide.classList.remove('swipe-left', 'swipe-right', 'slide-in-left', 'slide-in-right');
                    if (!contentToHide.classList.contains('active')) {
                        contentToHide.style.display = 'none';
                    }
                }
                // Clean up animation classes from the new content too
                newContent.classList.remove('swipe-left', 'swipe-right', 'slide-in-left', 'slide-in-right');
            }, 300);
        }

        function initSwipeNavigation() {
            const container = document.getElementById('tabsContainer');
            const leftIndicator = document.getElementById('swipeLeftIndicator');
            const rightIndicator = document.getElementById('swipeRightIndicator');

            if (!container) return;

            // Get all tabs in order
            const tabs = Array.from(document.querySelectorAll('.tab')).map(t => t.dataset.tab);
            
            let touchStartX = 0;
            let touchCurrentX = 0;
            let isSwiping = false;
            const swipeThreshold = 50; // Minimum distance to trigger swipe
            const activateThreshold = 100; // Distance to "ready" state

            container.addEventListener('touchstart', (e) => {
                // Don't interfere with form inputs or scrollable elements
                if (e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'TEXTAREA' || 
                    e.target.tagName === 'SELECT' ||
                    e.target.closest('iframe')) {
                    return;
                }

                touchStartX = e.touches[0].clientX;
                isSwiping = true;
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;

                touchCurrentX = e.touches[0].clientX;
                const deltaX = touchCurrentX - touchStartX;
                const absDeltaX = Math.abs(deltaX);

                // Determine swipe direction
                if (deltaX > swipeThreshold) {
                    // Swiping right (go to previous tab)
                    rightIndicator.classList.remove('active', 'ready');
                    leftIndicator.classList.add('active');
                    if (absDeltaX > activateThreshold) {
                        leftIndicator.classList.add('ready');
                    }
                } else if (deltaX < -swipeThreshold) {
                    // Swiping left (go to next tab)
                    leftIndicator.classList.remove('active', 'ready');
                    rightIndicator.classList.add('active');
                    if (absDeltaX > activateThreshold) {
                        rightIndicator.classList.add('ready');
                    }
                } else {
                    // Not enough movement
                    leftIndicator.classList.remove('active', 'ready');
                    rightIndicator.classList.remove('active', 'ready');
                }
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isSwiping) return;

                const deltaX = touchCurrentX - touchStartX;
                const absDeltaX = Math.abs(deltaX);

                // Clear indicators
                leftIndicator.classList.remove('active', 'ready');
                rightIndicator.classList.remove('active', 'ready');

                // Perform tab switch if threshold met
                if (absDeltaX > activateThreshold) {
                    const currentTab = document.querySelector('.tab.active');
                    const currentIndex = tabs.indexOf(currentTab.dataset.tab);

                    if (deltaX > 0 && currentIndex > 0) {
                        // Swipe right - go to previous tab
                        switchTab(tabs[currentIndex - 1], 'right');
                    } else if (deltaX < 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - go to next tab
                        switchTab(tabs[currentIndex + 1], 'left');
                    }
                }

                isSwiping = false;
                touchStartX = 0;
                touchCurrentX = 0;
            }, { passive: true });

            // Keyboard navigation (bonus)
            document.addEventListener('keydown', (e) => {
                // Only if no input is focused
                if (document.activeElement.tagName === 'INPUT' || 
                    document.activeElement.tagName === 'TEXTAREA') {
                    return;
                }

                const currentTab = document.querySelector('.tab.active');
                const currentIndex = tabs.indexOf(currentTab.dataset.tab);

                if (e.key === 'ArrowLeft' && currentIndex > 0) {
                    e.preventDefault();
                    switchTab(tabs[currentIndex - 1], 'right');
                } else if (e.key === 'ArrowRight' && currentIndex < tabs.length - 1) {
                    e.preventDefault();
                    switchTab(tabs[currentIndex + 1], 'left');
                }
            });

            console.log('‚ú® Advanced Swipe Navigation initialized!');
            console.log('üëÜ Swipe left/right to navigate tabs');
            console.log('‚å®Ô∏è Use arrow keys on desktop');
        }

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            
            // Initialize app state
            AppState.init();
            
            // Set today's date as default for loan date
            const today = new Date().toISOString().split('T')[0];
            const loanDateField = document.getElementById('loanDate');
            if (loanDateField) {
                loanDateField.value = today;
            }
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // Advanced Swipe Navigation
            initSwipeNavigation();
            
            const form = document.getElementById('loanForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form submitted');
                    e.preventDefault();
                    calculateLoan();
                });
            } else {
                console.error('Form not found');
            }

            // Handle Stockvel Member checkbox
            const stockvelCheckbox = document.getElementById('stockvelMember');
            const stockvelFields = document.getElementById('stockvelFields');
            
            if (stockvelCheckbox && stockvelFields) {
                stockvelCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        stockvelFields.style.display = 'block';
                        document.getElementById('totalContributions').required = true;
                        document.getElementById('monthlyContribution').required = true;
                        document.getElementById('membershipStartDate').required = true;
                    } else {
                        stockvelFields.style.display = 'none';
                        document.getElementById('totalContributions').required = false;
                        document.getElementById('monthlyContribution').required = false;
                        document.getElementById('membershipStartDate').required = false;
                        document.getElementById('totalContributions').value = '';
                        document.getElementById('monthlyContribution').value = '';
                        document.getElementById('membershipStartDate').value = '';
                        document.getElementById('membershipEndDate').value = '';
                        document.getElementById('accumulatedBonus').value = '0';
                    }
                });
            }
        });

        // Loan calculation functions
        function calculateTieredStockvelInterest(loanAmount, savingsAmount) {
            let totalInterest = 0;
            
            console.log(`\nTiered calculation for R${loanAmount.toFixed(2)} loan with R${savingsAmount.toFixed(2)} savings`);
            
            // Calculate tier boundaries based on savings
            const boundaries = {
                tier1: savingsAmount * 1.10, // >110% of savings
                tier2: savingsAmount * 1.05, // 105-110% of savings
                tier3: savingsAmount * 0.75, // 75-105% of savings
                tier4: savingsAmount * 0.50, // 50-75% of savings
                tier5: savingsAmount * 0.25, // 25-50% of savings
                tier6: 0 // 5-25% of savings
            };
            
            console.log(`Tier boundaries: 110%: R${boundaries.tier1.toFixed(2)}, 105%: R${boundaries.tier2.toFixed(2)}, 75%: R${boundaries.tier3.toFixed(2)}, 50%: R${boundaries.tier4.toFixed(2)}, 25%: R${boundaries.tier5.toFixed(2)}`);
            
            // Calculate interest for each tier
            let remainingLoan = loanAmount;
            
            // Tier 1: >110% of savings (30%)
            if (loanAmount > boundaries.tier1) {
                const tierAmount = loanAmount - boundaries.tier1;
                const tierInterest = tierAmount * 0.30;
                totalInterest += tierInterest;
                console.log(`Tier >110% of savings: R${tierAmount.toFixed(2)} √ó 30% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 2: 105-110% of savings (25%)
            if (remainingLoan > boundaries.tier2) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier2, boundaries.tier1 - boundaries.tier2);
                const tierInterest = tierAmount * 0.25;
                totalInterest += tierInterest;
                console.log(`Tier 105-110% of savings: R${tierAmount.toFixed(2)} √ó 25% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 3: 75-105% of savings (20%)
            if (remainingLoan > boundaries.tier3) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier3, boundaries.tier2 - boundaries.tier3);
                const tierInterest = tierAmount * 0.20;
                totalInterest += tierInterest;
                console.log(`Tier 75-105% of savings: R${tierAmount.toFixed(2)} √ó 20% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 4: 50-75% of savings (15%)
            if (remainingLoan > boundaries.tier4) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier4, boundaries.tier3 - boundaries.tier4);
                const tierInterest = tierAmount * 0.15;
                totalInterest += tierInterest;
                console.log(`Tier 50-75% of savings: R${tierAmount.toFixed(2)} √ó 15% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 5: 25-50% of savings (8%)
            if (remainingLoan > boundaries.tier5) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier5, boundaries.tier4 - boundaries.tier5);
                const tierInterest = tierAmount * 0.08;
                totalInterest += tierInterest;
                console.log(`Tier 25-50% of savings: R${tierAmount.toFixed(2)} √ó 8% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 6: 5-25% of savings (3%)
            if (remainingLoan > 0) {
                const tierAmount = Math.min(remainingLoan, boundaries.tier5);
                const tierInterest = tierAmount * 0.03;
                totalInterest += tierInterest;
                console.log(`Tier 5-25% of savings: R${tierAmount.toFixed(2)} √ó 3% = R${tierInterest.toFixed(2)}`);
            }
            
            console.log(`Total tiered interest: R${totalInterest.toFixed(2)}`);
            return totalInterest;
        }

        function calculateStockvelInterest(principal, term, totalContributions, monthlyContribution) {
            const basePrincipalPayment = principal / term;
            let outstandingBalance = principal;
            let cumulativeInterest = 0;
            let currentSavings = totalContributions;
            
            // Interest calculation period: minimum 3 months, or Math.ceil(term/2) if >= 3
            // BUT cannot exceed the actual loan term (for 1-2 month loans)
            const calculatedMonths = Math.ceil(term / 2) >= 3 ? Math.ceil(term / 2) : 3;
            const interestMonths = Math.min(calculatedMonths, term);
            
            console.log(`\n=== STOCKVEL INTEREST CALCULATION ===`);
            console.log(`Principal: R${principal.toFixed(2)}`);
            console.log(`Term: ${term} months`);
            console.log(`Interest Period: ${interestMonths} months`);
            console.log(`Base Principal Payment: R${basePrincipalPayment.toFixed(2)}`);
            console.log(`Initial Savings: R${currentSavings.toFixed(2)}`);
            console.log(`Monthly Contribution: R${monthlyContribution.toFixed(2)}`);
            
            for (let month = 1; month <= interestMonths; month++) {
                // Add monthly contribution if loan is more than 1 month and it's not the first month
                if (term > 1 && month > 1) {
                    currentSavings += monthlyContribution;
                }
                
                console.log(`\n=== Month ${month} Calculation ===`);
                console.log(`Outstanding Balance: R${outstandingBalance.toFixed(2)}`);
                console.log(`Current Savings: R${currentSavings.toFixed(2)}`);
                console.log(`Loan-to-Savings Ratio: ${(outstandingBalance/currentSavings*100).toFixed(1)}%`);
                
                // Only calculate interest if there's an outstanding balance
                if (outstandingBalance > 0) {
                    // Use the new tiered calculation
                    let monthlyInterest = calculateTieredStockvelInterest(outstandingBalance, currentSavings);
                    
                    // No minimum interest rule for Stockvel members - use tiered calculation only
                    console.log(`Tiered interest: R${monthlyInterest.toFixed(2)}`);
                    
                    cumulativeInterest += monthlyInterest;
                    console.log(`Final Monthly Interest: R${monthlyInterest.toFixed(2)}`);
                } else {
                    console.log(`Outstanding balance is R${outstandingBalance.toFixed(2)}, no interest calculated`);
                }
                
                outstandingBalance -= basePrincipalPayment;
            }
            
            console.log(`\n=== FINAL SUMMARY ===`);
            console.log(`Total Cumulative Interest: R${cumulativeInterest.toFixed(2)}`);
            console.log(`Monthly Interest Payment (spread across ${term} months): R${(cumulativeInterest/term).toFixed(2)}`);
            
            return cumulativeInterest;
        }

        function getMonthName(startIndex, offset) {
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            return months[(startIndex + offset) % 12];
        }
        
        function calculateMembershipEndDate() {
            const startDateInput = document.getElementById('membershipStartDate');
            const endDateInput = document.getElementById('membershipEndDate');
            
            if (startDateInput && endDateInput && startDateInput.value) {
                const startDate = new Date(startDateInput.value);
                // Add 12 months to the start date
                const endDate = new Date(startDate);
                endDate.setMonth(endDate.getMonth() + 12);
                
                // Format the date as YYYY-MM-DD for the input field
                const year = endDate.getFullYear();
                const month = String(endDate.getMonth() + 1).padStart(2, '0');
                const day = String(endDate.getDate()).padStart(2, '0');
                
                endDateInput.value = `${year}-${month}-${day}`;
            }
        }

        function calculateLoan() {
            console.log('calculateLoan function called');
            
            try {
                // Get form values
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const principal = parseFloat(document.getElementById('principal').value);
                const term = parseInt(document.getElementById('term').value);
                const loanDate = document.getElementById('loanDate').value; // Loan disbursement date
                const startMonthIndex = parseInt(document.getElementById('startMonth').value);
                
                // Stockvel member fields
                const isStockvelMember = document.getElementById('stockvelMember').checked;
                const totalContributions = isStockvelMember ? parseFloat(document.getElementById('totalContributions').value) : 0;
                const monthlyContribution = isStockvelMember ? parseFloat(document.getElementById('monthlyContribution').value) : 0;
                const membershipStartDate = isStockvelMember ? document.getElementById('membershipStartDate').value : '';
                const membershipEndDate = isStockvelMember ? document.getElementById('membershipEndDate').value : '';
                const accumulatedBonus = isStockvelMember ? parseFloat(document.getElementById('accumulatedBonus').value) || 0 : 0;

                console.log('Form values:', { 
                    firstName, lastName, accountNumber, principal, term, startMonthIndex,
                    isStockvelMember, totalContributions, monthlyContribution,
                    membershipStartDate, membershipEndDate, accumulatedBonus
                });

                // Validate inputs
                if (!firstName || !lastName || !accountNumber || isNaN(startMonthIndex)) {
                    alert('Please fill in all required fields including start month');
                    return;
                }

                if (isStockvelMember) {
                    if (!membershipStartDate) {
                        alert('Please enter the membership start date');
                        return;
                    }
                    if (isNaN(totalContributions) || totalContributions < 0) {
                        alert('Please enter a valid total contribution amount');
                        return;
                    }
                    if (isNaN(monthlyContribution) || monthlyContribution < 0) {
                        alert('Please enter a valid monthly contribution amount');
                        return;
                    }
                    if (totalContributions === 0 && monthlyContribution === 0) {
                        alert('Please enter your contribution amounts as a Stockvel member');
                        return;
                    }
                }

                if (isNaN(principal) || principal <= 0) {
                    alert('Please enter a valid loan amount');
                    return;
                }

                if (isNaN(term) || term <= 0) {
                    alert('Please enter a valid loan term');
                    return;
                }

                if (principal < 100) {
                    alert('Minimum loan amount is R100');
                    return;
                }

                if (term < 1) {
                    alert('Loan term must be at least 1 month');
                    return;
                }

                console.log('Validation passed, starting calculations');

                // Calculate loan components
                const basePrincipalPayment = principal / term;
                
                // NEW CALCULATION LOGIC
                let initiationFee;
                let totalInterest = 0;
                let totalAdminFees = 0;
                let breakdown = [];
                let interestRate;
                
                if (isStockvelMember) {
                    // ===== STOCKVEL LOAN CALCULATION =====
                    // Calculate with tiered interest but apply 10% minimum
                    
                    interestRate = 'Variable (Stockvel) - Min 10%';
                    let outstandingBalance = principal;
                    let currentSavings = totalContributions;
                    let totalBonus = 0; // Track accumulated bonus
                    
                    console.log(`\n=== STOCKVEL LOAN CALCULATION ===`);
                    console.log(`Principal: R${principal.toFixed(2)}`);
                    console.log(`Term: ${term} months`);
                    console.log(`Initial Savings: R${currentSavings.toFixed(2)}`);
                    console.log(`Monthly Contribution: R${monthlyContribution.toFixed(2)}`);
                    
                    // Calculate initiation fee: WAIVED for amount <= contribution, 12% on excess
                    if (principal <= totalContributions) {
                        initiationFee = 0; // Waived completely
                    } else {
                        // Only charge 12% on the amount above contributions
                        initiationFee = (principal - totalContributions) * 0.12;
                    }
                    const monthlyInitiationFee = initiationFee / term;
                    
                    // First pass: Calculate all interest, admin fees, and bonuses per month
                    const monthlyDetails = [];
                    for (let month = 1; month <= term; month++) {
                        // Update savings (add contribution after first month)
                        if (month > 1 && term > 1) {
                            currentSavings += monthlyContribution;
                        }
                        
                        // Calculate tiered interest on outstanding balance
                        const tieredInterest = calculateTieredStockvelInterest(outstandingBalance, currentSavings);
                        const tieredRate = outstandingBalance > 0 ? (tieredInterest / outstandingBalance) : 0;
                        
                        // Apply 10% minimum
                        const minimumInterest = outstandingBalance * 0.10;
                        const actualInterest = Math.max(tieredInterest, minimumInterest);
                        
                        // Calculate admin fee based on actual rate
                        const actualRate = outstandingBalance > 0 ? (actualInterest / outstandingBalance) : 0;
                        const adminFee = 60 * (1 - actualRate);
                        
                        // If we used the minimum, calculate bonus
                        let monthlyBonus = 0;
                        if (actualInterest > tieredInterest) {
                            // Bonus = difference between minimum charge and what we actually charged
                            const actualCharge = actualInterest + adminFee + monthlyInitiationFee;
                            const minimumCharge = minimumInterest + 60 + monthlyInitiationFee;
                            monthlyBonus = minimumCharge - actualCharge;
                        }
                        
                        totalBonus += monthlyBonus;
                        totalInterest += actualInterest;
                        totalAdminFees += adminFee;
                        
                        monthlyDetails.push({
                            tieredInterest,
                            tieredRate,
                            actualInterest,
                            actualRate,
                            adminFee,
                            monthlyBonus,
                            outstandingBalance
                        });
                        
                        console.log(`\nMonth ${month}:`);
                        console.log(`  Outstanding: R${outstandingBalance.toFixed(2)}`);
                        console.log(`  Savings: R${currentSavings.toFixed(2)}`);
                        console.log(`  Tiered Interest: R${tieredInterest.toFixed(2)} (${(tieredRate * 100).toFixed(1)}%)`);
                        console.log(`  Actual Interest: R${actualInterest.toFixed(2)} (${(actualRate * 100).toFixed(1)}%)`);
                        console.log(`  Admin Fee: R${adminFee.toFixed(2)}`);
                        console.log(`  Initiation: R${monthlyInitiationFee.toFixed(2)}`);
                        console.log(`  Bonus: R${monthlyBonus.toFixed(2)}`);
                        
                        outstandingBalance -= basePrincipalPayment;
                    }
                    
                    console.log(`\nTotal Bonus: R${totalBonus.toFixed(2)}`);
                    console.log(`Total Interest: R${totalInterest.toFixed(2)}`);
                    console.log(`Total Admin Fees: R${totalAdminFees.toFixed(2)}`);
                    console.log(`Total Initiation Fee: R${initiationFee.toFixed(2)}`);
                    
                    // Calculate total cost and equal monthly payment
                    const totalCostStockvel = principal + totalInterest + initiationFee + totalAdminFees;
                    const equalMonthlyPayment = totalCostStockvel / term;
                    
                    console.log(`\nTotal Cost: R${totalCostStockvel.toFixed(2)}`);
                    console.log(`Equal Monthly Payment: R${equalMonthlyPayment.toFixed(2)}`);
                    
                    // Second pass: Build breakdown with equal payments
                    outstandingBalance = principal;
                    for (let month = 1; month <= term; month++) {
                        const details = monthlyDetails[month - 1];
                        
                        breakdown.push({
                            month: month,
                            principalPayment: basePrincipalPayment,
                            interest: details.actualInterest,
                            adminFee: details.adminFee,
                            initiationFee: monthlyInitiationFee,
                            bonus: details.monthlyBonus,
                            totalPayment: equalMonthlyPayment, // Equal payment each month
                            outstandingBalance: Math.max(0, outstandingBalance - basePrincipalPayment)
                        });
                        
                        outstandingBalance -= basePrincipalPayment;
                    }
                    
                } else {
                    // ===== STANDARD LOAN CALCULATION =====
                    // Interest period: Full term for loans ‚â§ 3 months, otherwise Math.ceil(term/2) with min 3
                    // Total initiation fee = 12% of principal (distributed over term)
                    // Admin fee = R60 per month
                    // Interest = calculated on declining balance for interest period
                    
                    interestRate = '30% on declining balance';
                    initiationFee = principal * 0.12;
                    const monthlyInitiationFee = initiationFee / term;
                    const adminFee = 60;
                    
                    // Determine interest calculation period
                    let interestMonths;
                    if (term <= 3) {
                        // For loans <= 3 months, calculate interest for full term
                        interestMonths = term;
                    } else {
                        // For loans > 3 months, use Math.ceil(term/2) with minimum of 3
                        interestMonths = Math.max(Math.ceil(term / 2), 3);
                    }
                    
                    let outstandingBalance = principal;
                    
                    console.log(`\n=== STANDARD LOAN CALCULATION ===`);
                    console.log(`Principal: R${principal.toFixed(2)}`);
                    console.log(`Term: ${term} months`);
                    console.log(`Interest Period: ${interestMonths} months`);
                    console.log(`Total Initiation Fee (12%): R${initiationFee.toFixed(2)}`);
                    console.log(`Monthly Initiation: R${monthlyInitiationFee.toFixed(2)}`);
                    console.log(`Monthly Admin Fee: R${adminFee.toFixed(2)}`);
                    
                    // Calculate interest on declining balance for interest period only
                    for (let month = 1; month <= interestMonths; month++) {
                        const monthlyInterest = outstandingBalance * 0.30;
                        totalInterest += monthlyInterest;
                        
                        console.log(`\nMonth ${month} (interest calculation):`);
                        console.log(`  Outstanding: R${outstandingBalance.toFixed(2)}`);
                        console.log(`  Interest (30%): R${monthlyInterest.toFixed(2)}`);
                        
                        outstandingBalance -= basePrincipalPayment;
                    }
                    
                    // Spread interest evenly across all months
                    const equalMonthlyInterest = totalInterest / term;
                    totalAdminFees = adminFee * term;
                    
                    // Reset for breakdown
                    outstandingBalance = principal;
                    
                    console.log(`\nTotal Interest (${interestMonths} months): R${totalInterest.toFixed(2)}`);
                    console.log(`Interest per month (spread over ${term} months): R${equalMonthlyInterest.toFixed(2)}`);
                    console.log(`Total Admin Fees: R${totalAdminFees.toFixed(2)}`);
                    console.log(`Total Initiation Fee: R${initiationFee.toFixed(2)}`);
                    
                    // Build breakdown with equal monthly payments
                    for (let month = 1; month <= term; month++) {
                        breakdown.push({
                            month: month,
                            principalPayment: basePrincipalPayment,
                            interest: equalMonthlyInterest,
                            adminFee: adminFee,
                            initiationFee: monthlyInitiationFee,
                            totalPayment: basePrincipalPayment + equalMonthlyInterest + adminFee + monthlyInitiationFee,
                            outstandingBalance: Math.max(0, outstandingBalance - basePrincipalPayment)
                        });
                        
                        outstandingBalance -= basePrincipalPayment;
                    }
                }
                
                // Calculate totals
                const totalCost = principal + totalInterest + initiationFee + totalAdminFees;
                const monthlyPayment = totalCost / term;

                console.log('\n=== FINAL SUMMARY ===');
                console.log('Total Cost:', totalCost);
                console.log('Average Monthly Payment:', monthlyPayment);

                // Calculate total bonus for stockvel members
                const totalBonus = isStockvelMember ? 
                    breakdown.reduce((sum, month) => sum + (month.bonus || 0), 0) : 0;
                
                // Store data for PDF generation
                loanData = {
                    firstName,
                    lastName,
                    accountNumber,
                    principal,
                    term,
                    loanDate, // Custom loan disbursement date
                    monthlyPayment,
                    totalCost,
                    totalInterest,
                    initiationFee,
                    totalAdminFees,
                    breakdown,
                    startMonthIndex,
                    isStockvelMember,
                    totalContributions,
                    monthlyContribution,
                    interestRate,
                    totalBonus, // For stockvel members
                    membershipStartDate, // Membership tracking
                    membershipEndDate,
                    accumulatedBonus
                };

                console.log('Loan data stored, calling displayResults');
                // Display results
                displayResults();
                
            } catch (error) {
                console.error('Error in calculateLoan:', error);
                alert('An error occurred during calculation. Please check your inputs and try again.');
            }
        }

        function displayResults() {
            console.log('displayResults function called');
            
            try {
                // Show results section
                const resultsSection = document.getElementById('results');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    console.log('Results section made visible');
                } else {
                    console.error('Results section not found');
                    return;
                }

                // Display client info
                const clientInfoElement = document.getElementById('clientInfo');
                if (clientInfoElement) {
                    let clientInfoHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">Client Information</h4>
                            <p><strong>Name:</strong> ${loanData.firstName} ${loanData.lastName}</p>
                            <p><strong>Account Number:</strong> ${loanData.accountNumber}</p>
                            <p><strong>Loan Amount:</strong> R ${loanData.principal.toFixed(2)}</p>
                            <p><strong>Term:</strong> ${loanData.term} months</p>
                            <p><strong>Start Month:</strong> ${getMonthName(loanData.startMonthIndex, 0)}</p>`;
                    
                    if (loanData.isStockvelMember) {
                        // Format membership dates
                        const startDate = loanData.membershipStartDate ? new Date(loanData.membershipStartDate).toLocaleDateString('en-ZA') : 'Not set';
                        const endDate = loanData.membershipEndDate ? new Date(loanData.membershipEndDate).toLocaleDateString('en-ZA') : 'Not set';
                        
                        clientInfoHTML += `
                            <p><strong>Stockvel Member:</strong> Yes</p>
                            <p><strong>Membership Period:</strong> ${startDate} to ${endDate}<br>
                               <span style="font-size: 11px; color: #666;">(12-month membership)</span></p>
                            <p><strong>Total Contributions:</strong> R ${loanData.totalContributions.toFixed(2)}</p>
                            <p><strong>Monthly Contribution:</strong> R ${loanData.monthlyContribution.toFixed(2)}</p>
                            <p><strong>Accumulated Bonus:</strong> R ${loanData.accumulatedBonus.toFixed(2)}<br>
                               <span style="font-size: 11px; color: #666;">(Previous bonuses earned)</span></p>
                            <p><strong>Interest Rate:</strong> Variable (Tiered, with 10% minimum)</p>
                            <p><strong>Initiation Fee:</strong> R ${loanData.initiationFee.toFixed(2)}<br>
                               <span style="font-size: 11px; color: #666;">(Waived up to R${loanData.totalContributions.toFixed(2)}, 12% on excess)</span></p>
                            <p><strong>Total Admin Fees:</strong> R ${loanData.totalAdminFees.toFixed(2)}<br>
                               <span style="font-size: 11px; color: #666;">(R60 √ó (1 - interest rate), varies by month)</span></p>`;
                        if (loanData.totalBonus > 0) {
                            clientInfoHTML += `
                            <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 10px; border: 2px solid #ffc107;">
                                <strong style="color: #856404;">üéÅ Member Bonus:</strong> R ${loanData.totalBonus.toFixed(2)}<br>
                                <span style="font-size: 11px; color: #856404;">This bonus will be added to your contributions after each payment is received!</span>
                            </div>`;
                        }
                        clientInfoHTML += `
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                                <strong>Tiered Interest Rates:</strong><br>
                                ‚Ä¢ >110% of savings: 30% | 105-110%: 25% | 75-105%: 20%<br>
                                ‚Ä¢ 50-75%: 15% | 25-50%: 8% | 5-25%: 3%<br>
                                ‚Ä¢ <strong>10% Minimum Applied</strong> with bonus for difference<br>
                                ‚Ä¢ Admin Fee varies: R60 √ó (1 - interest rate)
                            </div>`;
                    } else {
                        // Calculate interest period for display
                        let interestPeriod;
                        if (loanData.term <= 3) {
                            interestPeriod = loanData.term;
                        } else {
                            interestPeriod = Math.max(Math.ceil(loanData.term / 2), 3);
                        }
                        
                        clientInfoHTML += `
                            <p><strong>Interest Rate:</strong> 30% per month on declining balance</p>
                            <p><strong>Interest Period:</strong> ${interestPeriod} months (calculated for ${interestPeriod} months, spread over ${loanData.term} months)</p>
                            <p><strong>Initiation Fee:</strong> R ${loanData.initiationFee.toFixed(2)} (12% of loan, distributed over ${loanData.term} months)</p>
                            <p><strong>Admin Fee:</strong> R 60.00 per month</p>
                            <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                                <strong>Interest Calculation:</strong><br>
                                ‚Ä¢ Loans ‚â§ 3 months: Full term<br>
                                ‚Ä¢ Loans > 3 months: Math.ceil(term/2) with minimum of 3 months<br>
                                ‚Ä¢ Interest calculated on declining balance for ${interestPeriod} months<br>
                                ‚Ä¢ Total interest spread equally across all ${loanData.term} months
                            </div>`;
                    }
                    
                    clientInfoHTML += `
                        </div>
                    `;
                    
                    clientInfoElement.innerHTML = clientInfoHTML;
                    console.log('Client info updated');
                }

                // Display summary with error handling
                const monthlyPaymentEl = document.getElementById('monthlyPayment');
                const totalCostEl = document.getElementById('totalCost');
                const numberOfPaymentsEl = document.getElementById('numberOfPayments');
                const totalInterestEl = document.getElementById('totalInterest');

                if (monthlyPaymentEl) {
                    monthlyPaymentEl.textContent = `R ${loanData.monthlyPayment.toFixed(2)}`;
                }
                if (totalCostEl) {
                    totalCostEl.textContent = `R ${loanData.totalCost.toFixed(2)}`;
                }
                if (numberOfPaymentsEl) {
                    numberOfPaymentsEl.textContent = loanData.term;
                }
                if (totalInterestEl) {
                    totalInterestEl.textContent = `R ${loanData.totalInterest.toFixed(2)}`;
                }

                // Show Stockvel summary card if applicable
                const stockvelSummaryCard = document.getElementById('stockvelSummaryCard');
                const initiationFeeDisplay = document.getElementById('initiationFeeDisplay');
                if (stockvelSummaryCard && initiationFeeDisplay) {
                    if (loanData.isStockvelMember) {
                        stockvelSummaryCard.style.display = 'block';
                        if (loanData.initiationFee === 0) {
                            initiationFeeDisplay.textContent = 'R 0.00 (Waived)';
                        } else {
                            initiationFeeDisplay.textContent = `R ${loanData.initiationFee.toFixed(2)}`;
                        }
                    } else {
                        stockvelSummaryCard.style.display = 'none';
                    }
                }

                console.log('Summary cards updated');

                // Display breakdown table with month names
                const tbody = document.getElementById('breakdownBody');
                if (tbody) {
                    tbody.innerHTML = '';
                    
                    // Show/hide bonus column for stockvel members
                    const bonusHeaders = document.querySelectorAll('.stockvel-only');
                    bonusHeaders.forEach(header => {
                        header.style.display = loanData.isStockvelMember ? 'table-cell' : 'none';
                    });

                    loanData.breakdown.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        let rowHTML = `
                            <td>${getMonthName(loanData.startMonthIndex, index)}</td>
                            <td>R ${row.totalPayment.toFixed(2)}</td>
                            <td>R ${row.principalPayment.toFixed(2)}</td>
                            <td>R ${row.interest.toFixed(2)}</td>
                            <td>R ${row.initiationFee.toFixed(2)}</td>
                            <td>R ${row.adminFee.toFixed(2)}</td>
                            <td>R ${row.outstandingBalance.toFixed(2)}</td>
                        `;
                        
                        if (loanData.isStockvelMember) {
                            rowHTML += `<td class="stockvel-only" style="color: #28a745; font-weight: 600;">R ${(row.bonus || 0).toFixed(2)}</td>`;
                        }
                        
                        tr.innerHTML = rowHTML;
                        tbody.appendChild(tr);
                    });

                    console.log('Breakdown table updated with', loanData.breakdown.length, 'rows');
                } else {
                    console.error('Breakdown table body not found');
                }

                // Scroll to results
                setTimeout(() => {
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                    console.log('Scrolled to results');
                }, 100);

            } catch (error) {
                console.error('Error in displayResults:', error);
                alert('An error occurred while displaying results. Please try again.');
            }
        }

        // Helper to load image as base64
        function getBase64Image(imgUrl, callback) {
            var img = new window.Image();
            img.crossOrigin = '';
            img.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                var dataURL = canvas.toDataURL('image/png');
                callback(dataURL);
            };
            img.onerror = function() { callback(null); };
            img.src = imgUrl;
        }

        function generatePDF() {
            console.log('generatePDF function called');
            
            try {
                if (!loanData || !loanData.firstName) {
                    alert('Please calculate a loan first before generating PDF');
                    return;
                }

                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF not loaded');
                    alert('PDF generation library not loaded. Please refresh the page and try again.');
                    return;
                }

                // Load logo and then generate PDF
                getBase64Image('./TBFS_Logo.png', function(logoDataUrl) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    console.log('Creating PDF document');

                    // Set font
                    doc.setFont('helvetica');

                    // Header with logo
                    if (logoDataUrl) {
                        doc.addImage(logoDataUrl, 'PNG', 85, 5, 40, 40);
                    } else {
                        alert('Logo image could not be loaded for the PDF. Please ensure TBFS_Logo.png is in the same folder and you are running a local server.');
                        return;
                    }
                    doc.setFontSize(18);
                    doc.setTextColor(44, 62, 80);
                    doc.text('THABA BOSIU FINANCIAL SERVICES', 105, 50, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Your Financial Refuge', 105, 57, { align: 'center' });

                    // Line separator
                    doc.setDrawColor(102, 126, 234);
                    doc.setLineWidth(0.5);
                    doc.line(20, 62, 190, 62);

                    // Client Information and Loan Summary
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    doc.text('Loan Details', 20, 70);
                    doc.text('Loan Summary', 105, 70);

                    // Left column - Client Info
                    doc.setFontSize(10);
                    doc.text(`Client Name: ${loanData.firstName} ${loanData.lastName}`, 20, 80);
                    doc.text(`Account Number: ${loanData.accountNumber}`, 20, 87);
                    doc.text(`Loan Amount: R ${loanData.principal.toFixed(2)}`, 20, 94);
                    doc.text(`Term: ${loanData.term} months`, 20, 101);
                    doc.text(`Start Month: ${getMonthName(loanData.startMonthIndex, 0)}`, 20, 108);
                    
                    if (loanData.isStockvelMember) {
                        doc.text(`Stockvel Member: Yes`, 20, 115);
                        doc.text(`Total Contributions: R ${loanData.totalContributions.toFixed(2)}`, 20, 122);
                        doc.text(`Monthly Contribution: R ${loanData.monthlyContribution.toFixed(2)}`, 20, 129);
                        const initiationFeeText = loanData.initiationFee === 0 ? 
                            `Initiation Fee: R 0.00 (Waived)` : 
                            `Initiation Fee: R ${loanData.initiationFee.toLocaleString('en-ZA', {minimumFractionDigits: 2})}`;
                        doc.text(initiationFeeText, 20, 136);
                        doc.text(`Admin Fee: R ${loanData.adminFee.toFixed(2)}`, 20, 143);
                    } else {
                        doc.text(`Initiation Fee: R ${loanData.initiationFee.toFixed(2)}`, 20, 115);
                        doc.text(`Admin Fee: R ${loanData.adminFee.toFixed(2)}`, 20, 122);
                    }

                    // Right column - Loan Summary
                    doc.text(`Monthly Repayment: R ${loanData.monthlyPayment.toFixed(2)}`, 105, 80);
                    doc.text(`Total Cost: R ${loanData.totalCost.toFixed(2)}`, 105, 87);
                    doc.text(`Total Interest: R ${loanData.totalInterest.toFixed(2)}`, 105, 94);

                    // Banking Details
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    const bankingDetailsY = loanData.isStockvelMember ? 152 : 125;
                    doc.text('Banking Details', 20, bankingDetailsY);

                    doc.setFontSize(10);
                    doc.text('To pay please use:', 20, bankingDetailsY + 10);
                    doc.setFontSize(9);
                    doc.text(`Account Holder: Thaba Bosiu Financial Services`, 25, bankingDetailsY + 17);
                    doc.text(`Bank Name: TymeBank`, 25, bankingDetailsY + 24);
                    doc.text(`Branch Code: 678910`, 25, bankingDetailsY + 31);
                    doc.text(`Account Number: 53000021839`, 25, bankingDetailsY + 38);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Please use your Name and Surname as the reference', 25, bankingDetailsY + 45);
                    doc.setFont('helvetica', 'normal');

                    // Monthly breakdown table
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    const tableStartY = bankingDetailsY + 60;
                    doc.text('Monthly Payment Breakdown', 20, tableStartY);

                    // Table headers
                    doc.setFontSize(8);
                    const startY = tableStartY + 10;
                    const rowHeight = 7;
                    doc.setFillColor(44, 62, 80);
                    doc.setTextColor(255, 255, 255);
                    doc.rect(20, startY, 170, rowHeight, 'F');
                    doc.text('Month', 25, startY + 5);
                    doc.text('Monthly', 45, startY + 5);
                    doc.text('Principal', 70, startY + 5);
                    doc.text('Interest', 95, startY + 5);
                    doc.text('Admin', 120, startY + 5);
                    doc.text('Balance', 145, startY + 5);

                    // Table rows with month names
                    doc.setTextColor(0, 0, 0);
                    let currentY = startY + rowHeight;
                    const availableHeight = 280 - currentY;
                    const maxRows = Math.floor(availableHeight / rowHeight);
                    const rowsToShow = Math.min(maxRows, loanData.breakdown.length);
                    
                    for (let i = 0; i < rowsToShow; i++) {
                        const row = loanData.breakdown[i];
                        if (i % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.rect(20, currentY, 170, rowHeight, 'F');
                        }
                        doc.setTextColor(0, 0, 0);
                        doc.text(getMonthName(loanData.startMonthIndex, i), 25, currentY + 5);
                        doc.text(`R${loanData.monthlyPayment.toFixed(2)}`, 45, currentY + 5);
                        doc.text(`R${row.principalPayment.toFixed(2)}`, 70, currentY + 5);
                        doc.text(`R${row.interest.toFixed(2)}`, 95, currentY + 5);
                        doc.text(`R${row.adminFee.toFixed(2)}`, 120, currentY + 5);
                        doc.text(`R${row.outstandingBalance.toFixed(2)}`, 145, currentY + 5);
                        currentY += rowHeight;
                    }
                    
                    if (rowsToShow < loanData.breakdown.length) {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Note: Showing ${rowsToShow} of ${loanData.breakdown.length} months`, 20, currentY + 10);
                    }

                    // Footer
                    const today = new Date().toLocaleDateString('en-ZA');
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Generated on: ${today}`, 20, 280);
                    doc.text('Thaba Bosiu Financial Services - Your Financial Refuge', 105, 285, { align: 'center' });

                    // Save PDF
                    const filename = `TBFS_Loan_Schedule_${loanData.accountNumber}.pdf`;
                    doc.save(filename);

                    console.log('PDF generated successfully:', filename);

                    // Show success message
                    const statusEl = document.getElementById('pdfStatus');
                    if (statusEl) {
                        statusEl.innerHTML = '<div class="success">PDF successfully generated and downloaded!</div>';
                        setTimeout(() => {
                            statusEl.innerHTML = '';
                        }, 5000);
                    }
                });
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('An error occurred while generating the PDF. Please try again.');
            }
        }

        function exportToExcel() {
            // Get table data
            const table = document.getElementById('breakdownTable');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Monthly Breakdown"});
            XLSX.writeFile(wb, 'TBFS_Monthly_Payment_Breakdown.xlsx');
        }

        // Backup and Restore Functions
        function backupData() {
            const data = localStorage.getItem('tbfsAppState');
            if (!data) {
                alert('No data to backup');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TBFS_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Data backup downloaded successfully!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.setItem('tbfsAppState', JSON.stringify(data));
                        AppState.init(); // Reload the app with restored data
                        alert('‚úÖ Data restored successfully!');
                    } catch (error) {
                        alert('‚ùå Invalid backup file. Please select a valid TBFS backup file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will permanently delete ALL data. Are you sure?')) {
                // Auto-backup before clearing
                console.log('üîí Auto-backup before clearing all data...');
                backupData();
                
                setTimeout(() => {
                localStorage.removeItem('tbfsAppState');
                AppState.init();
                    alert('üóëÔ∏è All data cleared successfully.\n\nüíæ A backup was automatically saved before clearing.');
                }, 500); // Small delay to ensure backup completes
            }
        }

        // Accept Loan Function
        function acceptLoan() {
            if (!loanData || !loanData.firstName) {
                alert('Please calculate a loan first before accepting it');
                return;
            }

            // Check if client exists and is active
            const existingClient = AppState.clients.find(c => c.account_number === loanData.accountNumber);
            if (existingClient) {
                if (existingClient.status !== 'active') {
                    alert(`‚ùå SECURITY ALERT: Client ${loanData.accountNumber} is ${existingClient.status.toUpperCase()}. Cannot approve loan for inactive clients.`);
                    return;
                }
            }

            // Create or update client
            let client;
            if (existingClient) {
                // Update existing client
                client = existingClient;
                client.total_loans += 1;
                client.total_contributions = loanData.totalContributions || client.total_contributions;
                // Initialize total_repayment if not exists
                if (!client.total_repayment) {
                    client.total_repayment = 0;
                }
            } else {
                // Create new client
                client = {
                    account_number: loanData.accountNumber,
                    first_name: loanData.firstName,
                    last_name: loanData.lastName,
                    phone_number: '', // Not collected in current form
                    client_type: loanData.isStockvelMember ? 'stockvel' : 'standard',
                    total_loans: 1,
                    total_contributions: loanData.totalContributions || 0,
                    total_repayment: 0, // Initialize total repayment to 0
                    status: 'active'
                };
                AppState.clients.push(client);
            }

            // Calculate interest cap based on Math.ceil(term/2) with minimum 3 months
            // BUT cannot exceed the actual loan term (for 1-2 month loans)
            const calculatedMonths = Math.ceil(loanData.term / 2) >= 3 ? Math.ceil(loanData.term / 2) : 3;
            const interestMonths = Math.min(calculatedMonths, loanData.term);
            
            // Create loan record with payment flexibility tracking
            const loan = {
                loan_id: AppState.loans.length + 1,
                client_name: `${loanData.firstName} ${loanData.lastName}`,
                account_number: loanData.accountNumber,
                principal_amount: loanData.principal,
                original_principal: loanData.principal, // Track original for interest cap
                remaining_principal: loanData.principal, // Track remaining principal
                term_months: loanData.term,
                interest_calculation_months: interestMonths, // Store the interest period for cap
                monthly_payment: loanData.monthlyPayment,
                total_cost: loanData.totalCost,
                current_balance: loanData.totalCost,
                total_initiation_fee: loanData.initiationFee, // Total initiation fee
                initiation_fee_paid: 0, // Track how much initiation fee has been paid
                max_interest_allowed: loanData.totalInterest, // Interest cap (based on Math.ceil(term/2) calculation)
                expected_monthly_interest: loanData.totalInterest / loanData.term, // Equalized monthly interest
                total_interest_charged: 0, // Track total interest charged so far
                payments_made: 0, // Track number of payments received
                status: 'active',
                created_at: new Date(loanData.loanDate + 'T12:00:00').toISOString() // Use custom loan date
            };

            // Add loan to system
            AppState.loans.push(loan);
            
            // NOTE: Initiation fee is NOT counted as earned here!
            // It will be counted incrementally as monthly payments are received
            
            // Disburse principal (reduce capital, increase deployed)
            AppState.capital -= loan.principal_amount;
            AppState.deployed += loan.principal_amount;
            
            // Log loan creation
            AppState.logTransaction('loan_created', `New loan #${loan.loan_id} created for ${loanData.firstName} ${loanData.lastName}`, {
                loanId: loan.loan_id,
                clientName: `${loanData.firstName} ${loanData.lastName}`,
                accountNumber: loanData.accountNumber,
                principal: loanData.principal,
                term: loanData.term,
                totalCost: loanData.totalCost,
                monthlyPayment: loanData.monthlyPayment
            });
            
            AppState.save();
            AppState.updateDashboard();

            alert(`‚úÖ Loan approved and added to system!\n\nClient: ${loanData.firstName} ${loanData.lastName}\nAccount: ${loanData.accountNumber}\nAmount: R${loanData.principal.toFixed(2)}\nMonthly Payment: R${loanData.monthlyPayment.toFixed(2)}`);

            // Reset form
            document.getElementById('loanForm').reset();
            document.getElementById('results').style.display = 'none';
        }

        // Client Status Management
        function updateClientStatus(accountNumber, newStatus) {
            const client = AppState.clients.find(c => c.account_number === accountNumber);
            if (!client) {
                alert('Client not found');
                return;
            }

            // Auto-backup before risky operations
            if (newStatus === 'defaulted' || newStatus === 'blacklisted') {
                console.log('üîí Auto-backup before risky operation...');
                backupData();
            }

            const oldStatus = client.status;
            client.status = newStatus;

            // If blacklisting or defaulting a client, also update their active loans
            if (newStatus === 'blacklisted' || newStatus === 'defaulted') {
                const clientLoans = AppState.loans.filter(l => l.account_number === accountNumber && l.status === 'active');
                clientLoans.forEach(loan => {
                    loan.status = newStatus;
                    AppState.deployed -= loan.principal_amount;
                });
            }

            // Log status change
            AppState.logTransaction('client_status', `Client ${client.first_name} ${client.last_name} status: ${oldStatus.toUpperCase()} ‚Üí ${newStatus.toUpperCase()}`, {
                accountNumber: accountNumber,
                clientName: `${client.first_name} ${client.last_name}`,
                previousStatus: oldStatus,
                newStatus: newStatus
            });

            // Save changes
            AppState.save();
            AppState.updateDashboard();

            // Show confirmation
            const statusMessages = {
                'active': '‚úÖ Client activated',
                'defaulted': '‚ùå Client marked as defaulted',
                'blacklisted': 'üö´ Client blacklisted'
            };

            alert(statusMessages[newStatus] || 'Client status updated');
        }

        // Payment Management
        function makePayment(loanId) {
            const loan = AppState.loans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('Loan not found');
                return;
            }

            if (loan.status !== 'active') {
                alert('Can only make payments on active loans');
                return;
            }

            // Get payment date from user first (default to today)
            const today = new Date().toISOString().split('T')[0];
            const paymentDate = prompt(`üìÖ Enter payment date (YYYY-MM-DD):`, today);
            
            if (!paymentDate) {
                alert('Payment cancelled');
                return;
            }
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(paymentDate)) {
                alert('Invalid date format. Please use YYYY-MM-DD format.');
                return;
            }

            // Calculate advanced payoff amount using new interest system
            const payoffInterest = AppState.calculateAdvancedInterest(loan, new Date(paymentDate));
            const initiationFeeRemaining = (loan.total_initiation_fee || 0) - (loan.initiation_fee_paid || 0);
            
            // Calculate interest balance (incurred - already paid)
            const interestAlreadyPaid = loan.total_interest_charged || 0;
            const interestBalance = Math.max(0, payoffInterest.totalOwed - interestAlreadyPaid);
            
            // Apply 20% discount to remaining interest for early payoff
            const discountedInterest = interestBalance * 0.80;
            
            const payoffAmount = (loan.remaining_principal || loan.principal_amount) + 
                                discountedInterest + 
                                initiationFeeRemaining;

            // Get payment amount from user
            const paymentAmount = prompt(`üí∞ Enter payment amount for Loan #${loanId}:\n\nüìä Current Status:\n‚Ä¢ Remaining Balance: R${loan.current_balance.toFixed(2)}\n‚Ä¢ Expected Monthly Payment: R${loan.monthly_payment.toFixed(2)}\n‚Ä¢ Remaining Principal: R${(loan.remaining_principal || loan.principal_amount).toFixed(2)}\n\nüí° Full Payoff Amount: R${payoffAmount.toFixed(2)}\n   (Principal + Remaining Initiation Fee)`);
            
            if (!paymentAmount || isNaN(paymentAmount) || parseFloat(paymentAmount) <= 0) {
                alert('Invalid payment amount');
                return;
            }

            const paidAmount = parseFloat(paymentAmount);
            
            // Find client to determine type
            const client = AppState.clients.find(c => c.account_number === loan.account_number);
            const isStockvel = client && client.client_type === 'stockvel';
            
            // Initialize loan fields if they don't exist (for older loans)
            if (!loan.remaining_principal) loan.remaining_principal = loan.principal_amount;
            if (!loan.original_principal) loan.original_principal = loan.principal_amount;
            if (!loan.total_initiation_fee) loan.total_initiation_fee = loan.principal_amount * 0.09;
            if (!loan.initiation_fee_paid) loan.initiation_fee_paid = 0;
            if (!loan.total_interest_charged) loan.total_interest_charged = 0;
            
            // Calculate max interest allowed based on Math.ceil(term/2) with min 3 months
            // BUT cannot exceed the actual loan term (for 1-2 month loans)
            if (!loan.max_interest_allowed) {
                const calculatedMonths = Math.ceil(loan.term_months / 2) >= 3 ? Math.ceil(loan.term_months / 2) : 3;
                const interestMonths = Math.min(calculatedMonths, loan.term_months);
                // Calculate declining balance interest for the interest period
                let maxInterest = 0;
                let balance = loan.original_principal;
                const monthlyPrincipal = loan.original_principal / loan.term_months;
                for (let i = 0; i < interestMonths; i++) {
                    maxInterest += balance * 0.15;
                    balance -= monthlyPrincipal;
                }
                loan.max_interest_allowed = maxInterest;
            }
            
            // Calculate expected monthly interest for older loans that don't have it
            if (!loan.expected_monthly_interest) {
                loan.expected_monthly_interest = loan.max_interest_allowed / loan.term_months;
            }
            
            // Calculate admin fee (perpetual R60 per payment)
            let adminFeePerMonth = 60;
            if (isStockvel) {
                const totalContributions = client.total_contributions || 0;
                if (totalContributions >= 20000) adminFeePerMonth = 45;
                else if (totalContributions >= 10000) adminFeePerMonth = 50;
            }
            
            // Step 1: Deduct admin fee from payment
            let remainingPayment = paidAmount - adminFeePerMonth;
            if (remainingPayment < 0) {
                alert(`‚ùå Payment too low! Minimum is R${adminFeePerMonth.toFixed(2)} for admin fee.`);
                return;
            }
            
            // Step 2: Calculate initiation fee portion
            const remainingInitiationFee = loan.total_initiation_fee - loan.initiation_fee_paid;
            const expectedMonthlyInitiation = loan.total_initiation_fee / loan.term_months;
            let initiationFeePaid = Math.min(expectedMonthlyInitiation, remainingInitiationFee, remainingPayment);
            remainingPayment -= initiationFeePaid;
            
            // Step 3: Calculate interest using ADVANCED system (calendar-based + 100% cap)
            const paymentInterest = AppState.calculateAdvancedInterest(loan, new Date(paymentDate));
            const interestPaidSoFar = loan.total_interest_charged || 0;
            const remainingInterest = Math.max(0, paymentInterest.totalOwed - interestPaidSoFar);
            
            // For early payoff, apply 20% discount to interest
            let isEarlyPayoff = paidAmount >= payoffAmount;
            const interestForThisPayment = isEarlyPayoff ? 
                Math.min(remainingInterest * 0.80, remainingPayment) : 
                Math.min(remainingInterest, remainingPayment);
            
            remainingPayment -= interestForThisPayment;
            
            // Step 4: Apply remaining payment to principal
            let principalPaid = Math.min(remainingPayment, loan.remaining_principal);
            
            // Round to 2 decimal places to avoid floating-point errors
            principalPaid = Math.round(principalPaid * 100) / 100;
            
            // Check for payoff (full balance paid or very small remaining balance)
            const isFullPayoff = paidAmount >= payoffAmount || loan.remaining_principal - principalPaid < 0.01;
            
            // Determine if this is actually an EARLY payoff (paid before due)
            // Note: isEarlyPayoff already declared above for interest calculation
            if (isFullPayoff) {
                // Calculate expected completion date (loan start + term)
                const loanStartDate = new Date(loan.created_at);
                const expectedCompletionDate = new Date(loanStartDate);
                expectedCompletionDate.setMonth(expectedCompletionDate.getMonth() + loan.term_months);
                
                // Compare payment date to expected completion
                const actualPaymentDate = new Date(paymentDate);
                isEarlyPayoff = actualPaymentDate < expectedCompletionDate;
            }
            
            // Update loan tracking
            loan.remaining_principal -= principalPaid;
            loan.initiation_fee_paid += initiationFeePaid;
            loan.total_interest_charged += interestForThisPayment;
            loan.current_balance -= paidAmount;
            loan.payments_made = (loan.payments_made || 0) + 1; // Increment payment counter
            
            // Round to 2 decimal places to avoid floating-point errors
            loan.remaining_principal = Math.round(loan.remaining_principal * 100) / 100;
            loan.current_balance = Math.round(loan.current_balance * 100) / 100;
            
            // If balance is tiny (< R0.01), zero it out
            if (loan.remaining_principal < 0.01) {
                loan.remaining_principal = 0;
            }
            if (loan.current_balance < 0.01) {
                loan.current_balance = 0;
            }
            
            // Update AppState
            AppState.deployed = Math.max(0, AppState.deployed - principalPaid);
            AppState.capital += paidAmount; // All money goes to capital
            AppState.totalInterestEarned += interestForThisPayment;
            AppState.totalFeesEarned += (adminFeePerMonth + initiationFeePaid);
            
            // Update client repayment
            if (client) {
                if (!client.total_repayment) client.total_repayment = 0;
                client.total_repayment += paidAmount;
            }
            
            // Check payment type
            const expectedPayment = loan.monthly_payment;
            let paymentType = 'Regular';
            if (isEarlyPayoff) {
                paymentType = 'Early Payoff';
            } else if (isFullPayoff) {
                paymentType = 'Final Payment';
            } else if (paidAmount > expectedPayment) {
                paymentType = `Overpayment (+R${(paidAmount - expectedPayment).toFixed(2)})`;
            } else if (paidAmount < expectedPayment) {
                paymentType = `Partial Payment (-R${(expectedPayment - paidAmount).toFixed(2)})`;
            }
            
            // Log transaction (with AppState values for undo)
            AppState.logTransaction('payment', `${paymentType}: R${paidAmount.toFixed(2)} from ${loan.client_name} (Loan #${loanId})`, {
                loanId: loanId,
                amount: paidAmount,
                paymentDate: paymentDate, // Custom payment date
                principalPaid: principalPaid,
                interestPaid: interestForThisPayment,
                adminFeePaid: adminFeePerMonth,
                initiationFeePaid: initiationFeePaid,
                previousRemainingPrincipal: loan.remaining_principal + principalPaid,
                newRemainingPrincipal: loan.remaining_principal,
                previousBalance: loan.current_balance + paidAmount,
                newBalance: loan.current_balance,
                // AppState values (for undo functionality)
                previousCapital: AppState.capital - paidAmount,
                previousDeployed: AppState.deployed + principalPaid,
                previousInterestEarned: AppState.totalInterestEarned - interestForThisPayment,
                previousFeesEarned: AppState.totalFeesEarned - (adminFeePerMonth + initiationFeePaid),
                previousClientRepayment: client ? (client.total_repayment - paidAmount) : 0
            });

            // Save changes
            AppState.save();
            AppState.updateDashboard();

            // Show detailed summary
            let summary = `üí∞ Payment Processed!\n\n`;
            summary += `Type: ${paymentType}\n`;
            summary += `Amount Paid: R${paidAmount.toFixed(2)}\n\n`;
            summary += `üìä Breakdown:\n`;
            summary += `‚Ä¢ Principal: R${principalPaid.toFixed(2)}\n`;
            summary += `‚Ä¢ Interest: R${interestForThisPayment.toFixed(2)}\n`;
            summary += `‚Ä¢ Admin Fee: R${adminFeePerMonth.toFixed(2)}\n`;
            summary += `‚Ä¢ Initiation Fee: R${initiationFeePaid.toFixed(2)}\n\n`;
            summary += `üìà Loan Status:\n`;
            summary += `‚Ä¢ Remaining Principal: R${loan.remaining_principal.toFixed(2)}\n`;
            summary += `‚Ä¢ Interest Cap Remaining: R${(loan.max_interest_allowed - loan.total_interest_charged).toFixed(2)}\n`;
            
            if (isFullPayoff || loan.remaining_principal <= 0) {
                loan.remaining_principal = 0;
                loan.current_balance = 0;
                loan.status = 'completed';
                AppState.logTransaction('system', `Loan #${loanId} ${isEarlyPayoff ? 'PAID OFF EARLY' : 'PAID OFF'} - ${loan.client_name}`, {
                    loanId: loanId,
                    totalInterestCharged: loan.total_interest_charged,
                    interestSaved: loan.max_interest_allowed - loan.total_interest_charged
                });
                AppState.save();
                AppState.updateDashboard();
                summary += `\nüéâ LOAN PAID OFF!\n`;
                if (!isEarlyPayoff) {
                    summary += `Interest Saved: R${(loan.max_interest_allowed - loan.total_interest_charged).toFixed(2)}`;
                }
            }
            
            alert(summary);
        }

        // Undo Last Payment
        function undoLastPayment() {
            const lastTransaction = AppState.transactionHistory[0];
            
            if (!lastTransaction || lastTransaction.type !== 'payment') {
                alert('‚ùå No payment to undo');
                return;
            }
            
            if (!confirm(`Are you sure you want to undo the last payment?\n\n${lastTransaction.description}\n\nThis will reverse all changes made by this payment.`)) {
                return;
            }
            
            const details = lastTransaction.details;
            const loan = AppState.loans.find(l => l.loan_id === details.loanId);
            
            if (!loan) {
                alert('‚ùå Cannot find loan for this payment');
                return;
            }
            
            const client = AppState.clients.find(c => c.account_number === loan.account_number);
            
            // Reverse all changes
            loan.current_balance = details.previousBalance;
            loan.remaining_principal = details.previousRemainingPrincipal;
            AppState.capital = details.previousCapital;
            AppState.deployed = details.previousDeployed;
            AppState.totalInterestEarned = details.previousInterestEarned;
            AppState.totalFeesEarned = details.previousFeesEarned;
            
            // Reverse interest and fees charged
            if (details.interestPaid) {
                loan.total_interest_charged = (loan.total_interest_charged || 0) - details.interestPaid;
            }
            if (details.initiationFeePaid) {
                loan.initiation_fee_paid = (loan.initiation_fee_paid || 0) - details.initiationFeePaid;
            }
            
            // Decrement payment counter
            if (loan.payments_made && loan.payments_made > 0) {
                loan.payments_made -= 1;
            }
            
            if (client) {
                client.total_repayment = details.previousClientRepayment;
            }
            
            // If loan was completed, reactivate it
            if (loan.status === 'completed' && loan.current_balance > 0) {
                loan.status = 'active';
            }
            
            // Remove the payment transaction from history
            AppState.transactionHistory.shift();
            
            // Log the undo action
            AppState.logTransaction('system', `UNDONE: ${lastTransaction.description}`, {
                originalTransactionId: lastTransaction.id,
                amountReversed: details.amount
            });
            
            AppState.save();
            AppState.updateDashboard();
            
            alert(`‚úÖ Payment undone successfully!\n\nReversed: R${details.amount.toFixed(2)}\nLoan #${details.loanId} balance restored to: R${details.previousBalance.toFixed(2)}`);
        }

        // Loan Status Management
        function updateLoanStatus(loanId, newStatus) {
            const loan = AppState.loans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('Loan not found');
                return;
            }

            const oldStatus = loan.status;
            loan.status = newStatus;
            
            // Update deployed capital based on status change
            if (oldStatus === 'active' && newStatus !== 'active') {
                // Loan is no longer active, reduce deployed capital
                AppState.deployed -= loan.principal_amount;
            } else if (oldStatus !== 'active' && newStatus === 'active') {
                // Loan is now active, increase deployed capital
                AppState.deployed += loan.principal_amount;
            }

            // Save changes
            AppState.save();
            AppState.updateDashboard();

            // Show confirmation
            const statusMessages = {
                'completed': '‚úÖ Loan marked as completed (paid)',
                'defaulted': '‚ùå Loan marked as defaulted',
                'blacklisted': 'üö´ Client blacklisted',
                'active': 'üîÑ Loan reactivated'
            };

            alert(statusMessages[newStatus] || 'Status updated');
        }

        // ===== UPDATE MANAGEMENT SYSTEM =====
        let updateAvailable = false;
        let waitingServiceWorker = null;
        
        // Display current version
        document.getElementById('currentVersion').textContent = `v${APP_VERSION}`;
        
        // PWA Service Worker Registration with Update Detection
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        
                        // Check for updates on load
                        registration.update();
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker found!');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker installed, update available
                                    console.log('Update available!');
                                    updateAvailable = true;
                                    waitingServiceWorker = newWorker;
                                    showUpdateBanner();
                                    document.getElementById('updateStatus').textContent = 'üéâ Update available!';
                                    document.getElementById('updateStatus').style.color = '#27ae60';
                                }
                            });
                        });
                        
                        // Check for updates every 30 minutes
                        setInterval(() => {
                            console.log('Checking for updates...');
                            registration.update();
                        }, 30 * 60 * 1000);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                        document.getElementById('updateStatus').textContent = 'Service worker not available';
                    });
                
                // Listen for controller change (update activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker activated, reloading...');
                    window.location.reload();
                });
            });
        } else {
            document.getElementById('updateStatus').textContent = 'Service worker not supported';
        }
        
        // Check for updates manually - Fetches version from GitHub Pages
        async function checkForUpdates() {
            const button = document.querySelector('[onclick="checkForUpdates()"]');
            if (button) {
                button.disabled = true;
                button.textContent = 'üîÑ Checking...';
            }
            document.getElementById('updateStatus').textContent = 'Checking for updates...';
            document.getElementById('updateStatus').style.color = '#7f8c8d';
            
            try {
                // Fetch the deployed index.html from GitHub Pages with cache-busting
                const response = await fetch(`https://ndelo-n.github.io/TBFS-Connected/index.html?t=${Date.now()}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch latest version');
                }
                
                const html = await response.text();
                
                // Extract version number from the deployed HTML
                const versionMatch = html.match(/const APP_VERSION = ['"]([^'"]+)['"]/);
                
                if (versionMatch && versionMatch[1]) {
                    const remoteVersion = versionMatch[1];
                    const currentVersion = APP_VERSION;
                    
                    console.log(`Current: ${currentVersion}, Remote: ${remoteVersion}`);
                    
                    if (remoteVersion !== currentVersion) {
                        // Version mismatch - update available
                        updateAvailable = true;
                        document.getElementById('updateStatus').textContent = `üéâ Update available! v${currentVersion} ‚Üí v${remoteVersion}`;
                        document.getElementById('updateStatus').style.color = '#27ae60';
                        showUpdateBanner();
                        
                        // Also trigger service worker update to fetch new files
                        if ('serviceWorker' in navigator) {
                            const registration = await navigator.serviceWorker.getRegistration();
                            if (registration) {
                                registration.update();
                            }
                        }
                    } else {
                        // Versions match - no update needed
                        updateAvailable = false;
                        document.getElementById('updateStatus').textContent = `‚úÖ You're running the latest version! (v${currentVersion})`;
                        document.getElementById('updateStatus').style.color = '#27ae60';
                        dismissUpdateBanner(); // Hide banner if shown
                    }
                } else {
                    // Couldn't extract version - fallback to service worker check
                    document.getElementById('updateStatus').textContent = 'Version check inconclusive - checking service worker...';
                    
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.getRegistration();
                        if (registration) {
                            await registration.update();
                            
                            setTimeout(() => {
                                if (updateAvailable) {
                                    document.getElementById('updateStatus').textContent = 'üéâ Update available!';
                                    document.getElementById('updateStatus').style.color = '#27ae60';
                                    showUpdateBanner();
                                } else {
                                    document.getElementById('updateStatus').textContent = '‚úÖ No updates found';
                                    document.getElementById('updateStatus').style.color = '#27ae60';
                                }
                            }, 1500);
                        }
                    }
                }
                
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üîÑ Check for Updates';
                }
                
            } catch (error) {
                console.error('Update check failed:', error);
                document.getElementById('updateStatus').textContent = '‚ùå Failed to check for updates. Check your internet connection.';
                document.getElementById('updateStatus').style.color = '#e74c3c';
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üîÑ Check for Updates';
                }
            }
        }
        
        // Show update banner
        function showUpdateBanner() {
            const banner = document.getElementById('updateBanner');
            if (banner) {
                banner.style.display = 'block';
            }
        }
        
        // Dismiss update banner
        function dismissUpdateBanner() {
            const banner = document.getElementById('updateBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        // Activate update
        function activateUpdate() {
            if (waitingServiceWorker) {
                // Send message to service worker to skip waiting
                waitingServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                // Show loading message
                const banner = document.getElementById('updateBanner');
                if (banner) {
                    banner.innerHTML = `
                        <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
                            <strong>üîÑ Updating...</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">The app will reload in a moment</p>
                        </div>
                    `;
                }
            } else {
                // Fallback: just reload
                alert('Reloading to apply update...');
                window.location.reload();
            }
        }

        // ===== CLOUD BACKUP SYSTEM =====
        const CloudBackup = {
            autoBackupEnabled: false,
            token: null,
            repoOwner: 'Ndelo-N',
            repoName: 'TBFS-Data-Backup',
            
            init() {
                // Check if token is configured
                const encryptedToken = localStorage.getItem('githubBackupToken');
                if (encryptedToken) {
                    this.token = this.decrypt(encryptedToken);
                }
                
                // Check if auto-backup is enabled
                const autoBackupSetting = localStorage.getItem('autoBackupEnabled');
                this.autoBackupEnabled = (autoBackupSetting === 'true');
                
                this.updateUI();
                
                if (this.autoBackupEnabled) {
                    this.updateSyncTime();
                }
                
                // Setup online/offline listeners
                window.addEventListener('online', () => this.syncPendingBackups());
            },
            
            hasToken() {
                return this.token !== null && this.token.length > 0;
            },
            
            encrypt(text) {
                // Simple Base64 encoding (for basic obfuscation)
                // In production, use stronger encryption
                return btoa(unescape(encodeURIComponent(text)));
            },
            
            decrypt(encoded) {
                return decodeURIComponent(escape(atob(encoded)));
            },
            
            updateUI() {
                if (this.hasToken()) {
                    document.getElementById('tokenConfigured').style.display = 'block';
                    document.getElementById('cloudBackupSetup').style.display = 'none';
                    
                    // Update toggle checkbox
                    const toggle = document.getElementById('autoBackupToggle');
                    if (toggle) {
                        toggle.checked = this.autoBackupEnabled;
                    }
                    
                    // Show/hide auto-backup status
                    if (this.autoBackupEnabled) {
                        document.getElementById('autoBackupStatus').style.display = 'block';
                    } else {
                        document.getElementById('autoBackupStatus').style.display = 'none';
                    }
                } else {
                    document.getElementById('tokenConfigured').style.display = 'none';
                    document.getElementById('cloudBackupSetup').style.display = 'block';
                }
            },
            
            updateSyncTime() {
                const lastSync = localStorage.getItem('lastCloudSync');
                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - date) / 60000);
                    
                    let timeText;
                    if (diffMinutes < 1) {
                        timeText = 'Just now';
                    } else if (diffMinutes < 60) {
                        timeText = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    }
                    
                    document.getElementById('lastSyncTime').textContent = timeText;
                }
            },
            
            async backup() {
                if (!this.autoBackupEnabled || !this.hasToken()) {
                    return; // Auto-backup not enabled, skip
                }
                
                if (!navigator.onLine) {
                    // Queue for later if offline
                    localStorage.setItem('pendingCloudBackup', 'true');
                    console.log('Offline: Backup queued for when online');
                    return;
                }
                
                const data = {
                    capital: AppState.capital,
                    deployed: AppState.deployed,
                    totalInterestEarned: AppState.totalInterestEarned,
                    totalFeesEarned: AppState.totalFeesEarned,
                    profitGoal: AppState.profitGoal,
                    clients: AppState.clients,
                    loans: AppState.loans,
                    transactionHistory: AppState.transactionHistory,
                    nextAccountNumber: AppState.nextAccountNumber,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    // Upload latest.json
                    await this.uploadToGitHub('latest.json', data);
                    
                    // Also create daily snapshot
                    const dateStr = new Date().toISOString().split('T')[0];
                    await this.uploadToGitHub(`daily/${dateStr}.json`, data);
                    
                    localStorage.setItem('lastCloudSync', new Date().toISOString());
                    localStorage.removeItem('pendingCloudBackup');
                    this.updateSyncTime();
                    
                    console.log('‚úÖ Cloud backup successful');
                } catch (error) {
                    console.error('Cloud backup failed:', error);
                    localStorage.setItem('pendingCloudBackup', 'true');
                }
            },
            
            async uploadToGitHub(path, data) {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${path}`;
                
                // Check if file exists to get SHA
                let sha = null;
                try {
                    const getResponse = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist, that's okay
                }
                
                // Create or update file
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Backup: ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.statusText}`);
                }
            },
            
            async syncPendingBackups() {
                const hasPending = localStorage.getItem('pendingCloudBackup');
                if (hasPending && this.autoBackupEnabled && this.hasToken()) {
                    console.log('üîÑ Syncing pending backup...');
                    await this.backup();
                    alert('‚úÖ Pending backup synced to cloud!');
                }
            },
            
            async restore() {
                if (!this.hasToken()) {
                    alert('Please configure your GitHub token first in Settings');
                    return;
                }
                
                try {
                    const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/latest.json`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        // Handle different error types with specific messages
                        if (response.status === 404) {
                            // No backup file exists yet - this is not an error, just information
                            alert('‚ÑπÔ∏è No cloud backup found yet.\n\n' +
                                  'üí° To create your first backup:\n' +
                                  '1. Enable "Auto-Backup" in Settings, or\n' +
                                  '2. Make any change (add/edit a loan) to trigger automatic backup, or\n' +
                                  '3. Use "Download Local Backup" to save locally first\n\n' +
                                  'Once created, your backup will sync across all devices!');
                            return;
                        } else if (response.status === 401) {
                            throw new Error('Authentication failed. Please check your GitHub token in Settings.');
                        } else if (response.status === 403) {
                            throw new Error('Access denied. Please verify your token has "Contents: Read and write" permission for the backup repository.');
                        } else {
                            throw new Error(`Unable to access cloud backup (Error ${response.status}). Please check your internet connection and try again.`);
                        }
                    }
                    
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    const data = JSON.parse(content);
                    
                    // Restore data
                    localStorage.setItem('tbfsAppState', JSON.stringify(data));
                    AppState.init();
                    alert('‚úÖ Data restored from cloud successfully!');
                } catch (error) {
                    // Only show error for actual errors (not 404 which we handled above)
                    alert('‚ùå Failed to restore from cloud: ' + error.message);
                }
            }
        };
        
        // Cloud Backup UI Functions
        function saveToken() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                alert('Please enter your GitHub token');
                return;
            }
            
            if (!token.startsWith('github_pat_') && !token.startsWith('ghp_')) {
                alert('Invalid token format. Token should start with "github_pat_" or "ghp_"');
                return;
            }
            
            // Encrypt and store token
            const encrypted = CloudBackup.encrypt(token);
            localStorage.setItem('githubBackupToken', encrypted);
            
            CloudBackup.token = token;
            CloudBackup.updateUI();
            
            // Clear token input
            document.getElementById('githubToken').value = '';
            
            alert('‚úÖ Token saved! You can now restore from cloud.\n\nüí° Tip: Check the "Enable Auto-Backup" box if you want this device to automatically sync changes to cloud.');
        }
        
        function removeToken() {
            if (confirm('Remove GitHub token? You won\'t be able to backup or restore from cloud until you add it again.')) {
                localStorage.removeItem('githubBackupToken');
                localStorage.removeItem('autoBackupEnabled');
                localStorage.removeItem('lastCloudSync');
                CloudBackup.token = null;
                CloudBackup.autoBackupEnabled = false;
                CloudBackup.updateUI();
                alert('Token removed');
            }
        }
        
        function toggleAutoBackup() {
            const isChecked = document.getElementById('autoBackupToggle').checked;
            
            if (isChecked) {
                // Enabling auto-backup
                CloudBackup.autoBackupEnabled = true;
                localStorage.setItem('autoBackupEnabled', 'true');
                CloudBackup.updateUI();
                
                // Perform initial backup
                CloudBackup.backup();
                
                alert('‚úÖ Auto-backup enabled! Every change will now sync to cloud automatically.');
            } else {
                // Disabling auto-backup
                if (confirm('Disable auto-backup on this device? You can still restore from cloud anytime.')) {
                    CloudBackup.autoBackupEnabled = false;
                    localStorage.setItem('autoBackupEnabled', 'false');
                    CloudBackup.updateUI();
                    alert('Auto-backup disabled. You can still restore from cloud anytime.');
                } else {
                    // User cancelled, re-check the box
                    document.getElementById('autoBackupToggle').checked = true;
                }
            }
        }
        
        async function restoreFromCloud() {
            if (!CloudBackup.hasToken()) {
                alert('Please configure your GitHub token first in Settings tab');
                return;
            }
            
            if (confirm('This will restore data from your cloud backup and overwrite local data. Continue?')) {
                await CloudBackup.restore();
            }
        }
        
        // Initialize cloud backup on load
        document.addEventListener('DOMContentLoaded', function() {
            CloudBackup.init();
            
            // Update sync time every minute
            setInterval(() => CloudBackup.updateSyncTime(), 60000);
        });
        
        // Hook into existing save function to trigger cloud backup
        const originalSave = AppState.save;
        AppState.save = function() {
            originalSave.call(this);
            // Trigger cloud backup after saving locally (only if auto-backup enabled)
            if (CloudBackup.autoBackupEnabled && CloudBackup.hasToken()) {
                CloudBackup.backup();
            }
        };

        // ========================================
        // REPORTS & ANALYTICS (v1.5)
        // ========================================

        // Reports State
        const ReportsState = {
            currentPeriod: 'all',
            charts: {}
        };

        // Set Report Period
        function setReportPeriod(period) {
            ReportsState.currentPeriod = period;
            
            // Update button styles
            ['month', 'quarter', 'year', 'all'].forEach(p => {
                const btn = document.getElementById(`period${p.charAt(0).toUpperCase() + p.slice(1)}`);
                if (btn) {
                    if (p === period) {
                        btn.className = 'btn';
                        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    } else {
                        btn.className = 'btn btn-secondary';
                        btn.style.background = '';
                    }
                }
            });
            
            generateReports();
        }

        // Filter loans by date period
        function filterLoansByPeriod(loans) {
            if (ReportsState.currentPeriod === 'all') return loans;
            
            const now = new Date();
            const startDate = new Date();
            
            switch(ReportsState.currentPeriod) {
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
                case 'quarter':
                    startDate.setMonth(now.getMonth() - 3);
                    break;
                case 'year':
                    startDate.setFullYear(now.getFullYear() - 1);
                    break;
            }
            
            return loans.filter(loan => {
                const loanDate = new Date(loan.created_at);
                return loanDate >= startDate;
            });
        }

        // Generate All Reports
        function generateReports() {
            const filteredLoans = filterLoansByPeriod(AppState.loans);
            
            // Calculate Summary Stats
            updateReportSummary(filteredLoans);
            
            // Update Performance Metrics
            updatePerformanceMetrics(filteredLoans);
            
            // Generate Charts
            generateRevenueTrendChart();
            generateCashFlowProjections(); // NEW v1.6
            generateROCDTrendChart(); // NEW v1.6
            generateLoanTypeChart(filteredLoans);
            generateLoanStatusChart(filteredLoans);
        }

        // Update Report Summary
        function updateReportSummary(loans) {
            const totalRevenue = AppState.totalInterestEarned + AppState.totalFeesEarned;
            const avgLoanSize = loans.length > 0 ? loans.reduce((sum, l) => sum + l.principal_amount, 0) / loans.length : 0;
            const avgLoanTerm = loans.length > 0 ? loans.reduce((sum, l) => sum + l.term_months, 0) / loans.length : 0;
            
            document.getElementById('reportTotalRevenue').textContent = `R${totalRevenue.toFixed(2)}`;
            document.getElementById('reportInterestEarned').textContent = `R${AppState.totalInterestEarned.toFixed(2)}`;
            document.getElementById('reportFeesEarned').textContent = `R${AppState.totalFeesEarned.toFixed(2)}`;
            document.getElementById('reportLoansDisbursed').textContent = loans.length;
            document.getElementById('reportAvgLoanSize').textContent = `R${avgLoanSize.toFixed(2)}`;
            document.getElementById('reportAvgLoanTerm').textContent = `${avgLoanTerm.toFixed(1)} months`;
        }

        // Update Performance Metrics
        function updatePerformanceMetrics(loans) {
            // ROCD (Return on Capital Deployed)
            const totalRevenue = AppState.totalInterestEarned + AppState.totalFeesEarned;
            const rocd = AppState.deployed > 0 ? (totalRevenue / AppState.deployed) * 100 : 0;
            
            // Default Rate
            const defaultedCount = AppState.loans.filter(l => l.status === 'defaulted').length;
            const defaultRate = AppState.loans.length > 0 ? (defaultedCount / AppState.loans.length) * 100 : 0;
            
            // Portfolio Utilization
            const utilization = AppState.capital > 0 ? (AppState.deployed / (AppState.capital + AppState.deployed)) * 100 : 0;
            
            // Average Client Lifetime Value
            const totalClients = AppState.clients.length;
            const clv = totalClients > 0 ? totalRevenue / totalClients : 0;
            
            document.getElementById('reportROCD').textContent = `${rocd.toFixed(2)}%`;
            document.getElementById('reportDefaultRate').textContent = `${defaultRate.toFixed(2)}%`;
            document.getElementById('reportUtilization').textContent = `${utilization.toFixed(2)}%`;
            document.getElementById('reportCLV').textContent = `R${clv.toFixed(2)}`;
        }

        // Generate Revenue Trend Chart (Last 12 Months) - ENHANCED v1.6
        function generateRevenueTrendChart() {
            const ctx = document.getElementById('revenueTrendChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (ReportsState.charts.revenueTrend) {
                ReportsState.charts.revenueTrend.destroy();
            }
            
            // Get last 12 months of ACTUAL revenue data from transaction history
            const monthLabels = [];
            const interestData = [];
            const feesData = [];
            const totalRevenueData = [];
            const now = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                monthLabels.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                
                // Calculate ACTUAL revenue for this month from transaction history
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59);
                
                let monthInterest = 0;
                let monthFees = 0;
                
                // Iterate through AppState.transactionHistory to find payments made in this month
                AppState.transactionHistory.forEach(transaction => {
                    if (transaction.type === 'payment' && transaction.details) {
                        const paymentDate = new Date(transaction.details.paymentDate || transaction.timestamp);
                        
                        if (paymentDate >= monthStart && paymentDate <= monthEnd) {
                            // Accumulate actual revenue from this payment
                            monthInterest += (transaction.details.interestPaid || 0);
                            monthFees += (transaction.details.adminFeePaid || 0) + (transaction.details.initiationFeePaid || 0);
                        }
                    }
                });
                
                interestData.push(monthInterest);
                feesData.push(monthFees);
                totalRevenueData.push(monthInterest + monthFees);
            }
            
            ReportsState.charts.revenueTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Interest Revenue (R)',
                            data: interestData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            tension: 0.4,
                            fill: true,
                            order: 2
                        },
                        {
                            label: 'Fees Revenue (R)',
                            data: feesData,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.2)',
                            tension: 0.4,
                            fill: true,
                            order: 3
                        },
                        {
                            label: 'Total Revenue (R)',
                            data: totalRevenueData,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: false,
                            borderWidth: 3,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'R' + context.parsed.y.toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: false,
                            ticks: {
                                callback: function(value) {
                                    return 'R' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Generate Cash Flow Projections (Next 6 Months) - NEW v1.6
        function generateCashFlowProjections() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (ReportsState.charts.cashFlow) {
                ReportsState.charts.cashFlow.destroy();
            }
            
            // Calculate projections for next 6 months
            const monthLabels = [];
            const principalData = [];
            const interestData = [];
            const feesData = [];
            const totalInflowData = [];
            const paymentsCountData = [];
            const now = new Date();
            
            let totalPrincipal = 0;
            let totalInterest = 0;
            let totalFees = 0;
            let totalInflow = 0;
            let totalPayments = 0;
            
            // Clear and rebuild table
            const tableBody = document.getElementById('cashFlowTableBody');
            if (tableBody) {
                tableBody.innerHTML = '';
            }
            
            for (let i = 0; i < 6; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthStart = new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
                const monthEnd = new Date(monthDate.getFullYear(), monthDate.getMonth() + 1, 0, 23, 59, 59);
                const monthLabel = monthDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                monthLabels.push(monthLabel);
                
                let monthPrincipal = 0;
                let monthInterest = 0;
                let monthFees = 0;
                let monthPayments = 0;
                
                // Go through all ACTIVE loans
                const activeLoans = AppState.loans.filter(l => l.status === 'active');
                
                activeLoans.forEach(loan => {
                    const monthlyPayment = loan.monthly_payment || 0;
                    const loanStartDate = new Date(loan.created_at);
                    
                    // Calculate which payment month this is for the loan
                    const monthsSinceStart = (monthDate.getFullYear() - loanStartDate.getFullYear()) * 12 + 
                                           (monthDate.getMonth() - loanStartDate.getMonth());
                    
                    // If this month falls within the loan term and loan hasn't been fully paid
                    if (monthsSinceStart >= 0 && monthsSinceStart < loan.term_months && loan.remaining_principal > 0) {
                        // Estimate allocation (simplified - assumes even distribution)
                        const remainingBalance = loan.remaining_principal || 0;
                        const remainingMonths = loan.term_months - (loan.payments_made || 0);
                        
                        if (remainingMonths > 0 && monthlyPayment > 0) {
                            // Expected monthly payment
                            const estimatedPrincipal = Math.min(remainingBalance / remainingMonths, monthlyPayment * 0.5);
                            const estimatedInterest = monthlyPayment * 0.3; // Rough estimate
                            const estimatedFees = monthlyPayment * 0.2; // Admin + initiation
                            
                            monthPrincipal += estimatedPrincipal;
                            monthInterest += estimatedInterest;
                            monthFees += estimatedFees;
                            monthPayments++;
                        }
                    }
                });
                
                principalData.push(monthPrincipal);
                interestData.push(monthInterest);
                feesData.push(monthFees);
                totalInflowData.push(monthPrincipal + monthInterest + monthFees);
                paymentsCountData.push(monthPayments);
                
                totalPrincipal += monthPrincipal;
                totalInterest += monthInterest;
                totalFees += monthFees;
                totalInflow += (monthPrincipal + monthInterest + monthFees);
                totalPayments += monthPayments;
                
                // Add to table
                if (tableBody) {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #dee2e6';
                    row.innerHTML = `
                        <td style="padding: 10px;">${monthLabel}</td>
                        <td style="padding: 10px; text-align: right;">R${monthPrincipal.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">R${monthInterest.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">R${monthFees.toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold;">R${(monthPrincipal + monthInterest + monthFees).toFixed(2)}</td>
                        <td style="padding: 10px; text-align: right;">${monthPayments}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            
            // Update totals
            document.getElementById('totalPrincipal').textContent = `R${totalPrincipal.toFixed(2)}`;
            document.getElementById('totalInterest').textContent = `R${totalInterest.toFixed(2)}`;
            document.getElementById('totalFees').textContent = `R${totalFees.toFixed(2)}`;
            document.getElementById('totalInflow').textContent = `R${totalInflow.toFixed(2)}`;
            document.getElementById('totalPayments').textContent = totalPayments;
            
            // Create stacked bar chart
            ReportsState.charts.cashFlow = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Principal Expected (R)',
                            data: principalData,
                            backgroundColor: '#3498db',
                            stack: 'stack0'
                        },
                        {
                            label: 'Interest Expected (R)',
                            data: interestData,
                            backgroundColor: '#667eea',
                            stack: 'stack0'
                        },
                        {
                            label: 'Fees Expected (R)',
                            data: feesData,
                            backgroundColor: '#f39c12',
                            stack: 'stack0'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(item => {
                                        total += item.parsed.y;
                                    });
                                    return 'Total: R' + total.toFixed(2);
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'R' + context.parsed.y.toFixed(2);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate ROCD Trend Chart (Last 12 Months) - NEW v1.6
        function generateROCDTrendChart() {
            const ctx = document.getElementById('rocdTrendChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (ReportsState.charts.rocdTrend) {
                ReportsState.charts.rocdTrend.destroy();
            }
            
            // Calculate ROCD for last 12 months
            const monthLabels = [];
            const rocdData = [];
            const now = new Date();
            
            let totalROCD = 0;
            let validMonths = 0;
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                monthLabels.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
                
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59);
                
                // Calculate revenue for this month from transactionHistory
                let monthRevenue = 0;
                AppState.transactionHistory.forEach(transaction => {
                    if (transaction.type === 'payment' && transaction.details) {
                        const paymentDate = new Date(transaction.details.paymentDate || transaction.timestamp);
                        if (paymentDate >= monthStart && paymentDate <= monthEnd) {
                            monthRevenue += (transaction.details.interestPaid || 0) + 
                                          (transaction.details.adminFeePaid || 0) + 
                                          (transaction.details.initiationFeePaid || 0);
                        }
                    }
                });
                
                // Calculate deployed capital at end of this month (simplified - use current deployed)
                // In reality, you'd track historical deployed values
                const deployedCapital = AppState.deployed > 0 ? AppState.deployed : 1;
                
                // ROCD = (Monthly Revenue / Deployed Capital) * 100
                const monthROCD = (monthRevenue / deployedCapital) * 100;
                rocdData.push(monthROCD);
                
                if (monthROCD > 0) {
                    totalROCD += monthROCD;
                    validMonths++;
                }
            }
            
            // Calculate statistics
            const avgROCD = validMonths > 0 ? totalROCD / validMonths : 0;
            const maxROCD = Math.max(...rocdData.filter(r => r > 0));
            const minROCD = Math.min(...rocdData.filter(r => r > 0));
            const currentROCD = AppState.deployed > 0 ? ((AppState.totalInterestEarned + AppState.totalFeesEarned) / AppState.deployed) * 100 : 0;
            
            // Update stat cards
            document.getElementById('bestROCD').textContent = maxROCD > 0 ? `${maxROCD.toFixed(2)}%` : 'N/A';
            document.getElementById('worstROCD').textContent = minROCD < Infinity ? `${minROCD.toFixed(2)}%` : 'N/A';
            document.getElementById('avgROCD').textContent = `${avgROCD.toFixed(2)}%`;
            
            const comparisonElement = document.getElementById('rocdComparison');
            if (currentROCD > avgROCD) {
                comparisonElement.textContent = `‚Üë ${((currentROCD - avgROCD) / avgROCD * 100).toFixed(1)}% above avg`;
                comparisonElement.style.color = '#27ae60';
            } else if (currentROCD < avgROCD) {
                comparisonElement.textContent = `‚Üì ${((avgROCD - currentROCD) / avgROCD * 100).toFixed(1)}% below avg`;
                comparisonElement.style.color = '#e74c3c';
            } else {
                comparisonElement.textContent = '= At average';
                comparisonElement.style.color = '#3498db';
            }
            
            // Update trend indicator
            const trendElement = document.getElementById('rocdTrend');
            if (rocdData.length >= 2) {
                const recent = rocdData.slice(-3).filter(r => r > 0);
                const previous = rocdData.slice(-6, -3).filter(r => r > 0);
                if (recent.length > 0 && previous.length > 0) {
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    const previousAvg = previous.reduce((a, b) => a + b, 0) / previous.length;
                    if (recentAvg > previousAvg) {
                        trendElement.textContent = '‚Üë Improving';
                        trendElement.style.color = '#27ae60';
                    } else if (recentAvg < previousAvg) {
                        trendElement.textContent = '‚Üì Declining';
                        trendElement.style.color = '#e74c3c';
                    } else {
                        trendElement.textContent = '‚Üí Stable';
                        trendElement.style.color = '#3498db';
                    }
                }
            }
            
            // Create chart
            ReportsState.charts.rocdTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Monthly ROCD (%)',
                            data: rocdData,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Average ROCD',
                            data: Array(12).fill(avgROCD),
                            borderColor: '#95a5a6',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Generate Loan Type Chart
        function generateLoanTypeChart(loans) {
            const ctx = document.getElementById('loanTypeChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (ReportsState.charts.loanType) {
                ReportsState.charts.loanType.destroy();
            }
            
            // Count Standard vs Stockvel
            const standardCount = loans.filter(loan => {
                const client = AppState.clients.find(c => c.account_number === loan.account_number);
                return client && client.client_type !== 'stockvel';
            }).length;
            const stockvelCount = loans.length - standardCount;
            
            ReportsState.charts.loanType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Standard', 'Stockvel'],
                    datasets: [{
                        data: [standardCount, stockvelCount],
                        backgroundColor: ['#3498db', '#9b59b6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Generate Loan Status Chart
        function generateLoanStatusChart(loans) {
            const ctx = document.getElementById('loanStatusChart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (ReportsState.charts.loanStatus) {
                ReportsState.charts.loanStatus.destroy();
            }
            
            // Count by status
            const activeCount = loans.filter(l => l.status === 'active').length;
            const completedCount = loans.filter(l => l.status === 'completed').length;
            const defaultedCount = loans.filter(l => l.status === 'defaulted').length;
            const blacklistedCount = loans.filter(l => l.status === 'blacklisted').length;
            
            ReportsState.charts.loanStatus = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Active', 'Completed', 'Defaulted', 'Blacklisted'],
                    datasets: [{
                        data: [activeCount, completedCount, defaultedCount, blacklistedCount],
                        backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#95a5a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Export Report to PDF
        // Export Report to PDF - ENHANCED v1.6
        function exportReportPDF() {
            if (typeof jsPDF === 'undefined') {
                alert('‚ùå PDF library not loaded');
                return;
            }
            
            const pdf = new jsPDF();
            const pageWidth = pdf.internal.pageSize.getWidth();
            let yPos = 20;
            
            // Header
            pdf.setFontSize(20);
            pdf.setTextColor(102, 126, 234);
            pdf.text('TBFS Business Report', pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 10;
            pdf.setFontSize(10);
            pdf.setTextColor(127, 140, 141);
            pdf.text(`Generated: ${new Date().toLocaleString()}`, pageWidth / 2, yPos, { align: 'center' });
            pdf.text(`Period: ${ReportsState.currentPeriod.toUpperCase()}`, pageWidth / 2, yPos + 5, { align: 'center' });
            
            yPos += 20;
            
            // Financial Summary
            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('üìä Financial Summary', 14, yPos);
            yPos += 10;
            
            pdf.setFontSize(10);
            const totalRevenue = AppState.totalInterestEarned + AppState.totalFeesEarned;
            const summaryItems = [
                ['Total Revenue:', `R${totalRevenue.toFixed(2)}`],
                ['Interest Earned:', `R${AppState.totalInterestEarned.toFixed(2)}`],
                ['Fees Earned:', `R${AppState.totalFeesEarned.toFixed(2)}`],
                ['Capital Available:', `R${AppState.capital.toFixed(2)}`],
                ['Capital Deployed:', `R${AppState.deployed.toFixed(2)}`],
                ['Available to Lend:', `R${(AppState.capital).toFixed(2)}`]
            ];
            
            summaryItems.forEach(item => {
                pdf.text(item[0], 14, yPos);
                pdf.text(item[1], 100, yPos);
                yPos += 7;
            });
            
            yPos += 10;
            
            // Performance Metrics
            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('üéØ Performance Metrics', 14, yPos);
            yPos += 10;
            
            pdf.setFontSize(10);
            const rocd = AppState.deployed > 0 ? (totalRevenue / AppState.deployed) * 100 : 0;
            const utilization = AppState.capital > 0 ? (AppState.deployed / (AppState.capital + AppState.deployed)) * 100 : 0;
            const activeLoans = AppState.loans.filter(l => l.status === 'active').length;
            
            const metricsItems = [
                ['ROCD:', `${rocd.toFixed(2)}%`],
                ['Portfolio Utilization:', `${utilization.toFixed(2)}%`],
                ['Active Loans:', activeLoans.toString()],
                ['Total Clients:', AppState.clients.length.toString()]
            ];
            
            metricsItems.forEach(item => {
                pdf.text(item[0], 14, yPos);
                pdf.text(item[1], 100, yPos);
                yPos += 7;
            });
            
            // Add new page for more details
            pdf.addPage();
            yPos = 20;
            
            // Cash Flow Projections (Next 3 Months)
            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('üí∞ Cash Flow Forecast (Next 3 Months)', 14, yPos);
            yPos += 10;
            
            pdf.setFontSize(9);
            pdf.text('Month', 14, yPos);
            pdf.text('Expected Inflow', 60, yPos);
            pdf.text('Loans Due', 120, yPos);
            yPos += 7;
            
            // Get cash flow data (simplified - first 3 months)
            const now = new Date();
            for (let i = 0; i < 3; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthLabel = monthDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                // Calculate expected (simplified)
                const monthlyTotal = activeLoans * 500; // Rough estimate
                
                pdf.text(monthLabel, 14, yPos);
                pdf.text(`~R${monthlyTotal.toFixed(0)}`, 60, yPos);
                pdf.text(activeLoans.toString(), 120, yPos);
                yPos += 7;
            }
            
            yPos += 10;
            
            // Top Clients
            pdf.setFontSize(14);
            pdf.setTextColor(44, 62, 80);
            pdf.text('üë• Top Clients', 14, yPos);
            yPos += 10;
            
            pdf.setFontSize(9);
            const clientLoans = {};
            AppState.loans.forEach(loan => {
                const key = loan.client_name || 'Unknown';
                if (!clientLoans[key]) clientLoans[key] = 0;
                clientLoans[key]++;
            });
            
            const sortedClients = Object.entries(clientLoans).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            pdf.text('Client Name', 14, yPos);
            pdf.text('Loans', 120, yPos);
            yPos += 7;
            
            sortedClients.forEach(([name, count]) => {
                if (yPos > 270) {
                    pdf.addPage();
                    yPos = 20;
                }
                pdf.text(name, 14, yPos);
                pdf.text(count.toString(), 120, yPos);
                yPos += 7;
            });
            
            // Footer on last page
            pdf.setFontSize(8);
            pdf.setTextColor(127, 140, 141);
            pdf.text('TBFS Ethical Lending - Comprehensive Business Report', pageWidth / 2, pdf.internal.pageSize.getHeight() - 10, { align: 'center' });
            
            // Download
            pdf.save(`TBFS_Comprehensive_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            
            alert('‚úÖ Comprehensive PDF report downloaded!');
        }

        // Export Report to Excel - ENHANCED v1.6 with Multiple Sheets
        function exportReportExcel() {
            if (typeof XLSX === 'undefined') {
                alert('‚ùå Excel export library not loaded');
                return;
            }
            
            const filteredLoans = filterLoansByPeriod(AppState.loans);
            const wb = XLSX.utils.book_new();
            
            // SHEET 1: Executive Summary
            const summaryData = [
                ['TBFS Business Report - Executive Summary'],
                ['Generated:', new Date().toLocaleString()],
                ['Period:', ReportsState.currentPeriod.toUpperCase()],
                [],
                ['Financial Overview'],
                ['Metric', 'Value'],
                ['Total Revenue', (AppState.totalInterestEarned + AppState.totalFeesEarned).toFixed(2)],
                ['Interest Earned', AppState.totalInterestEarned.toFixed(2)],
                ['Fees Earned', AppState.totalFeesEarned.toFixed(2)],
                ['Capital Available', AppState.capital.toFixed(2)],
                ['Capital Deployed', AppState.deployed.toFixed(2)],
                ['Available to Lend', (AppState.capital).toFixed(2)],
                [],
                ['Performance Metrics'],
                ['Metric', 'Value'],
                ['ROCD (%)', AppState.deployed > 0 ? ((AppState.totalInterestEarned + AppState.totalFeesEarned) / AppState.deployed * 100).toFixed(2) : '0'],
                ['Portfolio Utilization (%)', AppState.capital > 0 ? (AppState.deployed / (AppState.capital + AppState.deployed) * 100).toFixed(2) : '0'],
                ['Active Loans', filteredLoans.filter(l => l.status === 'active').length],
                ['Total Clients', AppState.clients.length]
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'Summary');
            
            // SHEET 2: Monthly Revenue (Last 12 Months)
            const revenueData = [['Month', 'Interest', 'Fees', 'Total']];
            const now = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
                const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0, 23, 59, 59);
                const monthLabel = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                let monthInterest = 0;
                let monthFees = 0;
                
                // Use AppState.transactionHistory for accurate payment tracking
                AppState.transactionHistory.forEach(transaction => {
                    if (transaction.type === 'payment' && transaction.details) {
                        const paymentDate = new Date(transaction.details.paymentDate || transaction.timestamp);
                        if (paymentDate >= monthStart && paymentDate <= monthEnd) {
                            monthInterest += (transaction.details.interestPaid || 0);
                            monthFees += (transaction.details.adminFeePaid || 0) + (transaction.details.initiationFeePaid || 0);
                        }
                    }
                });
                
                revenueData.push([monthLabel, monthInterest.toFixed(2), monthFees.toFixed(2), (monthInterest + monthFees).toFixed(2)]);
            }
            
            const ws2 = XLSX.utils.aoa_to_sheet(revenueData);
            XLSX.utils.book_append_sheet(wb, ws2, 'Monthly Revenue');
            
            // SHEET 3: Cash Flow Projections (Next 6 Months)
            const cashFlowData = [['Month', 'Principal Expected', 'Interest Expected', 'Fees Expected', 'Total Inflow', 'Loans Due']];
            
            for (let i = 0; i < 6; i++) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const monthLabel = monthDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                let monthPrincipal = 0;
                let monthInterest = 0;
                let monthFees = 0;
                let monthPayments = 0;
                
                const activeLoans = AppState.loans.filter(l => l.status === 'active');
                activeLoans.forEach(loan => {
                    const monthlyPayment = loan.monthly_payment || 0;
                    const loanStartDate = new Date(loan.created_at);
                    const monthsSinceStart = (monthDate.getFullYear() - loanStartDate.getFullYear()) * 12 + 
                                           (monthDate.getMonth() - loanStartDate.getMonth());
                    
                    if (monthsSinceStart >= 0 && monthsSinceStart < loan.term_months && loan.remaining_principal > 0) {
                        const remainingBalance = loan.remaining_principal || 0;
                        const remainingMonths = loan.term_months - (loan.payments_made || 0);
                        
                        if (remainingMonths > 0 && monthlyPayment > 0) {
                            monthPrincipal += Math.min(remainingBalance / remainingMonths, monthlyPayment * 0.5);
                            monthInterest += monthlyPayment * 0.3;
                            monthFees += monthlyPayment * 0.2;
                            monthPayments++;
                        }
                    }
                });
                
                cashFlowData.push([
                    monthLabel,
                    monthPrincipal.toFixed(2),
                    monthInterest.toFixed(2),
                    monthFees.toFixed(2),
                    (monthPrincipal + monthInterest + monthFees).toFixed(2),
                    monthPayments
                ]);
            }
            
            const ws3 = XLSX.utils.aoa_to_sheet(cashFlowData);
            XLSX.utils.book_append_sheet(wb, ws3, 'Cash Flow Forecast');
            
            // SHEET 4: Loan Details
            const loanData = [['Loan ID', 'Client Name', 'Principal', 'Term (months)', 'Payments Made', 'Remaining Principal', 'Current Balance', 'Status', 'Created Date']];
            
            filteredLoans.forEach(loan => {
                loanData.push([
                    loan.loan_id,
                    loan.client_name,
                    loan.principal_amount,
                    loan.term_months,
                    `${loan.payments_made || 0}/${loan.term_months}`,
                    loan.remaining_principal || 0,
                    loan.current_balance,
                    loan.status,
                    new Date(loan.created_at).toLocaleDateString()
                ]);
            });
            
            const ws4 = XLSX.utils.aoa_to_sheet(loanData);
            XLSX.utils.book_append_sheet(wb, ws4, 'Loan Details');
            
            // Download
            XLSX.writeFile(wb, `TBFS_Comprehensive_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            alert('‚úÖ Enhanced Excel report with 4 sheets exported successfully!\n\nüìä Sheets included:\n‚Ä¢ Summary\n‚Ä¢ Monthly Revenue\n‚Ä¢ Cash Flow Forecast\n‚Ä¢ Loan Details');
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Initialize reports when Reports tab is opened
        document.addEventListener('DOMContentLoaded', function() {
            // Generate reports when tab is clicked
            const reportsTab = document.querySelector('[data-tab="reports"]');
            if (reportsTab) {
                reportsTab.addEventListener('click', function() {
                    setTimeout(generateReports, 100); // Small delay to ensure tab is visible
                });
            }
        });
    </script>
</body>
</html>




