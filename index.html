<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="TBFS Ethical Lending - Dignity, No Harassment, Fair Rates">
    <title>TBFS - Enhanced Loan Management System</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="TBFS Loan Manager">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TBFS Loan Manager">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-config" content="/icons/browserconfig.xml">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-16x16.png">
    <link rel="shortcut icon" href="icons/favicon.ico">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: white;
            border-radius: 50%;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .company-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .tagline {
            font-size: 16px;
            opacity: 0.9;
            font-style: italic;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e6ed;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            flex: 0 0 auto;
            min-width: 120px;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            white-space: nowrap;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .results-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .breakdown-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .breakdown-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e6ed;
        }

        .breakdown-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .breakdown-table tr:hover {
            background: #e3f2fd;
        }

        .pdf-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .loan-card {
            background: #f8f9fa;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .loan-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .loan-card .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #27ae60;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-overdue {
            background: #e74c3c;
            color: white;
        }

        .status-completed {
            background: #95a5a6;
            color: white;
        }

        .status-defaulted {
            background: #e74c3c;
            color: white;
        }

        .status-blacklisted {
            background: #8e44ad;
            color: white;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-left: 4px solid #e74c3c;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border-left: 4px solid #27ae60;
            color: #155724;
        }

        .hidden {
            display: none;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #27ae60;
            font-size: 14px;
            margin-top: 10px;
        }

        .stockvel-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 2px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            color: #2c3e50;
        }

        .stockvel-info h4 {
            color: #27ae60;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .stockvel-info ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        .stockvel-info li {
            margin-bottom: 5px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e6ed;
            transition: all 0.3s ease;
        }

        .checkbox-container:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .checkbox-container input[type="checkbox"] {
            width: auto;
            margin-right: 15px;
            transform: scale(1.2);
        }

        .checkbox-container label {
            margin-bottom: 0;
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .breakdown-table {
                font-size: 14px;
            }
            
            .breakdown-table th,
            .breakdown-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Update Available Banner -->
    <div id="updateBanner" style="display: none; background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
            <div style="flex: 1; min-width: 200px;">
                <strong>🎉 New Update Available!</strong>
                <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.95;">A new version of TBFS is ready to install</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="activateUpdate()" style="background: white; color: #f39c12; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Update Now
                </button>
                <button onclick="dismissUpdateBanner()" style="background: transparent; color: white; border: 2px solid white; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
                    Later
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo" style="background: none; box-shadow: none;">
                <img src="./TBFS_Logo.png" 
                     alt="TBFS Logo" 
                     style="width: 120px; height: 120px; display: block; margin: 0 auto; border-radius: 50%; background: #f8fbfd; border: 4px solid #e3e8ef; object-fit: contain;" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div id="logoFallback" style="display: none; width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold;"> 
        TBFS 
    </div>
</div>
            <div class="company-name">Thaba Bosiu Financial Services</div>
            <div class="tagline">Your Financial Refuge</div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="calculator">Loan Calculator</button>
            <button class="tab" data-tab="dashboard">Dashboard</button>
            <button class="tab" data-tab="clients">Clients</button>
            <button class="tab" data-tab="loans">Active Loans</button>
            <button class="tab" data-tab="settings">⚙️ Settings</button>
        </div>

        <!-- CALCULATOR TAB -->
        <div id="calculator" class="tab-content active">
            <div class="form-section">
                <h2 class="section-title">Loan Application Details</h2>
                <form id="loanForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="firstName">First Name:</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name:</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                        <div class="form-group">
                            <label for="accountNumber">Account Number:</label>
                            <input type="text" id="accountNumber" name="accountNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="principal">Loan Amount (R):</label>
                            <input type="number" id="principal" name="principal" min="100" step="100" required>
                        </div>
                        <div class="form-group">
                            <label for="term">Loan Term (months):</label>
                            <input type="number" id="term" name="term" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="startMonth">Start Month:</label>
                            <select id="startMonth" name="startMonth" required>
                                <option value="">Select Month</option>
                                <option value="0">January</option>
                                <option value="1">February</option>
                                <option value="2">March</option>
                                <option value="3">April</option>
                                <option value="4">May</option>
                                <option value="5">June</option>
                                <option value="6">July</option>
                                <option value="7">August</option>
                                <option value="8">September</option>
                                <option value="9">October</option>
                                <option value="10">November</option>
                                <option value="11">December</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="stockvelMember" name="stockvelMember">
                                <label for="stockvelMember">Stockvel Member</label>
                            </div>
                        </div>
                        <div id="stockvelFields" style="display: none; grid-column: 1 / -1;">
                            <div class="stockvel-info">
                                <h4>Stockvel Member Benefits</h4>
                                <ul>
                                    <li><strong>Initiation Fee:</strong> Waived if loan amount ≤ total contributions, otherwise 12% on the difference</li>
                                    <li><strong>Interest Rates:</strong> Tiered calculation based on loan-to-savings ratio</li>
                                    <li><strong>Admin Fee:</strong> R60 × effective interest rate (based on tiered calculation)</li>
                                    <li><strong>Minimum Interest:</strong> 10% of outstanding balance per month applies if calculated interest is lower</li>
                                </ul>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="totalContributions">Total Contributions to Date (R):</label>
                                    <input type="number" id="totalContributions" name="totalContributions" min="0" step="100" placeholder="Enter total amount contributed to date">
                                </div>
                                <div class="form-group">
                                    <label for="monthlyContribution">Monthly Contribution (R):</label>
                                    <input type="number" id="monthlyContribution" name="monthlyContribution" min="0" step="50" placeholder="Enter monthly contribution amount">
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="calculate-btn">Calculate Loan Repayment</button>
                </form>
            </div>

            <div id="results" class="results-section">
                <h2 class="section-title">Loan Repayment Summary</h2>
                <div id="clientInfo"></div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Monthly Repayment</h3>
                        <div class="value" id="monthlyPayment">R 0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Cost</h3>
                        <div class="value" id="totalCost">R 0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Number of Payments</h3>
                        <div class="value" id="numberOfPayments">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Interest</h3>
                        <div class="value" id="totalInterest">R 0.00</div>
                    </div>
                    <div class="summary-card" id="stockvelSummaryCard" style="display: none;">
                        <h3>Initiation Fee</h3>
                        <div class="value" id="initiationFeeDisplay">R 0.00</div>
                    </div>
                </div>

                <h3 class="section-title">Monthly Breakdown</h3>
                <div style="overflow-x: auto;">
                    <table class="breakdown-table" id="breakdownTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Monthly Payment</th>
                                <th>Principal Payment</th>
                                <th>Interest</th>
                                <th>Admin Fee</th>
                                <th>Outstanding Balance</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownBody">
                        </tbody>
                    </table>
                </div>
                <button class="pdf-btn" style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%); margin-top: 15px;" onclick="exportToExcel()">Export to Excel</button>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 30px 0; border: 2px solid #e0e6ed;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 18px;">Banking Details</h3>
                    <p style="margin-bottom: 10px; color: #2c3e50;">To pay please use:</p>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p style="margin-bottom: 5px;"><strong>Account Holder:</strong> Thaba Bosiu Financial Services</p>
                        <p style="margin-bottom: 5px;"><strong>Bank Name:</strong> TymeBank</p>
                        <p style="margin-bottom: 5px;"><strong>Branch Code:</strong> 678910</p>
                        <p style="margin-bottom: 5px;"><strong>Account Number:</strong> 53000021839</p>
                    </div>
                    <p style="color: #2c3e50; font-style: italic;">Please use your <strong>Name and Surname</strong> as the reference</p>
                </div>

                <button class="pdf-btn" onclick="generatePDF()">Download PDF Report</button>
                <button class="pdf-btn" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); margin-left: 10px;" onclick="acceptLoan()">✅ Accept Loan & Add to System</button>
                <div id="pdfStatus"></div>
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="dashboard" class="tab-content">
            <h2>Portfolio Overview</h2>
            
            <div id="dashboardAlerts"></div>

            <!-- Financial Overview -->
            <h3 class="section-title">💰 Financial Overview</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                    <h3>Account Balance</h3>
                    <div class="value" id="totalCapital">R 100,000</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Available in bank</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);">
                    <h3>Deployed</h3>
                    <div class="value" id="deployedCapital">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Currently loaned out</p>
                </div>
                <div class="stat-card">
                    <h3>Active Loans</h3>
                    <div class="value" id="activeLoans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Default Rate</h3>
                    <div class="value" id="defaultRate">0%</div>
                </div>
            </div>

            <!-- Profitability Metrics -->
            <h3 class="section-title" style="margin-top: 30px;">📈 Profitability & Earnings</h3>
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3>Total Interest Earned</h3>
                    <div class="value" id="totalInterestEarned">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Lifetime interest income</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3>Total Fees Earned</h3>
                    <div class="value" id="totalFeesEarned">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Admin + Initiation fees</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);">
                    <h3>Total Profit</h3>
                    <div class="value" id="totalProfit">R 0</div>
                    <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">Interest + Fees</p>
                </div>
            </div>

            <!-- Profit Goal Progress -->
            <h3 class="section-title" style="margin-top: 30px;">🎯 Profit Goal Progress</h3>
            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Goal: R500,000</p>
                        <p style="margin: 5px 0 0 0; font-size: 32px; font-weight: bold; color: #2c3e50;" id="profitAmount">R 0</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Progress</p>
                        <p style="margin: 5px 0 0 0; font-size: 32px; font-weight: bold; color: #27ae60;" id="profitPercentage">0%</p>
                    </div>
                </div>
                <div style="background: #e0e6ed; border-radius: 10px; height: 20px; overflow: hidden;">
                    <div id="profitProgressBar" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
                <p style="margin: 15px 0 0 0; color: #7f8c8d; font-size: 14px; text-align: center;" id="profitRemaining">R500,000 remaining to reach goal</p>
            </div>

            <!-- Loan Portfolio Stats -->
            <h3 class="section-title" style="margin-top: 30px;">📊 Loan Portfolio</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Loans</h3>
                    <div class="value" id="totalLoans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Completed</h3>
                    <div class="value" id="completedLoans">0</div>
                </div>
                <div class="stat-card">
                    <h3>Defaulted</h3>
                    <div class="value" id="defaultedLoans">0</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Data Management</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="backupData()">📥 Backup Data</button>
                <button class="btn" onclick="restoreData()">📤 Restore Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ Clear All Data</button>
            </div>

            <!-- Transaction History Section -->
            <h3 class="section-title" style="margin-top: 30px;">📜 Transaction History</h3>
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Last 20 transactions</p>
                    <button class="btn" id="undoLastPaymentBtn" onclick="undoLastPayment()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 8px 16px; font-size: 14px; display: none;">
                        ↶ Undo Last Payment
                    </button>
                </div>
                <div id="transactionHistoryList" style="max-height: 400px; overflow-y: auto;">
                    <p style="color: #95a5a6; text-align: center; padding: 20px;">No transactions yet.</p>
                </div>
            </div>
        </div>

        <!-- CLIENTS TAB -->
        <div id="clients" class="tab-content">
            <h2>Client Management</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Clients</h3>
                    <div class="value" id="totalClients">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Clients</h3>
                    <div class="value" id="activeClients">0</div>
                </div>
                <div class="stat-card">
                    <h3>Blacklisted</h3>
                    <div class="value" id="blacklistedClients">0</div>
                </div>
                <div class="stat-card">
                    <h3>Defaulted</h3>
                    <div class="value" id="defaultedClients">0</div>
                </div>
            </div>

            <h3>Client Database</h3>
            <div style="overflow-x: auto; margin-top: 20px;">
                <table class="breakdown-table" id="clientsTable">
                    <thead>
                        <tr>
                            <th>Account Number</th>
                            <th>Client Name</th>
                            <th>Total Loans</th>
                            <th>Total Repayment</th>
                            <th>Current Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- LOANS TAB -->
        <div id="loans" class="tab-content">
            <h2>Active Loans</h2>
            <div id="loansList"></div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <h2 class="section-title">⚙️ Settings</h2>
            
            <!-- App Version & Updates Section -->
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">📱 App Version & Updates</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Current Version</p>
                            <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #2c3e50;" id="currentVersion">v1.2.0</p>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #95a5a6;" id="updateStatus">Checking for updates...</p>
                        </div>
                        <button class="btn" onclick="checkForUpdates()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px;">
                            🔄 Check for Updates
                        </button>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <strong style="color: #27ae60;">💡 How Updates Work:</strong>
                    <ul style="margin: 10px 0 0 20px; color: #2c3e50; font-size: 14px;">
                        <li>Updates download automatically in the background</li>
                        <li>Click "Update Now" or close and reopen the app to apply</li>
                        <li>Your data is always safe during updates</li>
                    </ul>
                </div>
            </div>
            
            <h3 class="section-title">☁️ Cloud Backup Settings</h3>
            
            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">🔐 GitHub Cloud Backup</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Automatically backup your data to a private GitHub repository. Your data syncs across all devices and works offline.</p>
                
                <div id="tokenConfigured" style="display: none;">
                    <div style="padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #f0f4ff; border: 2px solid #667eea;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong style="color: #667eea;">🔐 GitHub Token Configured</strong>
                                <p style="margin: 5px 0 0 0; font-size: 14px; color: #2c3e50;">
                                    You can now restore from cloud
                                </p>
                            </div>
                            <button class="btn btn-danger" onclick="removeToken()">Remove Token</button>
                        </div>
                    </div>
                    
                    <div class="checkbox-container" style="margin-bottom: 20px;">
                        <input type="checkbox" id="autoBackupToggle" onchange="toggleAutoBackup()">
                        <label for="autoBackupToggle" style="cursor: pointer;">
                            <strong>Enable Auto-Backup on This Device</strong>
                            <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                                When enabled, every change automatically syncs to cloud. Leave OFF if this is a secondary device.
                            </div>
                        </label>
                    </div>
                    
                    <div id="autoBackupStatus" style="padding: 15px; border-radius: 10px; margin-bottom: 20px; background: #e8f5e8; border: 2px solid #27ae60; display: none;">
                        <strong style="color: #27ae60;">✅ Auto-Backup Active</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #2c3e50;">
                            Last sync: <span id="lastSyncTime">Never</span>
                        </p>
                    </div>
                </div>

                <div id="cloudBackupSetup" style="display: block;">
                    <div class="form-group">
                        <label for="githubToken">GitHub Personal Access Token:</label>
                        <input type="password" id="githubToken" placeholder="github_pat_xxxxx..." 
                               style="font-family: monospace; font-size: 14px;">
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            ℹ️ Your token is encrypted and stored securely on your device only. Never shared or exposed.
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="backupRepoUrl">Backup Repository URL:</label>
                        <input type="text" id="backupRepoUrl" 
                               value="https://github.com/Ndelo-N/TBFS-Data-Backup.git" readonly
                               style="background: #f8f9fa; font-family: monospace; font-size: 14px;">
                        <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                            ℹ️ Ensure this is your PRIVATE backup repository.
                        </p>
                    </div>

                    <button class="calculate-btn" onclick="saveToken()">
                        🔐 Save Token & Configure
                    </button>
                </div>

                <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 5px;">
                    <strong style="color: #856404;">📋 How to Get Your Token:</strong>
                    <ol style="margin: 10px 0 0 20px; color: #856404;">
                        <li>Go to: <code>github.com/settings/tokens</code></li>
                        <li>Click "Generate new token" → "Fine-grained token"</li>
                        <li>Give access ONLY to <code>TBFS-Data-Backup</code> repo</li>
                        <li>Enable "Contents: Read and write" permission</li>
                        <li>Copy token and paste above</li>
                    </ol>
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="color: #2c3e50;">Cloud Backup Features:</h4>
                    <ul style="color: #7f8c8d; line-height: 1.8;">
                        <li>✅ Auto-sync on every data change</li>
                        <li>✅ Works offline - queues changes, syncs when online</li>
                        <li>✅ Access from any device</li>
                        <li>✅ Daily snapshots kept for 30 days</li>
                        <li>✅ One-click restore</li>
                        <li>✅ Completely free (uses your private GitHub repo)</li>
                    </ul>
                </div>
            </div>

            <div class="form-section">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">🔄 Manual Backup</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">Download or restore backups manually.</p>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="backupData()">📥 Download Local Backup</button>
                    <button class="btn" onclick="restoreData()">📤 Restore from File</button>
                    <button class="btn" style="background: #27ae60;" onclick="restoreFromCloud()">☁️ Restore from Cloud</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // App Version
        const APP_VERSION = '1.4.1'; // Update this when making changes
        
        // App State Management
        const AppState = {
            capital: 100000, // Account balance (what's in the bank)
            deployed: 0, // Amount currently loaned out
            totalInterestEarned: 0, // Lifetime interest earned
            totalFeesEarned: 0, // Lifetime fees earned (admin + initiation)
            profitGoal: 500000, // Business profit goal
            clients: [],
            loans: [],
            transactionHistory: [], // Track all changes
            nextAccountNumber: 2025001,
            
            init() {
                this.loadFromStorage();
                this.updateDashboard();
            },
            
            loadFromStorage() {
                const saved = localStorage.getItem('tbfsAppState');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.capital = data.capital || 100000;
                    this.deployed = data.deployed || 0;
                    this.totalInterestEarned = data.totalInterestEarned || 0;
                    this.totalFeesEarned = data.totalFeesEarned || 0;
                    this.profitGoal = data.profitGoal || 500000;
                    this.clients = data.clients || [];
                    this.loans = data.loans || [];
                    this.transactionHistory = data.transactionHistory || [];
                    this.nextAccountNumber = data.nextAccountNumber || 2025001;
                }
            },
            
            save() {
                localStorage.setItem('tbfsAppState', JSON.stringify({
                    capital: this.capital,
                    deployed: this.deployed,
                    totalInterestEarned: this.totalInterestEarned,
                    totalFeesEarned: this.totalFeesEarned,
                    profitGoal: this.profitGoal,
                    clients: this.clients,
                    loans: this.loans,
                    transactionHistory: this.transactionHistory,
                    nextAccountNumber: this.nextAccountNumber
                }));
            },
            
            // Add transaction to history (keeps last 20)
            logTransaction(type, description, details = {}) {
                const transaction = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    type: type, // 'payment', 'loan_created', 'client_status', 'system'
                    description: description,
                    details: details
                };
                
                this.transactionHistory.unshift(transaction); // Add to beginning
                
                // Keep only last 20 transactions
                if (this.transactionHistory.length > 20) {
                    this.transactionHistory = this.transactionHistory.slice(0, 20);
                }
                
                this.save();
            },
            
            addClient(client) {
                this.clients.push(client);
                this.save();
                this.updateDashboard();
            },
            
            addLoan(loan) {
                this.loans.push(loan);
                this.deployed += loan.principal_amount;
                this.save();
                this.updateDashboard();
            },
            
            updateDashboard() {
                // Data validation and cleanup
                this.validateAndFixData();
                
                // Financial Overview
                document.getElementById('totalCapital').textContent = `R ${this.capital.toLocaleString()}`;
                document.getElementById('deployedCapital').textContent = `R ${this.deployed.toLocaleString()}`;
                document.getElementById('activeLoans').textContent = this.loans.filter(l => l.status === 'active').length;
                
                // Profitability Metrics
                document.getElementById('totalInterestEarned').textContent = `R ${this.totalInterestEarned.toLocaleString()}`;
                document.getElementById('totalFeesEarned').textContent = `R ${this.totalFeesEarned.toLocaleString()}`;
                
                const totalProfit = this.totalInterestEarned + this.totalFeesEarned;
                document.getElementById('totalProfit').textContent = `R ${totalProfit.toLocaleString()}`;
                
                // Profit Goal Progress
                const profitPercentage = Math.min(100, (totalProfit / this.profitGoal * 100)).toFixed(1);
                const profitRemaining = Math.max(0, this.profitGoal - totalProfit);
                
                document.getElementById('profitAmount').textContent = `R ${totalProfit.toLocaleString()}`;
                document.getElementById('profitPercentage').textContent = `${profitPercentage}%`;
                document.getElementById('profitProgressBar').style.width = `${profitPercentage}%`;
                
                if (profitRemaining > 0) {
                    document.getElementById('profitRemaining').textContent = `R${profitRemaining.toLocaleString()} remaining to reach goal`;
                } else {
                    document.getElementById('profitRemaining').textContent = `🎉 Goal achieved! Exceeded by R${(totalProfit - this.profitGoal).toLocaleString()}`;
                    document.getElementById('profitRemaining').style.color = '#27ae60';
                    document.getElementById('profitRemaining').style.fontWeight = 'bold';
                }
                
                // Loan Portfolio Stats
                document.getElementById('totalLoans').textContent = this.loans.length;
                document.getElementById('completedLoans').textContent = this.loans.filter(l => l.status === 'completed').length;
                document.getElementById('defaultedLoans').textContent = this.loans.filter(l => l.status === 'defaulted').length;
                document.getElementById('totalClients').textContent = this.clients.length;
                
                const completed = this.loans.filter(l => l.status === 'completed' || l.status === 'defaulted').length;
                const defaulted = this.loans.filter(l => l.status === 'defaulted').length;
                const defaultRate = completed > 0 ? ((defaulted / completed) * 100).toFixed(1) : 0;
                document.getElementById('defaultRate').textContent = `${defaultRate}%`;
                
                this.checkRedFlags();
                this.updateClientsList();
                this.updateLoansList();
                this.updateTransactionHistory();
            },
            
            updateTransactionHistory() {
                const container = document.getElementById('transactionHistoryList');
                const undoBtn = document.getElementById('undoLastPaymentBtn');
                
                if (this.transactionHistory.length === 0) {
                    container.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 20px;">No transactions yet.</p>';
                    undoBtn.style.display = 'none';
                    return;
                }
                
                // Show undo button if last transaction was a payment
                const lastTransaction = this.transactionHistory[0];
                if (lastTransaction && lastTransaction.type === 'payment') {
                    undoBtn.style.display = 'inline-block';
                } else {
                    undoBtn.style.display = 'none';
                }
                
                let html = '';
                this.transactionHistory.forEach(tx => {
                    const date = new Date(tx.timestamp);
                    const timeStr = date.toLocaleString('en-ZA', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    let icon = '📝';
                    let color = '#3498db';
                    
                    switch(tx.type) {
                        case 'payment':
                            icon = '💰';
                            color = '#27ae60';
                            break;
                        case 'loan_created':
                            icon = '📋';
                            color = '#f39c12';
                            break;
                        case 'client_status':
                            icon = '⚠️';
                            color = '#e74c3c';
                            break;
                        case 'system':
                            icon = '⚙️';
                            color = '#95a5a6';
                            break;
                    }
                    
                    html += `
                        <div style="border-bottom: 1px solid #ecf0f1; padding: 12px 0;">
                            <div style="display: flex; align-items: start; gap: 12px;">
                                <div style="font-size: 24px;">${icon}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #2c3e50; margin-bottom: 4px;">${tx.description}</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">${timeStr}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            validateAndFixData() {
                // Fix negative deployed capital
                if (this.deployed < 0) {
                    console.warn('Fixed negative deployed capital:', this.deployed);
                    this.deployed = 0;
                }
                
                // Fix completed loans with outstanding balances
                this.loans.forEach(loan => {
                    if (loan.status === 'completed' && loan.current_balance > 0) {
                        console.warn(`Fixed completed loan #${loan.loan_id} with balance:`, loan.current_balance);
                        loan.current_balance = 0;
                    }
                });
                
                // Ensure capital is never negative
                if (this.capital < 0) {
                    console.warn('Fixed negative capital:', this.capital);
                    this.capital = 0;
                }
                
                // Save fixes
                this.save();
            },
            
            checkRedFlags() {
                const alerts = document.getElementById('dashboardAlerts');
                alerts.innerHTML = '';
                
                // Warning at 80 active loans
                const activeLoans = this.loans.filter(l => l.status === 'active').length;
                if (activeLoans >= 80) {
                    alerts.innerHTML += `<div class="alert alert-warning">⚠️ <strong>High Loan Volume:</strong> You have ${activeLoans} active loans. Consider monitoring capacity.</div>`;
                }
                
                // Deployment limit at R80,000
                if (this.deployed > 80000) {
                    alerts.innerHTML += `<div class="alert alert-danger">🚨 <strong>Deployment Limit Exceeded:</strong> You've deployed R${this.deployed.toLocaleString()}. Maximum deployment is R80,000!</div>`;
                }
                
                // Reserve capital warning at R20,000 remaining
                const available = this.capital - this.deployed;
                if (available < 20000) {
                    alerts.innerHTML += `<div class="alert alert-warning">⚠️ <strong>Reserve Capital Low:</strong> Only R${available.toLocaleString()} remaining. Consider maintaining higher reserves.</div>`;
                }
            },
            
            updateClientsList() {
                const tbody = document.getElementById('clientsTableBody');
                if (!tbody) return;
                
                if (this.clients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #95a5a6; padding: 20px;">No clients yet.</td></tr>';
                    return;
                }
                
                // Calculate client statistics
                const activeClients = this.clients.filter(c => c.status === 'active').length;
                const blacklistedClients = this.clients.filter(c => c.status === 'blacklisted').length;
                const defaultedClients = this.clients.filter(c => c.status === 'defaulted').length;
                
                // Update statistics
                document.getElementById('activeClients').textContent = activeClients;
                document.getElementById('blacklistedClients').textContent = blacklistedClients;
                document.getElementById('defaultedClients').textContent = defaultedClients;
                
                // Build table rows
                tbody.innerHTML = this.clients.map(client => {
                    // Calculate total loan amount for this client
                    const clientLoans = this.loans.filter(l => l.account_number === client.account_number);
                    const totalLoanAmount = clientLoans.reduce((sum, loan) => sum + loan.principal_amount, 0);
                    
                    // Get total repayment amount (initialize to 0 if not set)
                    const totalRepayment = client.total_repayment || 0;
                    
                    return `
                        <tr>
                            <td><strong>${client.account_number}</strong></td>
                            <td>${client.first_name} ${client.last_name}</td>
                            <td>R ${totalLoanAmount.toFixed(2)}</td>
                            <td>R ${totalRepayment.toFixed(2)}</td>
                            <td><span class="status-badge status-${client.status}">${client.status}</span></td>
                            <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    ${client.status !== 'active' ? `<button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="updateClientStatus('${client.account_number}', 'active')">✅ Activate</button>` : ''}
                                    <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="updateClientStatus('${client.account_number}', 'defaulted')">❌ Mark Default</button>
                                    <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #8e44ad;" onclick="updateClientStatus('${client.account_number}', 'blacklisted')">🚫 Blacklist</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },
            
            updateLoansList() {
                const container = document.getElementById('loansList');
                const allLoans = this.loans;
                
                if (allLoans.length === 0) {
                    container.innerHTML = '<p style="color: #95a5a6; text-align: center; padding: 20px;">No loans yet.</p>';
                    return;
                }
                
                container.innerHTML = allLoans.map(loan => {
                    // Initialize current balance if not set
                    if (!loan.current_balance) {
                        loan.current_balance = loan.total_cost;
                    }
                    
                    return `
                        <div class="loan-card">
                            <h4>Loan #${loan.loan_id} - ${loan.client_name}</h4>
                            <div class="info-row">
                                <span>Principal:</span>
                                <strong>R ${loan.principal_amount.toFixed(2)}</strong>
                            </div>
                            <div class="info-row">
                                <span>Monthly Payment:</span>
                                <strong>R ${loan.monthly_payment.toFixed(2)}</strong>
                            </div>
                            <div class="info-row">
                                <span>Term:</span>
                                <strong>${loan.term_months} months</strong>
                            </div>
                            <div class="info-row">
                                <span>Current Balance:</span>
                                <strong style="color: #e74c3c;">R ${loan.current_balance.toFixed(2)}</strong>
                            </div>
                            <div class="info-row">
                                <span>Status:</span>
                                <span class="status-badge status-${loan.status}">${loan.status}</span>
                            </div>
                            <div class="info-row">
                                <span>Actions:</span>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    ${loan.status === 'active' ? `
                                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="makePayment(${loan.loan_id})">💰 Make Payment</button>
                                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="updateLoanStatus(${loan.loan_id}, 'completed')">✅ Mark Paid</button>
                                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="updateLoanStatus(${loan.loan_id}, 'defaulted')">❌ Mark Default</button>
                                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #8e44ad;" onclick="updateLoanStatus(${loan.loan_id}, 'blacklisted')">🚫 Blacklist</button>
                                    ` : `
                                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="updateLoanStatus(${loan.loan_id}, 'active')">🔄 Reactivate</button>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        };

        let loanData = {};

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners');
            
            // Initialize app state
            AppState.init();
            
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            
            const form = document.getElementById('loanForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form submitted');
                    e.preventDefault();
                    calculateLoan();
                });
            } else {
                console.error('Form not found');
            }

            // Handle Stockvel Member checkbox
            const stockvelCheckbox = document.getElementById('stockvelMember');
            const stockvelFields = document.getElementById('stockvelFields');
            
            if (stockvelCheckbox && stockvelFields) {
                stockvelCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        stockvelFields.style.display = 'block';
                        document.getElementById('totalContributions').required = true;
                        document.getElementById('monthlyContribution').required = true;
                    } else {
                        stockvelFields.style.display = 'none';
                        document.getElementById('totalContributions').required = false;
                        document.getElementById('monthlyContribution').required = false;
                        document.getElementById('totalContributions').value = '';
                        document.getElementById('monthlyContribution').value = '';
                    }
                });
            }
        });

        // Loan calculation functions
        function calculateTieredStockvelInterest(loanAmount, savingsAmount) {
            let totalInterest = 0;
            
            console.log(`\nTiered calculation for R${loanAmount.toFixed(2)} loan with R${savingsAmount.toFixed(2)} savings`);
            
            // Calculate tier boundaries based on savings
            const boundaries = {
                tier1: savingsAmount * 1.10, // >110% of savings
                tier2: savingsAmount * 1.05, // 105-110% of savings
                tier3: savingsAmount * 0.75, // 75-105% of savings
                tier4: savingsAmount * 0.50, // 50-75% of savings
                tier5: savingsAmount * 0.25, // 25-50% of savings
                tier6: 0 // 5-25% of savings
            };
            
            console.log(`Tier boundaries: 110%: R${boundaries.tier1.toFixed(2)}, 105%: R${boundaries.tier2.toFixed(2)}, 75%: R${boundaries.tier3.toFixed(2)}, 50%: R${boundaries.tier4.toFixed(2)}, 25%: R${boundaries.tier5.toFixed(2)}`);
            
            // Calculate interest for each tier
            let remainingLoan = loanAmount;
            
            // Tier 1: >110% of savings (30%)
            if (loanAmount > boundaries.tier1) {
                const tierAmount = loanAmount - boundaries.tier1;
                const tierInterest = tierAmount * 0.30;
                totalInterest += tierInterest;
                console.log(`Tier >110% of savings: R${tierAmount.toFixed(2)} × 30% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 2: 105-110% of savings (25%)
            if (remainingLoan > boundaries.tier2) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier2, boundaries.tier1 - boundaries.tier2);
                const tierInterest = tierAmount * 0.25;
                totalInterest += tierInterest;
                console.log(`Tier 105-110% of savings: R${tierAmount.toFixed(2)} × 25% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 3: 75-105% of savings (20%)
            if (remainingLoan > boundaries.tier3) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier3, boundaries.tier2 - boundaries.tier3);
                const tierInterest = tierAmount * 0.20;
                totalInterest += tierInterest;
                console.log(`Tier 75-105% of savings: R${tierAmount.toFixed(2)} × 20% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 4: 50-75% of savings (15%)
            if (remainingLoan > boundaries.tier4) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier4, boundaries.tier3 - boundaries.tier4);
                const tierInterest = tierAmount * 0.15;
                totalInterest += tierInterest;
                console.log(`Tier 50-75% of savings: R${tierAmount.toFixed(2)} × 15% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 5: 25-50% of savings (8%)
            if (remainingLoan > boundaries.tier5) {
                const tierAmount = Math.min(remainingLoan - boundaries.tier5, boundaries.tier4 - boundaries.tier5);
                const tierInterest = tierAmount * 0.08;
                totalInterest += tierInterest;
                console.log(`Tier 25-50% of savings: R${tierAmount.toFixed(2)} × 8% = R${tierInterest.toFixed(2)}`);
                remainingLoan -= tierAmount;
            }
            
            // Tier 6: 5-25% of savings (3%)
            if (remainingLoan > 0) {
                const tierAmount = Math.min(remainingLoan, boundaries.tier5);
                const tierInterest = tierAmount * 0.03;
                totalInterest += tierInterest;
                console.log(`Tier 5-25% of savings: R${tierAmount.toFixed(2)} × 3% = R${tierInterest.toFixed(2)}`);
            }
            
            console.log(`Total tiered interest: R${totalInterest.toFixed(2)}`);
            return totalInterest;
        }

        function calculateStockvelInterest(principal, term, totalContributions, monthlyContribution) {
            const basePrincipalPayment = principal / term;
            let outstandingBalance = principal;
            let cumulativeInterest = 0;
            let currentSavings = totalContributions;
            
            // Interest calculation period: minimum 3 months, or Math.ceil(term/2) if >= 3
            const interestMonths = Math.ceil(term / 2) >= 3 ? Math.ceil(term / 2) : 3;
            
            console.log(`\n=== STOCKVEL INTEREST CALCULATION ===`);
            console.log(`Principal: R${principal.toFixed(2)}`);
            console.log(`Term: ${term} months`);
            console.log(`Interest Period: ${interestMonths} months`);
            console.log(`Base Principal Payment: R${basePrincipalPayment.toFixed(2)}`);
            console.log(`Initial Savings: R${currentSavings.toFixed(2)}`);
            console.log(`Monthly Contribution: R${monthlyContribution.toFixed(2)}`);
            
            for (let month = 1; month <= interestMonths; month++) {
                // Add monthly contribution if loan is more than 1 month and it's not the first month
                if (term > 1 && month > 1) {
                    currentSavings += monthlyContribution;
                }
                
                console.log(`\n=== Month ${month} Calculation ===`);
                console.log(`Outstanding Balance: R${outstandingBalance.toFixed(2)}`);
                console.log(`Current Savings: R${currentSavings.toFixed(2)}`);
                console.log(`Loan-to-Savings Ratio: ${(outstandingBalance/currentSavings*100).toFixed(1)}%`);
                
                // Only calculate interest if there's an outstanding balance
                if (outstandingBalance > 0) {
                    // Use the new tiered calculation
                    let monthlyInterest = calculateTieredStockvelInterest(outstandingBalance, currentSavings);
                    
                    // MINIMUM INTEREST RULE: If monthly interest is less than 10% of outstanding balance, use 10%
                    const minimumMonthlyInterest = outstandingBalance * 0.10;
                    console.log(`Tiered interest: R${monthlyInterest.toFixed(2)}, Minimum 10%: R${minimumMonthlyInterest.toFixed(2)}`);
                    
                    if (monthlyInterest < minimumMonthlyInterest) {
                        console.log(`Minimum interest rule applied: R${monthlyInterest.toFixed(2)} < R${minimumMonthlyInterest.toFixed(2)}`);
                        monthlyInterest = minimumMonthlyInterest;
                    }
                    
                    cumulativeInterest += monthlyInterest;
                    console.log(`Final Monthly Interest: R${monthlyInterest.toFixed(2)}`);
                } else {
                    console.log(`Outstanding balance is R${outstandingBalance.toFixed(2)}, no interest calculated`);
                }
                
                outstandingBalance -= basePrincipalPayment;
            }
            
            console.log(`\n=== FINAL SUMMARY ===`);
            console.log(`Total Cumulative Interest: R${cumulativeInterest.toFixed(2)}`);
            console.log(`Monthly Interest Payment (spread across ${term} months): R${(cumulativeInterest/term).toFixed(2)}`);
            
            return cumulativeInterest;
        }

        function getMonthName(startIndex, offset) {
            const months = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            return months[(startIndex + offset) % 12];
        }

        function calculateLoan() {
            console.log('calculateLoan function called');
            
            try {
                // Get form values
                const firstName = document.getElementById('firstName').value.trim();
                const lastName = document.getElementById('lastName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const principal = parseFloat(document.getElementById('principal').value);
                const term = parseInt(document.getElementById('term').value);
                const startMonthIndex = parseInt(document.getElementById('startMonth').value);
                
                // Stockvel member fields
                const isStockvelMember = document.getElementById('stockvelMember').checked;
                const totalContributions = isStockvelMember ? parseFloat(document.getElementById('totalContributions').value) : 0;
                const monthlyContribution = isStockvelMember ? parseFloat(document.getElementById('monthlyContribution').value) : 0;

                console.log('Form values:', { 
                    firstName, lastName, accountNumber, principal, term, startMonthIndex,
                    isStockvelMember, totalContributions, monthlyContribution 
                });

                // Validate inputs
                if (!firstName || !lastName || !accountNumber || isNaN(startMonthIndex)) {
                    alert('Please fill in all required fields including start month');
                    return;
                }

                if (isStockvelMember) {
                    if (isNaN(totalContributions) || totalContributions < 0) {
                        alert('Please enter a valid total contribution amount');
                        return;
                    }
                    if (isNaN(monthlyContribution) || monthlyContribution < 0) {
                        alert('Please enter a valid monthly contribution amount');
                        return;
                    }
                    if (totalContributions === 0 && monthlyContribution === 0) {
                        alert('Please enter your contribution amounts as a Stockvel member');
                        return;
                    }
                }

                if (isNaN(principal) || principal <= 0) {
                    alert('Please enter a valid loan amount');
                    return;
                }

                if (isNaN(term) || term <= 0) {
                    alert('Please enter a valid loan term');
                    return;
                }

                if (principal < 100) {
                    alert('Minimum loan amount is R100');
                    return;
                }

                if (term < 1) {
                    alert('Loan term must be at least 1 month');
                    return;
                }

                console.log('Validation passed, starting calculations');

                // Calculate loan components
                const basePrincipalPayment = principal / term;
                
                // INITIATION FEE RULES for Stockvel Members
                let initiationFee;
                if (isStockvelMember) {
                    if (principal <= totalContributions) {
                        initiationFee = 0; // R0.00 if loan amount <= total contribution
                    } else {
                        initiationFee = (principal - totalContributions) * 0.12; // 12% on the difference
                    }
                } else {
                    initiationFee = principal * 0.12; // Standard 12% for non-Stockvel members
                }
                
                // ADMIN FEE RULES for Stockvel Members
                let adminFee;
                if (isStockvelMember) {
                    // Calculate admin fee based on tiered interest calculation
                    const tieredInterest = calculateTieredStockvelInterest(principal, totalContributions);
                    const effectiveInterestRate = tieredInterest / principal;
                    adminFee = 60 * effectiveInterestRate;
                } else {
                    adminFee = 60; // Standard admin fee for non-Stockvel members
                }
                
                let totalInterest;
                let interestRate;
                
                if (isStockvelMember) {
                    // Use Stockvel interest calculation
                    totalInterest = calculateStockvelInterest(principal, term, totalContributions, monthlyContribution);
                    interestRate = 'Variable (Stockvel)';
                    console.log('Stockvel interest calculation:', totalInterest);
                } else {
                    // Use standard interest calculation
                    interestRate = 0.30; // 30% per month
                    
                    // Interest calculation period: minimum 3 months, or Math.ceil(term/2) if >= 3
                    const interestMonths = Math.ceil(term / 2) >= 3 ? Math.ceil(term / 2) : 3;
                    
                    console.log(`\n=== STANDARD INTEREST CALCULATION ===`);
                    console.log(`Principal: R${principal.toFixed(2)}`);
                    console.log(`Term: ${term} months`);
                    console.log(`Interest Period: ${interestMonths} months`);
                    
                    // Calculate interest on declining balance (outstanding amount)
                    let outstandingBalance = principal;
                    let cumulativeInterest = 0;
                    const monthlyPrincipalPayment = principal / term;
                    
                    // Calculate interest ONLY for the interest period (not full term)
                    for (let month = 1; month <= interestMonths; month++) {
                        if (outstandingBalance > 0) {
                            // Interest calculated on current outstanding balance
                            const monthlyInterest = outstandingBalance * interestRate;
                            cumulativeInterest += monthlyInterest;
                            
                            console.log(`Month ${month}: Outstanding: R${outstandingBalance.toFixed(2)}, Interest: R${monthlyInterest.toFixed(2)}`);
                            
                            // Reduce outstanding balance by principal payment
                            outstandingBalance -= monthlyPrincipalPayment;
                        }
                    }
                    
                    totalInterest = cumulativeInterest;
                    console.log(`Total Interest (${interestMonths} months): R${totalInterest.toFixed(2)}`);
                    console.log('Declining balance interest calculation:', totalInterest);
                }

                // Spread interest evenly across all months
                const equalMonthlyInterest = totalInterest / term;

                // Calculate totals
                const totalCost = principal + totalInterest + initiationFee + (adminFee * term);
                const monthlyPayment = totalCost / term;

                console.log('Final calculations:', { totalCost, monthlyPayment, totalInterest, equalMonthlyInterest });

                // Calculate monthly breakdown
                const breakdown = [];
                let outstandingBalance = principal;
                for (let month = 1; month <= term; month++) {
                    breakdown.push({
                        month: month,
                        principalPayment: basePrincipalPayment,
                        interest: equalMonthlyInterest,
                        adminFee: adminFee,
                        totalPayment: basePrincipalPayment + equalMonthlyInterest + adminFee,
                        outstandingBalance: Math.max(0, outstandingBalance - basePrincipalPayment)
                    });
                    outstandingBalance -= basePrincipalPayment;
                }

                // Store data for PDF generation
                loanData = {
                    firstName,
                    lastName,
                    accountNumber,
                    principal,
                    term,
                    monthlyPayment,
                    totalCost,
                    totalInterest,
                    initiationFee,
                    adminFee,
                    breakdown,
                    startMonthIndex,
                    isStockvelMember,
                    totalContributions,
                    monthlyContribution,
                    interestRate
                };

                console.log('Loan data stored, calling displayResults');
                // Display results
                displayResults();
                
            } catch (error) {
                console.error('Error in calculateLoan:', error);
                alert('An error occurred during calculation. Please check your inputs and try again.');
            }
        }

        function displayResults() {
            console.log('displayResults function called');
            
            try {
                // Show results section
                const resultsSection = document.getElementById('results');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    console.log('Results section made visible');
                } else {
                    console.error('Results section not found');
                    return;
                }

                // Display client info
                const clientInfoElement = document.getElementById('clientInfo');
                if (clientInfoElement) {
                    let clientInfoHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">Client Information</h4>
                            <p><strong>Name:</strong> ${loanData.firstName} ${loanData.lastName}</p>
                            <p><strong>Account Number:</strong> ${loanData.accountNumber}</p>
                            <p><strong>Loan Amount:</strong> R ${loanData.principal.toFixed(2)}</p>
                            <p><strong>Term:</strong> ${loanData.term} months</p>
                            <p><strong>Start Month:</strong> ${getMonthName(loanData.startMonthIndex, 0)}</p>`;
                    
                    if (loanData.isStockvelMember) {
                        clientInfoHTML += `
                            <p><strong>Stockvel Member:</strong> Yes</p>
                            <p><strong>Total Contributions:</strong> R ${loanData.totalContributions.toFixed(2)}</p>
                            <p><strong>Monthly Contribution:</strong> R ${loanData.monthlyContribution.toFixed(2)}</p>
                            <p><strong>Interest Rate:</strong> Variable (Based on loan-to-savings ratio)</p>
                            <p><strong>Initiation Fee:</strong> R ${loanData.initiationFee.toFixed(2)} ${loanData.initiationFee === 0 ? '(Waived - Loan ≤ Total Contributions)' : ''}</p>
                            <div style="background: #e8f5e8; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                                <strong>Interest Rate Breakdown (Tiered Calculation):</strong><br>
                                • >110% of savings: 30% | 105-110%: 25% | 75-105%: 20%<br>
                                • 50-75%: 15% | 25-50%: 8% | 5-25%: 3%<br>
                                • Each portion of loan is charged at its applicable rate<br>
                                • Minimum 10% of outstanding balance applies<br>
                                • <strong>Admin Fee:</strong> R60 × effective rate (R${loanData.adminFee.toFixed(2)})
                            </div>`;
                    } else {
                        const interestPeriod = Math.ceil(loanData.term / 2) >= 3 ? Math.ceil(loanData.term / 2) : 3;
                        clientInfoHTML += `
                            <p><strong>Interest Rate:</strong> 30% per month (calculated for ${interestPeriod} months, spread across ${loanData.term} months)</p>
                            <p><strong>Initiation Fee:</strong> R ${loanData.initiationFee.toFixed(2)}</p>`;
                    }
                    
                    clientInfoHTML += `
                        </div>
                    `;
                    
                    clientInfoElement.innerHTML = clientInfoHTML;
                    console.log('Client info updated');
                }

                // Display summary with error handling
                const monthlyPaymentEl = document.getElementById('monthlyPayment');
                const totalCostEl = document.getElementById('totalCost');
                const numberOfPaymentsEl = document.getElementById('numberOfPayments');
                const totalInterestEl = document.getElementById('totalInterest');

                if (monthlyPaymentEl) {
                    monthlyPaymentEl.textContent = `R ${loanData.monthlyPayment.toFixed(2)}`;
                }
                if (totalCostEl) {
                    totalCostEl.textContent = `R ${loanData.totalCost.toFixed(2)}`;
                }
                if (numberOfPaymentsEl) {
                    numberOfPaymentsEl.textContent = loanData.term;
                }
                if (totalInterestEl) {
                    totalInterestEl.textContent = `R ${loanData.totalInterest.toFixed(2)}`;
                }

                // Show Stockvel summary card if applicable
                const stockvelSummaryCard = document.getElementById('stockvelSummaryCard');
                const initiationFeeDisplay = document.getElementById('initiationFeeDisplay');
                if (stockvelSummaryCard && initiationFeeDisplay) {
                    if (loanData.isStockvelMember) {
                        stockvelSummaryCard.style.display = 'block';
                        if (loanData.initiationFee === 0) {
                            initiationFeeDisplay.textContent = 'R 0.00 (Waived)';
                        } else {
                            initiationFeeDisplay.textContent = `R ${loanData.initiationFee.toFixed(2)}`;
                        }
                    } else {
                        stockvelSummaryCard.style.display = 'none';
                    }
                }

                console.log('Summary cards updated');

                // Display breakdown table with month names
                const tbody = document.getElementById('breakdownBody');
                if (tbody) {
                    tbody.innerHTML = '';

                    loanData.breakdown.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${getMonthName(loanData.startMonthIndex, index)}</td>
                            <td>R ${loanData.monthlyPayment.toFixed(2)}</td>
                            <td>R ${row.principalPayment.toFixed(2)}</td>
                            <td>R ${row.interest.toFixed(2)}</td>
                            <td>R ${row.adminFee.toFixed(2)}</td>
                            <td>R ${row.outstandingBalance.toFixed(2)}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                    console.log('Breakdown table updated with', loanData.breakdown.length, 'rows');
                } else {
                    console.error('Breakdown table body not found');
                }

                // Scroll to results
                setTimeout(() => {
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                    console.log('Scrolled to results');
                }, 100);

            } catch (error) {
                console.error('Error in displayResults:', error);
                alert('An error occurred while displaying results. Please try again.');
            }
        }

        // Helper to load image as base64
        function getBase64Image(imgUrl, callback) {
            var img = new window.Image();
            img.crossOrigin = '';
            img.onload = function() {
                var canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                var ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                var dataURL = canvas.toDataURL('image/png');
                callback(dataURL);
            };
            img.onerror = function() { callback(null); };
            img.src = imgUrl;
        }

        function generatePDF() {
            console.log('generatePDF function called');
            
            try {
                if (!loanData || !loanData.firstName) {
                    alert('Please calculate a loan first before generating PDF');
                    return;
                }

                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF not loaded');
                    alert('PDF generation library not loaded. Please refresh the page and try again.');
                    return;
                }

                // Load logo and then generate PDF
                getBase64Image('./TBFS_Logo.png', function(logoDataUrl) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();

                    console.log('Creating PDF document');

                    // Set font
                    doc.setFont('helvetica');

                    // Header with logo
                    if (logoDataUrl) {
                        doc.addImage(logoDataUrl, 'PNG', 85, 5, 40, 40);
                    } else {
                        alert('Logo image could not be loaded for the PDF. Please ensure TBFS_Logo.png is in the same folder and you are running a local server.');
                        return;
                    }
                    doc.setFontSize(18);
                    doc.setTextColor(44, 62, 80);
                    doc.text('THABA BOSIU FINANCIAL SERVICES', 105, 50, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Your Financial Refuge', 105, 57, { align: 'center' });

                    // Line separator
                    doc.setDrawColor(102, 126, 234);
                    doc.setLineWidth(0.5);
                    doc.line(20, 62, 190, 62);

                    // Client Information and Loan Summary
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    doc.text('Loan Details', 20, 70);
                    doc.text('Loan Summary', 105, 70);

                    // Left column - Client Info
                    doc.setFontSize(10);
                    doc.text(`Client Name: ${loanData.firstName} ${loanData.lastName}`, 20, 80);
                    doc.text(`Account Number: ${loanData.accountNumber}`, 20, 87);
                    doc.text(`Loan Amount: R ${loanData.principal.toFixed(2)}`, 20, 94);
                    doc.text(`Term: ${loanData.term} months`, 20, 101);
                    doc.text(`Start Month: ${getMonthName(loanData.startMonthIndex, 0)}`, 20, 108);
                    
                    if (loanData.isStockvelMember) {
                        doc.text(`Stockvel Member: Yes`, 20, 115);
                        doc.text(`Total Contributions: R ${loanData.totalContributions.toFixed(2)}`, 20, 122);
                        doc.text(`Monthly Contribution: R ${loanData.monthlyContribution.toFixed(2)}`, 20, 129);
                        const initiationFeeText = loanData.initiationFee === 0 ? 
                            `Initiation Fee: R 0.00 (Waived)` : 
                            `Initiation Fee: R ${loanData.initiationFee.toLocaleString('en-ZA', {minimumFractionDigits: 2})}`;
                        doc.text(initiationFeeText, 20, 136);
                        doc.text(`Admin Fee: R ${loanData.adminFee.toFixed(2)}`, 20, 143);
                    } else {
                        doc.text(`Initiation Fee: R ${loanData.initiationFee.toFixed(2)}`, 20, 115);
                        doc.text(`Admin Fee: R ${loanData.adminFee.toFixed(2)}`, 20, 122);
                    }

                    // Right column - Loan Summary
                    doc.text(`Monthly Repayment: R ${loanData.monthlyPayment.toFixed(2)}`, 105, 80);
                    doc.text(`Total Cost: R ${loanData.totalCost.toFixed(2)}`, 105, 87);
                    doc.text(`Total Interest: R ${loanData.totalInterest.toFixed(2)}`, 105, 94);

                    // Banking Details
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    const bankingDetailsY = loanData.isStockvelMember ? 152 : 125;
                    doc.text('Banking Details', 20, bankingDetailsY);

                    doc.setFontSize(10);
                    doc.text('To pay please use:', 20, bankingDetailsY + 10);
                    doc.setFontSize(9);
                    doc.text(`Account Holder: Thaba Bosiu Financial Services`, 25, bankingDetailsY + 17);
                    doc.text(`Bank Name: TymeBank`, 25, bankingDetailsY + 24);
                    doc.text(`Branch Code: 678910`, 25, bankingDetailsY + 31);
                    doc.text(`Account Number: 53000021839`, 25, bankingDetailsY + 38);
                    doc.setFont('helvetica', 'italic');
                    doc.text('Please use your Name and Surname as the reference', 25, bankingDetailsY + 45);
                    doc.setFont('helvetica', 'normal');

                    // Monthly breakdown table
                    doc.setFontSize(12);
                    doc.setTextColor(44, 62, 80);
                    const tableStartY = bankingDetailsY + 60;
                    doc.text('Monthly Payment Breakdown', 20, tableStartY);

                    // Table headers
                    doc.setFontSize(8);
                    const startY = tableStartY + 10;
                    const rowHeight = 7;
                    doc.setFillColor(44, 62, 80);
                    doc.setTextColor(255, 255, 255);
                    doc.rect(20, startY, 170, rowHeight, 'F');
                    doc.text('Month', 25, startY + 5);
                    doc.text('Monthly', 45, startY + 5);
                    doc.text('Principal', 70, startY + 5);
                    doc.text('Interest', 95, startY + 5);
                    doc.text('Admin', 120, startY + 5);
                    doc.text('Balance', 145, startY + 5);

                    // Table rows with month names
                    doc.setTextColor(0, 0, 0);
                    let currentY = startY + rowHeight;
                    const availableHeight = 280 - currentY;
                    const maxRows = Math.floor(availableHeight / rowHeight);
                    const rowsToShow = Math.min(maxRows, loanData.breakdown.length);
                    
                    for (let i = 0; i < rowsToShow; i++) {
                        const row = loanData.breakdown[i];
                        if (i % 2 === 0) {
                            doc.setFillColor(248, 249, 250);
                            doc.rect(20, currentY, 170, rowHeight, 'F');
                        }
                        doc.setTextColor(0, 0, 0);
                        doc.text(getMonthName(loanData.startMonthIndex, i), 25, currentY + 5);
                        doc.text(`R${loanData.monthlyPayment.toFixed(2)}`, 45, currentY + 5);
                        doc.text(`R${row.principalPayment.toFixed(2)}`, 70, currentY + 5);
                        doc.text(`R${row.interest.toFixed(2)}`, 95, currentY + 5);
                        doc.text(`R${row.adminFee.toFixed(2)}`, 120, currentY + 5);
                        doc.text(`R${row.outstandingBalance.toFixed(2)}`, 145, currentY + 5);
                        currentY += rowHeight;
                    }
                    
                    if (rowsToShow < loanData.breakdown.length) {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Note: Showing ${rowsToShow} of ${loanData.breakdown.length} months`, 20, currentY + 10);
                    }

                    // Footer
                    const today = new Date().toLocaleDateString('en-ZA');
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Generated on: ${today}`, 20, 280);
                    doc.text('Thaba Bosiu Financial Services - Your Financial Refuge', 105, 285, { align: 'center' });

                    // Save PDF
                    const filename = `TBFS_Loan_Schedule_${loanData.accountNumber}.pdf`;
                    doc.save(filename);

                    console.log('PDF generated successfully:', filename);

                    // Show success message
                    const statusEl = document.getElementById('pdfStatus');
                    if (statusEl) {
                        statusEl.innerHTML = '<div class="success">PDF successfully generated and downloaded!</div>';
                        setTimeout(() => {
                            statusEl.innerHTML = '';
                        }, 5000);
                    }
                });
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('An error occurred while generating the PDF. Please try again.');
            }
        }

        function exportToExcel() {
            // Get table data
            const table = document.getElementById('breakdownTable');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Monthly Breakdown"});
            XLSX.writeFile(wb, 'TBFS_Monthly_Payment_Breakdown.xlsx');
        }

        // Backup and Restore Functions
        function backupData() {
            const data = localStorage.getItem('tbfsAppState');
            if (!data) {
                alert('No data to backup');
                return;
            }
            
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TBFS_Backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('✅ Data backup downloaded successfully!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.setItem('tbfsAppState', JSON.stringify(data));
                        AppState.init(); // Reload the app with restored data
                        alert('✅ Data restored successfully!');
                    } catch (error) {
                        alert('❌ Invalid backup file. Please select a valid TBFS backup file.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('⚠️ This will permanently delete ALL data. Are you sure?')) {
                // Auto-backup before clearing
                console.log('🔒 Auto-backup before clearing all data...');
                backupData();
                
                setTimeout(() => {
                    localStorage.removeItem('tbfsAppState');
                    AppState.init();
                    alert('🗑️ All data cleared successfully.\n\n💾 A backup was automatically saved before clearing.');
                }, 500); // Small delay to ensure backup completes
            }
        }

        // Accept Loan Function
        function acceptLoan() {
            if (!loanData || !loanData.firstName) {
                alert('Please calculate a loan first before accepting it');
                return;
            }

            // Check if client exists and is active
            const existingClient = AppState.clients.find(c => c.account_number === loanData.accountNumber);
            if (existingClient) {
                if (existingClient.status !== 'active') {
                    alert(`❌ SECURITY ALERT: Client ${loanData.accountNumber} is ${existingClient.status.toUpperCase()}. Cannot approve loan for inactive clients.`);
                    return;
                }
            }

            // Create or update client
            let client;
            if (existingClient) {
                // Update existing client
                client = existingClient;
                client.total_loans += 1;
                client.total_contributions = loanData.totalContributions || client.total_contributions;
                // Initialize total_repayment if not exists
                if (!client.total_repayment) {
                    client.total_repayment = 0;
                }
            } else {
                // Create new client
                client = {
                    account_number: loanData.accountNumber,
                    first_name: loanData.firstName,
                    last_name: loanData.lastName,
                    phone_number: '', // Not collected in current form
                    client_type: loanData.isStockvelMember ? 'stockvel' : 'standard',
                    total_loans: 1,
                    total_contributions: loanData.totalContributions || 0,
                    total_repayment: 0, // Initialize total repayment to 0
                    status: 'active'
                };
                AppState.clients.push(client);
            }

            // Calculate interest cap based on Math.ceil(term/2) with minimum 3 months
            const interestMonths = Math.ceil(loanData.term / 2) >= 3 ? Math.ceil(loanData.term / 2) : 3;
            
            // Create loan record with payment flexibility tracking
            const loan = {
                loan_id: AppState.loans.length + 1,
                client_name: `${loanData.firstName} ${loanData.lastName}`,
                account_number: loanData.accountNumber,
                principal_amount: loanData.principal,
                original_principal: loanData.principal, // Track original for interest cap
                remaining_principal: loanData.principal, // Track remaining principal
                term_months: loanData.term,
                interest_calculation_months: interestMonths, // Store the interest period for cap
                monthly_payment: loanData.monthlyPayment,
                total_cost: loanData.totalCost,
                current_balance: loanData.totalCost,
                total_initiation_fee: loanData.initiationFee, // Total initiation fee
                initiation_fee_paid: 0, // Track how much initiation fee has been paid
                max_interest_allowed: loanData.totalInterest, // Interest cap (based on Math.ceil(term/2) calculation)
                total_interest_charged: 0, // Track total interest charged so far
                status: 'active',
                created_at: new Date().toISOString()
            };

            // Add loan to system
            AppState.loans.push(loan);
            
            // NOTE: Initiation fee is NOT counted as earned here!
            // It will be counted incrementally as monthly payments are received
            
            // Disburse principal (reduce capital, increase deployed)
            AppState.capital -= loan.principal_amount;
            AppState.deployed += loan.principal_amount;
            
            // Log loan creation
            AppState.logTransaction('loan_created', `New loan #${loan.loan_id} created for ${loanData.firstName} ${loanData.lastName}`, {
                loanId: loan.loan_id,
                clientName: `${loanData.firstName} ${loanData.lastName}`,
                accountNumber: loanData.accountNumber,
                principal: loanData.principal,
                term: loanData.term,
                totalCost: loanData.totalCost,
                monthlyPayment: loanData.monthlyPayment
            });
            
            AppState.save();
            AppState.updateDashboard();

            alert(`✅ Loan approved and added to system!\n\nClient: ${loanData.firstName} ${loanData.lastName}\nAccount: ${loanData.accountNumber}\nAmount: R${loanData.principal.toFixed(2)}\nMonthly Payment: R${loanData.monthlyPayment.toFixed(2)}`);

            // Reset form
            document.getElementById('loanForm').reset();
            document.getElementById('results').style.display = 'none';
        }

        // Client Status Management
        function updateClientStatus(accountNumber, newStatus) {
            const client = AppState.clients.find(c => c.account_number === accountNumber);
            if (!client) {
                alert('Client not found');
                return;
            }

            // Auto-backup before risky operations
            if (newStatus === 'defaulted' || newStatus === 'blacklisted') {
                console.log('🔒 Auto-backup before risky operation...');
                backupData();
            }

            const oldStatus = client.status;
            client.status = newStatus;

            // If blacklisting or defaulting a client, also update their active loans
            if (newStatus === 'blacklisted' || newStatus === 'defaulted') {
                const clientLoans = AppState.loans.filter(l => l.account_number === accountNumber && l.status === 'active');
                clientLoans.forEach(loan => {
                    loan.status = newStatus;
                    AppState.deployed -= loan.principal_amount;
                });
            }

            // Log status change
            AppState.logTransaction('client_status', `Client ${client.first_name} ${client.last_name} status: ${oldStatus.toUpperCase()} → ${newStatus.toUpperCase()}`, {
                accountNumber: accountNumber,
                clientName: `${client.first_name} ${client.last_name}`,
                previousStatus: oldStatus,
                newStatus: newStatus
            });

            // Save changes
            AppState.save();
            AppState.updateDashboard();

            // Show confirmation
            const statusMessages = {
                'active': '✅ Client activated',
                'defaulted': '❌ Client marked as defaulted',
                'blacklisted': '🚫 Client blacklisted'
            };

            alert(statusMessages[newStatus] || 'Client status updated');
        }

        // Payment Management
        function makePayment(loanId) {
            const loan = AppState.loans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('Loan not found');
                return;
            }

            if (loan.status !== 'active') {
                alert('Can only make payments on active loans');
                return;
            }

            // Calculate payoff amount (for early payoff option)
            const remainingInitiationFee = (loan.total_initiation_fee || 0) - (loan.initiation_fee_paid || 0);
            const payoffAmount = (loan.remaining_principal || loan.principal_amount) + remainingInitiationFee;

            // Get payment amount from user
            const paymentAmount = prompt(`💰 Enter payment amount for Loan #${loanId}:\n\n📊 Current Status:\n• Remaining Balance: R${loan.current_balance.toFixed(2)}\n• Expected Monthly Payment: R${loan.monthly_payment.toFixed(2)}\n• Remaining Principal: R${(loan.remaining_principal || loan.principal_amount).toFixed(2)}\n\n💡 Full Payoff Amount: R${payoffAmount.toFixed(2)}\n   (Principal + Remaining Initiation Fee)`);
            
            if (!paymentAmount || isNaN(paymentAmount) || parseFloat(paymentAmount) <= 0) {
                alert('Invalid payment amount');
                return;
            }

            const paidAmount = parseFloat(paymentAmount);
            
            // Find client to determine type
            const client = AppState.clients.find(c => c.account_number === loan.account_number);
            const isStockvel = client && client.client_type === 'stockvel';
            
            // Initialize loan fields if they don't exist (for older loans)
            if (!loan.remaining_principal) loan.remaining_principal = loan.principal_amount;
            if (!loan.original_principal) loan.original_principal = loan.principal_amount;
            if (!loan.total_initiation_fee) loan.total_initiation_fee = loan.principal_amount * 0.12;
            if (!loan.initiation_fee_paid) loan.initiation_fee_paid = 0;
            if (!loan.total_interest_charged) loan.total_interest_charged = 0;
            
            // Calculate max interest allowed based on Math.ceil(term/2) with min 3 months
            if (!loan.max_interest_allowed) {
                const interestMonths = Math.ceil(loan.term_months / 2) >= 3 ? Math.ceil(loan.term_months / 2) : 3;
                // Calculate declining balance interest for the interest period
                let maxInterest = 0;
                let balance = loan.original_principal;
                const monthlyPrincipal = loan.original_principal / loan.term_months;
                for (let i = 0; i < interestMonths; i++) {
                    maxInterest += balance * 0.30;
                    balance -= monthlyPrincipal;
                }
                loan.max_interest_allowed = maxInterest;
            }
            
            // Calculate admin fee (perpetual R60 per payment)
            let adminFeePerMonth = 60;
            if (isStockvel) {
                const totalContributions = client.total_contributions || 0;
                if (totalContributions >= 20000) adminFeePerMonth = 45;
                else if (totalContributions >= 10000) adminFeePerMonth = 50;
            }
            
            // Step 1: Deduct admin fee from payment
            let remainingPayment = paidAmount - adminFeePerMonth;
            if (remainingPayment < 0) {
                alert(`❌ Payment too low! Minimum is R${adminFeePerMonth.toFixed(2)} for admin fee.`);
                return;
            }
            
            // Step 2: Calculate initiation fee portion
            const remainingInitiationFee = loan.total_initiation_fee - loan.initiation_fee_paid;
            const expectedMonthlyInitiation = loan.total_initiation_fee / loan.term_months;
            let initiationFeePaid = Math.min(expectedMonthlyInitiation, remainingInitiationFee, remainingPayment);
            remainingPayment -= initiationFeePaid;
            
            // Step 3: Calculate interest on current remaining principal
            const interestRate = 0.30; // 30% per month on declining balance
            let interestForThisPayment = loan.remaining_principal * interestRate;
            
            // Apply interest cap (never exceed 3-month calculation)
            const interestRemaining = loan.max_interest_allowed - loan.total_interest_charged;
            interestForThisPayment = Math.min(interestForThisPayment, interestRemaining, remainingPayment);
            remainingPayment -= interestForThisPayment;
            
            // Step 4: Apply remaining payment to principal
            const principalPaid = Math.min(remainingPayment, loan.remaining_principal);
            
            // Check for early payoff
            const isEarlyPayoff = paidAmount >= payoffAmount;
            
            // Update loan tracking
            loan.remaining_principal -= principalPaid;
            loan.initiation_fee_paid += initiationFeePaid;
            loan.total_interest_charged += interestForThisPayment;
            loan.current_balance -= paidAmount;
            
            // Update AppState
            AppState.deployed = Math.max(0, AppState.deployed - principalPaid);
            AppState.capital += paidAmount; // All money goes to capital
            AppState.totalInterestEarned += interestForThisPayment;
            AppState.totalFeesEarned += (adminFeePerMonth + initiationFeePaid);
            
            // Update client repayment
            if (client) {
                if (!client.total_repayment) client.total_repayment = 0;
                client.total_repayment += paidAmount;
            }
            
            // Check payment type
            const expectedPayment = loan.monthly_payment;
            let paymentType = 'Regular';
            if (isEarlyPayoff) {
                paymentType = 'Early Payoff';
            } else if (paidAmount > expectedPayment) {
                paymentType = `Overpayment (+R${(paidAmount - expectedPayment).toFixed(2)})`;
            } else if (paidAmount < expectedPayment) {
                paymentType = `Partial Payment (-R${(expectedPayment - paidAmount).toFixed(2)})`;
            }
            
            // Log transaction
            AppState.logTransaction('payment', `${paymentType}: R${paidAmount.toFixed(2)} from ${loan.client_name} (Loan #${loanId})`, {
                loanId: loanId,
                amount: paidAmount,
                principalPaid: principalPaid,
                interestPaid: interestForThisPayment,
                adminFeePaid: adminFeePerMonth,
                initiationFeePaid: initiationFeePaid,
                previousRemainingPrincipal: loan.remaining_principal + principalPaid,
                newRemainingPrincipal: loan.remaining_principal,
                previousBalance: loan.current_balance + paidAmount,
                newBalance: loan.current_balance
            });
            
            // Save changes
            AppState.save();
            AppState.updateDashboard();
            
            // Show detailed summary
            let summary = `💰 Payment Processed!\n\n`;
            summary += `Type: ${paymentType}\n`;
            summary += `Amount Paid: R${paidAmount.toFixed(2)}\n\n`;
            summary += `📊 Breakdown:\n`;
            summary += `• Principal: R${principalPaid.toFixed(2)}\n`;
            summary += `• Interest: R${interestForThisPayment.toFixed(2)}\n`;
            summary += `• Admin Fee: R${adminFeePerMonth.toFixed(2)}\n`;
            summary += `• Initiation Fee: R${initiationFeePaid.toFixed(2)}\n\n`;
            summary += `📈 Loan Status:\n`;
            summary += `• Remaining Principal: R${loan.remaining_principal.toFixed(2)}\n`;
            summary += `• Interest Cap Remaining: R${(loan.max_interest_allowed - loan.total_interest_charged).toFixed(2)}\n`;
            
            if (isEarlyPayoff || loan.remaining_principal <= 0) {
                loan.remaining_principal = 0;
                loan.current_balance = 0;
                loan.status = 'completed';
                AppState.logTransaction('system', `Loan #${loanId} PAID OFF - ${loan.client_name}`, {
                    loanId: loanId,
                    totalInterestCharged: loan.total_interest_charged,
                    interestSaved: loan.max_interest_allowed - loan.total_interest_charged
                });
                AppState.save();
                AppState.updateDashboard();
                summary += `\n🎉 LOAN PAID OFF!\n`;
                if (!isEarlyPayoff) {
                    summary += `Interest Saved: R${(loan.max_interest_allowed - loan.total_interest_charged).toFixed(2)}`;
                }
            }
            
            alert(summary);
        }

        // Undo Last Payment
        function undoLastPayment() {
            const lastTransaction = AppState.transactionHistory[0];
            
            if (!lastTransaction || lastTransaction.type !== 'payment') {
                alert('❌ No payment to undo');
                return;
            }
            
            if (!confirm(`Are you sure you want to undo the last payment?\n\n${lastTransaction.description}\n\nThis will reverse all changes made by this payment.`)) {
                return;
            }
            
            const details = lastTransaction.details;
            const loan = AppState.loans.find(l => l.loan_id === details.loanId);
            
            if (!loan) {
                alert('❌ Cannot find loan for this payment');
                return;
            }
            
            const client = AppState.clients.find(c => c.account_number === loan.account_number);
            
            // Reverse all changes
            loan.current_balance = details.previousBalance;
            AppState.capital = details.previousCapital;
            AppState.deployed = details.previousDeployed;
            AppState.totalInterestEarned = details.previousInterestEarned;
            AppState.totalFeesEarned = details.previousFeesEarned;
            
            if (client) {
                client.total_repayment = details.previousClientRepayment;
            }
            
            // If loan was completed, reactivate it
            if (loan.status === 'completed' && loan.current_balance > 0) {
                loan.status = 'active';
            }
            
            // Remove the payment transaction from history
            AppState.transactionHistory.shift();
            
            // Log the undo action
            AppState.logTransaction('system', `UNDONE: ${lastTransaction.description}`, {
                originalTransactionId: lastTransaction.id,
                amountReversed: details.amount
            });
            
            AppState.save();
            AppState.updateDashboard();
            
            alert(`✅ Payment undone successfully!\n\nReversed: R${details.amount.toFixed(2)}\nLoan #${details.loanId} balance restored to: R${details.previousBalance.toFixed(2)}`);
        }

        // Loan Status Management
        function updateLoanStatus(loanId, newStatus) {
            const loan = AppState.loans.find(l => l.loan_id === loanId);
            if (!loan) {
                alert('Loan not found');
                return;
            }

            const oldStatus = loan.status;
            loan.status = newStatus;
            
            // Update deployed capital based on status change
            if (oldStatus === 'active' && newStatus !== 'active') {
                // Loan is no longer active, reduce deployed capital
                AppState.deployed -= loan.principal_amount;
            } else if (oldStatus !== 'active' && newStatus === 'active') {
                // Loan is now active, increase deployed capital
                AppState.deployed += loan.principal_amount;
            }

            // Save changes
            AppState.save();
            AppState.updateDashboard();

            // Show confirmation
            const statusMessages = {
                'completed': '✅ Loan marked as completed (paid)',
                'defaulted': '❌ Loan marked as defaulted',
                'blacklisted': '🚫 Client blacklisted',
                'active': '🔄 Loan reactivated'
            };

            alert(statusMessages[newStatus] || 'Status updated');
        }

        // ===== UPDATE MANAGEMENT SYSTEM =====
        let updateAvailable = false;
        let waitingServiceWorker = null;
        
        // Display current version
        document.getElementById('currentVersion').textContent = `v${APP_VERSION}`;
        
        // PWA Service Worker Registration with Update Detection
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                        
                        // Check for updates on load
                        registration.update();
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('New service worker found!');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker installed, update available
                                    console.log('Update available!');
                                    updateAvailable = true;
                                    waitingServiceWorker = newWorker;
                                    showUpdateBanner();
                                    document.getElementById('updateStatus').textContent = '🎉 Update available!';
                                    document.getElementById('updateStatus').style.color = '#27ae60';
                                }
                            });
                        });
                        
                        // Check for updates every 30 minutes
                        setInterval(() => {
                            console.log('Checking for updates...');
                            registration.update();
                        }, 30 * 60 * 1000);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                        document.getElementById('updateStatus').textContent = 'Service worker not available';
                    });
                
                // Listen for controller change (update activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('New service worker activated, reloading...');
                    window.location.reload();
                });
            });
        } else {
            document.getElementById('updateStatus').textContent = 'Service worker not supported';
        }
        
        // Check for updates manually - Fetches version from GitHub Pages
        async function checkForUpdates() {
            const button = event.target;
            button.disabled = true;
            button.textContent = '🔄 Checking...';
            document.getElementById('updateStatus').textContent = 'Checking for updates...';
            document.getElementById('updateStatus').style.color = '#7f8c8d';
            
            try {
                // Fetch the deployed index.html from GitHub Pages with cache-busting
                const response = await fetch(`https://ndelo-n.github.io/TBFS-Connected/index.html?t=${Date.now()}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch latest version');
                }
                
                const html = await response.text();
                
                // Extract version number from the deployed HTML
                const versionMatch = html.match(/const APP_VERSION = ['"]([^'"]+)['"]/);
                
                if (versionMatch && versionMatch[1]) {
                    const remoteVersion = versionMatch[1];
                    const currentVersion = APP_VERSION;
                    
                    console.log(`Current: ${currentVersion}, Remote: ${remoteVersion}`);
                    
                    if (remoteVersion !== currentVersion) {
                        // Version mismatch - update available
                        updateAvailable = true;
                        document.getElementById('updateStatus').textContent = `🎉 Update available! v${currentVersion} → v${remoteVersion}`;
                        document.getElementById('updateStatus').style.color = '#27ae60';
                        showUpdateBanner();
                        
                        // Also trigger service worker update to fetch new files
                        if ('serviceWorker' in navigator) {
                            const registration = await navigator.serviceWorker.getRegistration();
                            if (registration) {
                                registration.update();
                            }
                        }
                    } else {
                        // Versions match - no update needed
                        updateAvailable = false;
                        document.getElementById('updateStatus').textContent = `✅ You're running the latest version! (v${currentVersion})`;
                        document.getElementById('updateStatus').style.color = '#27ae60';
                        dismissUpdateBanner(); // Hide banner if shown
                    }
                } else {
                    // Couldn't extract version - fallback to service worker check
                    document.getElementById('updateStatus').textContent = 'Version check inconclusive - checking service worker...';
                    
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.getRegistration();
                        if (registration) {
                            await registration.update();
                            
                            setTimeout(() => {
                                if (updateAvailable) {
                                    document.getElementById('updateStatus').textContent = '🎉 Update available!';
                                    document.getElementById('updateStatus').style.color = '#27ae60';
                                    showUpdateBanner();
                                } else {
                                    document.getElementById('updateStatus').textContent = '✅ No updates found';
                                    document.getElementById('updateStatus').style.color = '#27ae60';
                                }
                            }, 1500);
                        }
                    }
                }
                
                button.disabled = false;
                button.textContent = '🔄 Check for Updates';
                
            } catch (error) {
                console.error('Update check failed:', error);
                document.getElementById('updateStatus').textContent = '❌ Failed to check for updates. Check your internet connection.';
                document.getElementById('updateStatus').style.color = '#e74c3c';
                button.disabled = false;
                button.textContent = '🔄 Check for Updates';
            }
        }
        
        // Show update banner
        function showUpdateBanner() {
            const banner = document.getElementById('updateBanner');
            if (banner) {
                banner.style.display = 'block';
            }
        }
        
        // Dismiss update banner
        function dismissUpdateBanner() {
            const banner = document.getElementById('updateBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        // Activate update
        function activateUpdate() {
            if (waitingServiceWorker) {
                // Send message to service worker to skip waiting
                waitingServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                // Show loading message
                const banner = document.getElementById('updateBanner');
                if (banner) {
                    banner.innerHTML = `
                        <div style="max-width: 1200px; margin: 0 auto; text-align: center;">
                            <strong>🔄 Updating...</strong>
                            <p style="margin: 5px 0 0 0; font-size: 14px;">The app will reload in a moment</p>
                        </div>
                    `;
                }
            } else {
                // Fallback: just reload
                alert('Reloading to apply update...');
                window.location.reload();
            }
        }

        // ===== CLOUD BACKUP SYSTEM =====
        const CloudBackup = {
            autoBackupEnabled: false,
            token: null,
            repoOwner: 'Ndelo-N',
            repoName: 'TBFS-Data-Backup',
            
            init() {
                // Check if token is configured
                const encryptedToken = localStorage.getItem('githubBackupToken');
                if (encryptedToken) {
                    this.token = this.decrypt(encryptedToken);
                }
                
                // Check if auto-backup is enabled
                const autoBackupSetting = localStorage.getItem('autoBackupEnabled');
                this.autoBackupEnabled = (autoBackupSetting === 'true');
                
                this.updateUI();
                
                if (this.autoBackupEnabled) {
                    this.updateSyncTime();
                }
                
                // Setup online/offline listeners
                window.addEventListener('online', () => this.syncPendingBackups());
            },
            
            hasToken() {
                return this.token !== null && this.token.length > 0;
            },
            
            encrypt(text) {
                // Simple Base64 encoding (for basic obfuscation)
                // In production, use stronger encryption
                return btoa(unescape(encodeURIComponent(text)));
            },
            
            decrypt(encoded) {
                return decodeURIComponent(escape(atob(encoded)));
            },
            
            updateUI() {
                if (this.hasToken()) {
                    document.getElementById('tokenConfigured').style.display = 'block';
                    document.getElementById('cloudBackupSetup').style.display = 'none';
                    
                    // Update toggle checkbox
                    const toggle = document.getElementById('autoBackupToggle');
                    if (toggle) {
                        toggle.checked = this.autoBackupEnabled;
                    }
                    
                    // Show/hide auto-backup status
                    if (this.autoBackupEnabled) {
                        document.getElementById('autoBackupStatus').style.display = 'block';
                    } else {
                        document.getElementById('autoBackupStatus').style.display = 'none';
                    }
                } else {
                    document.getElementById('tokenConfigured').style.display = 'none';
                    document.getElementById('cloudBackupSetup').style.display = 'block';
                }
            },
            
            updateSyncTime() {
                const lastSync = localStorage.getItem('lastCloudSync');
                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - date) / 60000);
                    
                    let timeText;
                    if (diffMinutes < 1) {
                        timeText = 'Just now';
                    } else if (diffMinutes < 60) {
                        timeText = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
                    } else {
                        const hours = Math.floor(diffMinutes / 60);
                        timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                    }
                    
                    document.getElementById('lastSyncTime').textContent = timeText;
                }
            },
            
            async backup() {
                if (!this.autoBackupEnabled || !this.hasToken()) {
                    return; // Auto-backup not enabled, skip
                }
                
                if (!navigator.onLine) {
                    // Queue for later if offline
                    localStorage.setItem('pendingCloudBackup', 'true');
                    console.log('Offline: Backup queued for when online');
                    return;
                }
                
                const data = {
                    capital: AppState.capital,
                    deployed: AppState.deployed,
                    totalInterestEarned: AppState.totalInterestEarned,
                    totalFeesEarned: AppState.totalFeesEarned,
                    profitGoal: AppState.profitGoal,
                    clients: AppState.clients,
                    loans: AppState.loans,
                    transactionHistory: AppState.transactionHistory,
                    nextAccountNumber: AppState.nextAccountNumber,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    // Upload latest.json
                    await this.uploadToGitHub('latest.json', data);
                    
                    // Also create daily snapshot
                    const dateStr = new Date().toISOString().split('T')[0];
                    await this.uploadToGitHub(`daily/${dateStr}.json`, data);
                    
                    localStorage.setItem('lastCloudSync', new Date().toISOString());
                    localStorage.removeItem('pendingCloudBackup');
                    this.updateSyncTime();
                    
                    console.log('✅ Cloud backup successful');
                } catch (error) {
                    console.error('Cloud backup failed:', error);
                    localStorage.setItem('pendingCloudBackup', 'true');
                }
            },
            
            async uploadToGitHub(path, data) {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${path}`;
                
                // Check if file exists to get SHA
                let sha = null;
                try {
                    const getResponse = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist, that's okay
                }
                
                // Create or update file
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Backup: ${new Date().toISOString()}`,
                        content: content,
                        sha: sha
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.statusText}`);
                }
            },
            
            async syncPendingBackups() {
                const hasPending = localStorage.getItem('pendingCloudBackup');
                if (hasPending && this.autoBackupEnabled && this.hasToken()) {
                    console.log('🔄 Syncing pending backup...');
                    await this.backup();
                    alert('✅ Pending backup synced to cloud!');
                }
            },
            
            async restore() {
                if (!this.hasToken()) {
                    alert('Please configure your GitHub token first in Settings');
                    return;
                }
                
                try {
                    const url = `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/latest.json`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('No backup found in cloud');
                    }
                    
                    const fileData = await response.json();
                    const content = decodeURIComponent(escape(atob(fileData.content)));
                    const data = JSON.parse(content);
                    
                    // Restore data
                    localStorage.setItem('tbfsAppState', JSON.stringify(data));
                    AppState.init();
                    alert('✅ Data restored from cloud successfully!');
                } catch (error) {
                    alert('❌ Failed to restore from cloud: ' + error.message);
                }
            }
        };
        
        // Cloud Backup UI Functions
        function saveToken() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                alert('Please enter your GitHub token');
                return;
            }
            
            if (!token.startsWith('github_pat_') && !token.startsWith('ghp_')) {
                alert('Invalid token format. Token should start with "github_pat_" or "ghp_"');
                return;
            }
            
            // Encrypt and store token
            const encrypted = CloudBackup.encrypt(token);
            localStorage.setItem('githubBackupToken', encrypted);
            
            CloudBackup.token = token;
            CloudBackup.updateUI();
            
            // Clear token input
            document.getElementById('githubToken').value = '';
            
            alert('✅ Token saved! You can now restore from cloud.\n\n💡 Tip: Check the "Enable Auto-Backup" box if you want this device to automatically sync changes to cloud.');
        }
        
        function removeToken() {
            if (confirm('Remove GitHub token? You won\'t be able to backup or restore from cloud until you add it again.')) {
                localStorage.removeItem('githubBackupToken');
                localStorage.removeItem('autoBackupEnabled');
                localStorage.removeItem('lastCloudSync');
                CloudBackup.token = null;
                CloudBackup.autoBackupEnabled = false;
                CloudBackup.updateUI();
                alert('Token removed');
            }
        }
        
        function toggleAutoBackup() {
            const isChecked = document.getElementById('autoBackupToggle').checked;
            
            if (isChecked) {
                // Enabling auto-backup
                CloudBackup.autoBackupEnabled = true;
                localStorage.setItem('autoBackupEnabled', 'true');
                CloudBackup.updateUI();
                
                // Perform initial backup
                CloudBackup.backup();
                
                alert('✅ Auto-backup enabled! Every change will now sync to cloud automatically.');
            } else {
                // Disabling auto-backup
                if (confirm('Disable auto-backup on this device? You can still restore from cloud anytime.')) {
                    CloudBackup.autoBackupEnabled = false;
                    localStorage.setItem('autoBackupEnabled', 'false');
                    CloudBackup.updateUI();
                    alert('Auto-backup disabled. You can still restore from cloud anytime.');
                } else {
                    // User cancelled, re-check the box
                    document.getElementById('autoBackupToggle').checked = true;
                }
            }
        }
        
        async function restoreFromCloud() {
            if (!CloudBackup.hasToken()) {
                alert('Please configure your GitHub token first in Settings tab');
                return;
            }
            
            if (confirm('This will restore data from your cloud backup and overwrite local data. Continue?')) {
                await CloudBackup.restore();
            }
        }
        
        // Initialize cloud backup on load
        document.addEventListener('DOMContentLoaded', function() {
            CloudBackup.init();
            
            // Update sync time every minute
            setInterval(() => CloudBackup.updateSyncTime(), 60000);
        });
        
        // Hook into existing save function to trigger cloud backup
        const originalSave = AppState.save;
        AppState.save = function() {
            originalSave.call(this);
            // Trigger cloud backup after saving locally (only if auto-backup enabled)
            if (CloudBackup.autoBackupEnabled && CloudBackup.hasToken()) {
                CloudBackup.backup();
            }
        };
    </script>
</body>
</html>




